/*! For license information please see index.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("gl-matrix"),require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("@kitware/vtk.js/Filters/General/ClipClosedSurface"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder"),require("@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"),require("@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"),require("@kitware/vtk.js/Rendering/Core/AxesActor"),require("@kitware/vtk.js/IO/XML/XMLPolyDataReader")):"function"==typeof define&&define.amd?define(["gl-matrix","@cornerstonejs/core","@kitware/vtk.js/Common/DataModel/PiecewiseFunction","@kitware/vtk.js/Rendering/Core/ColorTransferFunction","@kitware/vtk.js/Common/Core/CellArray","@kitware/vtk.js/Common/Core/Points","@kitware/vtk.js/Common/DataModel/PolyData","@kitware/vtk.js/Common/Core/DataArray","@kitware/vtk.js/Filters/General/AppendPolyData","@kitware/vtk.js/Rendering/Core/Actor","@kitware/vtk.js/Rendering/Core/Mapper","@kitware/vtk.js/Filters/General/ClipClosedSurface","@kitware/vtk.js/Common/Core/Math","@kitware/vtk.js/Common/Core/MatrixBuilder","@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget","@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor","@kitware/vtk.js/Rendering/Core/AxesActor","@kitware/vtk.js/IO/XML/XMLPolyDataReader"],t):"object"==typeof exports?exports.cornerstoneTools3D=t(require("gl-matrix"),require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("@kitware/vtk.js/Filters/General/ClipClosedSurface"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder"),require("@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"),require("@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"),require("@kitware/vtk.js/Rendering/Core/AxesActor"),require("@kitware/vtk.js/IO/XML/XMLPolyDataReader")):e.cornerstoneTools3D=t(e.window,e.cornerstone3D,e["@kitware/vtk.js/Common/DataModel/PiecewiseFunction"],e["@kitware/vtk.js/Rendering/Core/ColorTransferFunction"],e["@kitware/vtk.js/Common/Core/CellArray"],e["@kitware/vtk.js/Common/Core/Points"],e["@kitware/vtk.js/Common/DataModel/PolyData"],e["@kitware/vtk.js/Common/Core/DataArray"],e["@kitware/vtk.js/Filters/General/AppendPolyData"],e["@kitware/vtk.js/Rendering/Core/Actor"],e["@kitware/vtk.js/Rendering/Core/Mapper"],e["@kitware/vtk.js/Filters/General/ClipClosedSurface"],e["@kitware/vtk.js/Common/Core/Math"],e["@kitware/vtk.js/Common/Core/MatrixBuilder"],e["@kitware/vtk.js/Interaction/Widgets/OrientationMarkerWidget"],e["@kitware/vtk.js/Rendering/Core/AnnotatedCubeActor"],e["@kitware/vtk.js/Rendering/Core/AxesActor"],e["@kitware/vtk.js/IO/XML/XMLPolyDataReader"])}(self,(function(e,t,n,r,o,a,i,l,s,c,d,u,v,f,g,h,p,m){return function(){var w={907:function(e,t,n){e=n.nmd(e);var r="__lodash_hash_undefined__",o=9007199254740991,a="[object Arguments]",i="[object Boolean]",l="[object Date]",s="[object Function]",c="[object GeneratorFunction]",d="[object Map]",u="[object Number]",v="[object Object]",f="[object Promise]",g="[object RegExp]",h="[object Set]",p="[object String]",m="[object Symbol]",w="[object WeakMap]",E="[object ArrayBuffer]",y="[object DataView]",I="[object Float32Array]",b="[object Float64Array]",C="[object Int8Array]",_="[object Int16Array]",T="[object Int32Array]",O="[object Uint8Array]",D="[object Uint8ClampedArray]",S="[object Uint16Array]",k="[object Uint32Array]",M=/\w*$/,x=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,P={};P[a]=P["[object Array]"]=P[E]=P[y]=P[i]=P[l]=P[I]=P[b]=P[C]=P[_]=P[T]=P[d]=P[u]=P[v]=P[g]=P[h]=P[p]=P[m]=P[O]=P[D]=P[S]=P[k]=!0,P["[object Error]"]=P[s]=P[w]=!1;var A="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,N="object"==typeof self&&self&&self.Object===Object&&self,L=A||N||Function("return this")(),U=t&&!t.nodeType&&t,V=U&&e&&!e.nodeType&&e,j=V&&V.exports===U;function B(e,t){return e.set(t[0],t[1]),e}function W(e,t){return e.add(t),e}function F(e,t,n,r){var o=-1,a=e?e.length:0;for(r&&a&&(n=e[++o]);++o<a;)n=t(n,e[o],o,e);return n}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function G(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function q(e,t){return function(n){return e(t(n))}}function z(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var K,Y=Array.prototype,X=Function.prototype,Z=Object.prototype,J=L["__core-js_shared__"],$=(K=/[^.]+$/.exec(J&&J.keys&&J.keys.IE_PROTO||""))?"Symbol(src)_1."+K:"",Q=X.toString,ee=Z.hasOwnProperty,te=Z.toString,ne=RegExp("^"+Q.call(ee).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=j?L.Buffer:void 0,oe=L.Symbol,ae=L.Uint8Array,ie=q(Object.getPrototypeOf,Object),le=Object.create,se=Z.propertyIsEnumerable,ce=Y.splice,de=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,ve=q(Object.keys,Object),fe=Le(L,"DataView"),ge=Le(L,"Map"),he=Le(L,"Promise"),pe=Le(L,"Set"),me=Le(L,"WeakMap"),we=Le(Object,"create"),Ee=We(fe),ye=We(ge),Ie=We(he),be=We(pe),Ce=We(me),_e=oe?oe.prototype:void 0,Te=_e?_e.valueOf:void 0;function Oe(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function De(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Se(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function ke(e){this.__data__=new De(e)}function Me(e,t,n){var r=e[t];ee.call(e,t)&&Fe(r,n)&&(void 0!==n||t in e)||(e[t]=n)}function xe(e,t){for(var n=e.length;n--;)if(Fe(e[n][0],t))return n;return-1}function Re(e,t,n,r,o,f,w){var x;if(r&&(x=f?r(e,o,f,w):r(e)),void 0!==x)return x;if(!Ke(e))return e;var R=He(e);if(R){if(x=function(e){var t=e.length,n=e.constructor(t);return t&&"string"==typeof e[0]&&ee.call(e,"index")&&(n.index=e.index,n.input=e.input),n}(e),!t)return function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}(e,x)}else{var A=Ve(e),N=A==s||A==c;if(qe(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(A==v||A==a||N&&!f){if(H(e))return f?e:{};if(x=function(e){return"function"!=typeof e.constructor||Be(e)?{}:Ke(t=ie(e))?le(t):{};var t}(N?{}:e),!t)return function(e,t){return Ae(e,Ue(e),t)}(e,function(e,t){return e&&Ae(t,Ye(t),e)}(x,e))}else{if(!P[A])return f?e:{};x=function(e,t,n,r){var o,a=e.constructor;switch(t){case E:return Pe(e);case i:case l:return new a(+e);case y:return function(e,t){var n=t?Pe(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,r);case I:case b:case C:case _:case T:case O:case D:case S:case k:return function(e,t){var n=t?Pe(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,r);case d:return function(e,t,n){return F(t?n(G(e),!0):G(e),B,new e.constructor)}(e,r,n);case u:case p:return new a(e);case g:return function(e){var t=new e.constructor(e.source,M.exec(e));return t.lastIndex=e.lastIndex,t}(e);case h:return function(e,t,n){return F(t?n(z(e),!0):z(e),W,new e.constructor)}(e,r,n);case m:return o=e,Te?Object(Te.call(o)):{}}}(e,A,Re,t)}}w||(w=new ke);var L=w.get(e);if(L)return L;if(w.set(e,x),!R)var U=n?function(e){return function(e,t,n){var r=t(e);return He(e)?r:function(e,t){for(var n=-1,r=t.length,o=e.length;++n<r;)e[o+n]=t[n];return e}(r,n(e))}(e,Ye,Ue)}(e):Ye(e);return function(e,t){for(var n=-1,r=e?e.length:0;++n<r&&!1!==t(e[n],n););}(U||e,(function(o,a){U&&(o=e[a=o]),Me(x,a,Re(o,t,n,r,a,e,w))})),x}function Pe(e){var t=new e.constructor(e.byteLength);return new ae(t).set(new ae(e)),t}function Ae(e,t,n,r){n||(n={});for(var o=-1,a=t.length;++o<a;){var i=t[o],l=r?r(n[i],e[i],i,n,e):void 0;Me(n,i,void 0===l?e[i]:l)}return n}function Ne(e,t){var n,r,o=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function Le(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){return!(!Ke(e)||(t=e,$&&$ in t))&&(ze(e)||H(e)?ne:x).test(We(e));var t}(n)?n:void 0}Oe.prototype.clear=function(){this.__data__=we?we(null):{}},Oe.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Oe.prototype.get=function(e){var t=this.__data__;if(we){var n=t[e];return n===r?void 0:n}return ee.call(t,e)?t[e]:void 0},Oe.prototype.has=function(e){var t=this.__data__;return we?void 0!==t[e]:ee.call(t,e)},Oe.prototype.set=function(e,t){return this.__data__[e]=we&&void 0===t?r:t,this},De.prototype.clear=function(){this.__data__=[]},De.prototype.delete=function(e){var t=this.__data__,n=xe(t,e);return!(n<0||(n==t.length-1?t.pop():ce.call(t,n,1),0))},De.prototype.get=function(e){var t=this.__data__,n=xe(t,e);return n<0?void 0:t[n][1]},De.prototype.has=function(e){return xe(this.__data__,e)>-1},De.prototype.set=function(e,t){var n=this.__data__,r=xe(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},Se.prototype.clear=function(){this.__data__={hash:new Oe,map:new(ge||De),string:new Oe}},Se.prototype.delete=function(e){return Ne(this,e).delete(e)},Se.prototype.get=function(e){return Ne(this,e).get(e)},Se.prototype.has=function(e){return Ne(this,e).has(e)},Se.prototype.set=function(e,t){return Ne(this,e).set(e,t),this},ke.prototype.clear=function(){this.__data__=new De},ke.prototype.delete=function(e){return this.__data__.delete(e)},ke.prototype.get=function(e){return this.__data__.get(e)},ke.prototype.has=function(e){return this.__data__.has(e)},ke.prototype.set=function(e,t){var n=this.__data__;if(n instanceof De){var r=n.__data__;if(!ge||r.length<199)return r.push([e,t]),this;n=this.__data__=new Se(r)}return n.set(e,t),this};var Ue=de?q(de,Object):function(){return[]},Ve=function(e){return te.call(e)};function je(e,t){return!!(t=null==t?o:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function Be(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Z)}function We(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Fe(e,t){return e===t||e!=e&&t!=t}(fe&&Ve(new fe(new ArrayBuffer(1)))!=y||ge&&Ve(new ge)!=d||he&&Ve(he.resolve())!=f||pe&&Ve(new pe)!=h||me&&Ve(new me)!=w)&&(Ve=function(e){var t=te.call(e),n=t==v?e.constructor:void 0,r=n?We(n):void 0;if(r)switch(r){case Ee:return y;case ye:return d;case Ie:return f;case be:return h;case Ce:return w}return t});var He=Array.isArray;function Ge(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=o}(e.length)&&!ze(e)}var qe=ue||function(){return!1};function ze(e){var t=Ke(e)?te.call(e):"";return t==s||t==c}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ye(e){return Ge(e)?function(e,t){var n=He(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ge(e)}(e)&&ee.call(e,"callee")&&(!se.call(e,"callee")||te.call(e)==a)}(e)?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],r=n.length,o=!!r;for(var i in e)!t&&!ee.call(e,i)||o&&("length"==i||je(i,r))||n.push(i);return n}(e):function(e){if(!Be(e))return ve(e);var t=[];for(var n in Object(e))ee.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return Re(e,!0,!0)}},485:function(e,t,n){var r,o="__lodash_hash_undefined__",a=1/0,i="[object Function]",l="[object GeneratorFunction]",s="[object Symbol]",c=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,d=/^\w*$/,u=/^\./,v=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,f=/\\(\\)?/g,g=/^\[object .+?Constructor\]$/,h="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,p="object"==typeof self&&self&&self.Object===Object&&self,m=h||p||Function("return this")(),w=Array.prototype,E=Function.prototype,y=Object.prototype,I=m["__core-js_shared__"],b=(r=/[^.]+$/.exec(I&&I.keys&&I.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"",C=E.toString,_=y.hasOwnProperty,T=y.toString,O=RegExp("^"+C.call(_).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),D=m.Symbol,S=w.splice,k=V(m,"Map"),M=V(Object,"create"),x=D?D.prototype:void 0,R=x?x.toString:void 0;function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function A(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function N(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function L(e,t){for(var n,r,o=e.length;o--;)if((n=e[o][0])===(r=t)||n!=n&&r!=r)return o;return-1}function U(e,t){var n,r,o=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function V(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){if(!H(e)||b&&b in e)return!1;var t=function(e){var t=H(e)?T.call(e):"";return t==i||t==l}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?O:g;return t.test(function(e){if(null!=e){try{return C.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}(n)?n:void 0}P.prototype.clear=function(){this.__data__=M?M(null):{}},P.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},P.prototype.get=function(e){var t=this.__data__;if(M){var n=t[e];return n===o?void 0:n}return _.call(t,e)?t[e]:void 0},P.prototype.has=function(e){var t=this.__data__;return M?void 0!==t[e]:_.call(t,e)},P.prototype.set=function(e,t){return this.__data__[e]=M&&void 0===t?o:t,this},A.prototype.clear=function(){this.__data__=[]},A.prototype.delete=function(e){var t=this.__data__,n=L(t,e);return!(n<0||(n==t.length-1?t.pop():S.call(t,n,1),0))},A.prototype.get=function(e){var t=this.__data__,n=L(t,e);return n<0?void 0:t[n][1]},A.prototype.has=function(e){return L(this.__data__,e)>-1},A.prototype.set=function(e,t){var n=this.__data__,r=L(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},N.prototype.clear=function(){this.__data__={hash:new P,map:new(k||A),string:new P}},N.prototype.delete=function(e){return U(this,e).delete(e)},N.prototype.get=function(e){return U(this,e).get(e)},N.prototype.has=function(e){return U(this,e).has(e)},N.prototype.set=function(e,t){return U(this,e).set(e,t),this};var j=W((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(G(e))return R?R.call(e):"";var t=e+"";return"0"==t&&1/e==-a?"-0":t}(t);var n=[];return u.test(e)&&n.push(""),e.replace(v,(function(e,t,r,o){n.push(r?o.replace(f,"$1"):t||e)})),n}));function B(e){if("string"==typeof e||G(e))return e;var t=e+"";return"0"==t&&1/e==-a?"-0":t}function W(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var r=arguments,o=t?t.apply(this,r):r[0],a=n.cache;if(a.has(o))return a.get(o);var i=e.apply(this,r);return n.cache=a.set(o,i),i};return n.cache=new(W.Cache||N),n}W.Cache=N;var F=Array.isArray;function H(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function G(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&T.call(e)==s}e.exports=function(e,t,n){var r=null==e?void 0:function(e,t){var n;t=function(e,t){if(F(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!G(e))||d.test(e)||!c.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:F(n=t)?n:j(n);for(var r=0,o=t.length;null!=e&&r<o;)e=e[B(t[r++])];return r&&r==o?e:void 0}(e,t);return void 0===r?n:r}},396:function(e){"use strict";e.exports=o},785:function(e){"use strict";e.exports=l},807:function(e){"use strict";e.exports=v},847:function(e){"use strict";e.exports=f},348:function(e){"use strict";e.exports=a},441:function(e){"use strict";e.exports=n},70:function(e){"use strict";e.exports=i},127:function(e){"use strict";e.exports=s},448:function(e){"use strict";e.exports=u},614:function(e){"use strict";e.exports=m},518:function(e){"use strict";e.exports=g},474:function(e){"use strict";e.exports=c},744:function(e){"use strict";e.exports=h},424:function(e){"use strict";e.exports=p},795:function(e){"use strict";e.exports=r},610:function(e){"use strict";e.exports=d},953:function(e){"use strict";e.exports=t},976:function(t){"use strict";t.exports=e},609:function(e,t,n){var r=n(425).default;function o(){"use strict";e.exports=o=function(){return t},e.exports.__esModule=!0,e.exports.default=e.exports;var t={},n=Object.prototype,a=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},l="function"==typeof Symbol?Symbol:{},s=l.iterator||"@@iterator",c=l.asyncIterator||"@@asyncIterator",d=l.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function v(e,t,n,r){var o=t&&t.prototype instanceof h?t:h,a=Object.create(o.prototype),l=new S(r||[]);return i(a,"_invoke",{value:_(e,n,l)}),a}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=v;var g={};function h(){}function p(){}function m(){}var w={};u(w,s,(function(){return this}));var E=Object.getPrototypeOf,y=E&&E(E(k([])));y&&y!==n&&a.call(y,s)&&(w=y);var I=m.prototype=h.prototype=Object.create(w);function b(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(o,i,l,s){var c=f(e[o],e,i);if("throw"!==c.type){var d=c.arg,u=d.value;return u&&"object"==r(u)&&a.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,l,s)}),(function(e){n("throw",e,l,s)})):t.resolve(u).then((function(e){d.value=e,l(d)}),(function(e){return n("throw",e,l,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(a,a):a()}})}function _(e,t,n){var r="suspendedStart";return function(o,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw a;return{value:void 0,done:!0}}for(n.method=o,n.arg=a;;){var i=n.delegate;if(i){var l=T(i,n);if(l){if(l===g)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=f(e,t,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===g)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}function T(e,t){var n=t.method,r=e.iterator[n];if(void 0===r)return t.delegate=null,"throw"===n&&e.iterator.return&&(t.method="return",t.arg=void 0,T(e,t),"throw"===t.method)||"return"!==n&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var o=f(r,e.iterator,t.arg);if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,g;var a=o.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,g):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function D(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function k(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(a.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:M}}function M(){return{value:void 0,done:!0}}return p.prototype=m,i(I,"constructor",{value:m,configurable:!0}),i(m,"constructor",{value:p,configurable:!0}),p.displayName=u(m,d,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,d,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},b(C.prototype),u(C.prototype,c,(function(){return this})),t.AsyncIterator=C,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new C(v(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(I),u(I,d,"Generator"),u(I,s,(function(){return this})),u(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=k,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(D),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var l=a.call(o,"catchLoc"),s=a.call(o,"finallyLoc");if(l&&s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&a.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),D(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;D(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:k(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),g}},t}e.exports=o,e.exports.__esModule=!0,e.exports.default=e.exports},425:function(e){function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},841:function(e,t,n){var r=n(609)();e.exports=r;try{regeneratorRuntime=r}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}}},E={};function y(e){var t=E[e];if(void 0!==t)return t.exports;var n=E[e]={id:e,loaded:!1,exports:{}};return w[e](n,n.exports,y),n.loaded=!0,n.exports}y.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return y.d(t,{a:t}),t},y.d=function(e,t){for(var n in t)y.o(t,n)&&!y.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},y.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),y.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},y.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},y.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e};var I={};return function(){"use strict";y.r(I),y.d(I,{AdvancedMagnifyTool:function(){return sp},AngleTool:function(){return qh},AnnotationDisplayTool:function(){return vd},AnnotationTool:function(){return hd},ArrowAnnotateTool:function(){return Fh},BaseTool:function(){return La},BidirectionalTool:function(){return Vh},BrushTool:function(){return Kc},CONSTANTS:function(){return u},CircleROITool:function(){return Ah},CircleScissorsTool:function(){return Ip},CobbAngleTool:function(){return Jh},CrosshairsTool:function(){return fh},DragProbeTool:function(){return Vg},EllipticalROITool:function(){return Sh},Enums:function(){return Z},LengthTool:function(){return oh},MIPJumpToClickTool:function(){return eh},MagnifyTool:function(){return ep},OrientationMarkerTool:function(){return Lp},OverlayGridTool:function(){return Eh},PaintFillTool:function(){return Bp},PanTool:function(){return kg},PlanarFreehandROITool:function(){return yf},PlanarRotateTool:function(){return Kg},ProbeTool:function(){return Ng},RectangleROIStartEndThresholdTool:function(){return Bd},RectangleROIThresholdTool:function(){return Ud},RectangleROITool:function(){return Nd},RectangleScissorsTool:function(){return Ep},ReferenceCursors:function(){return dp},ReferenceLines:function(){return ph},ReferenceLinesTool:function(){return ph},ScaleOverlayTool:function(){return fp},SegmentationDisplayTool:function(){return el},SegmentationIntersectionTool:function(){return Ch},SphereScissorsTool:function(){return Cp},StackScrollMouseWheelTool:function(){return Xg},StackScrollTool:function(){return Gg},Synchronizer:function(){return Tl},SynchronizerManager:function(){return s},ToolGroupManager:function(){return d},TrackballRotateTool:function(){return xg},Types:function(){return q},VideoRedactionTool:function(){return Fp},VolumeRotateMouseWheelTool:function(){return $g},WindowLevelTool:function(){return Bg},ZoomTool:function(){return Fg},addTool:function(){return wl},annotation:function(){return K},cancelActiveManipulations:function(){return Il},cursors:function(){return G},destroy:function(){return hl},drawing:function(){return f},init:function(){return gl},removeTool:function(){return El},segmentation:function(){return X},state:function(){return Ke},synchronizers:function(){return v},utilities:function(){return H}});var e={};y.r(e),y.d(e,{checkAndDefineIsLockedProperty:function(){return ge},getAnnotationsLocked:function(){return ue},getAnnotationsLockedCount:function(){return fe},isAnnotationLocked:function(){return ve},setAnnotationLocked:function(){return ce},unlockAllAnnotations:function(){return de}});var t={};y.r(t),y.d(t,{deselectAnnotation:function(){return be},getAnnotationsSelected:function(){return Ce},getAnnotationsSelectedByToolName:function(){return _e},getAnnotationsSelectedCount:function(){return Oe},isAnnotationSelected:function(){return Te},setAnnotationSelected:function(){return Ie}});var n={};y.r(n),y.d(n,{checkAndDefineIsVisibleProperty:function(){return Ae},isAnnotationVisible:function(){return Pe},setAnnotationVisibility:function(){return xe},showAllAnnotations:function(){return Re}});var r={};y.r(r),y.d(r,{addAnnotation:function(){return rt},getAnnotation:function(){return it},getAnnotationManager:function(){return Qe},getAnnotations:function(){return nt},getNumberOfAnnotations:function(){return ot},removeAllAnnotations:function(){return lt},removeAnnotation:function(){return at},resetAnnotationManager:function(){return tt},setAnnotationManager:function(){return et}});var o={};y.r(o),y.d(o,{triggerSegmentationDataModified:function(){return St},triggerSegmentationModified:function(){return Dt},triggerSegmentationRemoved:function(){return _t},triggerSegmentationRepresentationModified:function(){return Ot},triggerSegmentationRepresentationRemoved:function(){return Tt}});var a={};y.r(a),y.d(a,{addColorLUT:function(){return Qt},addSegmentation:function(){return Nt},addSegmentationRepresentation:function(){return qt},getAllSegmentationRepresentations:function(){return Ut},getColorLUT:function(){return $t},getDefaultSegmentationStateManager:function(){return Rt},getGlobalConfig:function(){return zt},getSegmentSpecificRepresentationConfig:function(){return Ht},getSegmentation:function(){return Pt},getSegmentationRepresentationByUID:function(){return Yt},getSegmentationRepresentationSpecificConfig:function(){return Ft},getSegmentationRepresentations:function(){return Lt},getSegmentations:function(){return At},getToolGroupIdsWithSegmentation:function(){return Vt},getToolGroupSpecificConfig:function(){return jt},removeColorLUT:function(){return Jt},removeSegmentation:function(){return Xt},removeSegmentationRepresentation:function(){return Zt},setGlobalConfig:function(){return Kt},setSegmentSpecificRepresentationConfig:function(){return Gt},setSegmentationRepresentationSpecificConfig:function(){return Wt},setToolGroupSpecificConfig:function(){return Bt}});var i={};y.r(i),y.d(i,{copyPoints:function(){return $n},copyPointsList:function(){return Jn},getDeltaDistance:function(){return Yn},getDeltaDistanceBetweenIPoints:function(){return Zn},getDeltaPoints:function(){return Kn},getDeltaRotation:function(){return Xn},getMeanPoints:function(){return Qn},getMeanTouchPoints:function(){return er}});var l={};y.r(l),y.d(l,{getSegmentationVisibility:function(){return Ra},setSegmentVisibility:function(){return Aa},setSegmentationVisibility:function(){return xa},setSegmentsVisibility:function(){return Pa}});var s={};y.r(s),y.d(s,{createSynchronizer:function(){return Ol},destroy:function(){return Dl},destroySynchronizer:function(){return Ml},getAllSynchronizers:function(){return kl},getSynchronizer:function(){return Sl},getSynchronizersForViewport:function(){return la}});var c={};y.r(c),y.d(c,{hideElementCursor:function(){return gs},initElementCursor:function(){return us},resetElementCursor:function(){return fs},setElementCursor:function(){return vs}});var d={};y.r(d),y.d(d,{createToolGroup:function(){return Is},destroy:function(){return vl},destroyToolGroup:function(){return dl},getAllToolGroups:function(){return bs},getToolGroup:function(){return fa},getToolGroupForViewport:function(){return Fr},getToolGroupsWithToolName:function(){return Je}});var u={};y.r(u),y.d(u,{COLOR_LUT:function(){return vt}});var v={};y.r(v),y.d(v,{createCameraPositionSynchronizer:function(){return Ts},createStackImageSynchronizer:function(){return Hs},createVOISynchronizer:function(){return Ds},createZoomPanSynchronizer:function(){return Ms}});var f={};y.r(f),y.d(f,{draw:function(){return Wr},drawArrow:function(){return ac},drawCircle:function(){return Ks},drawEllipse:function(){return Ys},drawHandles:function(){return Xs},drawLine:function(){return Zs},drawLinkedTextBox:function(){return rc},drawPolyline:function(){return $s},drawRect:function(){return oc},drawRedactionRect:function(){return ic},drawTextBox:function(){return tc},setAttributesIfNecessary:function(){return qs},setNewAttributesIfValid:function(){return zs}});var g={};y.r(g),y.d(g,{getActiveSegmentationRepresentation:function(){return Nc},setActiveSegmentationRepresentation:function(){return Lc}});var h={};y.r(h),y.d(h,{getLockedSegments:function(){return jc},isSegmentIndexLocked:function(){return Uc},setSegmentIndexLocked:function(){return Vc}});var p={};y.r(p),y.d(p,{getActiveSegmentIndex:function(){return Wc},setActiveSegmentIndex:function(){return Bc}});var m={};y.r(m),y.d(m,{addColorLUT:function(){return Fc},getColorForSegmentIndex:function(){return Gc},setColorForSegmentIndex:function(){return qc},setColorLUT:function(){return Hc}});var w={};y.r(w),y.d(w,{createLabelmapVolumeForViewport:function(){return Zd},createMergedLabelmapForIndex:function(){return Kd},floodFill:function(){return eu},getBrushSizeForToolGroup:function(){return nu},getBrushThresholdForToolGroup:function(){return ou},getDefaultRepresentationConfig:function(){return Xd},isValidRepresentationConfig:function(){return Yd},rectangleROIThresholdVolumeByRange:function(){return zd},setBrushSizeForToolGroup:function(){return tu},setBrushThresholdForToolGroup:function(){return ru},thresholdSegmentationByRange:function(){return au},thresholdVolumeByRange:function(){return Jc},triggerSegmentationRender:function(){return ol}});var E={};y.r(E),y.d(E,{getTextBoxCoordsCanvas:function(){return Td}});var b={};y.r(b),y.d(b,{findClosestPoint:function(){return nc},liangBarksyClip:function(){return du}});var C={};y.r(C),y.d(C,{getCanvasEllipseCorners:function(){return Oc},pointInEllipse:function(){return Dc}});var _={};y.r(_),y.d(_,{distanceToPoint:function(){return Cd},distanceToPointSquared:function(){return bd},intersectLine:function(){return vu}});var T={};y.r(T),y.d(T,{distanceToPoint:function(){return _d}});var O={};y.r(O),y.d(O,{addCanvasPointsToArray:function(){return bu},calculateAreaOfPoints:function(){return _u},getClosestIntersectionWithPolyline:function(){return gu},getFirstIntersectionWithPolyline:function(){return fu},getSubPixelSpacingAndXYDirections:function(){return yu},pointCanProjectOnLine:function(){return Cu},pointsAreWithinCloseContourProximity:function(){return Iu}});var D={};y.r(D),y.d(D,{distanceToPoint:function(){return Tu}});var S={};y.r(S),y.d(S,{BasicStatsCalculator:function(){return xd},Calculator:function(){return Md}});var k={};y.r(k),y.d(k,{BasicStatsCalculator:function(){return S},ellipse:function(){return C},lineSegment:function(){return _},point:function(){return D},polyline:function(){return O},rectangle:function(){return T},vec2:function(){return b}});var M={};y.r(M),y.d(M,{default:function(){return Mu},filterAnnotationsForDisplay:function(){return cd},filterAnnotationsWithinSlice:function(){return sd},getPointInLineOfSightWithCriteria:function(){return Su},getWorldWidthAndHeightFromCorners:function(){return Od}});var x={};y.r(x),y.d(x,{filterViewportsWithFrameOfReferenceUID:function(){return $c},filterViewportsWithParallelNormals:function(){return od},filterViewportsWithToolEnabled:function(){return nd},getViewportIdsWithToolToRender:function(){return ad}});var R={};y.r(R),y.d(R,{getOrientationStringLPS:function(){return xu},invertOrientationStringLPS:function(){return Ru}});var P={};y.r(P),y.d(P,{Events:function(){return Au},addToolState:function(){return Lu},getToolState:function(){return Uu},playClip:function(){return Hu},stopClip:function(){return Gu}});var A={};y.r(A),y.d(A,{extend2DBoundingBoxInViewAxis:function(){return Wd},getBoundingBoxAroundShape:function(){return mc}});var N={};y.r(N),y.d(N,{default:function(){return bf},interpolateAnnotation:function(){return If}});var L={};y.r(L),y.d(L,{getBoundsIJKFromRectangleAnnotations:function(){return Fd}});var U={};y.r(U),y.d(U,{isViewportPreScaled:function(){return Sd},jumpToSlice:function(){return Us},jumpToWorld:function(){return Hf}});var V={};y.r(V),y.d(V,{generateImageFromTimeData:function(){return qf},getDataInTime:function(){return Gf}});var j={};y.r(j),y.d(j,{getPoint:function(){return Kf},getPolyDataPointIndexes:function(){return Yf},getPolyDataPoints:function(){return Xf}});var B={};y.r(B),y.d(B,{ColorbarRangeTextPosition:function(){return Zf}});var W={};y.r(W),y.d(W,{Colorbar:function(){return fg},Enums:function(){return B},ViewportColorbar:function(){return wg}});var F={};y.r(F),y.d(F,{colorbar:function(){return W}});var H={};y.r(H),y.d(H,{boundingBox:function(){return A},calibrateImageSpacing:function(){return hc},cine:function(){return P},clip:function(){return Rs},debounce:function(){return vc},drawing:function(){return E},dynamicVolume:function(){return V},getAnnotationNearPoint:function(){return sc},getAnnotationNearPointOnEnabledElement:function(){return cc},isObject:function(){return uc},jumpToSlice:function(){return Us},math:function(){return k},orientation:function(){return R},planar:function(){return M},planarFreehandROITool:function(){return N},pointInShapeCallback:function(){return pc},pointInSurroundingSphereCallback:function(){return Ec},pointToString:function(){return $a},polyDataUtils:function(){return j},rectangleROITool:function(){return L},roundNumber:function(){return yc},scroll:function(){return Ps},segmentation:function(){return w},stackContextPrefetch:function(){return Ff},stackPrefetch:function(){return Uf},throttle:function(){return fc},touch:function(){return i},triggerAnnotationRender:function(){return Zr},triggerAnnotationRenderForViewportIds:function(){return ca},triggerEvent:function(){return J.triggerEvent},viewport:function(){return U},viewportFilters:function(){return x},voi:function(){return F}});var G={};y.r(G),y.d(G,{CursorNames:function(){return yg},CursorSVG:function(){return Xl},ImageMouseCursor:function(){return Wl},MouseCursor:function(){return Nl},SVGMouseCursor:function(){return as},elementCursor:function(){return c},registerCursor:function(){return Jl},setCursorForElement:function(){return Eg}});var q={};y.r(q);var z={};y.r(z),y.d(z,{getFont:function(){return Ig},getState:function(){return dd},style:function(){return ts}});var K={};y.r(K),y.d(K,{FrameOfReferenceSpecificAnnotationManager:function(){return Ge},config:function(){return z},locking:function(){return e},selection:function(){return t},state:function(){return r},visibility:function(){return n}});var Y={};y.r(Y),y.d(Y,{color:function(){return m},getGlobalConfig:function(){return Ia},getGlobalRepresentationConfig:function(){return Ca},getSegmentSpecificConfig:function(){return ka},getSegmentationRepresentationSpecificConfig:function(){return Da},getToolGroupSpecificConfig:function(){return Ta},setGlobalConfig:function(){return ba},setGlobalRepresentationConfig:function(){return _a},setSegmentSpecificConfig:function(){return Ma},setSegmentationRepresentationSpecificConfig:function(){return Sa},setToolGroupSpecificConfig:function(){return Oa},visibility:function(){return l}});var X={};y.r(X),y.d(X,{activeSegmentation:function(){return g},addSegmentationRepresentations:function(){return Dg},addSegmentations:function(){return Cg},config:function(){return Y},removeSegmentationsFromToolGroup:function(){return cl},segmentIndex:function(){return p},segmentLocking:function(){return h},state:function(){return a},triggerSegmentationEvents:function(){return o}});var Z={};y.r(Z),y.d(Z,{AnnotationStyleStates:function(){return Bl},Events:function(){return Q},KeyboardBindings:function(){return yo},MouseBindings:function(){return Eo},SegmentationRepresentations:function(){return gt},Swipe:function(){return qn},ToolModes:function(){return Xe}});var J=y(953),$=function(e){return e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE",e}($||{}),Q=$;function ee(e){return ee="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ee(e)}function te(e){var t=function(e,t){if("object"!==ee(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==ee(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===ee(t)?t:String(t)}function ne(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,te(r.key),r)}}function re(e,t,n){return t&&ne(e.prototype,t),n&&ne(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function oe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ae(e,t,n){return(t=te(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ie=y(907),le=y.n(ie),se=new Set;function ce(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=he();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,se,n):pe(e,se,n)),me(n,se)}function de(){var e=he();!function(e,t){e.forEach((function(n){pe(n,e,t)}))}(se,e),me(e,se)}function ue(){return Array.from(se)}function ve(e){return se.has(e)}function fe(){return se.size}function ge(e){if(e){var t=!!e.isLocked;(function(e){var t=Object.getOwnPropertyDescriptor(e,"isLocked");return t?t.configurable&&(t.set!==we||t.get!==Ee):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:we,get:Ee}),ce(e,t)}}function he(){return Object.freeze({added:[],removed:[],locked:[]})}function pe(e,t,n){t.delete(e)&&n.removed.push(e)}function me(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((function(t){e.locked.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_LOCK_CHANGE,e))}function we(e){ce(this,e)}function Ee(){return ve(this)}var ye=new Set;function Ie(e){arguments.length>1&&void 0!==arguments[1]&&!arguments[1]?be(e):function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=De();t||Se(ye,n),e&&!ye.has(e)&&(ye.add(e),n.added.push(e)),ke(n,ye)}(e,arguments.length>2&&void 0!==arguments[2]&&arguments[2])}function be(e){var t=De();e?ye.delete(e)&&t.removed.push(e):Se(ye,t),ke(t,ye)}function Ce(){return Array.from(ye)}function _e(e){return Ce().filter((function(t){return it(t).metadata.toolName===e}))}function Te(e){return ye.has(e)}function Oe(){return ye.size}function De(){return Object.freeze({added:[],removed:[],selection:[]})}function Se(e,t){e.forEach((function(n){e.delete(n)&&t.removed.push(n)}))}function ke(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((function(t){e.selection.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_SELECTION_CHANGE,e))}var Me=new Set;function xe(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=Ne();e&&(t?Le(e,Me,n):function(e,t,n){t.has(e)||(t.add(e),Te(e)&&be(e),n.lastHidden.push(e))}(e,Me,n)),Ue(n)}function Re(){var e=Ne();Me.forEach((function(t){Le(t,Me,e)})),Ue(e)}function Pe(e){if(it(e))return!Me.has(e)}function Ae(e){if(e){var t,n=null===(t=e.isVisible)||void 0===t||t;(function(e){var t=Object.getOwnPropertyDescriptor(e,"isVisible");return t?t.configurable&&(t.set!==Ve||t.get!==je):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:Ve,get:je}),xe(e.annotationUID,n)}}function Ne(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Le(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function Ue(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(Me.forEach((function(t){e.hidden.push(t)})),(0,J.triggerEvent)(J.eventTarget,Q.ANNOTATION_VISIBILITY_CHANGE,e))}function Ve(e){xe(this.annotationUID,e)}function je(){return Pe(this.annotationUID)}function Be(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return We(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?We(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function We(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Fe=re((function e(t){var n=this;oe(this,e),ae(this,"annotations",void 0),ae(this,"uid",void 0),ae(this,"getGroupKey",(function(e){if("string"==typeof e)return e;var t=e,n=(0,J.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID})),ae(this,"_imageVolumeModifiedHandler",(function(e){var t=e.detail.FrameOfReferenceUID,r=n.annotations[t];r&&Object.keys(r).forEach((function(e){r[e].forEach((function(e){void 0!==e.invalidated&&(e.invalidated=!0)}))}))})),ae(this,"getFramesOfReference",(function(){return Object.keys(n.annotations)})),ae(this,"getAnnotations",(function(e,t){var r=n.annotations;return r[e]?t?r[e][t]:r[e]:[]})),ae(this,"getAnnotation",(function(e){var t=n.annotations;for(var r in t){var o=t[r];for(var a in o){var i,l=Be(o[a]);try{for(l.s();!(i=l.n()).done;){var s=i.value;if(e===s.annotationUID)return s}}catch(e){l.e(e)}finally{l.f()}}}})),ae(this,"getNumberOfAnnotations",(function(e,t){var r=n.getAnnotations(e,t);if(!r.length)return 0;if(t)return r.length;var o=0;for(var a in r)o+=r[a].length;return o})),ae(this,"addAnnotation",(function(e,t){var r=e.metadata,o=r.FrameOfReferenceUID,a=r.toolName;t=t||o;var i=n.annotations,l=i[t];l||(i[t]={},l=i[t]);var s=l[a];s||(l[a]=[],s=l[a]),s.push(e),ge(e),Ae(e)})),ae(this,"removeAnnotation",(function(e){var t=n.annotations;for(var r in t){var o=t[r];for(var a in o){var i=o[a],l=i.findIndex((function(t){return t.annotationUID===e}));-1!==l&&(i.splice(l,1),0===i.length&&delete o[a])}0===Object.keys(o).length&&delete t[r]}})),ae(this,"removeAnnotations",(function(e,t){var r=n.annotations;r[e]&&(t?delete r[e][t]:delete r[e])})),ae(this,"saveAnnotations",(function(e,t){var r=n.annotations;if(e&&t){var o=r[e];if(!o)return;var a=o[t];return le()(a)}if(e){var i=r[e];return le()(i)}return le()(r)})),ae(this,"restoreAnnotations",(function(e,t,r){var o=n.annotations;if(t&&r){var a=o[t];a||(o[t]={},a=o[t]),a[r]=e}else t?o[t]=e:n.annotations=le()(e)})),ae(this,"getNumberOfAllAnnotations",(function(){var e=0,t=n.annotations;for(var r in t){var o=t[r];for(var a in o)e+=o[a].length}return e})),ae(this,"removeAllAnnotations",(function(){n.annotations={}})),t||(t=J.utilities.uuidv4()),this.annotations={},this.uid=t,J.eventTarget.addEventListener(J.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)})),He=new Fe("DEFAULT"),Ge=Fe,qe={},ze={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:qe,enabledElements:[],handleRadius:6},Ke={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:qe,enabledElements:[],handleRadius:6};var Ye=function(e){return e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled",e}(Ye||{}),Xe=Ye,Ze=[Xe.Active,Xe.Passive,Xe.Enabled],Je=function(e){return Ke.toolGroups.filter((function(t){for(var n=t.toolOptions,r=Object.keys(n),o=0;o<r.length;o++)if(e===r[o]&&n[e]&&Ze.includes(n[e].mode))return!0;return!1}))},$e=He;function Qe(){return $e}function et(e){$e=e}function tt(){$e=He}function nt(e,t){var n=Qe(),r=n.getGroupKey(t);return n.getAnnotations(r,e)}function rt(e,t){void 0===e.annotationUID&&(e.annotationUID=J.utilities.uuidv4());var n=Qe(),r=n.getGroupKey(t);return n.addAnnotation(e,r),t instanceof HTMLDivElement?function(e,t){var n=(0,J.getEnabledElement)(t),r=n.renderingEngine,o=n.viewportId,a=Q.ANNOTATION_ADDED,i={annotation:e,viewportId:o,renderingEngineId:r.id};(0,J.triggerEvent)(J.eventTarget,a,i)}(e,t):function(e){var t=e.metadata.toolName,n=Je(t);if(n.length){var r=[];if(n.forEach((function(t){t.viewportsInfo.forEach((function(t){var n=t.renderingEngineId,o=t.viewportId,a=(0,J.getEnabledElementByIds)(o,n).FrameOfReferenceUID;e.metadata.FrameOfReferenceUID===a&&r.push(t)}))})),r.length){var o=Q.ANNOTATION_ADDED;r.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,a={annotation:e,viewportId:r,renderingEngineId:n};(0,J.triggerEvent)(J.eventTarget,o,a)}))}}}(e),e.annotationUID}function ot(e,t){var n=Qe(),r=n.getGroupKey(t);return n.getNumberOfAnnotations(r,e)}function at(e){var t=Qe(),n=t.getAnnotation(e);if(n){t.removeAnnotation(e);var r=Q.ANNOTATION_REMOVED,o={annotation:n,annotationManagerUID:t.uid};(0,J.triggerEvent)(J.eventTarget,r,o)}}function it(e){return Qe().getAnnotation(e)}function lt(){Qe().removeAllAnnotations()}function st(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ct(e,t){if(e){if("string"==typeof e)return st(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?st(e,t):void 0}}function dt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,l=[],s=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;s=!1}else for(;!(s=(r=a.call(n)).done)&&(l.push(r.value),l.length!==t);s=!0);}catch(e){c=!0,o=e}finally{try{if(!s&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(c)throw o}}return l}}(e,t)||ct(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var ut,vt=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]],ft=function(e){return e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE",e}(ft||{}),gt=ft,ht={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0},pt={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85},mt=function(){return pt};function wt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Et(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wt(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var yt=mt(),It=ht,bt={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:(ut={},ae(ut,gt.Labelmap,yt),ae(ut,gt.Contour,It),ut)},toolGroups:{}},Ct=new(function(){function e(t){oe(this,e),ae(this,"state",void 0),ae(this,"uid",void 0),t||(t=J.utilities.uuidv4()),this.state=le()(bt),this.uid=t}return re(e,[{key:"getState",value:function(){return this.state}},{key:"getToolGroups",value:function(){return Object.keys(this.state.toolGroups)}},{key:"getColorLUT",value:function(e){return this.state.colorLUT[e]}},{key:"resetState",value:function(){this.state=le()(bt)}},{key:"getSegmentation",value:function(e){return this.state.segmentations.find((function(t){return t.segmentationId===e}))}},{key:"addSegmentation",value:function(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw new Error("Segmentation with id ".concat(e.segmentationId," already exists"));this.state.segmentations.push(e)}},{key:"getSegmentationRepresentations",value:function(e){var t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}},{key:"getAllSegmentationRepresentations",value:function(){var e={};return Object.entries(this.state.toolGroups).forEach((function(t){var n=dt(t,2),r=n[0],o=n[1];e[r]=o.segmentationRepresentations})),e}},{key:"addSegmentationRepresentation",value:function(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}},{key:"getGlobalConfig",value:function(){return this.state.globalConfig}},{key:"setGlobalConfig",value:function(e){this.state.globalConfig=e}},{key:"getSegmentationRepresentationByUID",value:function(e,t){return this.getSegmentationRepresentations(e).find((function(e){return e.segmentationRepresentationUID===t}))}},{key:"removeSegmentation",value:function(e){this.state.segmentations=this.state.segmentations.filter((function(t){return t.segmentationId!==e}))}},{key:"removeSegmentationRepresentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No viewport specific segmentation state found for viewport ".concat(e));var r=n.findIndex((function(e){return e.segmentationRepresentationUID===t}));-1===r&&console.warn("No viewport specific segmentation state data found for viewport ".concat(e," and segmentation data UID ").concat(t));var o=n[r];n.splice(r,1),this._handleActiveSegmentation(e,o)}},{key:"setActiveSegmentationRepresentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No segmentation data found for toolGroupId: ".concat(e));var r=n.find((function(e){return e.segmentationRepresentationUID===t}));if(!r)throw new Error("No segmentation data found for segmentation data UID ".concat(t));r.active=!0,this._handleActiveSegmentation(e,r)}},{key:"getToolGroupSpecificConfig",value:function(e){var t=this.state.toolGroups[e];if(t)return t.config}},{key:"getSegmentationRepresentationSpecificConfig",value:function(e,t){var n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}},{key:"setSegmentationRepresentationSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);r&&(r.segmentationRepresentationSpecificConfig=n)}},{key:"getSegmentSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);if(r)return r.segmentSpecificConfig[n]}},{key:"setSegmentSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);r&&(r.segmentSpecificConfig=n)}},{key:"setSegmentationRepresentationConfig",value:function(e,t){var n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config=Et(Et({},n.config),t)}},{key:"addColorLUT",value:function(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}},{key:"removeColorLUT",value:function(e){delete this.state.colorLUT[e]}},{key:"_handleActiveSegmentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);0!==n.length&&(1!==n.length&&0!==n.filter((function(e){return e.active})).length?t.active&&n.forEach((function(e){e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0)}},{key:"_initDefaultColorLUTIfNecessary",value:function(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(vt,0)}}]),e}())("DEFAULT");function _t(e){var t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REMOVED,t)}function Tt(e,t){var n={toolGroupId:e,segmentationRepresentationUID:t};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_REMOVED,n)}function Ot(e,t){var n={toolGroupId:e,segmentationRepresentationUID:t};t?(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_MODIFIED,n):(Lt(e)||[]).forEach((function(t){var n=t.segmentationRepresentationUID,r={toolGroupId:e,segmentationRepresentationUID:n};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_REPRESENTATION_MODIFIED,r)}))}function Dt(e){(e?[e]:At().map((function(e){return e.segmentationId}))).forEach((function(e){var t={segmentationId:e};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_MODIFIED,t)}))}function St(e,t){var n={segmentationId:e,modifiedSlicesToUse:t};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_DATA_MODIFIED,n)}function kt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Mt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kt(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var xt=function(e){var t=e.segmentationId,n=e.representation;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:ae({},n.type,Mt({},n.data))}};function Rt(){return Ct}function Pt(e){return Rt().getSegmentation(e)}function At(){return Rt().getState().segmentations}function Nt(e,t){var n=Rt(),r=xt(e);n.addSegmentation(r),t||Dt(r.segmentationId)}function Lt(e){return Rt().getSegmentationRepresentations(e)}function Ut(){return Rt().getAllSegmentationRepresentations()}function Vt(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");var t=Rt(),n=t.getState(),r=Object.keys(n.toolGroups),o=[];return r.forEach((function(n){t.getSegmentationRepresentations(n).forEach((function(t){t.segmentationId===e&&o.push(n)}))})),o}function jt(e){return Rt().getToolGroupSpecificConfig(e)}function Bt(e,t,n){Rt().setSegmentationRepresentationConfig(e,t),n||Ot(e)}function Wt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Rt().setSegmentationRepresentationSpecificConfig(e,t,n),r||Ot(e,t)}function Ft(e,t){return Rt().getSegmentationRepresentationSpecificConfig(e,t)}function Ht(e,t,n){return Rt().getSegmentSpecificConfig(e,t,n)}function Gt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];Rt().setSegmentSpecificConfig(e,t,n),r||Ot(e,t)}function qt(e,t,n){Rt().addSegmentationRepresentation(e,t),n||Ot(e,t.segmentationRepresentationUID)}function zt(){return Rt().getGlobalConfig()}function Kt(e,t){Rt().setGlobalConfig(e),t||Dt()}function Yt(e,t){return Rt().getSegmentationRepresentationByUID(e,t)}function Xt(e){Rt().removeSegmentation(e),_t(e)}function Zt(e,t){Rt().removeSegmentationRepresentation(e,t),Tt(e,t)}function Jt(e){Rt().removeColorLUT(e)}function $t(e){return Rt().getColorLUT(e)}function Qt(e,t){Rt().addColorLUT(e,t)}function en(e,t){var n=t||e.currentTarget,r=(0,J.getEnabledElement)(n).viewport,o=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),i=function(e,t){var n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:o,canvas:i,world:r.canvasToWorld(i)}}var tn=function(e){var t=e.currentTarget,n=(0,J.getEnabledElement)(t),r=n.viewportId,o=n.renderingEngineId,a=en(e,t),i={event:e,eventName:Q.MOUSE_DOUBLE_CLICK,viewportId:r,renderingEngineId:o,camera:{},element:t,startPoints:a,lastPoints:a,currentPoints:a,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,J.triggerEvent)(t,Q.MOUSE_DOUBLE_CLICK,i)&&(e.stopImmediatePropagation(),e.preventDefault())},nn=Q.MOUSE_MOVE,rn=function(e){var t=e.currentTarget,n=(0,J.getEnabledElement)(t),r={renderingEngineId:n.renderingEngineId,viewportId:n.viewportId,camera:{},element:t,currentPoints:en(e),eventName:nn,event:e};!(0,J.triggerEvent)(t,nn,r)&&(e.stopImmediatePropagation(),e.preventDefault())},on=Q.MOUSE_DOWN,an=Q.MOUSE_DOWN_ACTIVATE,ln=Q.MOUSE_CLICK,sn=Q.MOUSE_UP,cn=Q.MOUSE_DRAG,dn=3,un={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},vn={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},fn={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function gn(e){var t=en(e,vn.element),n=Cn(vn.element,vn.lastPoints),r=_n(t,n);if(fn.doubleClickTimeout){if(!mn(r.canvas))return;En()}var o={event:e,eventName:cn,mouseButton:vn.mouseButton,renderingEngineId:vn.renderingEngineId,viewportId:vn.viewportId,camera:{},element:vn.element,startPoints:bn(vn.startPoints),lastPoints:bn(n),currentPoints:t,deltaPoints:r};!(0,J.triggerEvent)(vn.element,cn,o)&&(e.stopImmediatePropagation(),e.preventDefault()),vn.lastPoints=bn(t)}function hn(e){if(clearTimeout(vn.preventClickTimeout),fn.doubleClickTimeout)fn.mouseUpEvent?In():(fn.mouseUpEvent=e,vn.element.addEventListener("mousemove",pn));else{var t=vn.isClickEvent?ln:sn,n=en(e,vn.element),r=_n(n,vn.lastPoints),o={event:e,eventName:t,mouseButton:vn.mouseButton,element:vn.element,renderingEngineId:vn.renderingEngineId,viewportId:vn.viewportId,camera:{},startPoints:bn(vn.startPoints),lastPoints:bn(vn.lastPoints),currentPoints:n,deltaPoints:r};(0,J.triggerEvent)(o.element,t,o),In()}document.removeEventListener("mousemove",gn)}function pn(e){mn(_n(en(e,vn.element),Cn(vn.element,vn.lastPoints)).canvas)&&(En(),rn(e))}function mn(e){return Math.abs(e[0])+Math.abs(e[1])>dn}function wn(){vn.isClickEvent=!1}function En(){fn.ignoreDoubleClick=!0;var e,t,n,r=fn.mouseDownEvent,o=fn.mouseUpEvent;yn(),e=r,t=_n(vn.startPoints,vn.startPoints),n={event:e,eventName:on,element:vn.element,mouseButton:vn.mouseButton,renderingEngineId:vn.renderingEngineId,viewportId:vn.viewportId,camera:{},startPoints:vn.startPoints,lastPoints:vn.startPoints,currentPoints:vn.startPoints,deltaPoints:t},vn.lastPoints=bn(n.lastPoints),(0,J.triggerEvent)(n.element,on,n)&&(0,J.triggerEvent)(n.element,an,n),o&&hn(o)}function yn(){fn.doubleClickTimeout&&(clearTimeout(fn.doubleClickTimeout),fn.doubleClickTimeout=null),fn.mouseDownEvent=null,fn.mouseUpEvent=null}function In(){var e,t;document.removeEventListener("mouseup",hn),null===(e=vn.element)||void 0===e||e.removeEventListener("mousemove",pn),null===(t=vn.element)||void 0===t||t.addEventListener("mousemove",rn),yn(),vn=JSON.parse(JSON.stringify(un))}function bn(e){return JSON.parse(JSON.stringify(e))}function Cn(e,t){var n=(0,J.getEnabledElement)(e).viewport.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:n}}function _n(e,t){return{page:Tn(e.page,t.page),client:Tn(e.client,t.client),canvas:Tn(e.canvas,t.canvas),world:(n=e.world,r=t.world,[n[0]-r[0],n[1]-r[1],n[2]-r[2]])};var n,r}function Tn(e,t){return[e[0]-t[0],e[1]-t[1]]}function On(e){fn.ignoreDoubleClick?(fn.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):In()}var Dn=function(e){if(fn.doubleClickTimeout){if(e.buttons===fn.mouseDownEvent.buttons)return;return fn.mouseDownEvent=e,void En()}fn.doubleClickTimeout=setTimeout(En,1===e.buttons?400:150),fn.mouseDownEvent=e,fn.ignoreDoubleClick=!1,vn.element=e.currentTarget,vn.mouseButton=e.buttons;var t=(0,J.getEnabledElement)(vn.element),n=t.renderingEngineId,r=t.viewportId;vn.renderingEngineId=n,vn.viewportId=r,vn.preventClickTimeout=setTimeout(wn,vn.clickDelay),vn.element.removeEventListener("mousemove",rn);var o=en(e,vn.element);vn.startPoints=bn(o),vn.lastPoints=bn(o),document.addEventListener("mouseup",hn),document.addEventListener("mousemove",gn)};function Sn(e){e.removeEventListener("dblclick",tn),e.removeEventListener("mousedown",Dn),e.removeEventListener("mousemove",rn),e.removeEventListener("dblclick",On,{capture:!0})}var kn={enable:function(e){Sn(e),e.addEventListener("dblclick",tn),e.addEventListener("mousedown",Dn),e.addEventListener("mousemove",rn),e.addEventListener("dblclick",On,{capture:!0})},disable:Sn},Mn=function(e){var t=e.currentTarget,n=(0,J.getEnabledElement)(t),r=n.renderingEngineId,o=n.viewportId;if(!(e.deltaY>-1&&e.deltaY<1)){e.preventDefault();var a=function(e){var t=0,n=0,r=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),r=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(r=e.deltaX),(r||o)&&e.deltaMode&&(1===e.deltaMode?(r*=40,o*=40):(r*=800,o*=800)),r&&!t&&(t=r<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:r,pixelY:o}}(e),i=a.spinX,l=a.spinY,s=a.pixelX,c=a.pixelY,d=l<0?-1:1,u={event:e,eventName:Q.MOUSE_WHEEL,renderingEngineId:r,viewportId:o,element:t,camera:{},detail:e,wheel:{spinX:i,spinY:l,pixelX:s,pixelY:c,direction:d},points:en(e)};(0,J.triggerEvent)(t,Q.MOUSE_WHEEL,u)}};function xn(e){e.removeEventListener("wheel",Mn)}var Rn,Pn,An={enable:function(e){xn(e),e.addEventListener("wheel",Mn,{passive:!1})},disable:xn},Nn={mouse:0,touch:1};function Ln(e,t){var n=Date.now();if(e!==Rn){if(n-Pn<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Rn=e}Pn=n}var Un=Ln.bind(null,Nn.mouse),Vn=Ln.bind(null,Nn.touch);function jn(e,t,n){var r=n?Un:Vn;t.forEach((function(t){e.addEventListener(t,r,{passive:!1})}))}function Bn(e,t,n){var r=n?Un:Vn;t.forEach((function(t){e.removeEventListener(t,r)}))}var Wn=["mousedown","mouseup","mousemove"],Fn=["touchstart","touchend"];function Hn(e){Bn(e,Wn,Nn.mouse),Bn(e,Fn,Nn.touch)}var Gn={enable:function(e){Hn(e),jn(e,Wn,Nn.mouse),jn(e,Fn,Nn.touch)},disable:Hn},qn=function(e){return e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT",e}(qn||{});function zn(e,t){var n=t||e.currentTarget,r="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(r).map((function(e){var t=function(e){return[e.clientX,e.clientY]}(r[e]),o=function(e){return[e.pageX,e.pageY]}(r[e]),a=function(e,t){var n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o);return{page:o,client:t,canvas:a,world:(0,J.getEnabledElement)(n).viewport.canvasToWorld(a),touch:{identifier:e,radiusX:r[e].radiusX,radiusY:r[e].radiusY,force:r[e].force,rotationAngle:r[e].rotationAngle}}}))}function Kn(e,t){var n,r,o=Qn(e),a=Qn(t);return{page:tr(o.page,a.page),client:tr(o.client,a.client),canvas:tr(o.canvas,a.canvas),world:(n=o.world,r=a.world,[n[0]-r[0],n[1]-r[1],n[2]-r[2]])}}function Yn(e,t){var n=Qn(e),r=Qn(t);return{page:rr(n.page,r.page),client:rr(n.client,r.client),canvas:rr(n.canvas,r.canvas),world:or(n.world,r.world)}}function Xn(e,t){}function Zn(e,t){var n=nr(e),r=nr(t);return{page:n.page-r.page,client:n.client-r.client,canvas:n.canvas-r.canvas,world:n.world-r.world}}function Jn(e){return JSON.parse(JSON.stringify(e))}function $n(e){return JSON.parse(JSON.stringify(e))}function Qn(e){return e.reduce((function(t,n){return{page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function er(e){return e.reduce((function(t,n){return{page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function tr(e,t){return[e[0]-t[0],e[1]-t[1]]}function nr(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e.length;r++)n<r&&t.push({page:rr(e[n].page,e[r].page),client:rr(e[n].client,e[r].client),canvas:rr(e[n].canvas,e[r].canvas),world:or(e[n].world,e[r].world)});return t.reduce((function(e,n){return{page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}}),{page:0,client:0,canvas:0,world:0})}function rr(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function or(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}function ar(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ir(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ar(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ar(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}J.Settings.getRuntimeSettings();var lr=Q.TOUCH_START,sr=Q.TOUCH_START_ACTIVATE,cr=Q.TOUCH_PRESS,dr=Q.TOUCH_DRAG,ur=Q.TOUCH_END,vr=Q.TOUCH_TAP,fr=Q.TOUCH_SWIPE,gr={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},hr={page:0,client:0,canvas:0,world:0},pr={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[ir(ir({},gr),{},{touch:null})],lastPointsList:[ir(ir({},gr),{},{touch:null})],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:hr,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},mr={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[ir(ir({},gr),{},{touch:null})],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300},wr=JSON.parse(JSON.stringify(pr)),Er=JSON.parse(JSON.stringify(mr));function yr(e,t,n){return(0,J.triggerEvent)(e,t,n)}function Ir(e){var t=zn(e,wr.element),n=Cr(wr.element,wr.lastPointsList),r=t.length===n.length?Kn(t,n):gr,o=t.length===n.length?Zn(t,n):hr,a=t.length===n.length?Yn(t,wr.lastPointsList):hr;wr.accumulatedDistance={page:wr.accumulatedDistance.page+a.page,client:wr.accumulatedDistance.client+a.client,canvas:wr.accumulatedDistance.canvas+a.canvas,world:wr.accumulatedDistance.world+a.world};var i={event:e,eventName:dr,renderingEngineId:wr.renderingEngineId,viewportId:wr.viewportId,camera:{},element:wr.element,startPoints:er(wr.startPointsList),lastPoints:er(n),currentPoints:er(t),startPointsList:Jn(wr.startPointsList),lastPointsList:Jn(n),currentPointsList:t,deltaPoints:r,deltaDistance:o};yr(wr.element,dr,i),function(e,t){var n=(new Date).getTime(),r=wr.startTime.getTime();if(!(wr.swiped||n-r>wr.swipeToleranceMs)){var o=dt(t.canvas,2),a=o[0],i=o[1],l={event:e,eventName:fr,renderingEngineId:wr.renderingEngineId,viewportId:wr.viewportId,camera:{},element:wr.element,swipe:null};Math.abs(a)>wr.swipeDistanceThreshold&&(l.swipe=a>0?qn.RIGHT:qn.LEFT,yr(l.element,fr,l),wr.swiped=!0),Math.abs(i)>wr.swipeDistanceThreshold&&(l.swipe=i>0?qn.DOWN:qn.UP,yr(l.element,fr,l),wr.swiped=!0)}}(e,r),wr.lastPointsList=Jn(t)}function br(e){clearTimeout(wr.pressTimeout);var t=zn(e,wr.element),n=Cr(wr.element,wr.lastPointsList),r=t.length===n.length?Kn(t,n):Kn(t,t),o=t.length===n.length?Zn(t,n):Zn(t,t),a={event:e,eventName:ur,element:wr.element,renderingEngineId:wr.renderingEngineId,viewportId:wr.viewportId,camera:{},startPointsList:Jn(wr.startPointsList),lastPointsList:Jn(n),currentPointsList:t,startPoints:er(wr.startPointsList),lastPoints:er(n),currentPoints:er(t),deltaPoints:r,deltaDistance:o};yr(a.element,ur,a),function(e){if(!((new Date).getTime()-wr.startTime.getTime()>Er.tapToleranceMs||(0===Er.taps&&(Er.element=wr.element,Er.renderingEngineId=wr.renderingEngineId,Er.viewportId=wr.viewportId,Er.startPointsList=wr.startPointsList),Er.taps>0&&(Er.element!=wr.element||Er.renderingEngineId!=wr.renderingEngineId||Er.viewportId!=wr.viewportId)))){var t=zn(e,Er.element);Yn(t,Er.startPointsList).canvas>Er.tapMaxDistance||(clearTimeout(Er.tapTimeout),Er.taps+=1,Er.tapTimeout=setTimeout((function(){var n={event:e,eventName:vr,element:Er.element,renderingEngineId:Er.renderingEngineId,viewportId:Er.viewportId,camera:{},currentPointsList:t,currentPoints:er(t),taps:Er.taps};yr(n.element,vr,n),Er=JSON.parse(JSON.stringify(mr))}),Er.tapToleranceMs))}}(e),wr=JSON.parse(JSON.stringify(pr)),document.removeEventListener("touchmove",Ir),document.removeEventListener("touchend",br)}function Cr(e,t){var n=(0,J.getEnabledElement)(e).viewport;return t.map((function(e){var t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}var _r=function(e){wr.element=e.currentTarget;var t=(0,J.getEnabledElement)(wr.element),n=t.renderingEngineId,r=t.viewportId;wr.renderingEngineId=n,wr.viewportId=r,wr.isTouchStart||(clearTimeout(wr.pressTimeout),wr.pressTimeout=setTimeout((function(){return function(e){if(!(wr.accumulatedDistance.canvas>wr.pressMaxDistance)){var t={event:e,eventName:cr,renderingEngineId:wr.renderingEngineId,viewportId:wr.viewportId,camera:{},element:wr.element,startPointsList:Jn(wr.startPointsList),lastPointsList:Jn(wr.lastPointsList),startPoints:$n(er(wr.startPointsList)),lastPoints:$n(er(wr.lastPointsList))};yr(t.element,cr,t)}}(e)}),wr.pressDelay),function(e){wr.isTouchStart=!0,wr.startTime=new Date;var t=zn(e,wr.element),n=er(t),r=gr,o=hr,a={event:e,eventName:lr,element:wr.element,renderingEngineId:wr.renderingEngineId,viewportId:wr.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:r,deltaDistance:o};wr.startPointsList=Jn(a.startPointsList),wr.lastPointsList=Jn(a.lastPointsList),yr(a.element,lr,a)&&yr(a.element,sr,a)}(e),document.addEventListener("touchmove",Ir),document.addEventListener("touchend",br))};function Tr(e){Gn.disable(e),e.removeEventListener("touchstart",_r)}var Or={enable:function(e){Tr(e),Gn.enable(e),e.addEventListener("touchstart",_r,{passive:!1})},disable:Tr},Dr={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null},Sr={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function kr(e){Sr.element=e.currentTarget;var t=(0,J.getEnabledElement)(Sr.element),n=t.renderingEngineId,r=t.viewportId;Sr.renderingEngineId=n,Sr.viewportId=r,Sr.key=e.key,Sr.keyCode=e.keyCode,e.preventDefault();var o={renderingEngineId:Sr.renderingEngineId,viewportId:Sr.viewportId,element:Sr.element,key:Sr.key,keyCode:Sr.keyCode};(0,J.triggerEvent)(o.element,Q.KEY_DOWN,o),document.addEventListener("keyup",xr),document.addEventListener("visibilitychange",Mr),Sr.element.removeEventListener("keydown",kr)}function Mr(){document.removeEventListener("visibilitychange",Mr),"hidden"===document.visibilityState&&Rr()}function xr(e){var t={renderingEngineId:Sr.renderingEngineId,viewportId:Sr.viewportId,element:Sr.element,key:Sr.key,keyCode:Sr.keyCode};document.removeEventListener("keyup",xr),document.removeEventListener("visibilitychange",Mr),Sr.element.addEventListener("keydown",kr),Sr=le()(Dr),(0,J.triggerEvent)(t.element,Q.KEY_UP,t)}function Rr(){Sr.keyCode=void 0}var Pr=kr;function Ar(e){e.removeEventListener("keydown",Pr)}var Nr={enable:function(e){Ar(e),e.addEventListener("keydown",Pr)},disable:Ar,getModifierKey:function(){return Sr.keyCode}};function Lr(e){return function(e){if(Array.isArray(e))return st(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ct(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ur(e,t){if(Ke.svgNodeCache[e])return Ke.svgNodeCache[e][t]?Ke.svgNodeCache[e][t].domRef:void 0}function Vr(e,t,n,r){if(!Ke.svgNodeCache[t])return null;Ke.svgNodeCache[t][r]={touched:!0,domRef:n},e.appendChild(n)}function jr(e,t){Ke.svgNodeCache[e]&&Ke.svgNodeCache[e][t]&&(Ke.svgNodeCache[e][t].touched=!0)}function Br(e,t){Ke.svgNodeCache[t]&&Object.keys(Ke.svgNodeCache[t]).forEach((function(n){var r=Ke.svgNodeCache[t][n];!r.touched&&r.domRef&&(e.removeChild(r.domRef),delete Ke.svgNodeCache[t][n])}))}var Wr=function(e,t){var n=function(e){var t=(0,J.getEnabledElement)(e),n=t.viewportId,r=t.renderingEngineId,o="".concat(n,":").concat(r),a=function(e){var t=".".concat("viewport-element");return e.querySelector(t).querySelector(":scope > .svg-layer")}(e);return Object.keys(Ke.svgNodeCache[o]).forEach((function(e){Ke.svgNodeCache[o][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:Ke.svgNodeCache,getSvgNode:Ur.bind(this,o),appendNode:Vr.bind(this,a,o),setNodeTouched:jr.bind(this,o),clearUntouched:Br.bind(this,a,o)}}(e);t(n),n.clearUntouched()},Fr=function(e,t){var n=Ke.toolGroups.filter((function(n){return n.viewportsInfo.some((function(n){return n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)}))}));if(n.length){if(n.length>1)throw new Error("Multiple tool groups found for renderingEngineId: ".concat(t," and viewportId: ").concat(e,". You should only\n      have one tool group per viewport in a renderingEngine."));return n[0]}};function Hr(e,t){var n=(0,J.getEnabledElement)(e),r=n.renderingEngineId,o=n.viewportId,a=Fr(o,r);if(!a)return[];for(var i=[],l=Object.keys(a.toolOptions),s=0;s<l.length;s++){var c=l[s],d=a.toolOptions[c];if(d&&t.includes(d.mode)){var u=a.getToolInstance(c);i.push(u)}}return i}function Gr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var qr=Xe.Active,zr=Xe.Passive,Kr=Xe.Enabled,Yr=function(){function e(){var t=this;oe(this,e),ae(this,"hasBeenDestroyed",void 0),ae(this,"_needsRender",new Set),ae(this,"_animationFrameSet",!1),ae(this,"_animationFrameHandle",null),ae(this,"_viewportElements",void 0),ae(this,"_renderFlaggedViewports",(function(){t._throwIfDestroyed();for(var e=Array.from(t._viewportElements.values()),n=0;n<e.length;n++){var r=e[n];if(t._needsRender.has(r)&&(t._triggerRender(r),t._needsRender.delete(r),0===t._needsRender.size))return t._animationFrameSet=!1,void(t._animationFrameHandle=null)}})),this._viewportElements=new Map}return re(e,[{key:"addViewportElement",value:function(e,t){this._viewportElements.set(e,t)}},{key:"removeViewportElement",value:function(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}},{key:"renderViewport",value:function(e){this._setViewportsToBeRenderedNextFrame([e])}},{key:"_throwIfDestroyed",value:function(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}},{key:"_setAllViewportsToBeRenderedNextFrame",value:function(){var e=this;Lr(this._viewportElements.values()).forEach((function(t){e._needsRender.add(t)})),this._renderFlaggedViewports()}},{key:"_setViewportsToBeRenderedNextFrame",value:function(e){var t=this,n=Lr(this._viewportElements.values());e.forEach((function(e){-1!==n.indexOf(e)&&t._needsRender.add(e)})),this._render()}},{key:"_render",value:function(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}},{key:"_triggerRender",value:function(e){var t=(0,J.getEnabledElement)(e);if(t)if((0,J.getRenderingEngine)(t.renderingEngineId)){var n=Hr(e,[qr,zr,Kr]),r=t.renderingEngineId,o=t.viewportId,a={element:e,renderingEngineId:r,viewportId:o};Wr(e,(function(r){var o=!1;n.forEach((function(e){if(e.renderAnnotation){var n=e.renderAnnotation(t,r);o=o||n}})),o&&(0,J.triggerEvent)(e,Q.ANNOTATION_RENDERED,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Gr(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Gr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},a))}))}else console.warn("rendering Engine has been destroyed");else console.warn("Element has been disabled")}},{key:"_reset",value:function(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}}]),e}(),Xr=new Yr,Zr=function(e){Xr.renderViewport(e)},Jr=function(e){Zr(e.detail.element)},$r={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_RENDERED,Jr)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_RENDERED,Jr)}};function Qr(e,t,n){var r=e.detail,o=r.renderingEngineId,a=r.viewportId,i=Fr(a,o);if(!i)return[];for(var l=[],s=Object.keys(i.toolOptions),c=0;c<s.length;c++){var d=s[c],u=i.toolOptions[d],v=null!=n&&u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===n}));if(t.includes(u.mode)&&(!n||v)){var f=i.getToolInstance(d);l.push(f)}}return l}var eo=Xe.Active,to=Xe.Passive,no=Xe.Enabled,ro=function(e){Qr(e,[eo,to,no]).forEach((function(t){t.onCameraModified&&t.onCameraModified(e)}))},oo={enable:function(e){e.addEventListener(J.Enums.Events.CAMERA_MODIFIED,ro)},disable:function(e){e.removeEventListener(J.Enums.Events.CAMERA_MODIFIED,ro)}},ao=Xe.Active,io=Xe.Passive,lo=Xe.Enabled,so=function(e){Qr(e,[ao,io,lo]).forEach((function(t){t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},co={enable:function(e){e.addEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,so)},disable:function(e){e.removeEventListener(J.Enums.Events.IMAGE_SPACING_CALIBRATED,so)}},uo=Xe.Active;function vo(e,t,n){if(Ke.isInteractingWithTool)return!1;var r,o=n.detail,a=o.renderingEngineId,i=o.viewportId,l=Fr(i,a);if(!l)return!1;for(var s=Object.keys(l.toolOptions),c=0;c<s.length;c++){var d=s[c],u=l.toolOptions[d],v=l.getToolInstance(d);if(u.mode===uo&&"function"==typeof v[t]){r=l.getToolInstance(d);break}}r&&r[t](n)}var fo=vo.bind(null,"Mouse","mouseClickCallback");function go(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ho(e,t,n){var r="touch"===(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse")?36:6,o=[];return t.forEach((function(t){var a,i=t.tool,l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return go(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?go(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(t.annotations);try{for(l.s();!(a=l.n()).done;){var s=a.value;if(!s.isLocked&&s.isVisible){var c=i.getHandleNearImagePoint(e,s,n,r);if(c){o.push({tool:i,annotation:s,handle:c});break}}}}catch(e){l.e(e)}finally{l.f()}})),o}function po(e,t){for(var n=[],r=0;r<t.length;r++){var o,a=t[r];if(a){var i=nt(a.constructor.toolName,e);null!==(o=i)&&void 0!==o&&o.length&&("function"==typeof a.filterInteractableAnnotationsForElement&&(i=a.filterInteractableAnnotationsForElement(e,i)),i.length>0&&n.push({tool:a,annotations:i}))}else console.warn("undefined tool in filterToolsWithAnnotationsForElement")}return n}function mo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function wo(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o="touch"===r?36:6,a=[];return t.forEach((function(t){var i,l=t.tool,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return mo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?mo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(t.annotations);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(!c.isLocked&&c.isVisible&&l.isPointNearTool(e,c,n,o,r)){a.push({tool:l,annotation:c});break}}}catch(e){s.e(e)}finally{s.f()}})),a}var Eo=function(e){return e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e}(Eo||{}),yo=function(e){return e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta",e}(yo||{}),Io=function(e){return e.shiftKey?e.ctrlKey?yo.ShiftCtrl:e.altKey?yo.ShiftAlt:e.metaKey?yo.ShiftMeta:yo.Shift:e.ctrlKey?e.altKey?yo.CtrlAlt:e.metaKey?yo.CtrlMeta:yo.Ctrl:e.altKey?e.metaKey&&yo.AltMeta||yo.Alt:e.metaKey?yo.Meta:void 0},bo=Xe.Active;function Co(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=e.detail.event,a=Io(o)||Nr.getModifierKey(),i=Fr(r,n);if(!i)return null;for(var l=Object.keys(i.toolOptions),s=i.getDefaultMousePrimary(),c=0;c<l.length;c++){var d=l[c],u=i.toolOptions[d],v=u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===(o?o.buttons:s)&&e.modifierKey===a}));if(u.mode===bo&&v)return i.getToolInstance(d)}}var _o=Xe.Active,To=Xe.Passive;var Oo=Xe.Active,Do=Xe.Passive;function So(e){if(!Ke.isInteractingWithTool){var t=Co(e);if(t&&"function"==typeof t.preMouseDownCallback&&t.preMouseDownCallback(e))return;var n=1===e.detail.event.buttons,r=Qr(e,[Oo],e.detail.event.buttons),o=n?Qr(e,[Do]):void 0,a=[].concat(Lr(r||[]),Lr(o||[])),i=e.detail,l=i.element,s=po(l,a),c=i.currentPoints.canvas,d=ho(l,s,c,"mouse"),u=!!e.detail.event.shiftKey;if(d.length>0){var v=ko(d),f=v.tool,g=v.annotation,h=v.handle;return Mo(g.annotationUID,u),void f.handleSelectedCallback(e,g,h,"Mouse")}var p=wo(l,s,c,"mouse");if(p.length>0){var m=ko(p),w=m.tool,E=m.annotation;return Mo(E.annotationUID,u),void w.toolSelectedCallback(e,E,"Mouse",c)}if(t&&"function"==typeof t.postMouseDownCallback&&t.postMouseDownCallback(e))return;!function(e){if(Ke.isInteractingWithTool)return!1;var t=e.detail,n=t.element,r=(0,J.getEnabledElement)(n),o=t.currentPoints.canvas;if(!r)return!1;var a=function(e,t){var n,r=new Map,o=e.detail,a=o.renderingEngineId,i=o.viewportId,l=Fr(i,a);if(!l)return r;for(var s=Object.keys(l.toolOptions),c=l.getDefaultMousePrimary(),d=e.detail.event,u=null!==(n=null==d?void 0:d.buttons)&&void 0!==n?n:c,v=Io(d)||Nr.getModifierKey(),f=0;f<s.length;f++){var g,h=s[f],p=l.getToolInstance(h),m=null===(g=p.configuration)||void 0===g?void 0:g.actions;if(null!=m&&m.length&&t.includes(p.mode)){var w=m.find((function(e){return e.bindings.length&&e.bindings.some((function(e){return e.mouseButton===u&&e.modifierKey===v}))}));w&&r.set(p,w)}}return r}(e,[_o,To]),i=wo(n,po(n,Array.from(a.keys())),o);if(i.length>0){var l=i[0],s=l.tool,c=l.annotation,d=a.get(s);return("string"==typeof d.method?s[d.method]:d.method).call(s,e,c),!0}}(e)}}function ko(e){return e.length>1&&e.find((function(e){return!ve(e.annotation)&&Pe(e.annotation.annotationUID)}))||e[0]}function Mo(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Te(e)?Ie(e,!1):Ie(e,!0,!0):Ie(e,!0,!1)}function xo(e){if(!Ke.isInteractingWithTool){var t=Co(e);t&&(Ke.isMultiPartToolActive||t.addNewAnnotation&&Ie(t.addNewAnnotation(e,"mouse").annotationUID))}}var Ro=vo.bind(null,"Mouse","doubleClickCallback");function Po(e){if(!Ke.isInteractingWithTool){var t=Co(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}}function Ao(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var No=Xe.Active,Lo=Xe.Passive;function Uo(e){if(!Ke.isInteractingWithTool&&!Ke.isMultiPartToolActive){var t,n=Qr(e,[No,Lo]),r=e.detail.element,o=po(r,n),a=n.filter((function(e){return!o.some((function(t){return t.tool.getToolName()===e.getToolName()}))})),i=!1,l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ao(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ao(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(l.s();!(t=l.n()).done;){var s=t.value,c=s.tool,d=s.annotations;"function"==typeof c.mouseMoveCallback&&(i=c.mouseMoveCallback(e,d)||i)}}catch(e){l.e(e)}finally{l.f()}a.forEach((function(t){"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===i&&Zr(r)}}var Vo=vo.bind(null,"Mouse","mouseUpCallback"),jo=vo.bind(null,"MouseWheel","mouseWheelCallback"),Bo={enable:function(e){e.addEventListener(Q.MOUSE_CLICK,fo),e.addEventListener(Q.MOUSE_DOWN,So),e.addEventListener(Q.MOUSE_DOWN_ACTIVATE,xo),e.addEventListener(Q.MOUSE_DOUBLE_CLICK,Ro),e.addEventListener(Q.MOUSE_DRAG,Po),e.addEventListener(Q.MOUSE_MOVE,Uo),e.addEventListener(Q.MOUSE_UP,Vo),e.addEventListener(Q.MOUSE_WHEEL,jo)},disable:function(e){e.removeEventListener(Q.MOUSE_CLICK,fo),e.removeEventListener(Q.MOUSE_DOWN,So),e.removeEventListener(Q.MOUSE_DOWN_ACTIVATE,xo),e.removeEventListener(Q.MOUSE_DOUBLE_CLICK,Ro),e.removeEventListener(Q.MOUSE_DRAG,Po),e.removeEventListener(Q.MOUSE_MOVE,Uo),e.removeEventListener(Q.MOUSE_UP,Vo),e.removeEventListener(Q.MOUSE_WHEEL,jo)}},Wo=Xe.Active;function Fo(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=vn.mouseButton,a=Nr.getModifierKey(),i=Fr(r,n);if(!i)return null;for(var l=Object.keys(i.toolOptions),s=i.getDefaultMousePrimary(),c=0;c<l.length;c++){var d=l[c],u=i.toolOptions[d],v=u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===(null!=o?o:s)&&e.modifierKey===a}));if(u.mode===Wo&&v)return i.getToolInstance(d)}}function Ho(e){var t=Fo(e);if(t){var n=e.detail,r=n.renderingEngineId,o=n.viewportId,a=Fr(o,r),i=t.getToolName();Object.keys(a.toolOptions).includes(i)&&a.setViewportsCursorByToolName(i)}}function Go(e){var t=Fo(e);if(t){var n=e.detail,r=n.renderingEngineId,o=n.viewportId,a=Fr(o,r);Rr();var i=t.getToolName();Object.keys(a.toolOptions).includes(i)&&a.setViewportsCursorByToolName(i)}}var qo={enable:function(e){e.addEventListener(Q.KEY_DOWN,Ho),e.addEventListener(Q.KEY_UP,Go)},disable:function(e){e.removeEventListener(Q.KEY_DOWN,Ho),e.removeEventListener(Q.KEY_UP,Go)}},zo=Xe.Active;function Ko(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=e.detail.event,a=Fr(r,n);if(!a)return null;for(var i=Object.keys(a.toolOptions),l=Object.keys(o.touches).length,s=Io(o)||Nr.getModifierKey(),c=a.getDefaultMousePrimary(),d=0;d<i.length;d++){var u=i[d],v=a.toolOptions[u],f=v.bindings.length&&v.bindings.some((function(e){return(e.numTouchPoints===l||1===l&&e.mouseButton===c)&&e.modifierKey===s}));if(v.mode===zo&&f)return a.getToolInstance(u)}}function Yo(e,t,n){var r=e.detail,o=r.renderingEngineId,a=r.viewportId,i=Fr(a,o);if(!i)return[];for(var l=[],s=Object.keys(i.toolOptions),c=0;c<s.length;c++){var d=s[c],u=i.toolOptions[d],v=null!=n&&u.bindings.length&&u.bindings.some((function(e){return e.numTouchPoints===n}));if(t.includes(u.mode)&&(!n||v)){var f=i.getToolInstance(d);l.push(f)}}return l}var Xo=Xe.Active,Zo=Xe.Passive;function Jo(e){if(!Ke.isInteractingWithTool){var t=Ko(e);if(t&&"function"==typeof t.preTouchStartCallback&&t.preTouchStartCallback(e))return;var n=1===Object.keys(e.detail.event.touches).length,r=Yo(e,[Xo],Object.keys(e.detail.event.touches).length),o=n?Yo(e,[Zo]):void 0,a=[].concat(Lr(r||[]),Lr(o||[]),[t]),i=e.detail,l=i.element,s=po(l,a),c=i.currentPoints.canvas,d=ho(l,s,c,"touch");if(d.length>0){var u=$o(d),v=u.tool,f=u.annotation,g=u.handle;return Qo(f.annotationUID,!1),void v.handleSelectedCallback(e,f,g,"Touch")}var h=wo(l,s,c,"touch");if(h.length>0){var p=$o(h),m=p.tool,w=p.annotation;return Qo(w.annotationUID,!1),void m.toolSelectedCallback(e,w,"Touch")}if(t&&"function"==typeof t.postTouchStartCallback&&t.postTouchStartCallback(e))return}}function $o(e){return e.length>1&&e.find((function(e){return!ve(e.annotation)&&Pe(e.annotation.annotationUID)}))||e[0]}function Qo(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Te(e)?Ie(e,!1):Ie(e,!0,!0):Ie(e,!0,!1)}function ea(e){if(!Ke.isInteractingWithTool){var t=Ko(e);t&&(Ke.isMultiPartToolActive||t.addNewAnnotation&&Ie(t.addNewAnnotation(e,"touch").annotationUID))}}function ta(e){if(!Ke.isInteractingWithTool){var t=Ko(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}}var na=vo.bind(null,"Touch","touchEndCallback"),ra=vo.bind(null,"Touch","touchTapCallback"),oa=vo.bind(null,"Touch","touchPressCallback"),aa={enable:function(e){e.addEventListener(Q.TOUCH_START,Jo),e.addEventListener(Q.TOUCH_START_ACTIVATE,ea),e.addEventListener(Q.TOUCH_DRAG,ta),e.addEventListener(Q.TOUCH_END,na),e.addEventListener(Q.TOUCH_TAP,ra),e.addEventListener(Q.TOUCH_PRESS,oa)},disable:function(e){e.removeEventListener(Q.TOUCH_START,Jo),e.removeEventListener(Q.TOUCH_START_ACTIVATE,ea),e.removeEventListener(Q.TOUCH_DRAG,ta),e.removeEventListener(Q.TOUCH_END,na),e.removeEventListener(Q.TOUCH_PRESS,oa)}};function ia(e){var t,n=e.detail,r=n.element,o=n.viewportId,a=function(e){var t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),r="svg-layer-".concat(e);n.classList.add("svg-layer"),n.setAttribute("id",r),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";var o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),i=document.createElementNS(t,"feOffset"),l=document.createElementNS(t,"feColorMatrix"),s=document.createElementNS(t,"feBlend");return a.setAttribute("id","shadow-".concat(r)),a.setAttribute("filterUnits","userSpaceOnUse"),i.setAttribute("result","offOut"),i.setAttribute("in","SourceGraphic"),i.setAttribute("dx","0.5"),i.setAttribute("dy","0.5"),l.setAttribute("result","matrixOut"),l.setAttribute("in","offOut"),l.setAttribute("in2","matrix"),l.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),s.setAttribute("in","SourceGraphic"),s.setAttribute("in2","matrixOut"),s.setAttribute("mode","normal"),a.appendChild(i),a.appendChild(l),a.appendChild(s),o.appendChild(a),n.appendChild(o),n}(o);!function(e){var t=e.dataset,n=t.viewportUid,r=t.renderingEngineUid,o="".concat(n,":").concat(r);Ke.svgNodeCache[o]={}}(r),t=a,r.querySelector("div.viewport-element").appendChild(t),Xr.addViewportElement(o,r),kn.enable(r),An.enable(r),Or.enable(r),Nr.enable(r),$r.enable(r),oo.enable(r),co.enable(r),Bo.enable(r),qo.enable(r),aa.enable(r),Ke.enabledElements.push(r)}var la=function(e,t){var n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(var r=0;r<Ke.synchronizers.length;r++){var o=Ke.synchronizers[r],a=!o.isDisabled(),i=o.hasSourceViewport(t,e),l=o.hasTargetViewport(t,e);a&&(i||l)&&n.push(o)}return n},sa=function(e){var t=e.detail,n=t.element,r=t.viewportId;!function(e){var t=e.dataset,n=t.viewportUid,r=t.renderingEngineUid,o="".concat(n,":").concat(r);delete Ke.svgNodeCache[o]}(n),function(e){var t=e.querySelector("div.".concat("viewport-element")),n=t.querySelector("svg");n&&t.removeChild(n)}(n),Xr.removeViewportElement(r,n),kn.disable(n),An.disable(n),Or.disable(n),Nr.disable(n),$r.disable(n),oo.disable(n),co.disable(n),Bo.disable(n),qo.disable(n),aa.disable(n),function(e){var t=(0,J.getEnabledElement)(e);la(t.viewportId,t.renderingEngineId).forEach((function(e){e.remove(t)}))}(n),function(e){var t=(0,J.getEnabledElement)(e),n=t.renderingEngineId,r=t.viewportId,o=Fr(r,n);o&&o.removeViewports(n,r)}(n),function(e){var t=Ke.enabledElements.findIndex((function(t){return t===e}));t>-1&&Ke.enabledElements.splice(t,1)}(n)},ca=function(e,t){t.length&&t.forEach((function(t){var n=e.getViewport(t).element;Zr(n)}))},da=function(e){var t=e.detail,n=t.viewportId,r=t.renderingEngineId,o=(0,J.getRenderingEngine)(r);ca(o,[n])},ua=function(e){e.detail.removed.length&&(0,J.getRenderingEngines)().forEach((function(e){var t=e.getViewports().map((function(e){return e.id}));ca(e,t)}))},va=function(e){var t=e.detail.segmentationId;Vt(t).forEach((function(e){Lt(e).forEach((function(n){n.segmentationId===t&&Ot(e,n.segmentationRepresentationUID)}))}))},fa=function(e){return Ke.toolGroups.find((function(t){return t.id===e}))};function ga(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ha(e,t){return ha=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ha(e,t)}function pa(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ha(e,t)}function ma(e,t){if(t&&("object"===ee(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ga(e)}function wa(e){return wa=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},wa(e)}function Ea(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ya(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ea(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ea(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ia(){return zt()}function ba(e){Kt(e)}function Ca(e){return Ia().representations[e]}function _a(e,t){var n=Ia();ba(ya(ya({},n),{},{representations:ya(ya({},n.representations),{},ae({},e,ya(ya({},n.representations[e]),t)))}))}function Ta(e){return jt(e)}function Oa(e,t){Bt(e,t)}function Da(e,t){return Ft(e,t)}function Sa(e,t,n){Wt(e,t,n)}function ka(e,t,n){return Ht(e,t,n)}function Ma(e,t,n){Gt(e,t,n)}function xa(e,t,n){var r=Lt(e);if(r){var o=r.find((function(e){return e.segmentationRepresentationUID===t}));if(o){var a=o.segmentsHidden,i=function(e){var t=Pt(e);if(t.type===gt.Labelmap){for(var n=J.cache.getVolume(e).getScalarData(),r={},o=0;o<n.length;o++){var a=n[o];0===a||r[a]||(r[a]=!0)}return Object.keys(r).map((function(e){return parseInt(e,10)}))}if(t.type===gt.Contour){var i,l=null===(i=t.representationData.CONTOUR)||void 0===i?void 0:i.geometryIds;if(!l)throw new Error("No geometryIds found for segmentationId ".concat(e));return l.map((function(e){return J.cache.getGeometry(e).data.getSegmentIndex()}))}}(o.segmentationId);n?a.clear():i.forEach((function(e){a.add(e)})),Ot(e,o.segmentationRepresentationUID)}}}function Ra(e,t){var n=Lt(e).find((function(e){return e.segmentationRepresentationUID===t}));if(n)return 0===n.segmentsHidden.size}function Pa(e,t,n,r){var o=Yt(e,t);o&&(n.forEach((function(e){r?o.segmentsHidden.delete(e):o.segmentsHidden.add(e)})),Ot(e,t))}function Aa(e,t,n,r){var o=Yt(e,t);o&&(r?o.segmentsHidden.delete(n):o.segmentsHidden.add(n),Ot(e,t))}var Na=function(){function e(t,n){oe(this,e),ae(this,"supportedInteractionTypes",void 0),ae(this,"configuration",void 0),ae(this,"toolGroupId",void 0),ae(this,"mode",void 0);var r=J.utilities.deepMerge(n,t),o=r.configuration,a=void 0===o?{}:o,i=r.supportedInteractionTypes,l=r.toolGroupId;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=l,this.supportedInteractionTypes=i||[],this.configuration=Object.assign({},a),this.mode=Xe.Disabled}return re(e,[{key:"getToolName",value:function(){return this.constructor.toolName}},{key:"applyActiveStrategy",value:function(e,t){var n=this.configuration;return n.strategies[n.activeStrategy].call(this,e,t)}},{key:"setConfiguration",value:function(e){this.configuration=J.utilities.deepMerge(this.configuration,e)}},{key:"setActiveStrategy",value:function(e){this.setConfiguration({activeStrategy:e})}},{key:"getTargetVolumeId",value:function(e){var t;if(this.configuration.volumeId)return this.configuration.volumeId;var n=e.getActors();return n?null===(t=n.find((function(e){return"vtkVolume"===e.actor.getClassName()})))||void 0===t?void 0:t.uid:void 0}},{key:"getTargetIdImage",value:function(e,t){if(e.startsWith("imageId:")){var n=e.split("imageId:")[1],r=J.utilities.imageIdToURI(n),o=J.utilities.getViewportsWithImageURI(r,t.id);if(!o||!o.length)return;if(!(o=o.filter((function(e){return e.getCurrentImageId()===n})))||!o.length)return;return o[0].getImageData()}if(e.startsWith("volumeId:")){var a=e.split("volumeId:")[1],i=J.utilities.getViewportsWithVolumeId(a,t.id);if(!i||!i.length)return;return i[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}},{key:"getTargetId",value:function(e){if(e instanceof J.StackViewport)return"imageId:".concat(e.getCurrentImageId());if(e instanceof J.BaseVolumeViewport)return"volumeId:".concat(this.getTargetVolumeId(e));if(e instanceof J.VideoViewport)return"";throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}]),e}();ae(Na,"toolName",void 0),Na.toolName="BaseTool";var La=Na;function Ua(e,t,n,r,o,a,i){try{var l=e[a](i),s=l.value}catch(e){return void n(e)}l.done?t(s):Promise.resolve(s).then(r,o)}function Va(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Ua(a,r,o,i,l,"next",e)}function l(e){Ua(a,r,o,i,l,"throw",e)}i(void 0)}))}}var ja=y(841),Ba=y.n(ja),Wa=function(e,t){var n=(0,J.getEnabledElement)(e).viewport,r=n.getActors().map((function(e){var n=e.uid;return n.startsWith(t)?n:void 0})).filter(Boolean);n.removeActors(r)},Fa=y(610),Ha=y.n(Fa),Ga=y(474),qa=y.n(Ga),za=y(448),Ka=y.n(za),Ya=y(70),Xa=y.n(Ya),Za=y(396),Ja=y.n(Za);function $a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}var Qa=new Map;function ei(e){var t=e.detail,n=t.actorEntry,r=t.vtkPlanes,o=t.viewport;if(null!=n&&n.clippingFilter){var a=n.actor.getMapper(),i=o.getCamera().viewPlaneNormal,l=o.getCurrentImageIdIndex(),s="".concat(o.id,"-").concat($a(i),"-").concat(l),c=Qa.get(n.uid);c||(c=new Map,Qa.set(n.uid,c));var d=c.get(s);if(!d){var u=n.clippingFilter;u.setClippingPlanes(r);try{u.update(),d=u.getOutputData(),c.set(s,d)}catch(e){console.error("Error clipping surface",e)}}a.setInputData(d)}}var ti=function(e,t,n){var r=(0,J.getEnabledElement)(e).viewport,o=t.getPoints(),a=t.getPolys(),i=t.getColor(),l=Xa().newInstance();l.getPoints().setData(o,3);var s=Ja().newInstance({values:Float32Array.from(a)});l.setPolys(s);var c,d=Ha().newInstance({});if(r instanceof J.VolumeViewport3D)d.setInputData(l);else{(c=Ka().newInstance({clippingPlanes:[],activePlaneId:2,passPointData:!1})).setInputData(l),c.setGenerateOutline(!0),c.setGenerateFaces(!1),c.update();var u=c.getOutputData();d.setInputData(u)}var v=qa().newInstance();v.setMapper(d),v.getProperty().setColor(i[0]/255,i[1]/255,i[2]/255),r.addActor({actor:v,uid:n,clippingFilter:c}),e.addEventListener(J.Enums.Events.CLIPPING_PLANES_UPDATED,ei)};function ni(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ri(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ni(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ni(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function oi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ai(){return(ai=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.segmentationId,a=J.utilities.uuidv4(),i=new Set,l={segmentationId:o,segmentationRepresentationUID:a,type:gt.Surface,segmentsHidden:i,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}},r&&(s=Ta(t),c=J.utilities.deepMerge(s,r),Oa(t,{renderInactiveSegmentations:c.renderInactiveSegmentations||!0,representations:ri({},c.representations)})),qt(t,l),e.abrupt("return",a);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ii(){return(ii=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c,d,u;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.colorLUTIndex,n.active,o=n.segmentationId,a=n.segmentationRepresentationUID,n.segmentsHidden,i=Pt(o),l=i.representationData[gt.Surface],(s=l.geometryId)||console.warn("No Surfaces found for segmentationId ".concat(o,". Skipping render.")),c=J.cache.getGeometry(s)){e.next=8;break}throw new Error("No Surfaces found for geometryId ".concat(s));case 8:if(c.type===J.Enums.GeometryType.SURFACE){e.next=10;break}throw new Error("Geometry type ".concat(c.type," not supported for rendering."));case 10:if(c.data){e.next=13;break}return console.warn("No Surfaces found for geometryId ".concat(s,". Skipping render.")),e.abrupt("return");case 13:d=c.data,u="".concat(a,"_").concat(d.id,"}"),li(t,d,u),t.resetCamera(),t.render();case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function li(e,t,n){var r=n;if(e.getActor(r))throw new Error("Not implemented yet. (Update surface)");ti(e.element,t,r)}var si={render:function(e,t,n){return ii.apply(this,arguments)},addSegmentationRepresentation:function(e,t,n){return ai.apply(this,arguments)},removeSegmentationRepresentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){var n=fa(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));var r,o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return oi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?oi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n.viewportsInfo);try{for(o.s();!(r=o.n()).done;){var a=r.value,i=a.viewportId,l=a.renderingEngineId,s=(0,J.getEnabledElementByIds)(i,l);Wa(s.viewport.element,t)}}catch(e){o.e(e)}finally{o.f()}})(e,t),Zt(e,t),n&&fa(e).getViewportsInfo().forEach((function(e){var t=e.viewportId,n=e.renderingEngineId;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}},ci=y(785),di=y.n(ci),ui=y(127),vi=y.n(ui),fi=y(348),gi=y.n(fi);function hi(e,t,n){var r,o,a=null===(r=e.segmentSpecificConfig)||void 0===r?void 0:r[t];return a||(a=null===(o=e.segmentSpecificConfig)||void 0===o?void 0:o[n]),a?a.CONTOUR:null}var pi=new Map;function mi(e){return pi.get(e)}function wi(e,t){pi.set(e,t)}function Ei(e,t,n,r,o){var a=n.segmentationRepresentationUID,i=n.segmentsHidden,l=vi().newInstance(),s=new Map,c=new Map;t.forEach((function(e){var t=J.cache.getGeometry(e);if(t){var r=t.data.getSegmentIndex();!function(e){if(!e)throw new Error("No contours found for geometryId ".concat(e.id));var t=e.id;if(e.type!==J.Enums.GeometryType.CONTOUR)throw new Error("Geometry type ".concat(e.type," not supported for rendering."));e.data||console.warn("No contours found for geometryId ".concat(t,". Skipping render."))}(t);for(var o=hi(n,e,r),a=t.data,d=function(e){var t=[],n=gi().newInstance(),r=Ja().newInstance(),o=0;e.getContours().forEach((function(e){var n=e.getPoints(),a=e.getFlatPointsArray(),i=e.getType(),l=n.map((function(e,t){return t+o}));i===J.Enums.ContourType.CLOSED_PLANAR&&l.push(l[0]);var s=Float32Array.from(a);t.push.apply(t,Lr(s)),r.insertNextCell(Lr(l)),o+=n.length})),n.setData(t,3);var a=Xa().newInstance();return a.setPoints(n),a.setLines(r),a}(a),u=a.getColor(),v=d.getPoints().getNumberOfPoints(),f=di().newInstance({size:4*v,numberOfComponents:4,dataType:"Uint8Array"}),g=0;g<v;++g)f.setTuple(g,[].concat(Lr(u),[255]));d.getPointData().setScalars(f),o&&c.set(r,o),s.set(r,[].concat(Lr(u),[i.has(r)?0:255])),0===r?l.setInputData(d):l.addInputData(d)}else console.warn("No geometry found for geometryId ".concat(e,". Skipping render."))}));var d=l.getOutputData(),u=r.representations.CONTOUR.outlineWidthActive,v=Ha().newInstance();v.setInputData(d);var f=qa().newInstance();f.setMapper(v),f.getProperty().setLineWidth(u),wi(a,Object.assign({},mi(a),{segmentsHidden:new Set(i),segmentSpecificMap:c,outlineWidthActive:u})),f.setForceOpaque(!0),e.addActor({uid:o,actor:f}),e.resetCamera(),e.render()}function yi(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ii(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ii(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function Ii(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function bi(e,t,n,r,o){var a=n.segmentationRepresentationUID,i=n.segmentsHidden,l=r.representations.CONTOUR,s=mi(a),c=e.getActor(o);if(c){var d=c.actor,u=l.outlineWidthActive;(null==s?void 0:s.outlineWidthActive)!==u&&(d.getProperty().setLineWidth(u),wi(a,Object.assign({},s,{outlineWidthActive:u})));var v,f=d.getMapper(),g=f.getLookupTable(),h=[],p=[],m=yi(i);try{for(m.s();!(v=m.n()).done;){var w=v.value;s.segmentsHidden.has(w)||h.push(w)}}catch(e){m.e(e)}finally{m.f()}var E,y=yi(s.segmentsHidden);try{for(y.s();!(E=y.n()).done;){var I=E.value;i.has(I)||p.push(I)}}catch(e){y.e(e)}finally{y.f()}var b=Array.from(s.segmentsHidden).filter((function(e){return!p.includes(e)})).concat(h),C=t.reduce((function(e,t){var r=J.cache.getGeometry(t).data,o=r.getSegmentIndex(),a=hi(n,t,o);return e.contourSets.push(r),e.segmentSpecificConfigs[o]=null!=a?a:{},e}),{contourSets:[],segmentSpecificConfigs:{}}),_=C.contourSets,T=C.segmentSpecificConfigs,O=[].concat(Lr(b),p),D=Object.values(T).some((function(e){return Object.keys(e).length>0})),S=!1;if(O.length||D){var k=f.getInputData(),M=k.getPointData().getScalars().getData(),x=0;_.forEach((function(e){var t,n=e.getSegmentIndex(),r=e.getTotalNumberOfPoints();if(O.includes(n)||null!==(t=T[n])&&void 0!==t&&t.fillAlpha){var o=e.getColor(),a=b.includes(n)?0:255,i=T[n];void 0!==i.fillAlpha&&(a=255*i.fillAlpha);for(var l=0;l<r;++l)M[x+4*l]=o[0],M[x+4*l+1]=o[1],M[x+4*l+2]=o[2],M[x+4*l+3]=a;S=!0}x+=4*r})),S&&k.modified(),wi(a,Object.assign({},s,{segmentsHidden:new Set(i)})),f.setLookupTable(g)}e.render()}else console.warn("No contour actor found for actorUID ".concat(o,". Skipping render."))}function Ci(e,t,n,r){var o=n.segmentationRepresentationUID,a="CONTOUR_".concat(o);(e.getActor(a)?bi:Ei)(e,t,n,r,a)}var _i=function(e,t){var n=(0,J.getEnabledElement)(e).viewport,r=n.getActors().map((function(e){var n=e.uid;return n.includes(t)?n:void 0})).filter(Boolean);n.removeActors(r)};function Ti(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Oi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ti(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ti(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Di(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Si(){return(Si=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.segmentationId,a=J.utilities.uuidv4(),i=new Set,l={segmentationId:o,segmentationRepresentationUID:a,type:gt.Contour,segmentsHidden:i,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}},r&&(s=Ta(t),c=J.utilities.deepMerge(s,r),Oa(t,{renderInactiveSegmentations:c.renderInactiveSegmentations||!0,representations:Oi({},c.representations)})),qt(t,l),e.abrupt("return",a);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ki(){return(ki=Va(Ba().mark((function e(t,n,r){var o,a,i,l;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.segmentationId,a=Pt(o),i=a.representationData[gt.Contour],l=i.geometryIds,!(t instanceof J.StackViewport)){e.next=6;break}return e.abrupt("return");case 6:null!=l&&l.length||console.warn("No contours found for segmentationId ".concat(o,". Skipping render.")),Ci(t,l,n,r);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Mi={render:function(e,t,n){return ki.apply(this,arguments)},addSegmentationRepresentation:function(e,t,n){return Si.apply(this,arguments)},removeSegmentationRepresentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){var n=fa(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));var r,o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Di(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Di(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n.viewportsInfo);try{for(o.s();!(r=o.n()).done;){var a=r.value,i=a.viewportId,l=a.renderingEngineId,s=(0,J.getEnabledElementByIds)(i,l);_i(s.viewport.element,t)}}catch(e){o.e(e)}finally{o.f()}})(e,t),Zt(e,t),function(e){pi.delete(e)}(t),n&&fa(e).getViewportsInfo().forEach((function(e){var t=e.viewportId,n=e.renderingEngineId;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}},xi=y(441),Ri=y.n(xi),Pi=y(795),Ai=y.n(Pi);function Ni(){return(Ni=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(0,J.getEnabledElement)(t),a=o.renderingEngine,i=o.viewport,l=i.id,s=[{volumeId:n,actorUID:r,visibility:!0,blendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}],e.next=9,(0,J.addVolumesToViewports)(a,s,[l],!1,!0);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Li=function(e,t,n){return Ni.apply(this,arguments)},Ui=function(e,t){var n=(0,J.getEnabledElement)(e).viewport;n instanceof J.StackViewport||n.removeVolumeActors([t])};function Vi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ji(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Bi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ji(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ji(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Wi=255,Fi=new Map;function Hi(){return(Hi=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c,d,u;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.segmentationId,a=J.utilities.uuidv4(),i=new Set,l=Ai().newInstance(),(s=Ri().newInstance()).addPoint(0,0),c={segmentationId:o,segmentationRepresentationUID:a,type:gt.Labelmap,segmentsHidden:i,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:l,ofun:s}},r&&(d=Ta(t),u=J.utilities.deepMerge(d,r),Oa(t,{renderInactiveSegmentations:u.renderInactiveSegmentations||!0,representations:Bi({},u.representations)})),qt(t,c),e.abrupt("return",a);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Gi(e,t){if(!t)return!0;var n=e.getDefaultActor();if(!n)return!1;var r=n.uid,o=J.cache.getVolume(r);if(o){var a=J.cache.getVolume(t);if(a&&o.metadata.FrameOfReferenceUID===a.metadata.FrameOfReferenceUID)return!0}return!1}function qi(){return(qi=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c,d,u,v,f,g,h,p,m,w,E;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.colorLUTIndex,a=n.active,i=n.segmentationId,l=n.segmentationRepresentationUID,s=n.segmentsHidden,c=n.config,d=Pt(i),u=d.representationData[gt.Labelmap],v=u.volumeId,J.cache.getVolume(v)){e.next=7;break}throw new Error("No Labelmap found for volumeId: ".concat(v));case 7:if(Gi(t,null==u?void 0:u.referencedVolumeId)){e.next=9;break}return e.abrupt("return");case 9:if(f=t.getActor(l)){e.next=16;break}return g=Pt(i),h=g.representationData[gt.Labelmap].volumeId,e.next=15,Xi(t,h,l);case 15:f=t.getActor(l);case 16:if(f){e.next=18;break}return e.abrupt("return");case 18:m=(p=c).cfun,w=p.ofun,E=r.renderInactiveSegmentations,zi(t.id,f,m,w,o,r.representations[gt.Labelmap],n,a,E,s);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function zi(e,t,n,r,o,a,i,l,s,c){for(var d=i.segmentSpecificConfig,u=i.segmentationRepresentationSpecificConfig[gt.Labelmap],v=$t(o),f=Math.min(256,v.length),g=t.actor,h=t.uid,p=Ki(a,u,l),m=p.outlineWidth,w=p.renderOutline,E=p.outlineOpacity,y=0;y<f;y++){var I,b=y,C=v[b],_=Ki(a,u,l,null===(I=d[b])||void 0===I?void 0:I[gt.Labelmap]),T=_.fillAlpha,O=_.outlineWidth,D=_.renderFill,S=Yi(e,h,b,{fillAlpha:T,renderFill:D,renderOutline:_.renderOutline,segmentColor:C,outlineWidth:O,segmentsHidden:c}),k=S.forceOpacityUpdate;if(S.forceColorUpdate&&n.addRGBPoint(b,C[0]/Wi,C[1]/Wi,C[2]/Wi),k)if(D){var M=c.has(b)?0:C[3]/255*T;r.removePoint(b),r.addPointLong(b,M,.5,1)}else r.addPointLong(b,.01,.5,1)}g.getProperty().setRGBTransferFunction(0,n),r.setClamping(!1),g.getProperty().setScalarOpacity(0,r),g.getProperty().setInterpolationTypeToNearest(),g.getProperty().setUseLabelOutline(w),g.getProperty().setLabelOutlineOpacity(E),g.getProperty().setLabelOutlineThickness(m);var x=l||s;g.setVisibility(x)}function Ki(e,t,n,r){var o=r||{},a=Bi(Bi(Bi({},e),t),o);return{fillAlpha:n?a.fillAlpha:a.fillAlphaInactive,outlineWidth:n?a.outlineWidthActive:a.outlineWidthInactive,renderFill:n?a.renderFill:a.renderFillInactive,renderOutline:a.renderOutline,outlineOpacity:n?a.outlineOpacity:a.outlineOpacityInactive}}function Yi(e,t,n,r){var o=r.fillAlpha,a=r.renderFill,i=r.renderOutline,l=r.segmentColor,s=r.outlineWidth,c=r.segmentsHidden,d="".concat(e,"-").concat(t,"-").concat(n),u=Fi.get(d);if(!u)return Fi.set(d,{fillAlpha:o,renderFill:a,renderOutline:i,outlineWidth:s,segmentColor:l.slice(),segmentsHidden:new Set(c)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};var v=u.fillAlpha,f=u.renderFill,g=u.renderOutline,h=u.outlineWidth,p=u.segmentColor,m=u.segmentsHidden,w=p[0]!==l[0]||p[1]!==l[1]||p[2]!==l[2],E=p[3]!==l[3]||v!==o||f!==a||g!==i||h!==s||m.has(n)!==c.has(n);return Fi.set(d,{fillAlpha:o,renderFill:a,renderOutline:i,outlineWidth:s,segmentColor:l.slice(),segmentsHidden:new Set(c)}),{forceOpacityUpdate:E,forceColorUpdate:w}}function Xi(e,t,n){return Zi.apply(this,arguments)}function Zi(){return(Zi=Va(Ba().mark((function e(t,n,r){return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Li(t.element,n,r);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Ji={render:function(e,t,n){return qi.apply(this,arguments)},addSegmentationRepresentation:function(e,t,n){return Hi.apply(this,arguments)},removeSegmentationRepresentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){var n=fa(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));var r,o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Vi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Vi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n.viewportsInfo);try{for(o.s();!(r=o.n()).done;){var a=r.value,i=a.viewportId,l=a.renderingEngineId,s=(0,J.getEnabledElementByIds)(i,l);Ui(s.viewport.element,t)}}catch(e){o.e(e)}finally{o.f()}})(e,t),Zt(e,t),n&&fa(e).getViewportsInfo().forEach((function(e){var t=e.viewportId,n=e.renderingEngineId;(0,J.getEnabledElementByIds)(t,n).viewport.render()}))}};function $i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Qi=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"renderSegmentation",(function(t){var n=fa(t);if(n){var r=Lt(t);if(r&&0!==r.length){var o=n.viewportsInfo.map((function(e){var t=e.renderingEngineId,n=e.viewportId,r=(0,J.getEnabledElementByIds)(n,t);if(r)return r.viewport})),a=r.map((function(n){var r,a,i=e._getMergedRepresentationsConfig(t),l=[],s=(ae(r={},gt.Labelmap,Ji),ae(r,gt.Contour,Mi),ae(r,gt.Surface,si),r)[n.type],c=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return $i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?$i(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(c.s();!(a=c.n()).done;){var d=a.value,u=s.render(d,n,i);l.push(u)}}catch(e){c.e(e)}finally{c.f()}return l}));Promise.allSettled(a).then((function(){o.forEach((function(e){e.render()}))}))}}})),e}return re(o,[{key:"onSetToolEnabled",value:function(){var e=this.toolGroupId,t=Lt(e);t&&0!==t.length&&t.forEach((function(t){xa(e,t.segmentationRepresentationUID,!0)}))}},{key:"onSetToolDisabled",value:function(){var e=this.toolGroupId,t=Lt(e);t&&0!==t.length&&t.forEach((function(t){xa(e,t.segmentationRepresentationUID,!1)}))}},{key:"_getMergedRepresentationsConfig",value:function(e){var t=Ta(e),n=Ia();return J.utilities.deepMerge(n,t)}}]),o}(La);ae(Qi,"toolName",void 0),Qi.toolName="SegmentationDisplay";var el=Qi;function tl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var nl=function(){function e(){var t=this;oe(this,e),ae(this,"_needsRender",new Set),ae(this,"_animationFrameSet",!1),ae(this,"_animationFrameHandle",null),ae(this,"hasBeenDestroyed",void 0),ae(this,"_renderFlaggedToolGroups",(function(){t._throwIfDestroyed();for(var e=0,n=Array.from(t._needsRender.values());e<n.length;e++){var r=n[e];if(t._triggerRender(r),t._needsRender.delete(r),0===t._needsRender.size)return t._animationFrameSet=!1,void(t._animationFrameHandle=null)}}))}return re(e,[{key:"removeToolGroup",value:function(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}},{key:"renderToolGroupSegmentations",value:function(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}},{key:"_throwIfDestroyed",value:function(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}},{key:"_setToolGroupSegmentationToBeRenderedNextFrame",value:function(e){var t=this;e.forEach((function(e){t._needsRender.add(e)})),this._render()}},{key:"_render",value:function(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}},{key:"_triggerRender",value:function(e){var t=fa(e);if(t){var n=t.viewportsInfo,r=[];n.forEach((function(e){var t=e.viewportId,n=e.renderingEngineId,o=(0,J.getRenderingEngine)(n);o?r.push(o.getViewport(t)):console.warn("rendering Engine has been destroyed")}));var o=t.getToolInstance(el.toolName);o?(r.forEach((function(e){e.element.addEventListener(J.Enums.Events.IMAGE_RENDERED,a)})),o.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}else console.warn("No tool group found with toolGroupId: ".concat(e));function a(e){var t=e.detail,n=t.element,r=t.viewportId,o=t.renderingEngineId;n.removeEventListener(J.Enums.Events.IMAGE_RENDERED,a);var i=Fr(r,o);if(i){var l={toolGroupId:i.id,viewportId:r};(0,J.triggerEvent)(J.eventTarget,Q.SEGMENTATION_RENDERED,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tl(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},l))}else console.warn("toolGroup has been destroyed")}}},{key:"_reset",value:function(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}}]),e}(),rl=new nl;function ol(e){rl.renderToolGroupSegmentations(e)}var al=ol,il=function(e){var t=e.detail,n=t.segmentationId,r=t.modifiedSlicesToUse,o=Pt(n),a=o.representationData,i=o.type;if(i!==gt.Labelmap)throw new Error("onSegmentationDataModified: representationType ".concat(i," not supported yet"));var l=J.cache.getVolume(a[i].volumeId);if(l){var s,c=l.imageData,d=l.vtkOpenGLTexture;if(r&&Array.isArray(r))s=r;else{var u=c.getDimensions()[2];s=Lr(Array(u).keys())}s.forEach((function(e){d.setUpdatedFrame(e)})),c.modified(),Vt(n).forEach((function(e){al(e)}))}else console.warn("segmentation not found in cache")},ll=function(e){var t=e.detail.toolGroupId;al(t)},sl=function(e){var t=e.detail,n=t.toolGroupId;t.segmentationRepresentationUID,al(n)},cl=function(e,t,n){var r=Lt(e);if(r&&0!==r.length){var o=r.map((function(e){return e.segmentationRepresentationUID})),a=t;if(a){var i=t.filter((function(e){return!o.includes(e)}));if(i.length>0)throw new Error("The following segmentationRepresentationUIDs are not part of the toolGroup: ".concat(JSON.stringify(i)))}else a=o;a.forEach((function(t){!function(e,t,n){var r=Yt(e,t).type;if(r===gt.Labelmap)Ji.removeSegmentationRepresentation(e,t,n);else{if(r!==gt.Contour)throw new Error("The representation ".concat(r," is not supported yet"));Mi.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))}},dl=function(e){var t=Ke.toolGroups.findIndex((function(t){return t.id===e}));t>-1&&(rl.removeToolGroup(e),cl(e),Ke.toolGroups.splice(t,1))};function ul(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var vl=function(){var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ul(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ul(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(Lr(Ke.toolGroups));try{for(t.s();!(e=t.n()).done;){var n=e.value;dl(n.id)}}catch(e){t.e(e)}finally{t.f()}Ke.toolGroups=[]},fl=!1;function gl(){fl||(function(){pl();var e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.addEventListener(e,ia),J.eventTarget.addEventListener(t,sa)}(),ml(),J.eventTarget.addEventListener(Q.ANNOTATION_MODIFIED,da),J.eventTarget.addEventListener(Q.ANNOTATION_SELECTION_CHANGE,ua),J.eventTarget.addEventListener(Q.ANNOTATION_SELECTION_CHANGE,ua),J.eventTarget.addEventListener(Q.SEGMENTATION_MODIFIED,va),J.eventTarget.addEventListener(Q.SEGMENTATION_DATA_MODIFIED,il),J.eventTarget.addEventListener(Q.SEGMENTATION_REPRESENTATION_MODIFIED,ll),J.eventTarget.addEventListener(Q.SEGMENTATION_REPRESENTATION_REMOVED,sl),fl=!0)}function hl(){pl(),ml(),vl(),qe={},Ke=le()(ze);var e=Qe(),t=Rt();e.restoreAnnotations({}),t.resetState(),fl=!1}function pl(){var e=J.Enums.Events.ELEMENT_ENABLED,t=J.Enums.Events.ELEMENT_DISABLED;J.eventTarget.removeEventListener(e,ia),J.eventTarget.removeEventListener(t,sa)}function ml(){J.eventTarget.removeEventListener(Q.ANNOTATION_MODIFIED,da),J.eventTarget.removeEventListener(Q.ANNOTATION_SELECTION_CHANGE,ua),J.eventTarget.removeEventListener(Q.ANNOTATION_SELECTION_CHANGE,ua),J.eventTarget.removeEventListener(Q.SEGMENTATION_MODIFIED,va),J.eventTarget.removeEventListener(Q.SEGMENTATION_DATA_MODIFIED,il),J.eventTarget.removeEventListener(Q.SEGMENTATION_REPRESENTATION_MODIFIED,ll),J.eventTarget.removeEventListener(Q.SEGMENTATION_REPRESENTATION_REMOVED,sl)}function wl(e){var t=e.toolName,n=void 0!==Ke.tools[t];if(!t)throw new Error("No Tool Found for the ToolClass ".concat(e.name));if(n)throw new Error("".concat(t," has already been added globally"));Ke.tools[t]={toolClass:e}}function El(e){var t=e.toolName;if(!t)throw new Error("No tool found for: ".concat(e.name));if(void 0===!Ke.tools[t])throw new Error("".concat(t," cannot be removed because it has not been added"));delete Ke.tools[t]}function yl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Il(e){var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return yl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?yl(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(po(e,Hr(e,[Xe.Active,Xe.Passive])));try{for(n.s();!(t=n.n()).done;){var r=t.value.tool.cancel(e);if(r)return r}}catch(e){n.e(e)}finally{n.f()}}var bl=function(){function e(t,n,r,o){var a=this;oe(this,e),ae(this,"_enabled",void 0),ae(this,"_eventName",void 0),ae(this,"_eventHandler",void 0),ae(this,"_ignoreFiredEvents",void 0),ae(this,"_sourceViewports",void 0),ae(this,"_targetViewports",void 0),ae(this,"_viewportOptions",{}),ae(this,"_options",void 0),ae(this,"id",void 0),ae(this,"_onEvent",(function(e){if(!0!==a._ignoreFiredEvents&&a._targetViewports.length){var t=(0,J.getEnabledElement)(e.currentTarget);if(t){var n=t.renderingEngineId,r=t.viewportId;a._sourceViewports.find((function(e){return e.viewportId===r}))&&a.fireEvent({renderingEngineId:n,viewportId:r},e)}}})),this._enabled=!0,this._eventName=n,this._eventHandler=r,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this.id=t}return re(e,[{key:"isDisabled",value:function(){return!this._enabled||!this._hasSourceElements()}},{key:"setOptions",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._viewportOptions[e]=t}},{key:"getOptions",value:function(e){return this._viewportOptions[e]}},{key:"add",value:function(e){this.addTarget(e),this.addSource(e)}},{key:"addSource",value:function(e){if(!_l(this._sourceViewports,e)){var t=e.renderingEngineId,n=e.viewportId;(0,J.getRenderingEngine)(t).getViewport(n).element.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}}},{key:"addTarget",value:function(e){_l(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}},{key:"getSourceViewports",value:function(){return this._sourceViewports}},{key:"getTargetViewports",value:function(){return this._targetViewports}},{key:"destroy",value:function(){var e=this;this._sourceViewports.forEach((function(t){return e.removeSource(t)})),this._targetViewports.forEach((function(t){return e.removeTarget(t)}))}},{key:"remove",value:function(e){this.removeTarget(e),this.removeSource(e)}},{key:"removeSource",value:function(e){var t=Cl(this._sourceViewports,e);if(-1!==t){var n=function(e){var t=(0,J.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error("No RenderingEngine for Id: ".concat(e.renderingEngineId));return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}}},{key:"removeTarget",value:function(e){var t=Cl(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}},{key:"hasSourceViewport",value:function(e,t){return _l(this._sourceViewports,{renderingEngineId:e,viewportId:t})}},{key:"hasTargetViewport",value:function(e,t){return _l(this._targetViewports,{renderingEngineId:e,viewportId:t})}},{key:"fireEvent",value:function(e,t){var n=this;if(!this.isDisabled()&&!this._ignoreFiredEvents){this._ignoreFiredEvents=!0;var r=[];try{for(var o=0;o<this._targetViewports.length;o++){var a=this._targetViewports[o];e.viewportId===a.viewportId||r.push(this._eventHandler(this,e,a,t,this._options))}}catch(e){console.warn("Synchronizer, for: ".concat(this._eventName),e)}finally{r.length?Promise.allSettled(r).then((function(){n._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}}},{key:"_hasSourceElements",value:function(){return 0!==this._sourceViewports.length}},{key:"_updateDisableHandlers",value:function(){var e=function(e,t){for(var n=[],r=e.concat(t),o=function(){var e=r[a];n.some((function(t){return e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId}))||n.push(e)},a=0;a<r.length;a++)o();return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=function(e){t(e.detail.element)};e.forEach((function(e){var t=(0,J.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(t){var r=t.element;r.removeEventListener(J.Enums.Events.ELEMENT_DISABLED,n),r.addEventListener(J.Enums.Events.ELEMENT_DISABLED,n)}}))}}]),e}();function Cl(e,t){return e.findIndex((function(e){return t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId}))}function _l(e,t){return e.some((function(e){return e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId}))}var Tl=bl,Ol=function(e,t,n,r){if(Ke.synchronizers.some((function(t){return t.id===e})))throw new Error("Synchronizer with id '".concat(e,"' already exists."));var o=new Tl(e,t,n,r);return Ke.synchronizers.push(o),o},Dl=function(){for(;Ke.synchronizers.length>0;)Ke.synchronizers.pop().destroy()},Sl=function(e){return Ke.synchronizers.find((function(t){return t.id===e}))},kl=function(){return Ke.synchronizers},Ml=function(e){var t=Ke.synchronizers.findIndex((function(t){return t.id===e}));t>-1&&(Ke.synchronizers[t].destroy(),Ke.synchronizers.splice(t,1))},xl=y(485),Rl=y.n(xl),Pl=Symbol("DefinedCursors"),Al=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]),Nl=function(){function e(t,n){oe(this,e),ae(this,"name",void 0),ae(this,"fallback",void 0),this.name=t+"",this.fallback=n}return re(e,[{key:"getName",value:function(){return this.name+""}},{key:"addFallbackStyleProperty",value:function(t){var n=this.fallback;return n instanceof e?"".concat(t,", ").concat(n.getStyleProperty()):t+""}},{key:"getStyleProperty",value:function(){return this.addFallbackStyleProperty(this.name)+""}}],[{key:"getDefinedCursor",value:function(t){var n=Ll(e,Pl),r=n.get(t);return r instanceof e?r:Al.has(t)?(r=new e(t),n.set(t,r),r):void 0}},{key:"setDefinedCursor",value:function(t,n){return n instanceof e&&(Ll(e,Pl).set(t,n),!0)}}]),e}();function Ll(e,t){var n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}var Ul=Al.values();function Vl(){return Vl="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=wa(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},Vl.apply(this,arguments)}var jl=function(e){return e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e}(jl||{}),Bl=jl;var Wl=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(e,t,n,a,i){var l;return oe(this,o),ae(ga(l=r.call(this,a||o.getUniqueInstanceName("image-cursor"),i)),"url",void 0),ae(ga(l),"x",void 0),ae(ga(l),"y",void 0),l.url=e,l.x=Number(t)||0,l.y=Number(n)||0,l}return re(o,[{key:"getStyleProperty",value:function(){var e=this.url,t=this.x,n=this.y,r="url('".concat(e,"')");return t>=0&&n>=0&&(t>0||n>0)&&(r+=" ".concat(t," ").concat(n)),this.addFallbackStyleProperty(r)}}],[{key:"getUniqueInstanceName",value:function(e){return"".concat(e,"-").concat(J.utilities.getRuntimeId(o))}}]),o}(Nl),Fl={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},Hl={x:127,y:60},Gl='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',ql='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',zl='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',Kl='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',Yl='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Xl={Angle:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:Zl(Fl,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:Zl(Fl,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:Zl(Fl,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:Zl(Fl,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:Zl(Fl,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:Zl(Fl,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:Zl(Fl,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:Zl(Fl,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:Zl(Fl,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:Zl(Fl,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:Zl(Fl,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:Zl(Fl,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:Zl(Fl,{iconContent:"".concat(zl," ").concat(Gl),viewBox:Hl}),SegmentationFreeHandFillInside:Zl(Fl,{iconContent:"".concat(zl," ").concat(ql),viewBox:Hl}),SegmentationFreeHandEraseOutside:Zl(Fl,{iconContent:"".concat(zl," ").concat(Gl),viewBox:Hl}),SegmentationFreeHandFillOutside:Zl(Fl,{iconContent:"".concat(zl," ").concat(ql),viewBox:Hl}),SegmentationRectangleEraseInside:Zl(Fl,{iconContent:"".concat(Kl," ").concat(Gl),viewBox:Hl}),RectangleScissor:Zl(Fl,{iconContent:"".concat(Kl," ").concat(ql),viewBox:Hl}),"RectangleScissor.FILL_INSIDE":Zl(Fl,{iconContent:"".concat(Kl," ").concat(ql),viewBox:Hl}),"RectangleScissor.FILL_OUTSIDE":Zl(Fl,{iconContent:"".concat(Kl," ").concat(ql),viewBox:Hl}),"RectangleScissor.ERASE_OUTSIDE":Zl(Fl,{iconContent:"".concat(Kl," ").concat(Gl),viewBox:Hl}),"RectangleScissor.ERASE_INSIDE":Zl(Fl,{iconContent:"".concat(Kl," ").concat(Gl),viewBox:Hl}),CircleScissor:Zl(Fl,{iconContent:"".concat(Yl," ").concat(ql),viewBox:Hl}),"CircleScissor.FILL_INSIDE":Zl(Fl,{iconContent:"".concat(Yl," ").concat(ql),viewBox:Hl}),"CircleScissor.ERASE_OUTSIDE":Zl(Fl,{iconContent:"".concat(Yl," ").concat(Gl),viewBox:Hl}),"CircleScissor.FILL_OUTSIDE":Zl(Fl,{iconContent:"".concat(Yl," ").concat(ql),viewBox:Hl})};function Zl(e,t){return Object.assign(Object.create(e),t)}function Jl(e,t,n){Xl[e]=Zl(Fl,{iconContent:t,viewBox:n})}var $l=Object.keys(Xl);function Ql(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function es(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ql(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ql(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ts=new(function(){function e(){oe(this,e),ae(this,"config",void 0),this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}return re(e,[{key:"getAnnotationToolStyles",value:function(e){return this.config.annotations&&this.config.annotations[e]}},{key:"getViewportToolStyles",value:function(e){return this.config.viewports&&this.config.viewports[e]}},{key:"getToolGroupToolStyles",value:function(e){return this.config.toolGroups&&this.config.toolGroups[e]}},{key:"getDefaultToolStyles",value:function(){return this.config.default}},{key:"setAnnotationStyles",value:function(e,t){var n=this.config.annotations;n||(this.config=es(es({},this.config),{},{annotations:{}}),n=this.config.annotations),n[e]=t}},{key:"setViewportToolStyles",value:function(e,t){var n=this.config.viewports;n||(this.config=es(es({},this.config),{},{viewports:{}}),n=this.config.viewports),n[e]=t}},{key:"setToolGroupToolStyles",value:function(e,t){var n=this.config.toolGroups;n||(this.config=es(es({},this.config),{},{toolGroups:{}}),n=this.config.toolGroups),n[e]=t}},{key:"setDefaultToolStyles",value:function(e){this.config.default=e}},{key:"getStyleProperty",value:function(e,t){var n=t.annotationUID,r=t.viewportId,o=t.toolGroupId,a=t.toolName;return this._getToolStyle(e,n,r,o,a)}},{key:"_getToolStyle",value:function(e,t,n,r,o){if(t){var a=this.getAnnotationToolStyles(t);if(a&&a[e])return a[e]}if(n){var i=this.getViewportToolStyles(n);if(i){if(i[o]&&i[o][e])return i[o][e];if(i.global&&i.global[e])return i.global[e]}}if(r){var l=this.getToolGroupToolStyles(r);if(l){if(l[o]&&l[o][e])return l[o][e];if(l.global&&l.global[e])return l.global[e]}}var s=this.getDefaultToolStyles();return s[o]&&s[o][e]?s[o][e]:s.global&&s.global[e]?s.global[e]:void 0}},{key:"_initializeConfig",value:function(e){var t={};for(var n in e)t[n]=e[n];this.config={default:{global:t}}}}]),e}());function ns(e,t,n,r){for(var o=function(e,t,n){var r=["".concat(e)];return t&&r.push("".concat(r[0]).concat(t)),n&&r.push("".concat(r[r.length-1]).concat(n)),r}(e,n,r),a=o.length-1;a>=0;--a){var i=ts.getStyleProperty(o[a],t);if(void 0!==i)return i}}var rs=Bl.Highlighted,os=Xe.Active,as=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(e,t,n,a,i){return oe(this,o),r.call(this,e,t,n,a,i)}return re(o,null,[{key:"getDefinedCursor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;n||(n=ns("color",{},rs,os));var r=function(e,t,n){return"".concat(t?"pointer":"cursor",":").concat(e,"/").concat(n)}(e,t,n),a=Vl(wa(o),"getDefinedCursor",this).call(this,r);if(!a){var i=function(e){return Xl[e]}(e);i&&(a=ls(i,r,t,n,Vl(wa(o),"getDefinedCursor",this).call(this,"default")),Vl(wa(o),"setDefinedCursor",this).call(this,r,a))}return a}}]),o}(Wl);function is(e,t){var n=Object(t),r=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,(function(e,t){return r(t)?n[t]+"":""}))}function ls(e,t,n,r,o){var a=e.mousePoint,i=a.x,l=a.y;return new as(function(e,t,n){return URL.createObjectURL(function(e,t,n){var r=(t?cs:ss)(e,n);return new Blob([r],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:r}),i,l,t,o)}function ss(e,t){var n=e.iconContent,r=e.iconSize,o=e.viewBox;return is('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(r,'" height="').concat(r,'" viewBox="0 0\n      ').concat(o.x," ").concat(o.y,'">\n      ').concat(n,"\n    </svg>"),t)}function cs(e,t){var n=e.iconContent,r=e.iconSize,o=e.viewBox,a=e.mousePointerGroupString,i=r/Math.max(o.x,o.y,1),l=16+r;return is('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(l,'" height="').concat(l,'" viewBox="0 0 ').concat(l," ").concat(l,'">\n      <g>').concat(a,'</g>\n      <g transform="translate(16, 16) scale(').concat(i,')">').concat(n,"</g>\n    </svg>"),t)}var ds=Symbol("ElementCursorsMap");function us(e,t){hs(e)[0]=t,vs(e,t)}function vs(e,t){var n=hs(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof Nl?t:Nl.getDefinedCursor("auto")).getStyleProperty()}function fs(e){vs(e,hs(e)[1])}function gs(e){vs(e,Nl.getDefinedCursor("none"))}function hs(e){var t=hs[ds];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(hs,ds,{value:t}));var n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}var ps=Xe.Active,ms=Xe.Passive,ws=Xe.Enabled,Es=Xe.Disabled,ys=function(){function e(t){oe(this,e),ae(this,"id",void 0),ae(this,"viewportsInfo",[]),ae(this,"toolOptions",{}),ae(this,"_toolInstances",{}),this.id=t}return re(e,[{key:"getViewportIds",value:function(){return this.viewportsInfo.map((function(e){return e.viewportId}))}},{key:"getViewportsInfo",value:function(){return this.viewportsInfo.slice()}},{key:"getToolInstance",value:function(e){var t=this._toolInstances[e];if(t)return t;console.warn("'".concat(e,"' is not registered with this toolGroup (").concat(this.id,")."))}},{key:"addTool",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Ke.tools[e],r=void 0!==e&&""!==e,o=this.toolOptions[e];if(r)if(n)if(o)console.warn("'".concat(e,"' is already registered for ToolGroup ").concat(this.id,"."));else{var a=new(0,n.toolClass)({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=a}else console.warn("'".concat(e,"' is not registered with the library. You need to use cornerstoneTools.addTool to register it."));else console.warn("Tool with configuration did not produce a toolName: ",t)}},{key:"addToolInstance",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=null===(n=Ke.tools[e])||void 0===n?void 0:n.toolClass;if(!o){var a=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){return oe(this,o),r.apply(this,arguments)}return re(o)}(Ke.tools[t].toolClass);a.toolName=e,o=a,Ke.tools[e]={toolClass:a}}this.addTool(o.toolName,r)}},{key:"addViewport",value:function(e,t){var n=(0,J.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");var r=t||n[0].id;this.viewportsInfo.some((function(t){return t.viewportId===e}))||this.viewportsInfo.push({viewportId:e,renderingEngineId:r});var o=this.getActivePrimaryMouseButtonTool();J.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(o)}},{key:"removeViewports",value:function(e,t){var n=[];if(this.viewportsInfo.forEach((function(r,o){var a=!1;r.renderingEngineId===e&&(a=!0,t&&r.viewportId!==t&&(a=!1)),a&&n.push(o)})),n.length)for(var r=n.length-1;r>=0;r--)this.viewportsInfo.splice(n[r],1)}},{key:"setActiveStrategy",value:function(e,t){var n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn("Tool ".concat(e," not added to toolGroup, can't set tool configuration."))}},{key:"setToolMode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e?t!==Xe.Active?t!==Xe.Passive?t!==Xe.Enabled?t!==Xe.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n):console.warn("setToolMode: toolName must be defined")}},{key:"setToolActive",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._toolInstances[e];if(void 0!==n)if(n){var r=this.toolOptions[e]?this.toolOptions[e].bindings:[],o=t.bindings?t.bindings:[],a={bindings:[].concat(Lr(r),Lr(o)).reduce((function(e,t){var n=void 0!==t.numTouchPoints,r=void 0!==t.mouseButton;return e.some((function(e){return r=t,(n=e).mouseButton===r.mouseButton&&n.modifierKey===r.modifierKey;var n,r}))||!n&&!r||e.push(t),e}),[]),mode:ps};this.toolOptions[e]=a,this._toolInstances[e].mode=ps;var i=J.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&i)this.setViewportsCursorByToolName(e);else if(!this.getActivePrimaryMouseButtonTool()&&i){var l=Nl.getDefinedCursor("default");this._setCursorForViewports(l)}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();var s={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,J.triggerEvent)(J.eventTarget,Q.TOOL_ACTIVATED,s),this._triggerToolModeChangedEvent(e,ps,t)}else console.warn("'".concat(e,"' instance ").concat(n," is not registered with this toolGroup, can't set tool mode."));else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolPassive",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n=this.getToolOptions(e),r=Object.assign({bindings:n?n.bindings:[]},n,{mode:ms}),o=this.getDefaultMousePrimary();r.bindings=r.bindings.filter((function(e){return e.mouseButton!==o||e.modifierKey}));var a=ms;0!==r.bindings.length&&(a=ps,r.mode=a),this.toolOptions[e]=r,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,ms)}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolEnabled",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n={bindings:[],mode:ws};this.toolOptions[e]=n,t.mode=ws,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,ws)}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolDisabled",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n={bindings:[],mode:Es};this.toolOptions[e]=n,t.mode=Es,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,Es)}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"getToolOptions",value:function(e){var t=this.toolOptions[e];if(void 0!==t)return t}},{key:"getActivePrimaryMouseButtonTool",value:function(){var e=this;return Object.keys(this.toolOptions).find((function(t){var n=e.toolOptions[t];return n.mode===ps&&e._hasMousePrimaryButtonBinding(n)}))}},{key:"setViewportsCursorByToolName",value:function(e,t){var n=this._getCursor(e,t);this._setCursorForViewports(n)}},{key:"_getCursor",value:function(e,t){var n,r;return t&&(n="".concat(e,".").concat(t),r=as.getDefinedCursor(n,!0))?r:(n="".concat(e),(r=as.getDefinedCursor(n,!0))?r:(n=e,(r=as.getDefinedCursor(n,!0))||Nl.getDefinedCursor("default")))}},{key:"_setCursorForViewports",value:function(e){this.viewportsInfo.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,o=(0,J.getEnabledElementByIds)(r,n);o&&us(o.viewport.element,e)}))}},{key:"setToolConfiguration",value:function(e,t,n){return void 0===this._toolInstances[e]?(console.warn("Tool ".concat(e," not present, can't set tool configuration.")),!1):(r=n?t:Object.assign(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=r,this._renderViewports(),!0);var r}},{key:"getDefaultMousePrimary",value:function(){return Eo.Primary}},{key:"getToolConfiguration",value:function(e,t){if(void 0!==this._toolInstances[e]){var n=Rl()(this._toolInstances[e].configuration,t);return le()(n)}console.warn("Tool ".concat(e," not present, can't set tool configuration."))}},{key:"clone",value:function(e){var t,n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=fa(e);return o?(console.warn("ToolGroup ".concat(e," already exists")),o):(o=Is(e),r=null!==(t=r)&&void 0!==t?t:function(){return!0},Object.keys(this._toolInstances).filter(r).forEach((function(e){var t,r=n._toolInstances[e],a=n.toolOptions[e],i=r.mode;o.addTool(e),o.setToolMode(e,i,{bindings:null!==(t=a.bindings)&&void 0!==t?t:[]})})),o)}},{key:"_hasMousePrimaryButtonBinding",value:function(e){var t,n=this.getDefaultMousePrimary();return null==e||null===(t=e.bindings)||void 0===t?void 0:t.some((function(e){return e.mouseButton===n&&void 0===e.modifierKey}))}},{key:"_renderViewports",value:function(){this.viewportsInfo.forEach((function(e){var t=e.renderingEngineId,n=e.viewportId;(0,J.getRenderingEngine)(t).renderViewport(n)}))}},{key:"_triggerToolModeChangedEvent",value:function(e,t,n){var r={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,J.triggerEvent)(J.eventTarget,Q.TOOL_MODE_CHANGED,r)}}]),e}(),Is=function(e){if(!Ke.toolGroups.some((function(t){return t.id===e}))){var t=new ys(e);return Ke.toolGroups.push(t),t}console.warn("'".concat(e,"' already exists."))},bs=function(){return Ke.toolGroups};function Cs(e,t,n,r){var o=r.detail.camera,a=(0,J.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));var i=a.getViewport(n.viewportId);i.setCamera(o),i.render()}var _s=J.Enums.Events.CAMERA_MODIFIED;function Ts(e){return Ol(e,_s,Cs)}function Os(e,t,n,r,o){var a=r.detail,i=a.volumeId,l=a.range,s=a.invertStateChanged,c=a.invert,d=(0,J.getRenderingEngine)(n.renderingEngineId);if(!d)throw new Error("Rendering Engine does not exist: ".concat(n.renderingEngineId));var u=d.getViewport(n.viewportId),v={voiRange:l};if(null!=o&&o.syncInvertState&&s&&(v.invert=c),u instanceof J.BaseVolumeViewport)u.setProperties(v,i);else{if(!(u instanceof J.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(v)}u.render()}function Ds(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{syncInvertState:!0};return Ol(e,J.Enums.Events.VOI_MODIFIED,Os,t)}function Ss(e,t,n){var r=(0,J.getRenderingEngine)(n.renderingEngineId);if(!r)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));var o=e.getOptions(n.viewportId),a=r.getViewport(n.viewportId),i=r.getViewport(t.viewportId);if(!1!==(null==o?void 0:o.syncZoom)){var l=i.getZoom();a.setZoom(l)}if(!1!==(null==o?void 0:o.syncPan)){var s=i.getPan();a.setPan(s)}a.render()}var ks=J.Enums.Events.CAMERA_MODIFIED;function Ms(e){return Ol(e,ks,Ss)}var xs=y(976);var Rs=function(e,t,n){return Math.min(Math.max(t,e),n)};function Ps(e,t){if(!(0,J.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof J.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");var n=e.type,r=t.volumeId,o=t.delta;if(e instanceof J.StackViewport)e.scroll(o,t.debounceLoading,t.loop);else if(e instanceof J.VolumeViewport)!function(e,t,n){var r=J.utilities.getVolumeViewportScrollInfo(e,t),o=r.numScrollSteps,a=r.currentStepIndex,i=r.sliceRangeInfo;if(i){var l=i.sliceRange,s=i.spacingInNormalDirection,c=i.camera,d=c.focalPoint,u=c.viewPlaneNormal,v=c.position,f=J.utilities.snapFocalPointToSlice(d,v,l,u,s,n),g=f.newFocalPoint,h=f.newPosition;e.setCamera({focalPoint:g,position:h}),e.render();var p=a+n;if((p>o||p<0)&&e.getCurrentImageId()){var m={volumeId:t,viewport:e,delta:n,desiredStepIndex:p,currentStepIndex:a,numScrollSteps:o,currentImageId:e.getCurrentImageId()};J.utilities.triggerEvent(J.eventTarget,J.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,m)}}}(e,r,o);else{if(!(e instanceof J.VideoViewport))throw new Error("Not implemented for Viewport Type: ".concat(n));e.scroll(o)}}function As(){return As=Va(Ba().mark((function e(t){var n,r,o,a,i,l,s,c,d,u,v=arguments;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(n=v.length>1&&void 0!==v[1]?v[1]:{}).imageIndex,o=n.debounceLoading,a=n.volumeId,i=(0,J.getEnabledElement)(t)){e.next=5;break}throw new Error("Element has been disabled");case 5:l=i.viewport,s=Ns(l,o),c=s.imageIndex,d=s.numberOfSlices,u=Ls(d,r),Ps(l,{delta:u-c,debounceLoading:o,volumeId:a});case 10:case"end":return e.stop()}}),e)}))),As.apply(this,arguments)}function Ns(e,t){if(e instanceof J.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof J.VolumeViewport)return J.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}function Ls(e,t){return Rs(t,0,e-1)}var Us=function(e){return As.apply(this,arguments)},Vs=function(e,t){return J.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",[e,t])};function js(e,t,n){return Bs.apply(this,arguments)}function Bs(){return(Bs=Va(Ba().mark((function e(t,n,r){var o,a,i,l,s,c,d,u,v,f,g,h,p;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=(0,J.getRenderingEngine)(r.renderingEngineId)){e.next=3;break}throw new Error("No RenderingEngine for Id: ".concat(r.renderingEngineId));case 3:if(a=o.getViewport(n.viewportId),null==(i=t.getOptions(r.viewportId))||!i.disabled){e.next=7;break}return e.abrupt("return");case 7:if(l=o.getViewport(r.viewportId),s=a.getCurrentImageId(),c=J.metaData.get("imagePlaneModule",s),d=c.imagePositionPatient,u=l.getImageIds(),m=l,void 0,void 0,void 0,w=a.getCamera().viewPlaneNormal,E=m.getCamera().viewPlaneNormal,y=xs.vec3.dot(w,E),Math.abs(y)>.9){e.next=14;break}return e.abrupt("return");case 14:if(v=Vs(r.viewportId,n.viewportId)){e.next=21;break}if(f=a.getFrameOfReferenceUID(),g=l.getFrameOfReferenceUID(),f===g&&!1!==(null==i?void 0:i.useInitialPosition)?v=xs.mat4.identity(xs.mat4.create()):(J.utilities.calculateViewportsSpatialRegistration(a,l),v=Vs(r.viewportId,n.viewportId)),v){e.next=21;break}return e.abrupt("return");case 21:if(h=xs.vec3.transformMat4(xs.vec3.create(),d,v),-1===(p=Ws(h,u)).index||l.getCurrentImageIdIndex()===p.index){e.next=26;break}return e.next=26,Us(l.element,{imageIndex:p.index});case 26:case"end":return e.stop()}var m,w,E,y}),e)})))).apply(this,arguments)}function Ws(e,t){return t.reduce((function(t,n,r){var o=J.metaData.get("imagePlaneModule",n).imagePositionPatient,a=xs.vec3.distance(o,e);return a<t.distance?{distance:a,index:r}:t}),{distance:1/0,index:-1})}var Fs=J.Enums.Events.STACK_NEW_IMAGE;function Hs(e){return Ol(e,Fs,js)}var Gs=function(e,t,n){return"".concat(e,"::").concat(t,"::").concat(n)},qs=function(e,t){Object.keys(e).forEach((function(n){var r=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):r!==o&&t.setAttribute(n,o)}))},zs=function(e,t){Object.keys(e).forEach((function(n){var r=e[n];void 0!==r&&""!==r&&t.setAttribute(n,r)}))},Ks=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},a),s=l.color,c=l.fill,d=l.width,u=l.lineWidth,v=l.lineDash,f=l.fillOpacity,g=l.strokeOpacity,h=u||d,p=Gs(t,"circle",n),m=e.getSvgNode(p),w={cx:"".concat(r[0]),cy:"".concat(r[1]),r:"".concat(o),stroke:s,fill:c,"stroke-width":h,"stroke-dasharray":v,"fill-opacity":f,"stroke-opacity":g};if(m)qs(w,m),e.setNodeTouched(p);else{var E=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==i&&E.setAttribute("data-id",i),zs(w,E),e.appendNode(E,p)}},Ys=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),s=l.color,c=l.width,d=l.lineWidth,u=l.lineDash,v=d||c,f=Gs(t,"ellipse",n),g=e.getSvgNode(f),h=Math.abs(r[0]-o[0]),p=Math.abs(r[1]-o[1]),m=[Math.min(r[0],o[0])+h/2,Math.min(r[1],o[1])+p/2],w=h/2,E=p/2,y={cx:"".concat(m[0]),cy:"".concat(m[1]),rx:"".concat(w),ry:"".concat(E),stroke:s,fill:"transparent","stroke-width":v,"stroke-dasharray":u};if(g)qs(y,g),e.setNodeTouched(f);else{var I=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==i&&I.setAttribute("data-id",i),zs(y,I),e.appendNode(I,f)}},Xs=function(e,t,n,r){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),i=a.color,l=a.handleRadius,s=a.width,c=a.lineWidth,d=a.fill,u=a.type,v=a.opacity,f=c||s,g=0;g<r.length;g++){var h=r[g],p=Gs(t,"handle","hg-".concat(n,"-index-").concat(g)),m=void 0;if("circle"===u)m={cx:"".concat(h[0]),cy:"".concat(h[1]),r:l,stroke:i,fill:d,"stroke-width":f,opacity:v};else{if("rect"!==u)throw new Error("Unsupported handle type: ".concat(u));var w=1.5*parseFloat(l),E=h[0]-.5*w,y=h[1]-.5*w;m={x:"".concat(E),y:"".concat(y),width:"".concat(w),height:"".concat(w),stroke:i,fill:d,"stroke-width":f,rx:"".concat(.1*w),opacity:v}}var I=e.getSvgNode(p);if(I)qs(m,I),e.setNodeTouched(p);else{var b=document.createElementNS("http://www.w3.org/2000/svg",u);zs(m,b),e.appendNode(b,p)}}};function Zs(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(!(isNaN(r[0])||isNaN(r[1])||isNaN(o[0])||isNaN(o[1]))){var l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),s=l.color,c=l.width,d=l.lineWidth,u=l.lineDash,v=l.shadow,f=d||c,g=Gs(t,"line",n),h=e.getSvgNode(g),p=v?"filter:url(#shadow-".concat(e.svgLayerElement.id,");"):"",m={x1:"".concat(r[0]),y1:"".concat(r[1]),x2:"".concat(o[0]),y2:"".concat(o[1]),stroke:s,style:p,"stroke-width":f,"stroke-dasharray":u};if(h)qs(m,h),e.setNodeTouched(g);else{var w=document.createElementNS("http://www.w3.org/2000/svg","line");""!==i&&w.setAttribute("data-id",i),zs(m,w),e.appendNode(w,g)}}}function Js(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function $s(e,t,n,r,o){if(!(r.length<2)){var a,i=Object.assign({color:"dodgerblue",width:"2",fillColor:"none",fillOpacity:0,lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},o),l=i.fillColor,s=i.fillOpacity,c=i.color,d=i.width,u=i.lineWidth,v=i.lineDash,f=u||d,g=Gs(t,"polyline",n),h=e.getSvgNode(g),p="",m=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Js(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Js(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(r);try{for(m.s();!(a=m.n()).done;){var w=a.value;p+="".concat(w[0],", ").concat(w[1]," ")}}catch(e){m.e(e)}finally{m.f()}if(o.connectLastToFirst){var E=r[0];p+="".concat(E[0],", ").concat(E[1])}var y={points:p,stroke:c,fill:l,"fill-opacity":s,"stroke-width":f,"stroke-dasharray":v};if(h)qs(y,h),e.setNodeTouched(g);else{var I=document.createElementNS("http://www.w3.org/2000/svg","polyline");zs(y,I),e.appendNode(I,g)}}}function Qs(e){var t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function ec(e,t){var n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||((n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("class","background"),e.insertBefore(n,e.firstChild));var r=e.getBBox(),o={x:"".concat(r.x),y:"".concat(r.y),width:"".concat(r.width),height:"".concat(r.height),fill:t};return qs(o,n),r}var tc=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=function(e,t,n){var r,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[""],a=arguments.length>4?arguments[4]:void 0,i=arguments.length>5?arguments[5]:void 0,l=i.padding,s=i.color,c=i.fontFamily,d=i.fontSize,u=i.background,v=a[0]+l,f=a[1]+l,g=Gs(t,"text",n),h=e.getSvgNode(g);if(h){for(var p=h.querySelector("text"),m=Array.from(p.children),w=0;w<m.length;w++){var E=m[w],y=o[w]||"";E.textContent=y}if(o.length>m.length){for(var I=0;I<o.length-m.length;I++){var b=Qs(o[I+m.length]);p.appendChild(b)}h.appendChild(p),e.appendNode(h,g)}var C={fill:s,"font-size":d,"font-family":c},_={transform:"translate(".concat(v," ").concat(f,")")};qs(C,p),qs(_,h),r=ec(h,u),e.setNodeTouched(g)}else{var T=document.createElementNS("http://www.w3.org/2000/svg","g");T.setAttribute("transform","translate(".concat(v," ").concat(f,")"));for(var O=function(e,t){var n=t.color,r=t.fontFamily,o=t.fontSize,a=document.createElementNS("http://www.w3.org/2000/svg","text"),i="filter:url(#shadow-".concat(e.svgLayerElement.id,");"),l="".concat("user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);").concat(i);return a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("fill",n),a.setAttribute("font-family",r),a.setAttribute("font-size",o),a.setAttribute("style",l),a}(e,i),D=0;D<o.length;D++){var S=Qs(o[D]);O.appendChild(S)}T.appendChild(O),e.appendNode(T,g),r=ec(T,u)}return Object.assign({},r,{x:v,y:f,height:r.height+l,width:r.width+l})}(e,t,n,r,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a));return i};function nc(e,t){var n=[0,0],r=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){var o,a,i,l,s,c,d,u=(o=e,i=(a=dt(t,2))[0],l=a[1],c=(s=dt(o,2))[0],d=s[1],Math.sqrt(Math.pow(i-c,2)+Math.pow(l-d,2)));u<r&&(r=u,n=Lr(e))})),n}var rc=function(e,t,n,r,o,a,i){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},s=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},l),c=tc(e,t,n,r,o,s);return function(e,t,n,r,o,a){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=r.length>0?nc(r,o):o,s=nc(function(e){var t=e.x,n=e.y,r=e.height,o=e.width,a=o/2,i=r/2;return[[t+a,n],[t,n+i],[t+a,n+r],[t+o,n+i]]}(a),l),c=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},i);Zs(e,t,"link-".concat(n),l,s,c)}(e,t,n,a,o,c,s),c};function oc(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),s=l.color,c=l.width,d=l.lineWidth,u=l.lineDash,v=d||c,f=Gs(t,"rect",n),g=e.getSvgNode(f),h=[Math.min(r[0],o[0]),Math.min(r[1],o[1])],p=Math.abs(r[0]-o[0]),m=Math.abs(r[1]-o[1]),w={x:"".concat(h[0]),y:"".concat(h[1]),width:"".concat(p),height:"".concat(m),stroke:s,fill:"transparent","stroke-width":v,"stroke-dasharray":u};if(g)qs(w,g),e.setNodeTouched(f);else{var E=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==i&&E.setAttribute("data-id",i),zs(w,E),e.appendNode(E,f)}}function ac(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};if(!(isNaN(r[0])||isNaN(r[1])||isNaN(o[0])||isNaN(o[1]))){var i=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),l=i.color,s=i.width,c=i.lineWidth;Zs(e,t,n,r,o,{color:l,width:s,lineWidth:c,lineDash:i.lineDash});var d=Math.atan2(o[1]-r[1],o[0]-r[0]),u={start:[o[0]-10*Math.cos(d-Math.PI/7),o[1]-10*Math.sin(d-Math.PI/7)],end:o},v={start:[o[0]-10*Math.cos(d+Math.PI/7),o[1]-10*Math.sin(d+Math.PI/7)],end:o};Zs(e,t,"2",u.start,u.end,{color:l,width:s,lineWidth:c}),Zs(e,t,"3",v.start,v.end,{color:l,width:s,lineWidth:c})}}function ic(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),l=i.color,s=i.width,c=i.lineWidth,d=i.lineDash,u=c||s,v=Gs(t,"rect",n),f=e.getSvgNode(v),g=[Math.min(r[0],o[0]),Math.min(r[1],o[1])],h=Math.abs(r[0]-o[0]),p=Math.abs(r[1]-o[1]),m={x:"".concat(g[0]),y:"".concat(g[1]),width:"".concat(h),height:"".concat(p),stroke:l,fill:"black","stroke-width":u,"stroke-dasharray":d};if(f)qs(m,f),e.setNodeTouched(v);else{var w=document.createElementNS("http://www.w3.org/2000/svg","rect");zs(m,w),e.appendNode(w,v)}}function lc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function sc(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,r=(0,J.getEnabledElement)(e);if(!r)throw new Error("getAnnotationNearPoint: enabledElement not found");return cc(r,t,n)}function cc(e,t,n){var r=e.renderingEngineId,o=e.viewportId,a=Fr(o,r);if(!a)return null;var i=a._toolInstances;for(var l in i){var s=dc(i[l],e,t,n);if(s)return s}return null}function dc(e,t,n,r){var o,a=t.viewport,i=nt(e.constructor.toolName,null==a?void 0:a.element),l=null==a||null===(o=a.getCurrentImageId)||void 0===o?void 0:o.call(a);if(null!=i&&i.length){var s,c=t.viewport.element,d=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return lc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?lc(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(i);try{for(d.s();!(s=d.n()).done;){var u,v=s.value,f=null===(u=v.metadata)||void 0===u?void 0:u.referencedImageId;if(!(l&&f&&l!==f||!e.isPointNearTool)&&(e.isPointNearTool(c,v,n,r,"")||e.getHandleNearImagePoint(c,v,n,r)))return v}}catch(e){d.e(e)}finally{d.f()}}return null}var uc=function(e){var t=ee(e);return null!==e&&("object"===t||"function"===t)},vc=function(e,t,n){var r,o,a,i,l,s,c=0,d=!1,u=!1,v=!0,f=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function g(t){var n=r,a=o;return r=o=void 0,c=t,i=e.apply(a,n)}function h(e,t){return f?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){var n=e-s;return void 0===s||n>=t||n<0||u&&e-c>=a}function m(){var e=Date.now();if(p(e))return w(e);l=h(m,function(e){var n=e-c,r=t-(e-s);return u?Math.min(r,a-n):r}(e))}function w(e){return l=void 0,v&&r?g(e):(r=o=void 0,i)}function E(){for(var e=Date.now(),n=p(e),a=arguments.length,v=new Array(a),f=0;f<a;f++)v[f]=arguments[f];if(r=v,o=this,s=e,n){if(void 0===l)return function(e){return c=e,l=h(m,t),d?g(e):i}(s);if(u)return l=h(m,t),g(s)}return void 0===l&&(l=h(m,t)),i}return t=Number(t)||0,uc(n)&&(d=Boolean(n.leading),a=(u="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):a,v="trailing"in n?Boolean(n.trailing):v),E.cancel=function(){void 0!==l&&function(e){if(f)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),c=0,r=s=o=l=void 0},E.flush=function(){return void 0===l?i:w(Date.now())},E.pending=function(){return void 0!==l},E},fc=function(e,t,n){var r=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return uc(n)&&(r="leading"in n?Boolean(n.leading):r,o="trailing"in n?Boolean(n.trailing):o),vc(e,t,{leading:r,trailing:o,maxWait:t})},gc=J.utilities.calibratedPixelSpacingMetadataProvider;function hc(e,t,n){"number"==typeof n&&(n={type:J.Enums.CalibrationTypes.USER,scale:n}),gc.add(e,n),t.getStackViewports().forEach((function(t){t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}function pc(e,t,n,r){var o,a,i,l,s,c,d;d=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();var u=e.getDimensions();if(r){var v=dt(r,3),f=dt(v[0],2);o=f[0],a=f[1];var g=dt(v[1],2);i=g[0],l=g[1];var h=dt(v[2],2);s=h[0],c=h[1]}else o=0,a=u[0],i=0,l=u[1],s=0,c=u[2];for(var p=xs.vec3.fromValues(o,i,s),m=e.getDirection(),w=m.slice(0,3),E=m.slice(3,6),y=m.slice(6,9),I=dt(e.getSpacing(),3),b=I[0],C=I[1],_=I[2],T=e.indexToWorld(p),O=xs.vec3.fromValues(w[0]*b,w[1]*b,w[2]*b),D=xs.vec3.fromValues(E[0]*C,E[1]*C,E[2]*C),S=xs.vec3.fromValues(y[0]*_,y[1]*_,y[2]*_),k=u[0],M=u[0]*u[1],x=[],R=s;R<=c;R++)for(var P=i;P<=l;P++)for(var A=o;A<=a;A++){var N=[A,P,R],L=A-o,U=P-i,V=R-s,j=T,B=[j[0]+L*O[0]+U*D[0]+V*S[0],j[1]+L*O[1]+U*D[1]+V*S[1],j[2]+L*O[2]+U*D[2]+V*S[2]];if(t(B,N)){var W=R*M+P*k+A,F=d[W];x.push({value:F,index:W,pointIJK:N,pointLPS:B}),null!==n&&n({value:F,index:W,pointIJK:N,pointLPS:B})}}return x}var mc=function(e,t){var n=1/0,r=0,o=1/0,a=0,i=1/0,l=0;if(e.forEach((function(e){n=Math.min(e[0],n),r=Math.max(e[0],r),o=Math.min(e[1],o),a=Math.max(e[1],a),i=Math.min(e[2],i),l=Math.max(e[2],l)})),n=Math.floor(n),r=Math.floor(r),o=Math.floor(o),a=Math.floor(a),i=Math.floor(i),l=Math.floor(l),t){var s=dt(t,3),c=s[0],d=s[1],u=s[2];n=Math.max(0,n),r=Math.min(c-1,r),o=Math.max(0,o),a=Math.min(d-1,a),i=Math.max(0,i),l=Math.min(u-1,l)}return[[n,r],[o,a],[i,l]]},wc=J.utilities.transformWorldToIndex;function Ec(e,t,n,r){var o=function(e,t,n){var r,o=dt(e,2),a=o[0],i=o[1],l=xs.vec3.fromValues((a[0]+i[0])/2,(a[1]+i[1])/2,(a[2]+i[2])/2),s=xs.vec3.distance(a,i)/2;if(!n){var c=wc(t,l),d=t.getSpacing(),u=Math.min.apply(Math,Lr(d)),v=Math.ceil(s/u);return{boundsIJK:r=[[c[0]-v,c[0]+v],[c[1]-v,c[1]+v],[c[2]-v,c[2]+v]],centerWorld:l,radiusWorld:s}}return r=function(e,t,n,r,o){var a=dt(n,2),i=a[0],l=a[1],s=e.getDimensions(),c=t.getCamera(),d=xs.vec3.fromValues(c.viewUp[0],c.viewUp[1],c.viewUp[2]),u=xs.vec3.fromValues(c.viewPlaneNormal[0],c.viewPlaneNormal[1],c.viewPlaneNormal[2]),v=xs.vec3.create();xs.vec3.cross(v,d,u);var f=xs.vec3.create(),g=xs.vec3.create();xs.vec3.scaleAndAdd(f,l,u,o),xs.vec3.scaleAndAdd(g,i,u,-o),xs.vec3.scaleAndAdd(f,f,v,-o),xs.vec3.scaleAndAdd(g,g,v,o);var h=[wc(e,f),wc(e,g)];return mc(h,s)}(t,n,e,0,s),{boundsIJK:r,centerWorld:l,radiusWorld:s}}(t,e,r),a=o.boundsIJK,i={center:o.centerWorld,radius:o.radiusWorld};pc(e,(function(e){return function(e,t){var n=e.center,r=e.radius;return Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)<=Math.pow(r,2)}(i,e)}),n,a)}var yc=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(null==e||""===e)return"NaN";if((e=Number(e))<1e-4)return"".concat(e);var n=e>=100?t-2:e>=10?t-1:e>=1?t:e>=.1?t+1:e>=.01?t+2:e>=.001?t+3:t+4;return e.toFixed(n)},Ic=function(e,t,n){var r=n.THRESHOLD_INSIDE_CIRCLE,o=t.getScalarData()[e],a=r.threshold;return a[0]<=o&&o<=a[1]};function bc(e,t){var n,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=e.viewport,a=t.volume,i=t.segmentsLocked,l=t.segmentIndex,s=t.imageVolume,c=t.strategySpecificConfiguration,d=t.segmentationId,u=t.points,v=a.imageData,f=a.dimensions,g=a.getScalarData(),h=[];n=r?function(e){var t=e.value,n=e.index;e.pointIJK,i.includes(t)||Ic(n,s,c)&&(g[n]=l,h.push(n))}:function(e){var t=e.index,n=e.value;i.includes(n)||(g[t]=l,h.push(t))},Ec(v,[u[0],u[1]],n,o);var p=f[0]*f[1],m=Math.floor(h[0]/p),w=Math.floor(h[h.length-1]/p);St(d,Array.from({length:w-m+1},(function(e,t){return t+m})))}function Cc(e,t){bc(e,t,!0)}function _c(e,t){var n=t.volume,r=t.imageVolume;if(!J.utilities.isEqual(n.dimensions,r.dimensions)||!J.utilities.isEqual(n.direction,r.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");bc(e,t,!0,!0)}function Tc(e,t){Cc(e,Object.assign({},t,{segmentIndex:0}))}function Oc(e){var t=dt(e,4),n=t[0],r=t[1],o=t[2],a=t[3];return[[o[0],r[1]],[a[0],n[1]]]}function Dc(e,t){var n=e.center,r=e.xRadius,o=e.yRadius,a=e.zRadius,i=dt(t,3),l=i[0],s=i[1],c=i[2],d=dt(n,3),u=d[0],v=d[1],f=d[2],g=0;return 0!==r&&(g+=(l-u)*(l-u)/(r*r)),0!==o&&(g+=(s-v)*(s-v)/(o*o)),0!==a&&(g+=(c-f)*(c-f)/(a*a)),g<=1}var Sc=J.utilities.transformWorldToIndex;function kc(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.volume,o=t.imageVolume,a=t.points,i=t.segmentsLocked,l=t.segmentIndex,s=t.segmentationId,c=t.strategySpecificConfiguration,d=r.imageData,u=r.dimensions,v=r.getScalarData(),f=e.viewport,g=xs.vec3.fromValues(0,0,0);a.forEach((function(e){xs.vec3.add(g,g,e)})),xs.vec3.scale(g,g,1/a.length);var h=dt(Oc(a.map((function(e){return f.worldToCanvas(e)}))),2),p=h[0],m=h[1],w=f.canvasToWorld(p),E=f.canvasToWorld(m),y=[Sc(d,w),Sc(d,E)],I=mc(y,u),b={center:g,xRadius:Math.abs(w[0]-E[0])/2,yRadius:Math.abs(w[1]-E[1])/2,zRadius:Math.abs(w[2]-E[2])/2},C=new Set;pc(d,(function(e,t){return Dc(b,e)}),n?function(e){var t=e.value,n=e.index,r=e.pointIJK;i.includes(t)||Ic(n,o,c)&&(v[n]=l,C.add(r[2]))}:function(e){var t=e.value,n=e.index,r=e.pointIJK;i.includes(t)||(v[n]=l,C.add(r[2]))},I),St(s,Array.from(C))}function Mc(e,t){kc(e,t,!1)}function xc(e,t){var n=t.volume,r=t.imageVolume;if(!J.utilities.isEqual(n.dimensions,r.dimensions)||!J.utilities.isEqual(n.direction,r.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");kc(e,t,!0)}function Rc(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pc(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Rc(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Rc(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ac(e,t){Mc(e,Pc(Pc({},t),{},{segmentIndex:0}))}function Nc(e){var t=Rt().getSegmentationRepresentations(e);if(t)return t.find((function(e){return e.active}))}function Lc(e,t){Rt().setActiveSegmentationRepresentation(e,t),Ot(e,t)}function Uc(e,t){var n=Pt(e);if(!n)throw new Error("No segmentation state found for ".concat(e));return n.segmentsLocked.has(t)}function Vc(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=Pt(e);if(!r)throw new Error("No segmentation state found for ".concat(e));var o=r.segmentsLocked;n?o.add(t):o.delete(t),Dt(e)}function jc(e){var t=Pt(e);if(!t)throw new Error("No segmentation state found for ".concat(e));var n=t.segmentsLocked;return Array.from(n)}function Bc(e,t){var n=Pt(e);(null==n?void 0:n.activeSegmentIndex)!==t&&(n.activeSegmentIndex=t,Dt(e))}function Wc(e){var t=Pt(e);if(t)return t.activeSegmentIndex}function Fc(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");J.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),Qt(e,t)}function Hc(e,t,n){var r=Yt(e,t);if(!r)throw new Error("setColorLUT: could not find segmentation representation with UID ".concat(t));if(!$t(n))throw new Error("setColorLUT: could not find colorLUT with index ".concat(n));r.colorLUTIndex=n,Ot(e,t)}function Gc(e,t,n){var r=Yt(e,t);if(!r)throw new Error("segmentation representation with UID ".concat(t," does not exist for tool group ").concat(e));return $t(r.colorLUTIndex)[n]}function qc(e,t,n,r){for(var o=Gc(e,t,n),a=0;a<r.length;a++)o[a]=r[a];Ot(e,t)}var zc=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:Mc,ERASE_INSIDE_CIRCLE:Ac,FILL_INSIDE_SPHERE:Cc,ERASE_INSIDE_SPHERE:Tc,THRESHOLD_INSIDE_CIRCLE:xc,THRESHOLD_INSIDE_SPHERE:_c},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_editData",void 0),ae(ga(e),"_hoverData",void 0),ae(ga(e),"onSetToolPassive",(function(){e.disableCursor()})),ae(ga(e),"onSetToolEnabled",(function(){e.disableCursor()})),ae(ga(e),"onSetToolDisabled",(function(){e.disableCursor()})),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail.element,r=(0,J.getEnabledElement)(n),o=r.viewport,a=r.renderingEngine;if(o instanceof J.StackViewport)throw new Error("Not implemented yet");var i=Nc(e.toolGroupId);if(!i)throw new Error("No active segmentation detected, create one before using the brush tool");var l=i.segmentationId,s=i.type,c=jc(l),d=Pt(l).representationData[s].volumeId,u=J.cache.getVolume(d),v=o.getActors()[0].uid,f=J.cache.getVolume(v),g=[o.id];return e._editData={segmentation:u,imageVolume:f,segmentsLocked:c},e._activateDraw(n),gs(n),t.preventDefault(),ca(a,g),!0})),ae(ga(e),"mouseMoveCallback",(function(t){e.mode===Xe.Active&&e.updateCursor(t)})),ae(ga(e),"_dragCallback",(function(t){var n=t.detail.element,r=(0,J.getEnabledElement)(n),o=r.renderingEngine,a=e._editData,i=a.imageVolume,l=a.segmentation,s=a.segmentsLocked;e.updateCursor(t);var c=e._hoverData,d=c.segmentIndex,u=c.segmentationId,v=c.segmentationRepresentationUID,f=c.brushCursor,g=c.viewportIdsToRender,h=f.data,p=f.metadata,m=p.viewPlaneNormal,w=p.viewUp;ca(o,g);var E={points:h.handles.points,volume:l,imageVolume:i,segmentIndex:d,segmentsLocked:s,viewPlaneNormal:m,toolGroupId:e.toolGroupId,segmentationId:u,segmentationRepresentationUID:v,viewUp:w,strategySpecificConfiguration:e.configuration.strategySpecificConfiguration};e.applyActiveStrategy(r,E)})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e._editData,o=r.imageVolume,a=r.segmentation,i=r.segmentsLocked,l=e._hoverData,s=l.segmentIndex,c=l.segmentationId,d=l.segmentationRepresentationUID,u=l.brushCursor,v=u.data,f=u.metadata,g=f.viewPlaneNormal,h=f.viewUp;e._deactivateDraw(n),fs(n);var p=(0,J.getEnabledElement)(n),m=p.viewport;if(e._editData=null,e.updateCursor(t),m instanceof J.StackViewport)throw new Error("Not implemented yet");var w={points:v.handles.points,volume:a,imageVolume:o,segmentIndex:s,segmentsLocked:i,viewPlaneNormal:g,toolGroupId:e.toolGroupId,segmentationId:c,segmentationRepresentationUID:d,viewUp:h,strategySpecificConfiguration:e.configuration.strategySpecificConfiguration};e.applyActiveStrategy(p,w)})),ae(ga(e),"_activateDraw",(function(t){t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback)})),e}return re(o,[{key:"disableCursor",value:function(){this._hoverData=void 0}},{key:"updateCursor",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints.canvas,o=(0,J.getEnabledElement)(n),a=o.renderingEngine,i=o.viewport,l=i.getCamera(),s=l.viewPlaneNormal,c=l.viewUp,d=this.toolGroupId,u=Nc(d);if(u){var v=u.segmentationRepresentationUID,f=u.segmentationId,g=Wc(f),h=Gc(d,v,g),p=[i.id],m={metadata:{viewPlaneNormal:Lr(s),viewUp:Lr(c),FrameOfReferenceUID:i.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:h},data:{}};this._hoverData={brushCursor:m,centerCanvas:r,segmentIndex:g,segmentationId:f,segmentationRepresentationUID:v,segmentColor:h,viewportIdsToRender:p},this._calculateCursor(n,r),ca(a,p)}else console.warn("No active segmentation detected, create one before using the brush tool")}},{key:"_calculateCursor",value:function(e,t){var n=(0,J.getEnabledElement)(e).viewport,r=n.canvasToWorld,o=n.getCamera(),a=this.configuration.brushSize,i=xs.vec3.fromValues(o.viewUp[0],o.viewUp[1],o.viewUp[2]),l=xs.vec3.fromValues(o.viewPlaneNormal[0],o.viewPlaneNormal[1],o.viewPlaneNormal[2]),s=xs.vec3.create();xs.vec3.cross(s,i,l);for(var c=r([t[0],t[1]]),d=xs.vec3.create(),u=xs.vec3.create(),v=xs.vec3.create(),f=xs.vec3.create(),g=0;g<=2;g++)d[g]=c[g]-i[g]*a,u[g]=c[g]+i[g]*a,v[g]=c[g]-s[g]*a,f[g]=c[g]+s[g]*a;var h=this._hoverData.brushCursor.data;void 0===h.handles&&(h.handles={}),h.handles.points=[d,u,v,f],h.invalidated=!1}},{key:"invalidateBrushCursor",value:function(){void 0!==this._hoverData&&(this._hoverData.brushCursor.data.invalidated=!0)}},{key:"renderAnnotation",value:function(e,t){if(this._hoverData){var n=e.viewport;if(this._hoverData.viewportIdsToRender.includes(n.id)){var r=this._hoverData.brushCursor;if(!0===r.data.invalidated){var o=this._hoverData.centerCanvas,a=n.element;this._calculateCursor(a,o)}var i=r.metadata,l=i.brushCursorUID,s=r.data.handles.points.map((function(e){return n.worldToCanvas(e)})),c=s[0],d=s[1],u=[Math.floor((c[0]+d[0])/2),Math.floor((c[1]+d[1])/2)],v=Math.abs(c[1]-Math.floor((c[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");n.getRenderingEngine()?Ks(t,l,"0",u,v,{color:f}):console.warn("Rendering Engine has been destroyed")}}}}]),o}(La);ae(zc,"toolName",void 0),zc.toolName="Brush";var Kc=zc;function Yc(e,t){var n=fa(e);if(void 0!==n){var r=n._toolInstances;if(Object.keys(r).length)return t&&r[t]?[r[t]]:Object.values(r).filter((function(e){return e instanceof Kc}))}}function Xc(e,t,n,r){for(var o=[],a=0;a<2;a++)for(var i=0;i<2;i++)for(var l=0;l<2;l++){var s=Lr(r);s[0]=s[0]+(2*a-1)*n[0]/2,s[1]=s[1]+(2*i-1)*n[1]/2,s[2]=s[2]+(2*l-1)*n[2]/2,o.push(s)}var c=o.map((function(t){return J.utilities.transformWorldToIndex(e,t)}));return mc(c,t)}function Zc(e,t){for(var n=e.spacing,r=e.getScalarData(),o=[],a=0,i=0;i<t.length;i++){var l=t[i].volume,s=l.imageData,c=l.spacing,d=l.dimensions,u=t[i].volume.getScalarData().length;u===r.length&&(h=c,p=n,JSON.stringify(h)===JSON.stringify(p))&&(a=i);var v=s.getPointData().getScalars().getData(),f=t[i].lower,g=t[i].upper;o.push({imageData:s,referenceValues:v,lower:f,upper:g,spacing:c,dimensions:d,volumeSize:u})}var h,p;return{volumeInfoList:o,baseVolumeIdx:a}}var Jc=function(e,t,n){var r=e.imageData,o=e.getScalarData(),a=n.overwrite,i=n.boundsIJK,l=(null==n?void 0:n.overlapType)||0;if(a)for(var s=0;s<o.length;s++)o[s]=0;var c,d,u,v=Zc(e,t),f=v.baseVolumeIdx,g=v.volumeInfoList,h=function(e,t,n){var r=e.imageData,o=e.dimensions,a=e.lower,i=e.upper,s=Xc(r,o,t,n);d=0,c=0,u={lower:a,upper:i};var v=!1;return pc(r,(function(){return!0}),(function(e){var t=e.value;d+=1,t>=u.lower&&t<=u.upper&&(c+=1)}),s),0===l?v=c>0:1==l&&(v=c===d),v},p=function(e,t){var n=e.imageData,r=e.referenceValues,o=e.lower,a=e.upper,i=r[n.computeOffsetIndex(t)];return!(i<=o||i>=a)};return pc(r,(function(){return!0}),(function(e){for(var t=e.index,n=e.pointIJK,r=e.pointLPS,a=g.length>0,i=0;i<g.length&&(a=g[i].volumeSize===o.length?p(g[i],n):h(g[i],g[f].spacing,r));i++);a&&(o[t]=1)}),i),St(e.volumeId),e};function $c(e,t){for(var n=e.length,r=[],o=0;o<n;o++){var a=e[o];a.getFrameOfReferenceUID()===t&&r.push(a)}return r}var Qc=Xe.Active,ed=Xe.Passive,td=Xe.Enabled;function nd(e,t){for(var n=e.length,r=[],o=0;o<n;o++){var a=e[o],i=Fr(a.id,a.renderingEngineId);i&&rd(i,t)&&r.push(a)}return r}function rd(e,t){var n=e.toolOptions[t];if(!n)return!1;var r=n.mode;return r===Qc||r===ed||r===td}var od=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.999;return e.filter((function(e){var r=e.getCamera();return Math.abs(xs.vec3.dot(r.viewPlaneNormal,t.viewPlaneNormal))>n}))};function ad(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=(0,J.getEnabledElement)(e),o=r.renderingEngine,a=r.FrameOfReferenceUID,i=o.getViewports();i=nd(i=$c(i,a),t);var l=o.getViewport(r.viewportId);return n&&(i=od(i,l.getCamera())),i.map((function(e){return e.id}))}function id(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ld=1-J.CONSTANTS.EPSILON;function sd(e,t,n){var r=t.viewPlaneNormal,o=e.filter((function(e){var t=e.metadata.viewPlaneNormal;if(!t){var n=e.metadata.referencedImageId,o=J.metaData.get("imagePlaneModule",n).imageOrientationPatient,a=xs.vec3.fromValues(o[0],o[1],o[2]),i=xs.vec3.fromValues(o[3],o[4],o[5]);t=xs.vec3.create(),xs.vec3.cross(t,a,i),e.metadata.viewPlaneNormal=t}var l=Math.abs(xs.vec3.dot(r,t))>ld;return t&&l}));if(!o.length)return[];var a,i=n/2,l=t.focalPoint,s=[],c=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return id(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?id(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(c.s();!(a=c.n()).done;){var d=a.value,u=d.data.handles.points[0];if(d.isVisible){var v=xs.vec3.create();xs.vec3.sub(v,l,u);var f=xs.vec3.dot(v,r);Math.abs(f)<i&&s.push(d)}}}catch(e){c.e(e)}finally{c.f()}return s}function cd(e,t){if(e instanceof J.StackViewport){var n=e.getCurrentImageId(),r=n.indexOf(":"),o=n.substring(r+1);return t.filter((function(e){if(!e.isVisible)return!1;var t=e.metadata.referencedImageId;if(void 0===t)return!1;var n=t.indexOf(":");return t.substring(n+1)===o}))}if(e instanceof J.VideoViewport){var a=e.getFrameOfReferenceUID();return t.filter((function(e){return e.metadata.FrameOfReferenceUID===a}))}if(e instanceof J.VolumeViewport){var i=e.getCamera();return sd(t,i,J.utilities.getTargetVolumeAndSpacingInNormalDir(e,i).spacingInNormalDirection)}throw new Error("Viewport Type ".concat(e.type," not supported"))}var dd=function(e){if(e){if(e.data&&e.highlighted)return Bl.Highlighted;if(Te(e.annotationUID))return Bl.Selected;if(ve(e))return Bl.Locked}return Bl.Default};var ud=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e;oe(this,o);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return ae(ga(e=r.call.apply(r,[this].concat(n))),"onImageSpacingCalibrated",(function(t){var n=t.detail,r=n.element,o=n.imageId,a=J.utilities.imageIdToURI(o),i=Qe();i.getFramesOfReference().forEach((function(t){var n=i.getAnnotations(t)[e.getToolName()];n&&n.length&&(n.forEach((function(e){var t;null!==(t=e.metadata)&&void 0!==t&&t.referencedImageId&&J.utilities.imageIdToURI(e.metadata.referencedImageId)===a&&(e.invalidated=!0,e.data.cachedStats={})})),Zr(r))}))})),e}return re(o,[{key:"filterInteractableAnnotationsForElement",value:function(e,t){if(t&&t.length)return cd((0,J.getEnabledElement)(e).viewport,t)}},{key:"getReferencedImageId",value:function(e,t,n,r){var o,a=this.getTargetId(e);if(e instanceof J.StackViewport||e instanceof J.VideoViewport)o=a.split("imageId:")[1];else{var i=a.split("volumeId:")[1],l=J.cache.getVolume(i);o=J.utilities.getClosestImageId(l,t,n)}return o}},{key:"getStyle",value:function(e,t,n){return ns(e,t,dd(n),this.mode)}}]),o}(La);ae(ud,"toolName",void 0),ud.toolName="AnnotationDisplayTool";var vd=ud;function fd(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var gd=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(e,t){var n,a,i;return oe(this,o),ae(ga(i=r.call(this,e,t)),"mouseMoveCallback",(function(e,t){if(!t)return!1;var n,r=e.detail,o=r.element,a=r.currentPoints.canvas,l=!1,s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return fd(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?fd(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(t);try{for(s.s();!(n=s.n()).done;){var c=n.value;if(!ve(c)&&Pe(c.annotationUID)){var d=c.data,u=d.handles?d.handles.activeHandleIndex:void 0,v=i._imagePointNearToolOrHandle(o,c,a,6),f=v&&!c.highlighted,g=!v&&c.highlighted;f||g?(c.highlighted=!c.highlighted,l=!0):d.handles&&d.handles.activeHandleIndex!==u&&(l=!0)}}}catch(e){s.e(e)}finally{s.f()}return l})),null!==(n=e.configuration)&&void 0!==n&&n.getTextLines&&(i.configuration.getTextLines=e.configuration.getTextLines),null!==(a=e.configuration)&&void 0!==a&&a.statsCalculator&&(i.configuration.statsCalculator=e.configuration.statsCalculator),i}return re(o,[{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=t.data,i=a.handles,l=i.points,s=i.textBox;if(s){var c=s.worldBoundingBox;if(c){var d={topLeft:o.worldToCanvas(c.topLeft),topRight:o.worldToCanvas(c.topRight),bottomLeft:o.worldToCanvas(c.bottomLeft),bottomRight:o.worldToCanvas(c.bottomRight)};if(n[0]>=d.topLeft[0]&&n[0]<=d.bottomRight[0]&&n[1]>=d.topLeft[1]&&n[1]<=d.bottomRight[1])return a.handles.activeHandleIndex=null,s}}for(var u=0;u<l.length;u++){var v=l[u],f=o.worldToCanvas(v);if(!0==xs.vec2.distance(n,f)<r)return a.handles.activeHandleIndex=u,v}a.handles.activeHandleIndex=null}},{key:"getLinkedTextBoxStyle",value:function(e,t){return{visibility:this.getStyle("textBoxVisibility",e,t),fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}},{key:"isSuvScaled",value:function(e,t,n){if(e instanceof J.BaseVolumeViewport){var r,o=t.split("volumeId:")[1];return void 0!==(null===(r=J.cache.getVolume(o).scaling)||void 0===r?void 0:r.PT)}if(e instanceof J.StackViewport){var a=n&&J.metaData.get("scalingModule",n);return"number"==typeof(null==a?void 0:a.suvbw)}throw new Error("Viewport is not a valid type")}},{key:"_imagePointNearToolOrHandle",value:function(e,t,n,r){return!!this.getHandleNearImagePoint(e,t,n,r)||!!this.isPointNearTool(e,t,n,r,"mouse")||void 0}}]),o}(vd);ae(gd,"toolName",void 0),gd.toolName="AnnotationTool";var hd=gd,pd=J.Enums.CalibrationTypes,md="px",wd=function(e,t){var n=t.calibration,r=t.hasPixelSpacing?"mm":md;return n&&n.type?n.type===pd.UNCALIBRATED?md:n.SequenceOfUltrasoundRegions?"US Region":"".concat(r," ").concat(n.type):r},Ed=function(e,t){var n=t.calibration,r=(t.hasPixelSpacing?"mm":md)+"²";return n&&n.type?n.SequenceOfUltrasoundRegions?"US Region":"".concat(r," ").concat(n.type):r},yd=function(e){var t;return(null===(t=e.calibration)||void 0===t?void 0:t.scale)||1};function Id(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function bd(e,t,n){var r=Id(e,t);if(0===r)return Id(n,e);var o=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/r;return Id(n,o<0?e:o>1?t:[e[0]+o*(t[0]-e[0]),e[1]+o*(t[1]-e[1])])}function Cd(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(bd(e,t,n))}function _d(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");var n=dt(e,4),r=n[0],o=n[1],a=n[2],i=n[3],l=655535,s=function(e,t,n,r){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+r]],bottom:[[e+n,t+r],[e,t+r]],left:[[e,t+r],[e,t]]}}(r,o,a,i);return Object.keys(s).forEach((function(e){var n=dt(s[e],2),r=Cd(n[0],n[1],t);r<l&&(l=r)})),l}function Td(e){var t,n,r,o,a=(n=[(t=e)[0],t[1]].sort((function(e,t){return e[0]<t[0]?-1:1})),r=[t[0],t[1]].sort((function(e,t){return e[1]<t[1]?-1:1})),o=n[n.length-1],{top:r[0],bottom:r[r.length-1],right:o}),i=(a.top[1]+a.bottom[1])/2;return[a.right[0],i]}function Od(e,t,n,r){var o=xs.vec3.create();xs.vec3.cross(o,t,e);var a=xs.vec3.fromValues.apply(xs.vec3,Lr(n)),i=xs.vec3.fromValues.apply(xs.vec3,Lr(r)),l=xs.vec3.create();xs.vec3.subtract(l,a,i);var s=xs.vec3.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};var c=xs.vec3.dot(l,o)/(s*xs.vec3.length(o));return{worldWidth:Math.sqrt(1-c*c)*s,worldHeight:c*s}}function Dd(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";var n=J.metaData.get("generalSeriesModule",e);if("PT"===(null==n?void 0:n.modality)){var r=J.metaData.get("petSeriesModule",e);return(null==r?void 0:r.units)||"unitless"}}(t,n):""}function Sd(e,t){if(e instanceof J.BaseVolumeViewport){var n=t.split("volumeId:"),r=n.length>1?n[1]:n[0],o=J.cache.getVolume(r);return!(null==o||!o.scaling)&&Object.keys(o.scaling).length>0}if(e instanceof J.StackViewport){var a=(e.getImageData()||{}).preScale;return!(null==a||!a.scaled)}throw new Error("Viewport is not a valid type")}var kd=re((function e(){oe(this,e)}));ae(kd,"run",void 0),ae(kd,"getStatistics",void 0);var Md=kd;var xd=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){return oe(this,o),r.apply(this,arguments)}return re(o)}(Md);ae(xd,"max",-1/0),ae(xd,"currentMax",0),ae(xd,"sum",0),ae(xd,"sumSquares",0),ae(xd,"squaredDiffSum",0),ae(xd,"count",0),ae(xd,"statsCallback",(function(e){var t=e.value;t>xd.max&&(xd.max=t,xd.currentMax=t),xd.count+=1,xd.sum+=t,xd.sumSquares+=Math.pow(t,2),xd.squaredDiffSum+=Math.pow(t-xd.sum/xd.count,2)})),ae(xd,"getStatistics",(function(){var e=xd.sum/xd.count,t=Math.sqrt(xd.squaredDiffSum/xd.count),n=Math.sqrt(xd.sumSquares/xd.count-Math.pow(e,2));return xd.max=-1/0,xd.sum=0,xd.sumSquares=0,xd.squaredDiffSum=0,xd.count=0,[{name:"max",value:xd.currentMax,unit:null},{name:"mean",value:e,unit:null},{name:"stdDev",value:t,unit:null},{name:"stdDevWithSumSquare",value:n,unit:null}]}));var Rd=J.utilities.transformWorldToIndex,Pd=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ad,statsCalculator:xd}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{points:[Lr(a),Lr(a),Lr(a),Lr(a)],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,h),g})),ae(ga(e),"isPointNearTool",(function(t,n,r,o){var a=(0,J.getEnabledElement)(t).viewport,i=n.data.handles.points,l=a.worldToCanvas(i[0]),s=a.worldToCanvas(i[3]),c=e._getRectangleImageCoordinates([l,s]),d=[r[0],r[1]];return _d([c.left,c.top,c.width,c.height],d)<=o})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),gs(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var s=ad(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},e._activateModify(o),gs(o);var c=(0,J.getEnabledElement)(o).renderingEngine;ca(c,s),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}}})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g,h,p,m,w,E,y,I,b=n.currentPoints,C=(0,J.getEnabledElement)(r).viewport,_=C.worldToCanvas,T=C.canvasToWorld,O=b.world,D=c.handles.points;switch(D[l]=Lr(O),l){case 0:case 3:g=_(D[0]),h=[(m=_(D[3]))[0],g[1]],p=[g[0],m[1]],E=T(h),y=T(p),D[1]=E,D[2]=y;break;case 1:case 2:h=_(D[1]),g=[(p=_(D[2]))[0],h[1]],m=[h[0],p[1]],w=T(g),I=T(m),D[0]=w,D[3]=I}a.invalidated=!0}e.editData.hasMoved=!0;var S=(0,J.getEnabledElement)(r).renderingEngine;ca(S,i)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=s[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex,p=g.map((function(e){return i.worldToCanvas(e)}));u.annotationUID=o;var m,w=e.getStyle("lineWidth",u,r),E=e.getStyle("lineDash",u,r),y=e.getStyle("color",u,r),I=i.getCamera(),b=I.viewPlaneNormal,C=I.viewUp;if(l.cachedStats[c]&&null!=l.cachedStats[c].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,b,C,d,t),i instanceof J.VolumeViewport)){var _=r.metadata.referencedImageId;for(var T in l.cachedStats)T.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=J.utilities.imageIdToURI(_),n=e.hasImageURI(t),r=J.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[T]}}else l.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,b,C,d,t);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!Pe(o))return"continue";ve(r)||e.editData||null===h||(m=[p[h]]),m&&Xs(n,o,"0",m,{color:y});var O="".concat(o,"-rect");oc(n,o,"0",p[0],p[3],{color:y,lineDash:E,lineWidth:w},O),a=!0;var D=e.getLinkedTextBoxStyle(u,r);if(!D.visibility)return l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},"continue";var S=e.configuration.getTextLines(l,c);if(!S||0===S.length)return"continue";if(!l.handles.textBox.hasMoved){var k=Td(p);l.handles.textBox.worldPosition=i.canvasToWorld(k)}var M=i.worldToCanvas(l.handles.textBox.worldPosition),x=rc(n,o,"1",S,M,p,{},D),R=x.x,P=x.y,A=x.width,N=x.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([R,P]),topRight:i.canvasToWorld([R+A,P]),bottomLeft:i.canvasToWorld([R,P+N]),bottomRight:i.canvasToWorld([R+A,P+N])}},f=0;f<s.length;f++){var g=v();if("continue"!==g&&"object"===ee(g))return g.v}return a})),ae(ga(e),"_getRectangleImageCoordinates",(function(e){var t=dt(e,2),n=t[0],r=t[1];return{left:Math.min(n[0],r[0]),top:Math.min(n[1],r[1]),width:Math.abs(n[0]-r[0]),height:Math.abs(n[1]-r[1])}})),ae(ga(e),"_calculateCachedStats",(function(t,n,r,o,a){for(var i=t.data,l=a.viewportId,s=a.renderingEngineId,c=a.viewport,d=i.handles.points[0],u=i.handles.points[3],v=i.cachedStats,f=Object.keys(v),g=0;g<f.length;g++){var h=f[g],p=e.getTargetIdImage(h,o);if(p){var m=p.dimensions,w=p.imageData,E=p.metadata,y=("getScalarData"in p?p.getScalarData():p.scalarData,Rd(w,d));y[0]=Math.floor(y[0]),y[1]=Math.floor(y[1]),y[2]=Math.floor(y[2]);var I=Rd(w,u);if(I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]),e._isInsideVolume(y,I,m)){var b,C,_;e.isHandleOutsideImage=!1;var T=[[Math.min(y[0],I[0]),Math.max(y[0],I[0])],[Math.min(y[1],I[1]),Math.max(y[1],I[1])],[Math.min(y[2],I[2]),Math.max(y[2],I[2])]],O=Od(n,r,d,u),D=O.worldWidth,S=O.worldHeight,k=yd(p),M=Math.abs(D*S)/(k*k),x={isPreScaled:Sd(c,h),isSuvScaled:e.isSuvScaled(c,h,t.metadata.referencedImageId)},R=Dd(E.Modality,t.metadata.referencedImageId,x),P=pc(w,(function(){return!0}),e.configuration.statsCalculator.statsCallback,T),A=e.configuration.statsCalculator.getStatistics();v[h]={Modality:E.Modality,area:M,mean:null===(b=A[1])||void 0===b?void 0:b.value,stdDev:null===(C=A[2])||void 0===C?void 0:C.value,max:null===(_=A[0])||void 0===_?void 0:_.value,statsArray:A,pointsInShape:P,areaUnit:Ed(0,p),modalityUnit:R}}else e.isHandleOutsideImage=!0,v[h]={Modality:E.Modality}}}t.invalidated=!1;var N=Q.ANNOTATION_MODIFIED,L={annotation:t,viewportId:l,renderingEngineId:s};return(0,J.triggerEvent)(J.eventTarget,N,L),v})),ae(ga(e),"_isInsideVolume",(function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o)}(hd);function Ad(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.max,i=n.stdDev,l=n.areaUnit,s=n.modalityUnit;if(void 0!==o){var c=[];return c.push("Area: ".concat(yc(r)," ").concat(l)),c.push("Mean: ".concat(yc(o)," ").concat(s)),c.push("Max: ".concat(yc(a)," ").concat(s)),c.push("Std Dev: ".concat(yc(i)," ").concat(s)),c}}ae(Pd,"toolName",void 0),Pd.toolName="RectangleROI";var Nd=Pd;var Ld=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c,d,u=l.getCamera(),v=u.viewPlaneNormal,f=u.viewUp,g=e.getTargetId(l);if(l instanceof J.StackViewport)c=g.split("imageId:")[1];else{d=g.split("volumeId:")[1];var h=J.cache.getVolume(d);c=J.utilities.getClosestImageId(h,a,v)}var p=l.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:Lr(v),enabledElement:i,viewUp:Lr(f),FrameOfReferenceUID:p,referencedImageId:c,toolName:e.getToolName(),volumeId:d},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},segmentationId:null}};rt(m,o);var w=ad(o,e.getToolName());return e.editData={annotation:m,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,w),m})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=t.renderingEngineId,s=i.element,c=nt(e.getToolName(),s);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(s,c))||void 0===o||!o.length)return a;for(var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=0;u<c.length;u++){var v=c[u],f=v.annotationUID,g=v.data.handles,h=g.points,p=g.activeHandleIndex,m=h.map((function(e){return i.worldToCanvas(e)}));d.annotationUID=f;var w=e.getStyle("lineWidth",d,v),E=e.getStyle("lineDash",d,v),y=e.getStyle("color",d,v);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var I=Q.ANNOTATION_MODIFIED,b={annotation:v,viewportId:i.id,renderingEngineId:l};(0,J.triggerEvent)(J.eventTarget,I,b);var C=void 0;Pe(f)&&(ve(v)||e.editData||null===p||(C=[m[p]]),C&&Xs(n,f,"0",C,{color:y}),oc(n,f,"0",m[0],m[3],{color:y,lineDash:E,lineWidth:w}),a=!0)}return a})),e}return re(o)}(Nd);ae(Ld,"toolName",void 0),Ld.toolName="RectangleROIThreshold";var Ud=Ld;var Vd=J.utilities.transformWorldToIndex,jd=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{numSlicesToPropagate:10}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c,d,u,v=l.getCamera(),f=v.viewPlaneNormal,g=v.viewUp;if(l instanceof J.StackViewport)throw new Error("Stack Viewport Not implemented");if(u=e.getTargetId(l).split("volumeId:")[1],d=J.cache.getVolume(u),!(c=J.utilities.getClosestImageId(d,a,f)))throw new Error("This tool does not work on non-acquisition planes");var h=l.getCurrentImageIdIndex(),p=J.utilities.getSpacingInNormalDirection(d,f),m=e._getEndSliceIndex(d,a,p,f),w=l.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:Lr(f),enabledElement:i,viewUp:Lr(g),FrameOfReferenceUID:w,referencedImageId:c,toolName:e.getToolName(),volumeId:u,spacingInNormal:p},data:{label:"",startSlice:h,endSlice:m,cachedStats:{projectionPoints:[],projectionPointsImageIds:[c]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},labelmapUID:null}};e._computeProjectionPoints(E,d),rt(E,o);var y=ad(o,e.getToolName());return e.editData={annotation:E,viewportIdsToRender:y,handleIndex:3,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,y),E})),ae(ga(e),"renderAnnotation",(function(t,n){var r=!1,o=t.viewport,a=nt(e.getToolName(),o.element);if(null==a||!a.length)return r;for(var i=o.getCurrentImageIdIndex(),l={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},s=0;s<a.length;s++){var c=a[s],d=c.annotationUID,u=c.data,v=u.startSlice,f=u.endSlice,g=u.handles,h=g.points,p=g.activeHandleIndex,m=h.map((function(e){return o.worldToCanvas(e)}));l.annotationUID=d;var w=e.getStyle("lineWidth",l,c),E=e.getStyle("lineDash",l,c),y=e.getStyle("color",l,c);if(!(i<Math.min(v,f)||i>Math.max(v,f))){c.invalidated&&e._throttledCalculateCachedStats(c,t);var I=!1;if(i!==v&&i!==f||(I=!0),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),r;var b=void 0;if(Pe(d)){ve(c)||e.editData||null===p||!I||(b=[m[p]]),b&&Xs(n,d,"0",b,{color:y});var C=E;I||(C=2),oc(n,d,"0",m[0],m[3],{color:y,lineDash:C,lineWidth:w}),r=!0}}}return r})),e._throttledCalculateCachedStats=fc(e._calculateCachedStatsTool,100,{trailing:!0}),e}return re(o,[{key:"_computeProjectionPoints",value:function(e,t){var n=e.data,r=e.metadata,o=r.viewPlaneNormal,a=r.spacingInNormal,i=t.imageData,l=n.startSlice,s=n.endSlice,c=n.handles.points,d=Vd(i,c[0]);if(d[2]!==l)throw new Error("Start slice does not match");var u=xs.vec3.fromValues(d[0],d[1],s),v=xs.vec3.create();i.indexToWorldVec3(d,v);var f=xs.vec3.create();i.indexToWorldVec3(u,f);for(var g=xs.vec3.distance(v,f),h=[],p=function(e){h.push(c.map((function(t){var n=xs.vec3.create();return xs.vec3.scaleAndAdd(n,t,o,e),Array.from(n)})))},m=0;m<g;m+=a)p(m);n.cachedStats.projectionPoints=h;for(var w=[],E=0,y=h;E<y.length;E++){var I=y[E],b=J.utilities.getClosestImageId(t,I[0],o);w.push(b)}n.cachedStats.projectionPointsImageIds=w}},{key:"_calculateCachedStatsTool",value:function(e,t){var n=e.data,r=t.viewportId,o=t.renderingEngineId,a=t.viewport,i=n.cachedStats,l=this.getTargetId(a),s=J.cache.getVolume(l.split("volumeId:")[1]);this._computeProjectionPoints(e,s),e.invalidated=!1;var c=Q.ANNOTATION_MODIFIED,d={annotation:e,viewportId:r,renderingEngineId:o};return(0,J.triggerEvent)(J.eventTarget,c,d),i}},{key:"_getEndSliceIndex",value:function(e,t,n,r){var o=this.configuration.numSlicesToPropagate,a=xs.vec3.create();xs.vec3.scaleAndAdd(a,t,r,o*n);for(var i,l=n/2,s=e.imageIds,c=0;c<s.length;c++){var d=s[c],u=J.metaData.get("imagePlaneModule",d).imagePositionPatient,v=xs.vec3.create();xs.vec3.sub(v,a,u);var f=xs.vec3.dot(v,r);Math.abs(f)<l&&(i=c)}return i}}]),o}(Nd);ae(jd,"toolName",void 0),jd.toolName="RectangleROIStartEndThreshold";var Bd=jd,Wd=function(e,t){var n=e.findIndex((function(e){var t=dt(e,2);return t[0]===t[1]}));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e},Fd=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=[];return e.forEach((function(e){var o,a,i=e.data,l=i.handles.points,s=t.imageData,c=t.dimensions,d=l;if(null!==(o=i.cachedStats)&&void 0!==o&&o.projectionPoints){var u,v=i.cachedStats.projectionPoints;d=(u=[]).concat.apply(u,Lr(v))}var f=d.map((function(e){return J.utilities.transformWorldToIndex(s,e)})),g=mc(f,c);!n.numSlicesToProject||null!==(a=i.cachedStats)&&void 0!==a&&a.projectionPoints||(g=Wd(g,n.numSlicesToProject)),r.push(g)})),1===r.length?r[0]:r.reduce((function(e,t){return{iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)}}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})};function Hd(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Gd(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function qd(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Gd(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Gd(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var zd=function(e,t,n,r){var o,a=e.map((function(e){return it(e)}));!function(e){var t,n=[Ud.toolName,Bd.toolName],r=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Hd(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Hd(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(e);try{for(r.s();!(t=r.n()).done;){var o=t.value.metadata.toolName;if(!n.includes(o))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}catch(e){r.e(e)}finally{r.f()}}(a);for(var i=0;i<n.length;i++)n[i].volume.getScalarData().length!==t.getScalarData().length&&0!==i||(o=Fd(a,n[i].volume,r));return Jc(t,n,qd(qd({},r),{},{boundsIJK:o}))},Kd=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mergedLabelmap";e.forEach((function(t){var n=t.direction,r=t.dimensions,o=t.origin,a=t.spacing;if(!(J.utilities.isEqual(r,e[0].dimensions)&&J.utilities.isEqual(n,e[0].direction)&&J.utilities.isEqual(a,e[0].spacing)&&J.utilities.isEqual(o,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));var r=e[0],o=new(0,r.getScalarData().constructor)(r.getScalarData().length);e.forEach((function(e){for(var n=e.getScalarData(),r=0;r<n.length;r++)n[r]===t&&(o[r]=t)}));var a={scalarData:o,metadata:r.metadata,spacing:r.spacing,origin:r.origin,direction:r.direction,dimensions:r.dimensions};return J.volumeLoader.createLocalVolume(a,n,!0)};function Yd(e,t){if(e===gt.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error("Unknown representation type: ".concat(e))}function Xd(e){var t=e.type;if(t===gt.Labelmap)return mt();throw new Error("Unknown representation type: ".concat(t))}function Zd(e){return Jd.apply(this,arguments)}function Jd(){return(Jd=Va(Ba().mark((function e(t){var n,r,o,a,i,l,s,c,d,u,v,f;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.viewportId,r=t.renderingEngineId,o=t.options,a=t.segmentationId,i=(0,J.getEnabledElementByIds)(n,r)){e.next=5;break}throw new Error("element disabled");case 5:if((l=i.viewport)instanceof J.VolumeViewport){e.next=8;break}throw new Error("Segmentation only supports VolumeViewport");case 8:if(s=l.getDefaultActor(),c=s.uid,void 0===a&&(a="".concat(c,"-based-segmentation-").concat(null!==(d=null==o?void 0:o.volumeId)&&void 0!==d?d:J.utilities.uuidv4().slice(0,8))),!o){e.next=16;break}return u=(0,ie._cloneDeep)(o),e.next=14,J.volumeLoader.createLocalVolume(u,a);case 14:e.next=19;break;case 16:return v=l.getDefaultActor(),f=v.uid,e.next=19,J.volumeLoader.createAndCacheDerivedVolume(f,{volumeId:a});case 19:return e.abrupt("return",a);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function $d(e,t){return e===t}function Qd(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}var eu=function(e,t){var n,r,o,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=a.onFlood,l=a.onBoundary,s=a.equals||$d,c=a.diagonals||!1,d=p(t),u=function(e){for(var t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))},r=0;r<Math.pow(3,e);r+=1){var o=Qd(r.toString(3),"0",e);t.push(n(o))}return t}(t.length).filter((function(e){var t=function(e){for(var t=0,n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||c)})),v=[],f=[],g={},h={};for(v.push({currentArgs:t});v.length>0;)n=v.pop(),r=void 0,o=void 0,r=n.currentArgs,o=n.previousArgs,!0!==g[r]&&(g[r]=!0,function(e){var t=m(p,[e]);return m(s,[t,d])}(r)?(function(e){f.push(e),i&&i.apply(void 0,Lr(e))}(r),function(e){for(var t=0;t<u.length;t+=1){for(var n=u[t],r=e.slice(0),o=0;o<e.length;o+=1)r[o]+=n[o];v.push({currentArgs:r,previousArgs:e})}}(r)):function(e){h[e]=e,l&&l.apply(void 0,Lr(e))}(o));return{flooded:f,boundaries:function(){var e=[];for(var t in h)void 0!==h[t]&&e.unshift(h[t]);return e}()};function p(t){return e.apply(void 0,Lr(t))}function m(e,t){try{return e.apply(void 0,Lr(t))}catch(e){return}}};function tu(e,t,n){var r=fa(e);if(void 0!==r){Yc(e,n).forEach((function(e){e.configuration.brushSize=t,e.invalidateBrushCursor()}));var o=r.getViewportsInfo(),a=Object.keys(o).map((function(e){return o[e]}));if(a.length){var i=a[0].renderingEngineId,l=r.getViewportIds(),s=(0,J.getRenderingEngine)(i);ca(s,l)}}}function nu(e,t){var n=fa(e);if(void 0!==n){var r=n._toolInstances;if(Object.keys(r).length){var o=Yc(e,t)[0];if(o)return o.configuration.brushSize}}}function ru(e,t){var n=fa(e);if(void 0!==n){Yc(e).forEach((function(e){e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t}));var r=n.getViewportsInfo();if(r.length){var o=r[0].renderingEngineId,a=n.getViewportIds(),i=(0,J.getRenderingEngine)(o);ca(i,a)}}}function ou(e){var t=fa(e);if(void 0!==t){var n=t._toolInstances;if(Object.keys(n).length){var r=Yc(e)[0];if(r)return r.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold}}}var au=function(e,t,n,r){var o=e.getScalarData(),a=Zc(e,n),i=a.baseVolumeIdx,l=a.volumeInfoList;return l.forEach((function(e){e.volumeSize===o.length?function(e,t,n){for(var r=n.referenceValues,o=n.lower,a=n.upper,i=0;i<e.length;i++)if(e[i]===t){var l=r[i];e[i]=l>=o&&l<=a?t:0}}(o,t,e):function(e,t,n,r,o,a){for(var i,l,s,c=n.imageData,d=n.lower,u=n.upper,v=n.dimensions,f=0;f<e.length;f++)if(e[f]===t){var g=Xc(c,v,r[o].spacing,r[o].imageData.getPoint(f));i=0,l=0,s={lower:d,upper:u};var h;pc(c,(function(){return!0}),(function(e){var t=e.value;i+=1,t>=s.lower&&t<=s.upper&&(l+=1)}),g),h=0===a?l>0:l===i,e[f]=h?t:0}}(o,t,e,l,i,r)})),St(e.volumeId),e},iu=1e-6,lu=1,su=0;function cu(e,t,n){var r=dt(n,2),o=r[0],a=r[1];if(Math.abs(t)<iu)return e<0;var i=e/t;if(t>0){if(i>a)return 0;i>o&&(n[0]=i)}else{if(i<o)return 0;i<a&&(n[1]=i)}return 1}function du(e,t,n,r,o){var a=dt(e,2),i=a[0],l=a[1],s=dt(t,2),c=s[0]-i,d=s[1]-l;if(void 0===r||void 0===o?(r=e,o=t):(r[0]=e[0],r[1]=e[1],o[0]=t[0],o[1]=t[1]),Math.abs(c)<iu&&Math.abs(d)<iu&&i>=n[0]&&i<=n[2]&&l>=n[1]&&l<=n[3])return lu;var u=[0,1];if(cu(n[0]-i,c,u)&&cu(i-n[2],-c,u)&&cu(n[1]-l,d,u)&&cu(l-n[3],-d,u)){var v=u[0],f=u[1];return f<1&&(o[0]=i+f*c,o[1]=l+f*d),v>0&&(r[0]+=v*c,r[1]+=v*d),lu}return su}function uu(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function vu(e,t,n,r){var o=dt(e,2),a=o[0],i=o[1],l=dt(t,2),s=l[0],c=l[1],d=dt(n,2),u=d[0],v=d[1],f=dt(r,2),g=f[0],h=f[1],p=c-i,m=a-s,w=s*i-a*c,E=p*u+m*v+w,y=p*g+m*h+w;if(0===E||0===y||uu(E)!==uu(y)){var I=h-v,b=u-g,C=g*v-u*h,_=I*a+b*i+C,T=I*s+b*c+C;if(0===_||0===T||uu(_)!==uu(T)){var O=p*b-I*m;return[(m*C-b*w)/O,(I*w-p*C)/O]}}}function fu(e,t,n){var r,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var a=r;a<e.length;a++){if(hu(t,n,e[o],e[a]))return[o,a];o=a}}function gu(e,t,n){var r,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var a=[],i=r;i<e.length;i++){var l=e[o],s=e[i];hu(t,n,l,s)&&a.push([o,i]),o=i}if(0!==a.length){var c=[];a.forEach((function(n){var r=[e[n[0]],e[n[1]]],o=[(r[0][0]+r[1][0])/2,(r[0][1]+r[1][1])/2];c.push(xs.vec2.distance(o,t))}));var d=Math.min.apply(Math,c);return{segment:a[c.indexOf(d)],distance:d}}}function hu(e,t,n,r){var o=!1,a=[pu(e,t,n),pu(e,t,r),pu(n,r,e),pu(n,r,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&mu(e,n,t)||0===a[1]&&mu(e,r,t)||0===a[2]&&mu(n,e,r)||0===a[3]&&mu(n,t,r))&&(o=!0),o)}function pu(e,t,n){var r=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===r?0:r>0?1:2}function mu(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function wu(e,t,n,r){var o=(r[1]-n[1])*(t[0]-e[0])-(r[0]-n[0])*(t[1]-e[1]);if(0!=o){var a=e[1]-n[1],i=e[0]-n[0],l=(r[0]-n[0])*a-(r[1]-n[1])*i,s=(t[0]-e[0])*a-(t[1]-e[1])*i;return a=l/o,i=s/o,[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}}var Eu=.001,yu=function(e,t){var n,r,o;if(e instanceof J.StackViewport){var a=e.getImageData();r=a.direction.slice(0,3),o=a.direction.slice(3,6),n=a.spacing}else{var i=e.getImageData(),l=i.direction,s=i.spacing,c=e.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=l.slice(0,3),f=l.slice(3,6),g=l.slice(6,9),h=xs.vec3.create();xs.vec3.cross(h,u,d);var p,m=Math.abs(xs.vec3.dot(h,v)),w=Math.abs(xs.vec3.dot(h,f)),E=Math.abs(xs.vec3.dot(h,g));if(Math.abs(1-m)<Eu)p=s[0],r=v;else if(Math.abs(1-w)<Eu)p=s[1],r=f;else{if(!(Math.abs(1-E)<Eu))throw new Error("No support yet for oblique plane planar contours");p=s[2],r=g}var y,I=Math.abs(xs.vec3.dot(u,v)),b=Math.abs(xs.vec3.dot(u,f)),C=Math.abs(xs.vec3.dot(u,g));if(Math.abs(1-I)<Eu)y=s[0],o=v;else if(Math.abs(1-b)<Eu)y=s[1],o=f;else{if(!(Math.abs(1-C)<Eu))throw new Error("No support yet for oblique plane planar contours");y=s[2],o=g}n=[p,y]}return{spacing:[n[0]/t,n[1]/t],xDir:r,yDir:o}},Iu=function(e,t,n){return xs.vec2.dist(e,t)<n},bu=function(e,t,n,r){var o=r.xDir,a=r.yDir,i=r.spacing,l=(0,J.getEnabledElement)(e).viewport,s=l.canvasToWorld(t[t.length-1]),c=l.canvasToWorld(n),d=xs.vec3.create();xs.vec3.subtract(d,c,s);var u=Math.abs(xs.vec3.dot(d,o)),v=Math.abs(xs.vec3.dot(d,a)),f=Math.max(Math.floor(u/i[0]),Math.floor(v/i[0]));if(f>1){var g=t[t.length-1],h=xs.vec2.dist(g,n),p=xs.vec2.create();xs.vec2.subtract(p,n,g),xs.vec2.set(p,p[0]/h,p[1]/h);for(var m=h/f,w=1;w<=f;w++)t.push([g[0]+m*p[0]*w,g[1]+m*p[1]*w])}else t.push(n);return f},Cu=function(e,t,n,r){var o=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],i=o[0]*a[0]+o[1]*a[1];if(i<0)return!1;var l=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===l)return!1;var s=i/l,c=[a[0]/l,a[1]/l],d=[c[0]*s,c[1]*s],u=[t[0]+d[0],t[1]+d[1]];return!(xs.vec2.distance(e,u)>r||xs.vec2.distance(t,u)>xs.vec2.distance(t,n))};function _u(e){for(var t=e.length,n=0,r=t-1,o=0;o<t;o++)n+=(e[r][0]+e[o][0])*(e[r][1]-e[o][1]),r=o;return Math.abs(n/2)}function Tu(e,t){if(e.length!==t.length)throw Error("Both points should have the same dimensionality");var n=dt(e,3),r=n[0],o=n[1],a=n[2],i=void 0===a?0:a,l=dt(t,3),s=l[0],c=l[1],d=l[2],u=void 0===d?0:d;return Math.sqrt(Math.pow(r-s,2)+Math.pow(o-c,2)+Math.pow(i-u,2))}var Ou=y(807),Du=y.n(Ou);function Su(e,t,n,r){var o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.25,i=e.getCamera(),l=i.position,s=J.utilities.getTargetVolumeAndSpacingInNormalDir(e,i,n).spacingInNormalDirection*a,c=e.getBounds(),d=c[0],u=c[1],v=[0,0,0],f=[0,0,0];Du().subtract(t,l,v);for(var g=d;g<=u;g+=s){f=[g,0,0];var h=(g-l[0])/v[0];if(f[1]=h*v[1]+l[1],f[2]=h*v[2]+l[2],ku(f,c)){var p=r(e.getIntensityFromWorld(f),f);p&&(o=p)}}return o}var ku=function(e,t){var n=dt(t,6),r=n[0],o=n[1],a=n[2],i=n[3],l=n[4],s=n[5];return e[0]>r&&e[0]<o&&e[1]>a&&e[1]<i&&e[2]>l&&e[2]<s},Mu={filterAnnotationsWithinSlice:sd,getWorldWidthAndHeightFromCorners:Od,filterAnnotationsForDisplay:cd,getPointInLineOfSightWithCriteria:Su};function xu(e){for(var t="",n=e[0]<0?"R":"L",r=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],i=1e-4,l=0;l<3;l++)if(a[0]>i&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>i&&a[1]>a[0]&&a[1]>a[2])t+=r,a[1]=0;else if(a[2]>i&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>i&&a[1]>i&&a[0]===a[1])t+=n+r,a[0]=0,a[1]=0;else if(a[0]>i&&a[2]>i&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else{if(!(a[1]>i&&a[2]>i&&a[1]===a[2]))break;t+=r+o,a[1]=0,a[2]=0}return t}function Ru(e){var t=e.replace("H","f");return(t=(t=(t=(t=(t=t.replace("F","h")).replace("R","l")).replace("L","r")).replace("A","p")).replace("P","a")).toUpperCase()}var Pu=function(e){return e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED",e}(Pu||{}),Au=Pu,Nu={};function Lu(e,t){var n=(0,J.getEnabledElement)(e).viewportId;Nu[n]=t}function Uu(e){var t=(0,J.getEnabledElement)(e).viewportId;return Nu[t]}var Vu=J.Enums.ViewportStatus,ju=J.utilities.triggerEvent,Bu=!0,Wu=!0,Fu=new Map;function Hu(e,t){var n,r,o;if(void 0===e)throw new Error("playClip: element must not be undefined");var a=(0,J.getEnabledElement)(e);if(!a)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=null===(n=t.dynamicCineEnabled)||void 0===n||n;var i,l,s,c,d=a.viewport,u=Ku(d),v=function(e,t){var n;if(e instanceof J.StackViewport)return function(e,t){var n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll:function(n){this.waitForRenderedCount<=t&&e.viewportStatus!==Vu.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,Ps(e,{delta:n,debounceLoading:Bu}))}}}(e,null!==(n=t.waitForRendered)&&void 0!==n?n:30);if(e instanceof J.VolumeViewport){var r=Ku(e);return t.dynamicCineEnabled&&null!=r&&r.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll:function(t){e.timePointIndex+=t}}}(r):function(e,t){var n=t.volumeId,r={viewPlaneNormal:xs.vec3.create(),scrollInfo:null},o=function(){var t=e.getCamera();if(!r.scrollInfo||!xs.vec3.equals(t.viewPlaneNormal,r.viewPlaneNormal)){var o=J.utilities.getVolumeViewportScrollInfo(e,n);r.viewPlaneNormal=t.viewPlaneNormal,r.scrollInfo=o}return r.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){var n=e.getCamera(),r=t.direction.slice(6,9).map((function(e){return-e})),o=xs.vec3.dot(r,n.viewPlaneNormal);return xs.glMatrix.equals(o,1)},scroll:function(t){o().currentStepIndex+=t,Ps(e,{delta:t})}}}(e,r)}throw new Error("Unknown viewport type")}(d,t),f=Uu(e),g=t.dynamicCineEnabled&&(null==u?void 0:u.isDynamicVolume());if(g&&zu(e),f?qu(e,g):(f={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:null!==(i=t.frameTimeVector)&&void 0!==i?i:void 0,speed:null!==(l=t.frameTimeVectorSpeedMultiplier)&&void 0!==l?l:1,reverse:null!==(s=t.reverse)&&void 0!==s&&s,loop:null===(c=t.loop)||void 0===c||c},Lu(e,f)),f.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(f.framesPerSecond=Number(t.framesPerSecond),f.reverse=f.framesPerSecond<0,f.ignoreFrameTimeVector=!0),!0!==f.ignoreFrameTimeVector&&f.frameTimeVector&&f.frameTimeVector.length===v.numScrollSteps&&v.frameTimeVectorEnabled){var h=function(e,t){var n,r,o,a=0,i=e.length,l=[],s=!1;for(("number"!=typeof t||t<=0)&&(t=1),n=1;n<i;n++)o=Number(e[n])/t|0,l.push(o),1===n?r=o:o!==r&&(s=!0),a+=o;return l.length>0&&(o=s?a/l.length|0:l[0],l.push(o)),{timeouts:l,isTimeVarying:s}}(f.frameTimeVector,f.speed),p=h.timeouts,m=h.isTimeVarying;r=p,o=m}var w=function(){var t=v.numScrollSteps,n=v.currentStepIndex,r=n+(f.reverse?-1:1);if(Wu||!(r<0||r>=t)){r>=t?r=0:r<0&&(r=t-1);var o=r-n;o&&v.scroll(o)}else{qu(e,g);var a={element:e};ju(e,Au.CLIP_STOPPED,a)}};g&&Fu.set(u.volumeId,e),r&&r.length>0&&o?(f.usingFrameTimeVector=!0,f.intervalId=window.setTimeout((function e(){f.intervalId=window.setTimeout(e,r[v.currentStepIndex]),w()}),0)):(f.usingFrameTimeVector=!1,f.intervalId=window.setInterval(w,1e3/Math.abs(f.framesPerSecond)));var E={element:e};ju(e,Au.CLIP_STARTED,E)}function Gu(e){qu(e,!0)}function qu(e,t){var n=(0,J.getEnabledElement)(e);if(n){var r,o,a=n.viewport,i=Uu(a.element);i&&void 0!==(o=(r=i).intervalId)&&(r.intervalId=void 0,r.usingFrameTimeVector?clearTimeout(o):clearInterval(o)),t&&a instanceof J.BaseVolumeViewport&&zu(e)}}function zu(e){var t=Ku((0,J.getEnabledElement)(e).viewport);if(null!=t&&t.isDynamicVolume()){var n=Fu.get(t.volumeId);Fu.delete(t.volumeId),n&&n!==e&&Gu(n)}}function Ku(e){var t=function(e){return e.getActors().map((function(e){return J.cache.getVolume(e.uid)})).filter((function(e){return!!e}))}(e),n=t.find((function(e){return e.isDynamicVolume()}));return null!=n?n:t[0]}function Yu(e){var t=e.length-1;return function(n){var r=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),o=e[r],a=e[r+1],i=r>0?e[r-1]:2*o-a,l=r<t-1?e[r+2]:2*a-o;return function(e,t,n,r,o){var a=e*e,i=a*e;return((1-3*e+3*a-i)*t+(4-6*a+3*i)*n+(1+3*e+3*a-3*i)*r+i*o)/6}((n-r/t)*t,i,o,a,l)}}function Xu(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e(r/(t-1));return n}function Zu(e){return e.length}function Ju(){return function(e){if(!(o=e.length))return[];for(var t=-1,n=function(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let r=-1;for(let o of e)null!=(o=t(o,++r,e))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}(e,Zu),r=new Array(n);++t<n;)for(var o,a=-1,i=r[t]=new Array(o);++a<o;)i[a]=e[a][t];return r}(arguments)}function $u(e,t,n,r){var o,a,i=n-t+1,l=null!==(o=Math.floor(r/100*i))&&void 0!==o?o:1,s=null!==(a=Math.floor(i/l))&&void 0!==a?a:1;if(isNaN(i)||!i||!s)return e;if(i/s<2)return e;var c=Math.max(0,t),d=Math.min(e.length-1,n),u=e.slice(0,c),v=e.slice(d+1,e.length),f=function(e,t){if(!t||0===t.length||t.length===e.length)return e;var n,r=t[t.length-1]-t[0]+1,o=Yu(t.map((function(t){return e[t][0]}))),a=Yu(t.map((function(t){return e[t][1]})));if(3===(null===(n=e[0])||void 0===n?void 0:n.length)){var i=Yu(t.map((function(t){return e[t][2]})));return Ju(Xu(o,r),Xu(a,r),Xu(i,r))}return Ju(Xu(o,r),Xu(a,r))}(e,function(e,t){for(var n=[],r=dt(t,2),o=r[0],a=r[1],i=a-o+1,l=Math.floor(i/e),s=0,c=Math.round((i-1)/(l-1)*s)+o;c<=a;)n.push(c),s++,c=Math.round((i-1)/(l-1)*s)+o;return n}(s,[c,d]));return[].concat(Lr(u),Lr(f),Lr(v))}function Qu(e){var t,n;return!0===(null==e||null===(t=e.interpolation)||void 0===t?void 0:t.interpolateOnAdd)||!0===(null==e||null===(n=e.interpolation)||void 0===n?void 0:n.interpolateOnEdit)}function ev(e,t,n){return(e+t+n)%t}function tv(e,t,n,r){var o=dt(e,3),a=o[1],i=o[2],l=dt(t,3),s=l[1],c=l[2],d=i.length,u=c.length,v=e[0],f=t[0];if(!(i[v]&&c[f]&&i[a]&&c[s]))return[void 0,void 0];for(;v!==a&&f!==s;){if(n(c[f],i[v]))return[v,f];v=ev(v,d,r),f=ev(f,u,r)}return[void 0,void 0]}function nv(e,t,n){var r=e.interpolation,o=t;if(r){var a=r.knotsRatioPercentageOnAdd,i=r.knotsRatioPercentageOnEdit,l=r.interpolateOnAdd,s=void 0!==l&&l,c=r.interpolateOnEdit,d=n?i:a;if(n?void 0!==c&&c:s){var u=dt(n?function(e,t){var n=function(e,t){for(var n=0;n<e.length;n++)for(var r=0;r<t.length;r++)if(0===Tu(e[n],t[r]))return[n,r]}(e,t)||[],r=dt(n,2),o=r[0],a=r[1],i=function(e,t){return!1===function(e,t){return Tu(e,t)<.001}(e,t)},l=dt(tv([ev(o,e.length,1),o,e],[ev(a,t.length,1),a,t],i,1),2),s=l[0],c=l[1];return[s,dt(tv([ev(s,e.length,-1),s,e],[ev(c,t.length,-1),c,t],i,-1),1)[0]]}(t,n):[0,t.length-1],2),v=u[0],f=u[1];return t[v]&&t[f]?$u(t,v,f,d):t}}return o}function rv(e,t){var n=e[0],r=e[e.length-1],o=xs.vec2.create();xs.vec2.set(o,r[0]-n[0],r[1]-n[1]),xs.vec2.normalize(o,o);var a=xs.vec2.create(),i=xs.vec2.create();xs.vec2.set(a,-o[1],o[0]),xs.vec2.set(i,o[1],-o[0]);for(var l=[(n[0]+r[0])/2,(n[1]+r[1])/2],s={dist:0,index:null},c=0;c<e.length;c++){var d=e[c],u=xs.vec2.dist(d,l);u>s.dist&&(s.dist=u,s.index=c)}return[e[s.index],l].map(t.canvasToWorld)}var ov=bu,av=Iu,iv=fu,lv=yu;function sv(e,t,n){this.isDrawing=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,J.getEnabledElement)(a).viewport,s=lv(l,this.configuration.subPixelResolution),c=s.spacing,d=s.xDir,u=s.yDir;this.drawData={canvasPoints:[i],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:c,xDir:d,yDir:u,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),gs(a)}function cv(e){Ke.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),fs(e)}function dv(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,J.getEnabledElement)(r),l=i.renderingEngine,s=i.viewport,c=this.commonData,d=c.annotation,u=c.viewportIdsToRender,v=c.xDir,f=c.yDir,g=c.spacing,h=c.movingTextBox,p=this.drawData,m=p.polylineIndex,w=p.canvasPoints,E=w[w.length-1],y=s.canvasToWorld(E),I=xs.vec3.create();xs.vec3.subtract(I,o,y);var b=Math.abs(xs.vec3.dot(I,v)),C=Math.abs(xs.vec3.dot(I,f));if(!(b<=g[0]&&C<=g[1])){if(h){this.isDrawing=!1;var _=t.deltaPoints.world,T=d.data.handles.textBox,O=T.worldPosition;O[0]+=_[0],O[1]+=_[1],O[2]+=_[2],T.hasMoved=!0}else{var D=this.findCrossingIndexDuringCreate(e);if(void 0!==D)this.applyCreateOnCross(e,D);else{var S=ov(r,w,a,this.commonData);this.drawData.polylineIndex=m+S}}ca(l,u)}}function uv(e){var t=this.configuration.allowOpenContours,n=this.drawData.canvasPoints,r=n[0],o=n[n.length-1],a=e.detail.element;t&&!av(r,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(a):this.completeDrawClosedContour(a)}function vv(e){this.removeCrossedLinesOnCompleteDraw();var t=this.drawData.canvasPoints;if(this.haltDrawing(e,t))return!1;var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,J.getEnabledElement)(e),i=a.viewport,l=a.renderingEngine;ov(e,t,t[0],this.commonData),t.pop();var s=(Qu(this.configuration)?nv(this.configuration,t):t).map((function(e){return i.canvasToWorld(e)}));return r.data.polyline=s,r.data.isOpenContour=!1,r.data.handles.textBox.hasMoved||this.triggerAnnotationCompleted(r),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,ca(l,o),this.deactivateDraw(e),!0}function fv(){var e=this.drawData.canvasPoints,t=e.length,n=[e[0],e[t-1]],r=e.slice(0,-1).slice(1),o=iv(r,n[0],n[1],!1);if(o){var a=o[1];this.drawData.canvasPoints=e.splice(0,a)}}function gv(e){var t=this.drawData.canvasPoints;if(this.haltDrawing(e,t))return!1;var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,J.getEnabledElement)(e),i=a.viewport,l=a.renderingEngine,s=(Qu(this.configuration)?nv(this.configuration,t):t).map((function(e){return i.canvasToWorld(e)}));r.data.polyline=s,r.data.isOpenContour=!0;var c=r.data.handles.textBox;return r.data.handles.points=[s[0],s[s.length-1]],r.data.isOpenUShapeContour&&(r.data.openUShapeContourVectorToPeak=rv(t,i)),c.hasMoved||this.triggerAnnotationCompleted(r),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,ca(l,o),this.deactivateDraw(e),!0}function hv(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.drawData.canvasPoints.slice(0,-1),l=iv(i,o,a,!1);if(void 0!==l)return l[0]}function pv(e,t){var n=e.detail.element,r=this.drawData.canvasPoints,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender;ov(n,r,r[t],this.commonData),r.pop();for(var l=0;l<t;l++)r.shift();this.completeDrawClosedContour(n)&&this.activateClosedContourEdit(e,a,i)}function mv(e){var t=this.configuration.allowOpenContours,n=this.drawData.canvasPoints,r=n[0],o=n[n.length-1];t&&!av(r,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function wv(e,t){if(function(e,t){var n=Math.max(3*t,3);return e.length<n}(t,this.configuration.subPixelResolution)){var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,J.getEnabledElement)(e).renderingEngine;return at(r.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,ca(a,o),this.deactivateDraw(e),!0}return!1}var Ev=function(e){e.activateDraw=sv.bind(e),e.deactivateDraw=cv.bind(e),e.applyCreateOnCross=pv.bind(e),e.findCrossingIndexDuringCreate=hv.bind(e),e.completeDrawOpenContour=gv.bind(e),e.removeCrossedLinesOnCompleteDraw=fv.bind(e),e.mouseDragDrawCallback=dv.bind(e),e.mouseUpDrawCallback=uv.bind(e),e.completeDrawClosedContour=vv.bind(e),e.cancelDrawing=mv.bind(e),e.haltDrawing=wv.bind(e)},yv=bu,Iv=fu;function bv(e,t){var n=e.detail,r=n.element,o=n.currentPoints,a=n.lastPoints,i=o.canvas,l=a.canvas,s=this.editData,c=s.editCanvasPoints,d=s.prevCanvasPoints,u=Iv(d,i,l,t);if(u)this.editData.startCrossingIndex=u[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(c.length>this.configuration.checkCanvasEditFallbackProximity){for(var v=c[0],f=[],g=0;g<d.length;g++){var h=d[g],p=xs.vec2.distance(h,v);f.push({distance:p,index:g})}f.sort((function(e,t){return e.distance-t.distance}));var m=[f[0],f[1]],w=Math.min(m[0].index,m[1].index);this.editData.startCrossingIndex=w}else{var E=xs.vec2.create();xs.vec2.subtract(E,c[1],c[0]),xs.vec2.normalize(E,E);var y=[c[0][0]-6*E[0],c[0][1]-6*E[1]],I=Iv(d,y,c[0],t);if(I){var b=[y];yv(r,b,c[0],this.commonData),c.unshift.apply(c,b),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=c.length-1,this.editData.startCrossingIndex=I[0]}}}function Cv(e){for(var t=this.editData,n=t.editCanvasPoints,r=t.prevCanvasPoints,o=0,a=0;a<n.length-1;a++){var i=[n[a],n[a+1]];if(o++,Iv(r,i[0],i[1],e))break}n.splice(0,o),this.editData.editIndex=n.length-1}function _v(e,t){var n=e.detail,r=n.currentPoints,o=n.lastPoints,a=r.canvas,i=o.canvas,l=this.editData.prevCanvasPoints;return!!Iv(l,a,i,t)}function Tv(e){for(var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=r.length-1;o>0;o--){var a=[r[o],r[o-1]],i=!!Iv(n,a[0],a[1],e);if(r.pop(),i)break}}function Ov(){var e=this.editData,t=e.editCanvasPoints,n=e.prevCanvasPoints;if(void 0!==e.startCrossingIndex){for(var r=t[t.length-1],o=[],a=0;a<n.length;a++){var i=n[a],l=xs.vec2.distance(i,r);o.push({distance:l,index:a})}o.sort((function(e,t){return e.distance-t.distance}));for(var s=t.slice(0,-1),c=0;c<o.length;c++){var d=o[c].index,u=n[d],v=t[t.length-1];if(!Iv(s,u,v,!1))return d}return-1}}function Dv(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.editData.editCanvasPoints,l=i.slice(0,-2),s=Iv(l,o,a,!1);if(s)for(var c=s[0],d=i.length-c,u=0;u<d;u++)i.pop()}var Sv=function(e){e.checkForFirstCrossing=bv.bind(e),e.removePointsUpUntilFirstCrossing=Cv.bind(e),e.checkForSecondCrossing=_v.bind(e),e.findSnapIndex=Ov.bind(e),e.removePointsAfterSecondCrossing=Tv.bind(e),e.checkAndRemoveCrossesOnEditLine=Dv.bind(e)},kv=yu,Mv=bu,xv=_u;function Rv(e,t,n){this.isEditingClosed=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,J.getEnabledElement)(a).viewport,s=t.data.polyline.map(l.worldToCanvas),c=kv(l,this.configuration.subPixelResolution),d=c.spacing,u=c.xDir,v=c.yDir;this.editData={prevCanvasPoints:s,editCanvasPoints:[i],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:v,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpClosedContourEditCallback),gs(a)}function Pv(e){Ke.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpClosedContourEditCallback),fs(e)}function Av(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,J.getEnabledElement)(r),l=i.renderingEngine,s=i.viewport,c=this.commonData,d=c.viewportIdsToRender,u=c.xDir,v=c.yDir,f=c.spacing,g=this.editData,h=g.editIndex,p=g.editCanvasPoints,m=g.startCrossingIndex,w=p[p.length-1],E=s.canvasToWorld(w),y=xs.vec3.create();xs.vec3.subtract(y,o,E);var I=Math.abs(xs.vec3.dot(y,u)),b=Math.abs(xs.vec3.dot(y,v));if(!(I<=f[0]&&b<=f[1])){void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);var C=h+Mv(r,p,a,this.commonData);this.editData.editIndex=C,void 0===m&&p.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==m&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),ca(l,d)):this.finishEditAndStartNewEdit(e)}}function Nv(e){var t=e.detail.element,n=(0,J.getEnabledElement)(t),r=n.viewport,o=n.renderingEngine,a=this.commonData,i=a.annotation,l=a.viewportIdsToRender,s=this.editData,c=s.fusedCanvasPoints,d=s.editCanvasPoints,u=c.map((function(e){return r.canvasToWorld(e)}));i.data.polyline=u,i.data.isOpenContour=!1,this.triggerAnnotationModified(i,n);var v=d.pop();this.editData={prevCanvasPoints:c,editCanvasPoints:[v],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},ca(o,l)}function Lv(e){var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=t.startCrossingIndex,a=t.snapIndex;if(void 0!==o&&void 0!==a){var i,l,s=e.detail.element,c=Lr(r);Mv(s,c,n[a],this.commonData),c.length>r.length&&c.pop(),o>a?(i=a,l=o):(i=o,l=a);for(var d=xs.vec2.distance(n[i],c[0]),u=xs.vec2.distance(n[i],c[c.length-1]),v=xs.vec2.distance(n[l],c[0]),f=xs.vec2.distance(n[l],c[c.length-1]),g=[],h=0;h<i;h++){var p=n[h];g.push([p[0],p[1]])}var m=d+f,w=u+v;if(m<w)for(var E=0;E<c.length;E++){var y=c[E];g.push([y[0],y[1]])}else for(var I=c.length-1;I>=0;I--){var b=c[I];g.push([b[0],b[1]])}for(var C=l;C<n.length;C++){var _=n[C];g.push([_[0],_[1]])}for(var T=[],O=i;O<l;O++){var D=n[O];T.push([D[0],D[1]])}if((m=v+u)<(w=f+d))for(var S=0;S<c.length;S++){var k=c[S];T.push([k[0],k[1]])}else for(var M=c.length-1;M>=0;M--){var x=c[M];T.push([x[0],x[1]])}return xv(g)>xv(T)?g:T}}function Uv(e){var t=e.detail.element;this.completeClosedContourEdit(t)}function Vv(e){var t=(0,J.getEnabledElement)(e),n=t.viewport,r=t.renderingEngine,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.editData,s=l.fusedCanvasPoints,c=l.prevCanvasPoints;if(s){var d=(Qu(this.configuration)?nv(this.configuration,s,c):s).map((function(e){return n.canvasToWorld(e)}));a.data.polyline=d,a.data.isOpenContour=!1,a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,ca(r,i),this.deactivateClosedContourEdit(e)}function jv(e){this.completeClosedContourEdit(e)}var Bv=function(e){e.activateClosedContourEdit=Rv.bind(e),e.deactivateClosedContourEdit=Pv.bind(e),e.mouseDragClosedContourEditCallback=Av.bind(e),e.mouseUpClosedContourEditCallback=Uv.bind(e),e.finishEditAndStartNewEdit=Nv.bind(e),e.fuseEditPointsWithClosedContour=Lv.bind(e),e.cancelClosedContourEdit=jv.bind(e),e.completeClosedContourEdit=Vv.bind(e)},Wv=bu,Fv=yu;function Hv(e,t,n){this.isEditingOpen=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,J.getEnabledElement)(a).viewport,s=t.data.polyline.map(l.worldToCanvas),c=Fv(l,this.configuration.subPixelResolution),d=c.spacing,u=c.xDir,v=c.yDir;this.editData={prevCanvasPoints:s,editCanvasPoints:[i],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:v,movingTextBox:!1},Ke.isInteractingWithTool=!0,a.addEventListener(Q.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(Q.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(Q.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(Q.TOUCH_TAP,this.mouseUpOpenContourEditCallback),gs(a)}function Gv(e){Ke.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(Q.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(Q.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(Q.TOUCH_TAP,this.mouseUpOpenContourEditCallback),fs(e)}function qv(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,J.getEnabledElement)(r),l=i.renderingEngine,s=i.viewport,c=this.commonData,d=c.viewportIdsToRender,u=c.xDir,v=c.yDir,f=c.spacing,g=this.editData,h=g.editIndex,p=g.editCanvasPoints,m=g.startCrossingIndex,w=p[p.length-1],E=s.canvasToWorld(w),y=xs.vec3.create();xs.vec3.subtract(y,o,E);var I=Math.abs(xs.vec3.dot(y,u)),b=Math.abs(xs.vec3.dot(y,v));if(!(I<=f[0]&&b<=f[1])){void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);var C=h+Wv(r,p,a,this.commonData);this.editData.editIndex=C,void 0===m&&p.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==m&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),ca(l,d)}}function zv(e){var t=e.detail.element,n=(0,J.getEnabledElement)(t),r=n.viewport,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.fuseEditPointsForOpenContourEndEdit().map((function(e){return r.canvasToWorld(e)}));a.data.polyline=l,a.data.isOpenContour=!0,a.data.handles.points=[l[0],l[l.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,n),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(t),this.activateOpenContourEndEdit(e,a,i,null)}function Kv(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.editData,l=i.snapIndex,s=i.prevCanvasPoints;if(void 0===i.startCrossingIndex||void 0===l)return!1;if(-1===l)return!0;if(0!==l&&l!==s.length-1)return!1;var c=o,d=a,u=s[l],v=xs.vec2.create(),f=xs.vec2.create();xs.vec2.set(v,c[0]-d[0],c[1]-d[1]),xs.vec2.set(f,c[0]-u[0],c[1]-u[1]);var g=xs.vec2.dot(v,f),h=Math.sqrt(v[0]*v[0]+v[1]*v[1]),p=Math.sqrt(f[0]*f[0]+f[1]*f[1]);return Math.acos(g/(h*p))<Math.PI/2}function Yv(){var e=this.editData,t=e.snapIndex,n=e.prevCanvasPoints,r=e.editCanvasPoints,o=e.startCrossingIndex,a=[];if(0===t)for(var i=n.length-1;i>=o;i--){var l=n[i];a.push([l[0],l[1]])}else for(var s=0;s<o;s++){var c=n[s];a.push([c[0],c[1]])}if(xs.vec2.distance(n[o],r[0])<xs.vec2.distance(n[o],r[r.length-1]))for(var d=0;d<r.length;d++){var u=r[d];a.push([u[0],u[1]])}else for(var v=r.length-1;v>=0;v--){var f=r[v];a.push([f[0],f[1]])}return a}function Xv(e){var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=t.startCrossingIndex,a=t.snapIndex;if(void 0!==o&&void 0!==a){var i,l,s=e.detail.element,c=Lr(r);Wv(s,c,n[a],this.commonData),c.length>r.length&&c.pop(),o>a?(i=a,l=o):(i=o,l=a);for(var d=xs.vec2.distance(n[i],c[0]),u=xs.vec2.distance(n[i],c[c.length-1]),v=xs.vec2.distance(n[l],c[0]),f=xs.vec2.distance(n[l],c[c.length-1]),g=[],h=0;h<i;h++){var p=n[h];g.push([p[0],p[1]])}if(d+f<u+v)for(var m=0;m<c.length;m++){var w=c[m];g.push([w[0],w[1]])}else for(var E=c.length-1;E>=0;E--){var y=c[E];g.push([y[0],y[1]])}for(var I=l;I<n.length;I++){var b=n[I];g.push([b[0],b[1]])}return g}}function Zv(e){var t=e.detail.element,n=(0,J.getEnabledElement)(t),r=n.viewport,o=n.renderingEngine,a=this.commonData,i=a.annotation,l=a.viewportIdsToRender,s=this.editData,c=s.fusedCanvasPoints,d=s.editCanvasPoints,u=c.map((function(e){return r.canvasToWorld(e)}));i.data.polyline=u,i.data.isOpenContour=!0,i.data.handles.points=[u[0],u[u.length-1]],this.triggerAnnotationModified(i,n);var v=d.pop();this.editData={prevCanvasPoints:c,editCanvasPoints:[v],startCrossingIndex:void 0,editIndex:0},ca(o,l)}function Jv(e){var t=e.detail.element;this.completeOpenContourEdit(t)}function $v(e){var t=(0,J.getEnabledElement)(e),n=t.viewport,r=t.renderingEngine,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.editData,s=l.fusedCanvasPoints,c=l.prevCanvasPoints;if(s){var d=(Qu(this.configuration)?nv(this.configuration,s,c):s).map((function(e){return n.canvasToWorld(e)}));a.data.polyline=d,a.data.isOpenContour=!0,a.data.handles.points=[d[0],d[d.length-1]],a.data.isOpenUShapeContour&&(a.data.openUShapeContourVectorToPeak=rv(s,n)),a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,ca(r,i),this.deactivateOpenContourEdit(e)}function Qv(e){this.completeOpenContourEdit(e)}var ef=function(e){e.activateOpenContourEdit=Hv.bind(e),e.deactivateOpenContourEdit=Gv.bind(e),e.mouseDragOpenContourEditCallback=qv.bind(e),e.mouseUpOpenContourEditCallback=Jv.bind(e),e.fuseEditPointsWithOpenContour=Xv.bind(e),e.finishEditOpenOnSecondCrossing=Zv.bind(e),e.checkIfShouldOverwriteAnEnd=Kv.bind(e),e.fuseEditPointsForOpenContourEndEdit=Yv.bind(e),e.openContourEditOverwriteEnd=zv.bind(e),e.cancelOpenContourEdit=Qv.bind(e),e.completeOpenContourEdit=$v.bind(e)},tf=yu;function nf(e,t,n,r){this.isDrawing=!0;var o=e.detail.element,a=(0,J.getEnabledElement)(o).viewport,i=tf(a,this.configuration.subPixelResolution),l=i.spacing,s=i.xDir,c=i.yDir,d=t.data.polyline.map(a.worldToCanvas);0===t.data.handles.activeHandleIndex&&d.reverse();var u=!1;r.worldPosition&&(u=!0),this.drawData={canvasPoints:d,polylineIndex:d.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:s,yDir:c,movingTextBox:u},Ke.isInteractingWithTool=!0,o.addEventListener(Q.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(Q.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(Q.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(Q.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(Q.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(Q.TOUCH_TAP,this.mouseUpDrawCallback),gs(o)}var rf=function(e){e.activateOpenContourEndEdit=nf.bind(e)},of=Iu;function af(e,t){var n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},r=this.getStyle("lineWidth",n,t),o=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===r?void 0:r,lineDash:void 0===o?void 0:o,connectLastToFirst:!t.data.isOpenContour}}function lf(e,t,n){var r;null!=e&&null!==(r=e.viewport)&&void 0!==r&&r.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){var n=e.viewport;return rv(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function sf(e,t,n){var r=e.viewport,o=this._getRenderingOptions(e,n),a=n.data.polyline.map((function(e){return r.worldToCanvas(e)}));$s(t,n.annotationUID,"1",a,o)}function cf(e,t,n){var r,o=e.viewport,a=this._getRenderingOptions(e,n),i=n.data.polyline.map((function(e){return o.worldToCanvas(e)}));$s(t,n.annotationUID,"1",i,a);var l=n.data.handles.activeHandleIndex;if(!0===(null===(r=this.configuration.alwaysRenderOpenContourHandles)||void 0===r?void 0:r.enabled)){var s=this.configuration.alwaysRenderOpenContourHandles.radius,c=[i[0],i[i.length-1]];0===l?c.shift():1===l&&c.pop(),Xs(t,n.annotationUID,"0",c,{color:a.color,handleRadius:s})}if(null!==l){var d=i[0===l?0:i.length-1];Xs(t,n.annotationUID,"1",[d],{color:a.color})}}function df(e,t,n){var r=e.viewport,o=n.data,a=o.polyline,i=o.openUShapeContourVectorToPeak;if(this.renderOpenContour(e,t,n),i){var l=r.worldToCanvas(a[0]),s=r.worldToCanvas(a[a.length-1]),c=[r.worldToCanvas(i[0]),r.worldToCanvas(i[1])],d=this._getRenderingOptions(e,n);$s(t,n.annotationUID,"first-to-last",[l,s],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),$s(t,n.annotationUID,"midpoint-to-open-contour",[c[0],c[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}}function uf(e,t,n){var r=this._getRenderingOptions(e,n),o=this.configuration.allowOpenContours,a=this.drawData.canvasPoints;if(r.connectLastToFirst=!1,$s(t,n.annotationUID,"1",a,r),o){var i=a[0],l=a[a.length-1];of(i,l,this.configuration.closeContourProximity)?$s(t,n.annotationUID,"2",[l,i],r):Xs(t,n.annotationUID,"0",[i],{color:r.color,handleRadius:2})}}function vf(e,t,n){var r=this.editData.fusedCanvasPoints;if(void 0!==r){var o=this._getRenderingOptions(e,n);$s(t,n.annotationUID,"preview-1",r,o)}else this.renderClosedContour(e,t,n)}function ff(e,t,n){var r=this.editData.fusedCanvasPoints;if(void 0!==r){var o=this._getRenderingOptions(e,n);$s(t,n.annotationUID,"preview-1",r,o)}else this.renderOpenContour(e,t,n)}var gf=function(e){e.renderContour=lf.bind(e),e.renderClosedContour=sf.bind(e),e.renderOpenContour=cf.bind(e),e.renderOpenUShapedContour=df.bind(e),e.renderContourBeingDrawn=uf.bind(e),e.renderClosedContourBeingEdited=vf.bind(e),e.renderOpenContourBeingEdited=ff.bind(e),e._getRenderingOptions=af.bind(e)};function hf(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var pf=Cu,mf=1-J.CONSTANTS.EPSILON,wf=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1,getTextLines:Ef,statsCalculator:xd}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"commonData",void 0),ae(ga(e),"isDrawing",!1),ae(ga(e),"isEditingClosed",!1),ae(ga(e),"isEditingOpen",!1),ae(ga(e),"activateDraw",void 0),ae(ga(e),"activateClosedContourEdit",void 0),ae(ga(e),"activateOpenContourEdit",void 0),ae(ga(e),"activateOpenContourEndEdit",void 0),ae(ga(e),"cancelDrawing",void 0),ae(ga(e),"cancelClosedContourEdit",void 0),ae(ga(e),"cancelOpenContourEdit",void 0),ae(ga(e),"renderContour",void 0),ae(ga(e),"renderContourBeingDrawn",void 0),ae(ga(e),"renderClosedContourBeingEdited",void 0),ae(ga(e),"renderOpenContourBeingEdited",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine,c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=ad(o,e.getToolName()),g=l.getFrameOfReferenceUID(),h={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:g,referencedImageId:v,toolName:e.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[Lr(a)],label:"",cachedStats:{}}};return rt(h,o),e.activateDraw(t,h,f),t.preventDefault(),ca(s,f),h})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=ad(t.detail.element,e.getToolName());e.activateOpenContourEndEdit(t,n,o,r)})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=ad(t.detail.element,e.getToolName());n.data.isOpenContour?e.activateOpenContourEdit(t,n,r):e.activateClosedContourEdit(t,n,r)})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){for(var o=(0,J.getEnabledElement)(e).viewport,a=t.data.polyline,i=o.worldToCanvas(a[0]),l=1;l<a.length;l++){var s=i,c=o.worldToCanvas(a[l]);if(!0===pf(n,s,c,r))return!0;i=c}if(t.data.isOpenContour)return!1;var d=o.worldToCanvas(a[0]),u=o.worldToCanvas(a[a.length-1]);return!0===pf(n,d,u,r)})),ae(ga(e),"cancel",(function(t){var n=e.isDrawing,r=e.isEditingOpen,o=e.isEditingClosed;n?e.cancelDrawing(t):r?e.cancelOpenContourEdit(t):o&&e.cancelClosedContourEdit(t)})),ae(ga(e),"triggerAnnotationModified",(function(e,t){var n=t.viewportId,r=t.renderingEngineId,o=Q.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:r};(0,J.triggerEvent)(J.eventTarget,o,a)})),ae(ga(e),"triggerAnnotationCompleted",(function(e){var t=Q.ANNOTATION_COMPLETED,n={annotation:e};(0,J.triggerEvent)(J.eventTarget,t,n)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=t.renderingEngine,s=i.element,c=e.getTargetId(i),d=nt(e.getToolName(),s);if(null===(r=d)||void 0===r||!r.length)return a;if(null===(o=d=e.filterInteractableAnnotationsForElement(s,d))||void 0===o||!o.length)return a;var u=e.isDrawing,v=e.isEditingOpen,f=e.isEditingClosed;if(u||v||f){var g=e.commonData.annotation.annotationUID;d.forEach((function(r){if(r.annotationUID===g)if(u)e.renderContourBeingDrawn(t,n,r);else if(f)e.renderClosedContourBeingEdited(t,n,r);else{if(!v)throw new Error("Unknown ".concat(e.getToolName()," annotation rendering state"));e.renderOpenContourBeingEdited(t,n,r)}else e.renderContour(t,n,r)})),a=!0}else d.forEach((function(r){e.renderContour(t,n,r)}));return e.configuration.calculateStats?(d.forEach((function(r){var o,a,s,d=null===(o=e.commonData)||void 0===o?void 0:o.annotation.annotationUID;if(r.annotationUID!==d||null!==(a=e.commonData)&&void 0!==a&&a.movingTextBox){if(null===(s=e.commonData)||void 0===s||!s.movingTextBox){var u=r.data;u.cachedStats[c]&&null!=u.cachedStats[c].areaUnit?r.invalidated&&e._throttledCalculateCachedStats(r,i,l,t):(u.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,i,l,t))}e._renderStats(r,i,t,n)}})),a):void 0})),ae(ga(e),"_calculateCachedStats",(function(t,n,r,o){for(var a=t.data,i=a.cachedStats,l=a.polyline,s=Object.keys(i),c=function(){var o,a,c,u=s[d],v=e.getTargetIdImage(u,r);if(!v)return"continue";var f=v.imageData,g=v.metadata,h=l.map((function(e){return n.worldToCanvas(e)})),p=h[0],m=n.canvasToWorld(p),w=n.canvasToWorld([p[0]+1,p[1]]),E=n.canvasToWorld([p[0],p[1]+1]),y=xs.vec3.distance(m,w),I=xs.vec3.distance(m,E),b=yd(v),C=_u(h)/b/b;C*=y*I;var _=J.utilities.transformWorldToIndex(f,l[0]);_[0]=Math.floor(_[0]),_[1]=Math.floor(_[1]),_[2]=Math.floor(_[2]);for(var T=_[0],O=_[0],D=_[1],S=_[1],k=_[2],M=_[2],x=1;x<l.length;x++){var R=J.utilities.transformWorldToIndex(f,l[x]);R[0]=Math.floor(R[0]),R[1]=Math.floor(R[1]),R[2]=Math.floor(R[2]),T=Math.min(T,R[0]),O=Math.max(O,R[0]),D=Math.min(D,R[1]),S=Math.max(S,R[1]),k=Math.min(k,R[2]),M=Math.max(M,R[2])}var P=.01*(O-T),A=.01*(S-D),N=.01*(M-k),L=[[T=Math.floor(T-P),O=Math.ceil(O+P)],[D=Math.floor(D-A),S=Math.ceil(S+A)],[k=Math.floor(k-N),M=Math.ceil(M+N)]],U=f.indexToWorld([O,S,M]),V=n.worldToCanvas(U),j=0,B=[],W=0,F=pc(f,(function(e,t){var r=!0,o=n.worldToCanvas(e);return o[1]!=j&&(W=0,j=o[1],(B=function(e,t,n){for(var r=[],o=function(e,t,n){var r,o,a=[];arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var i=r;i<e.length;i++)hu(t,n,e[o],e[i])&&a.push([o,i]),o=i;return a}(e,t,n,!(arguments.length>3&&void 0!==arguments[3])||arguments[3]),a=0;a<o.length;a++){var i=wu(t,n,e[o[a][0]],e[o[a][1]]);r.push(i)}return r}(h,o,[V[0],o[1]])).sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),B.length&&o[0]>B[0][0]&&(B.shift(),W++),W%2==0&&(r=!1),r}),e.configuration.statsCalculator.statsCallback,L),H={isPreScaled:Sd(n,u),isSuvScaled:e.isSuvScaled(n,u,t.metadata.referencedImageId)},G=Dd(g.Modality,t.metadata.referencedImageId,H),q=e.configuration.statsCalculator.getStatistics();i[u]={Modality:g.Modality,area:C,mean:null===(o=q[1])||void 0===o?void 0:o.value,max:null===(a=q[0])||void 0===a?void 0:a.value,stdDev:null===(c=q[3])||void 0===c?void 0:c.value,statsArray:q,pointsInShape:F,areaUnit:Ed(0,v),modalityUnit:G}},d=0;d<s.length;d++)c();return e.triggerAnnotationModified(t,o),t.invalidated=!1,i})),ae(ga(e),"_renderStats",(function(t,n,r,o){var a,i=t.data,l=e.getTargetId(n),s={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:r.viewport.id},c=e.getLinkedTextBoxStyle(s,t);if(c.visibility){var d=e.configuration.getTextLines(i,l);if(d&&0!==d.length){var u=i.polyline.map((function(e){return n.worldToCanvas(e)}));if(!i.handles.textBox.hasMoved){var v=Td(u);i.handles.textBox.worldPosition=n.canvasToWorld(v)}var f=n.worldToCanvas(i.handles.textBox.worldPosition),g=rc(o,null!==(a=t.annotationUID)&&void 0!==a?a:"","1",d,f,u,{},c),h=g.x,p=g.y,m=g.width,w=g.height;i.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([h,p]),topRight:n.canvasToWorld([h+m,p]),bottomLeft:n.canvasToWorld([h,p+w]),bottomRight:n.canvasToWorld([h+m,p+w])}}}})),Ev(ga(e)),Sv(ga(e)),Bv(ga(e)),ef(ga(e)),rf(ga(e)),gf(ga(e)),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"filterInteractableAnnotationsForElement",value:function(e,t){if(t&&t.length){var n,r=(0,J.getEnabledElement)(e).viewport;if(r instanceof J.StackViewport)n=cd(r,t);else{if(!(r instanceof J.VolumeViewport))throw new Error("Viewport Type ".concat(r.type," not supported"));var o=r.getCamera(),a=J.utilities.getTargetVolumeAndSpacingInNormalDir(r,o).spacingInNormalDirection;n=this.filterAnnotationsWithinSlice(t,o,a)}return n}}},{key:"filterAnnotationsWithinSlice",value:function(e,t,n){var r=t.viewPlaneNormal,o=e.filter((function(e){var t=e.metadata.viewPlaneNormal,n=Math.abs(xs.vec3.dot(r,t))>mf;return t&&n}));if(!o.length)return[];var a,i=n/2,l=t.focalPoint,s=[],c=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return hf(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?hf(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(c.s();!(a=c.n()).done;){var d=a.value,u=d.data.polyline[0];if(d.isVisible){var v=xs.vec3.create();xs.vec3.sub(v,l,u);var f=xs.vec3.dot(v,r);Math.abs(f)<i&&s.push(d)}}}catch(e){c.e(e)}finally{c.f()}return s}}]),o}(hd);function Ef(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.stdDev,i=n.max,l=n.isEmptyArea,s=n.areaUnit,c=n.modalityUnit,d=[];if(r){var u=l?"Area: Oblique not supported":"Area: ".concat(yc(r)," ").concat(s);d.push(u)}return o&&d.push("Mean: ".concat(yc(o)," ").concat(c)),i&&d.push("Max: ".concat(yc(i)," ").concat(c)),a&&d.push("Std Dev: ".concat(yc(a)," ").concat(c)),d}ae(wf,"toolName",void 0),wf.toolName="PlanarFreehandROI";var yf=wf;function If(e,t,n){if(function(e,t,n){var r;if(null==t||null===(r=t.data)||void 0===r||!r.polyline||n<=0)return!0;if(!e.viewport)return!0;var o=e.renderingEngineId,a=e.viewportId,i=e.FrameOfReferenceUID,l=Fr(a,o);if(t.metadata.FrameOfReferenceUID!==i)return!0;if(!l)return!0;var s=l.getToolInstance(t.metadata.toolName);return!(s instanceof yf)||s.isDrawing||s.isEditingOpen||s.isEditingClosed}(e,t,n))return!1;var r=e.viewport,o=t.data.polyline.map(r.worldToCanvas),a=$u(o,0,o.length,n);return a!==o&&(t.data.polyline=a.map(r.canvasToWorld),!0)}var bf={interpolateAnnotation:If},Cf={};function _f(e,t){var n=(0,J.getEnabledElement)(e).viewportId;Cf[n]=t}function Tf(e){var t=(0,J.getEnabledElement)(e).viewportId;return Cf[t]}var Of=J.Enums.RequestType.Prefetch,Df=0;function Sf(e,t){e=Math.round(e)||0;var n=[],r=(t=Math.round(t)||0)-e+1;if(r<=0)return n;for(;r--;)n[r]=t--;return n}function kf(e){var t=(0,J.getEnabledElement)(e);if(!t)return null;var n=t.viewport;if(!(n instanceof J.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function Mf(e){return function(t){var n,r=t.detail;try{n=kf(e)}catch(e){return}if(n&&n.imageIds&&0!==n.imageIds.length){var o=n.imageIds.indexOf(r.imageId);if(!(o<0)){var a=Tf(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(o)}}}}var xf,Rf=function(e){var t=new Set(e.imageIds);return function(e){return e.type!==Of||!t.has(e.additionalDetails.imageId)}},Pf={maxImagesToPrefetch:1/0,preserveExistingPool:!0};function Af(e){var t,n,r=Tf(e);if(r){var o=r||{},a=kf(e);if(null!=a&&null!==(t=a.imageIds)&&void 0!==t&&t.length){var i=a.currentImageIdIndex;if(o.enabled&&(o.enabled=null===(n=o.indicesToRequest)||void 0===n?void 0:n.length),!1!==o.enabled&&(r.indicesToRequest.sort((function(e,t){return e-t})),o.indicesToRequest.slice().forEach((function(e){var t=a.imageIds[e];t&&(Math.abs(i-e)<6?J.cache.getImageLoadObject(t):J.cache.isLoaded(t))&&function(e){var t=o.indicesToRequest.indexOf(e);t>-1&&o.indicesToRequest.splice(t,1)}(e)})),o.indicesToRequest.length)){Pf.preserveExistingPool||J.imageLoadPoolManager.clearRequestStack(Of);for(var l,s,c,d,u,v,f=(l=o.indicesToRequest,s=a.currentImageIdIndex,c=0,d=l.length-1,l.forEach((function(e,t){e<s?c=Math.max(t,c):e>s&&(d=Math.min(t,d))})),{low:c,high:d}),g=f.low,h=f.high,p=[];g>=0||h<o.indicesToRequest.length;){var m=a.currentImageIdIndex,w=!(m-o.indicesToRequest[g]>Pf.maxImagesToPrefetch)&&g>=0,E=!(o.indicesToRequest[h]-m>Pf.maxImagesToPrefetch)&&h<o.indicesToRequest.length;if(!E&&!w)break;w&&(v=o.indicesToRequest[g--],u=a.imageIds[v],p.push(u)),E&&(v=o.indicesToRequest[h++],u=a.imageIds[v],p.push(u))}var y=function(e,t){return J.imageLoader.loadAndCacheImage(e,t)},I=(0,J.getConfiguration)().rendering.useNorm16Texture;p.forEach((function(e){var t={targetBuffer:{type:I?void 0:"Float32Array"},preScale:{enabled:!0},requestType:Of};J.imageLoadPoolManager.addRequest(y.bind(null,e,t),Of,{imageId:e},Df)}))}}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")}}function Nf(e){clearTimeout(xf),xf=setTimeout((function(){var t=e.target;try{Af(t)}catch(e){return}}),10)}var Lf,Uf={enable:function(e){var t=kf(e);if(t&&t.imageIds&&0!==t.imageIds.length){var n={indicesToRequest:Sf(0,t.imageIds.length-1),enabled:!0,direction:1},r=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(r,1),_f(e,n),Af(e),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Nf),e.addEventListener(J.Enums.Events.STACK_NEW_IMAGE,Nf);var o=Mf(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),J.eventTarget.addEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")},disable:function(e){clearTimeout(xf),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Nf);var t=Mf(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);var n=Tf(e);n&&n.indicesToRequest.length&&(n.enabled=!1,J.imageLoadPoolManager.clearRequestStack(Of))},getConfiguration:function(){return Pf},setConfiguration:function(e){Pf=e}},Vf={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1};function jf(e){var t,n,r=kf(e);if(null!=r&&null!==(t=r.imageIds)&&void 0!==t&&t.length){var o=Tf(e);if(o){var a=o||{};if(a.enabled&&(a.enabled=null===(n=a.indicesToRequest)||void 0===n?void 0:n.length),!1!==a.enabled){var i=a.indicesToRequest.slice(),l=r.currentImageIdIndex;if(i.forEach((function(e){var t=r.imageIds[e];t&&(Math.abs(l-e)<6?J.cache.getImageLoadObject(t):J.cache.isLoaded(t))&&d(e)})),a.indicesToRequest.length){Vf.preserveExistingPool||J.imageLoadPoolManager.filterRequests(Rf(r));var s=function(t,n){return J.imageLoader.loadAndCacheImage(t,n).then((function(){return function(t){var n;d(r.imageIds.indexOf(t));var o=J.cache.getCachedImageBasedOnImageURI(t),i=a.stats,l=(null==o||null===(n=o.image)||void 0===n?void 0:n.decodeTimeInMS)||0;if(l){var s;i.imageIds.set(t,l),i.decodeTimeInMS+=l;var c=(null==o||null===(s=o.image)||void 0===s?void 0:s.loadTimeInMS)||0;i.loadTimeInMS+=c}if(!a.indicesToRequest.length&&null!=o&&o.sizeInBytes){var u=o.sizeInBytes,v=J.cache.getMaxCacheSize()/4/u;if(a.cacheFill){if(i.imageIds.size){i.fillTime=Date.now()-i.start;var f=i.imageIds.size;i.fillSize=f,console.log("Done cache fill",i.fillTime,"ms",f,"items","average total time",yc(i.fillTime/f),"ms","average load",yc(i.loadTimeInMS/f),"ms","average decode",yc(i.decodeTimeInMS/f),"ms")}}else i.initialTime=Date.now()-i.start,i.initialSize=i.imageIds.size,Wf(e,v),jf(e)}}(t)}))},c=(0,J.getConfiguration)().rendering.useNorm16Texture;i.forEach((function(e){var t=r.imageIds[e],n={targetBuffer:{type:c?void 0:"Float32Array"},preScale:{enabled:!0},requestType:Of};J.imageLoadPoolManager.addRequest(s.bind(null,t,n),Of,{imageId:t},Df)}))}}}}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.");function d(e){var t=a.indicesToRequest.indexOf(e);t>-1&&a.indicesToRequest.splice(t,1)}}function Bf(e){clearTimeout(Lf),Lf=setTimeout((function(){var t=e.target;try{Wf(t),jf(t)}catch(e){return}}),5)}var Wf=function(e,t){var n=kf(e);if(n&&n.imageIds&&0!==n.imageIds.length){var r=n.currentImageIdIndex,o=Vf,a=o.maxAfter,i=void 0===a?2:a,l=o.minBefore,s=void 0===l?2:l,c=Vf.directionExtraImages,d=void 0===c?10:c,u=Tf(e)||{indicesToRequest:[],currentImageIdIndex:r,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},v=r-u.currentImageIdIndex;if(u.direction=v<0?-1:1,u.currentImageIdIndex=r,u.enabled=!0,u.stackCount<100&&(u.stackCount+=d),Math.abs(v)>i||!v)if(u.stackCount=0,t){var f=r/n.imageIds.length;s=Math.ceil(t*f),i=Math.ceil(t*(1-f)),u.cacheFill=!0}else u.cacheFill=!1;else v<0?(s+=u.stackCount,i=0):(i+=u.stackCount,s=0);for(var g=Math.max(0,r-s),h=Math.min(n.imageIds.length-1,r+i),p=[],m=r+1;m<=h;m++)p.push(m);for(var w=r-1;w>=g;w--)p.push(w);u.indicesToRequest=p,_f(e,u)}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")},Ff={enable:function(e){var t=kf(e);if(t&&t.imageIds&&0!==t.imageIds.length){Wf(e),jf(e),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Bf),e.addEventListener(J.Enums.Events.STACK_NEW_IMAGE,Bf);var n=Mf(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),J.eventTarget.addEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")},disable:function(e){clearTimeout(Lf),e.removeEventListener(J.Enums.Events.STACK_NEW_IMAGE,Bf);var t=Mf(e);J.eventTarget.removeEventListener(J.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);var n=Tf(e);n&&n.data.length&&(n.enabled=!1)},getConfiguration:function(){return Vf},setConfiguration:function(e){Vf=e}};function Hf(e,t){if(e instanceof J.VolumeViewport){var n=e.getCamera().focalPoint,r=[0,0,0];return xs.vec3.sub(r,t,n),function(e,t){var n=e.getCamera(),r=n.viewPlaneNormal,o=xs.vec3.dot(t,r),a=xs.vec3.fromValues(r[0],r[1],r[2]);if(xs.vec3.scale(a,a,o),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){var i=[0,0,0],l=[0,0,0];xs.vec3.add(i,n.focalPoint,a),xs.vec3.add(l,n.position,a),e.setCamera({focalPoint:i,position:l}),e.render()}}(e,r),!0}}var Gf=function(e,t){var n=t.frameNumbers||Lr(Array(e.numTimePoints).keys());if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){var r=function(e,t,n){var r=n.imageData,o=n.getScalarData(),a=o.length,i=[];i.length=a;for(var l=0,s=0,c=o.length;s<c;s++)0!==o[s]&&(i[l++]=s);i.length=l;var d=t.getScalarDataArrays(),u=[];if(d[0].length===a&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing)){for(var v=function(t){var n=[];e.forEach((function(e){var r=d[e];n.push(r[i[t]])})),u.push(n)},f=0;f<i.length;f++)v(f);return u}return pc(r,(function(){return!0}),(function(n){var r=n.pointLPS;if(0!==n.value){var o=Xc(t.imageData,t.dimensions,t.spacing,r),a=0,i=new Map;e.forEach((function(e){return i.set(e,0)}));pc(t.imageData,(function(){return!0}),(function(t){for(var n=t.index,r=0;r<e.length;r++){var o=d[r][n],l=e[r];i.set(l,i.get(l)+o)}a++}),o);var l=[];i.forEach((function(e){l.push(e/a)})),u.push(l)}})),u}(n,e,J.cache.getVolume(t.maskVolumeId));return r}if(t.imageCoordinate){var o=function(e,t,n){var r=n.dimensions,o=n.imageData.worldToIndex(t);if(o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o[2]=Math.floor(o[2]),!J.utilities.indexWithinDimensions(o,r))throw new Error("outside bounds");var a=r[0],i=r[0]*r[1],l=n.getScalarDataArrays(),s=[];return e.forEach((function(e){var t=l[e],n=o[2]*i+o[1]*a+o[0];s.push(t[n])})),s}(n,t.imageCoordinate,e);return o}},qf=function(e,t,n){var r=n||Lr(Array(e.numTimePoints).keys()),o=r.length;if(r.length<=1)throw new Error("Please provide two or more time points");var a=e.getScalarDataArrays(),i=a[0].length,l=new Float32Array(i);if(t===J.Enums.DynamicOperatorType.SUM){for(var s=0;s<o;s++)for(var c=a[r[s]],d=0;d<i;d++)l[d]+=c[d];return l}if(t===J.Enums.DynamicOperatorType.SUBTRACT){if(r.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(var u=0;u<i;u++)l[u]+=a[r[0]][u]-a[r[1]][u];return l}if(t===J.Enums.DynamicOperatorType.AVERAGE){for(var v=0;v<o;v++)for(var f=a[r[v]],g=0;g<i;g++)l[g]+=f[g];for(var h=0;h<i;h++)l[h]=l[h]/o;return l}};function zf(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Kf(e,t){if(t<e.length/3)return[e[3*t],e[3*t+1],e[3*t+2]]}function Yf(e){for(var t=e.getLines().getData(),n=0,r=new Map;n<t.length;){for(var o=t[n++],a=[],i=0;i<o;i++)a.push(t[n+i]);r.set(a[0],a),n+=o}for(var l=[],s=function(e){var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return zf(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?zf(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(e.entries());try{for(n.s();!(t=n.n()).done;){var r=dt(t.value,2),o=r[0];if(void 0!==r[1])return o}}catch(e){n.e(e)}finally{n.f()}return-1},c=s(r);-1!==c;){for(var d=[c];r.has(c);){var u=r.get(c)[1];r.has(u)&&d.push(u),r.delete(c),c=u}l.push(d),c=s(r)}return l.length?l:void 0}function Xf(e){var t=Yf(e);if(t){var n=e.getPoints().getData();return t.map((function(e){return e.map((function(e){return Kf(n,e)}))}))}}var Zf=function(e){return e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right",e}({}),Jf=function(e){return e&&e.upper>e.lower},$f=function(e,t){return!!e&&!!t&&e.lower===t.lower&&e.upper===t.upper},Qf=function(e){return!!e&&e.width>0&&e.height>0},eg=function(e,t){return!!e&&!!t&&e.width===t.width&&e.height===t.height};function tg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ng(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tg(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var rg=J.utilities.clamp,og=function(){function e(t){oe(this,e),ae(this,"_canvas",void 0),ae(this,"_imageRange",void 0),ae(this,"_voiRange",void 0),ae(this,"_colormap",void 0),ae(this,"_showFullImageRange",void 0),e.validateProps(t);var n=t.colormap,r=t.size,o=void 0===r?{width:20,height:100}:r,a=t.imageRange,i=void 0===a?{lower:0,upper:1}:a,l=t.voiRange,s=void 0===l?{lower:0,upper:1}:l,c=t.container,d=t.showFullPixelValueRange,u=void 0!==d&&d;this._colormap=n,this._imageRange=i,this._voiRange=s,this._showFullImageRange=u,this._canvas=this._createRootElement(o),c&&this.appendTo(c)}return re(e,[{key:"colormap",get:function(){return this._colormap},set:function(e){this._colormap=e,this.render()}},{key:"size",get:function(){var e=this._canvas;return{width:e.width,height:e.height}},set:function(e){var t=this._canvas;Qf(e)&&!eg(t,e)&&(this._setCanvasSize(t,e),this.render())}},{key:"imageRange",get:function(){return ng({},this._imageRange)},set:function(e){Jf(e)&&!$f(e,this._imageRange)&&(this._imageRange=e,this.render())}},{key:"voiRange",get:function(){return ng({},this._voiRange)},set:function(e){Jf(e)&&!$f(e,this._voiRange)&&(this._voiRange=e,this.render())}},{key:"showFullImageRange",get:function(){return this._showFullImageRange},set:function(e){e!==this._showFullImageRange&&(this._showFullImageRange=e,this.render())}},{key:"appendTo",value:function(e){e.appendChild(this._canvas),this.render()}},{key:"dispose",value:function(){var e=this._canvas,t=e.parentElement;null==t||t.removeChild(e)}},{key:"_setCanvasSize",value:function(e,t){var n=t.width,r=t.height;e.width=n,e.height=r,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(r,"px")})}},{key:"_createRootElement",value:function(e){var t=document.createElement("canvas");return Object.assign(t.style,{position:"absolute",top:"0",left:"0",pointerEvents:"none",boxSizing:"border-box"}),this._setCanvasSize(t,e),t}},{key:"render",value:function(){if(this._canvas.isConnected)for(var e,t,n,r=this._colormap.RGBPoints,o=r.length/4,a=function(e){var t=4*e;if(!(e<0||e>=o))return{index:e,position:r[t],color:[r[t+1],r[t+2],r[t+3]]}},i=this._canvas,l=i.width,s=i.height,c=this._canvas.getContext("2d"),d=l>s,u=d?l:s,v=this._voiRange,f=this._showFullImageRange?this._imageRange:ng({},v),g=J.utilities.windowLevel.toWindowLevel(v.lower,v.upper).windowWidth,h=void 0,p=a(0),m=(f.upper-f.lower)/(u-1),w=f.lower,E=0;E<u;E++){var y=(w-v.lower)/g;if(p)for(var I=p.index;I<o&&!(y<=p.position);I++)h=p,p=a(I+1);var b=void 0;if(h)if(p){var C=(y-h.position)/(p.position-h.position);e=h.color,t=p.color,n=C,b=[e[0]*(1-n)+t[0]*n,e[1]*(1-n)+t[1]*n,e[2]*(1-n)+t[2]*n]}else b=Lr(h.color);else b=Lr(p.color);var _=b.map((function(e){return rg(Math.round(255*e),0,255)}));c.fillStyle="rgb(".concat(_[0],", ").concat(_[1],", ").concat(_[2],")"),d?c.fillRect(E,0,1,s):c.fillRect(0,s-E-1,l,1),w+=m}}}],[{key:"validateProps",value:function(e){var t=e.size,n=e.imageRange,r=e.voiRange;if(t&&!Qf(t))throw new Error('Invalid "size"');if(n&&!Jf(n))throw new Error('Invalid "imageRange"');if(r&&!Jf(r))throw new Error('Invalid "voiRange"')}}]),e}();function ag(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ig(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ag(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ag(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var lg={FONT:"10px Arial",COLOR:"white",TICK_SIZE:5,TICK_WIDTH:1,TICK_LABEL_MARGIN:3,MAX_NUM_TICKS:8,TICKS_STEPS:[1,2.5,5,10]},sg=function(){function e(t){var n,r,o,a,i,l;oe(this,e),ae(this,"_canvas",void 0),ae(this,"_imageRange",void 0),ae(this,"_voiRange",void 0),ae(this,"_color",void 0),ae(this,"_tickSize",void 0),ae(this,"_tickWidth",void 0),ae(this,"_labelMargin",void 0),ae(this,"_maxNumTicks",void 0),ae(this,"_rangeTextPosition",void 0),ae(this,"_showFullPixelValueRange",void 0),ae(this,"_font",void 0),e.validateProps(t);var s=t.top,c=void 0===s?0:s,d=t.left,u=void 0===d?0:d,v=t.size,f=void 0===v?{width:20,height:100}:v,g=t.imageRange,h=void 0===g?{lower:0,upper:1}:g,p=t.voiRange,m=void 0===p?{lower:0,upper:1}:p,w=t.ticks,E=t.container,y=t.showFullPixelValueRange,I=void 0!==y&&y,b=null!=w?w:{},C=b.style,_=b.position;this._imageRange=h,this._voiRange=m,this._font=null!==(n=null==C?void 0:C.font)&&void 0!==n?n:lg.FONT,this._color=null!==(r=null==C?void 0:C.color)&&void 0!==r?r:lg.COLOR,this._tickSize=null!==(o=null==C?void 0:C.tickSize)&&void 0!==o?o:lg.TICK_SIZE,this._tickWidth=null!==(a=null==C?void 0:C.tickWidth)&&void 0!==a?a:lg.TICK_WIDTH,this._labelMargin=null!==(i=null==C?void 0:C.labelMargin)&&void 0!==i?i:lg.TICK_LABEL_MARGIN,this._maxNumTicks=null!==(l=null==C?void 0:C.maxNumTicks)&&void 0!==l?l:lg.MAX_NUM_TICKS,this._rangeTextPosition=null!=_?_:Zf.Right,this._showFullPixelValueRange=I,this._canvas=this._createCanvasElement(f,c,u),E&&this.appendTo(E)}return re(e,[{key:"size",get:function(){var e=this._canvas;return{width:e.width,height:e.height}},set:function(e){var t=this._canvas;Qf(e)&&!eg(t,e)&&(this._setCanvasSize(t,e),this.render())}},{key:"top",get:function(){return Number.parseInt(this._canvas.style.top)},set:function(e){var t=this._canvas;e!==this.top&&(t.style.top="".concat(e,"px"),this.render())}},{key:"left",get:function(){return Number.parseInt(this._canvas.style.left)},set:function(e){var t=this._canvas;e!==this.left&&(t.style.left="".concat(e,"px"),this.render())}},{key:"imageRange",get:function(){return ig({},this._imageRange)},set:function(e){Jf(e)&&!$f(e,this._imageRange)&&(this._imageRange=e,this.render())}},{key:"voiRange",get:function(){return ig({},this._voiRange)},set:function(e){Jf(e)&&!$f(e,this._voiRange)&&(this._voiRange=e,this.render())}},{key:"tickSize",get:function(){return this._tickSize},set:function(e){e!==this._tickSize&&(this._tickSize=e,this.render())}},{key:"tickWidth",get:function(){return this._tickWidth},set:function(e){e!==this._tickWidth&&(this._tickWidth=e,this.render())}},{key:"color",get:function(){return this._color},set:function(e){e!==this._color&&(this._color=e,this.render())}},{key:"showFullPixelValueRange",get:function(){return this._showFullPixelValueRange},set:function(e){e!==this._showFullPixelValueRange&&(this._showFullPixelValueRange=e,this.render())}},{key:"visible",get:function(){return"block"===this._canvas.style.display},set:function(e){e!==this.visible&&(this._canvas.style.display=e?"block":"none",e&&this.render())}},{key:"appendTo",value:function(e){e.appendChild(this._canvas),this.render()}},{key:"_setCanvasSize",value:function(e,t){var n=t.width,r=t.height;e.width=n,e.height=r,Object.assign(e.style,{width:"".concat(n,"px"),height:"".concat(r,"px")})}},{key:"_createCanvasElement",value:function(e,t,n){var r=document.createElement("canvas");return Object.assign(r.style,{display:"none",position:"absolute",boxSizing:"border-box",top:"".concat(t,"px"),left:"".concat(n,"px")}),this._setCanvasSize(r,e),r}},{key:"_getTicks",value:function(e){for(var t=e.lower,n=e.upper,r=(n-t)/(this._maxNumTicks-1),o=Math.pow(10,-Math.floor(Math.log10(Math.abs(r)))),a=r*o,i=lg.TICKS_STEPS.find((function(e){return e>=a}))/o,l=Math.ceil(n/i)*i,s=Math.floor(t/i)*i,c=Math.round((l-s)/i)+1,d=[],u=0;u<c;u++)d.push(s+u*i);return{scaleMin:s,scaleMax:l,step:i,ticks:d}}},{key:"_getLeftTickInfo",value:function(e){var t=e.position,n=e.labelMeasure,r=this._canvas.width;return{labelPoint:[r-this.tickSize-n.width-this._labelMargin,t],tickPoints:{start:[r-this._tickSize,t],end:[r,t]}}}},{key:"_getRightTickInfo",value:function(e){var t=e.position;return{labelPoint:[this._tickSize+this._labelMargin,t],tickPoints:{start:[0,t],end:[this._tickSize,t]}}}},{key:"_getTopTickInfo",value:function(e){throw e.position,e.labelMeasure,new Error("Not implemented")}},{key:"_getBottomTickInfo",value:function(e){throw e.position,e.labelMeasure,new Error("Not implemented")}},{key:"render",value:function(){var e=this,t=this._canvas;if(t.isConnected&&this.visible){var n=t.width,r=t.height,o=n>=r,a=o?n:r,i=t.getContext("2d"),l=this._voiRange,s=this._showFullPixelValueRange?this._imageRange:ig({},l),c=s.upper-s.lower,d=this._getTicks(s).ticks;i.clearRect(0,0,n,r),i.font=this._font,i.textBaseline="middle",i.fillStyle=this._color,i.strokeStyle=this._color,i.lineWidth=this.tickWidth,d.forEach((function(t){var n=Math.round(a*((t-s.lower)/c));if(o||(n=r-n),!(n<0||n>a)){var l=t.toString(),d=i.measureText(l),u=o?e._rangeTextPosition===Zf.Top?e._getTopTickInfo({position:n,labelMeasure:d}):e._getBottomTickInfo({position:n,labelMeasure:d}):e._rangeTextPosition===Zf.Left?e._getLeftTickInfo({position:n,labelMeasure:d}):e._getRightTickInfo({position:n}),v=u.labelPoint,f=u.tickPoints,g=f.start,h=f.end;return i.beginPath(),i.moveTo(g[0],g[1]),i.lineTo(h[0],h[1]),i.fillText(l,v[0],v[1]),i.stroke(),n}}))}}}],[{key:"validateProps",value:function(e){var t=e.size,n=e.imageRange,r=e.voiRange;if(t&&!Qf(t))throw new Error('Invalid "size"');if(n&&!Jf(n))throw new Error('Invalid "imageRange"');if(r&&!Jf(r))throw new Error('Invalid "voiRange"')}}]),e}();function cg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var dg=function(){function e(t){var n=this,r=t.id,o=t.container;oe(this,e),ae(this,"_id",void 0),ae(this,"_rootElement",void 0),ae(this,"_containerSize",void 0),ae(this,"_containerResizeObserver",void 0),ae(this,"_containerResizeCallback",(function(e){var t,r,o=e[0],a=o.contentRect,i=o.contentBoxSize;a?(t=a.width,r=a.height):null!=i&&i.length&&(t=i[0].inlineSize,r=i[0].blockSize),n._containerSize={width:t,height:r},n.onContainerResize()})),this._id=r,this._containerSize={width:0,height:0},this._rootElement=this.createRootElement(r),this._containerResizeObserver=new ResizeObserver(this._containerResizeCallback),o&&this.appendTo(o)}return re(e,[{key:"id",get:function(){return this._id}},{key:"rootElement",get:function(){return this._rootElement}},{key:"appendTo",value:function(e){var t=this._rootElement,n=this._containerResizeObserver,r=t.parentElement;e&&e!==r&&(r&&n.unobserve(r),e.appendChild(t),n.observe(e))}},{key:"destroy",value:function(){var e=this._rootElement,t=this._containerResizeObserver,n=e.parentElement;null==n||n.removeChild(e),t.disconnect()}},{key:"containerSize",get:function(){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?cg(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},this._containerSize)}},{key:"createRootElement",value:function(e){var t=document.createElement("div");return t.id=e,t.classList.add("widget"),Object.assign(t.style,{width:"100%",height:"100%"}),t}},{key:"onContainerResize",value:function(){}}]),e}();function ug(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var vg={MULTIPLIER:1,RANGE_TEXT_POSITION:Zf.Right,TICKS_BAR_SIZE:50},fg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(e){var t,n,a;return oe(this,o),ae(ga(a=r.call(this,e)),"_colormaps",void 0),ae(ga(a),"_activeColormapName",void 0),ae(ga(a),"_eventListenersManager",void 0),ae(ga(a),"_canvas",void 0),ae(ga(a),"_ticksBar",void 0),ae(ga(a),"_rangeTextPosition",void 0),ae(ga(a),"_isMouseOver",!1),ae(ga(a),"_isInteracting",!1),ae(ga(a),"_mouseOverCallback",(function(e){a._isMouseOver=!0,a.showTicks(),e.stopPropagation()})),ae(ga(a),"_mouseOutCallback",(function(e){a._isMouseOver=!1,a.hideTicks(),e.stopPropagation()})),ae(ga(a),"_mouseDownCallback",(function(e){a._isInteracting=!0,a.showTicks(),a._addVOIEventListeners(e),e.stopPropagation()})),ae(ga(a),"_mouseDragCallback",(function(e,t){var n=a.getVOIMultipliers(),r=a._getPointsFromMouseEvent(e),o=t.points,i=t.voiRange,l=xs.vec2.sub(xs.vec2.create(),r.local,o.local),s=l[0]*n[0],c=l[1]*n[1];if(s||c){var d=i.lower,u=i.upper,v=J.utilities.windowLevel.toWindowLevel(d,u),f=v.windowWidth,g=v.windowCenter;f=Math.max(f+s,1),g+=c;var h=J.utilities.windowLevel.toLowHighRange(f,g);a.voiRange=h,e.stopPropagation(),e.preventDefault()}})),ae(ga(a),"_mouseUpCallback",(function(e){a._isInteracting=!1,a.hideTicks(),a._removeVOIEventListeners(),e.stopPropagation()})),a._eventListenersManager=new J.utilities.eventListener.MultiTargetEventListenerManager,a._colormaps=o.getColormapsMap(e),a._activeColormapName=o.getInitialColormapName(e),a._canvas=a._createCanvas(e),a._ticksBar=a._createTicksBar(e),a._rangeTextPosition=null!==(t=null===(n=e.ticks)||void 0===n?void 0:n.position)&&void 0!==t?t:vg.RANGE_TEXT_POSITION,a._canvas.appendTo(a.rootElement),a._ticksBar.appendTo(a.rootElement),a._addRootElementEventListeners(),a}return re(o,[{key:"activeColormapName",get:function(){return this._activeColormapName},set:function(e){if(e!==this._activeColormapName){var t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn("Invalid colormap name (".concat(e,")"))}}},{key:"imageRange",get:function(){return this._canvas.imageRange},set:function(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}},{key:"voiRange",get:function(){return this._canvas.voiRange},set:function(e){var t=this._canvas.voiRange;Jf(e)&&!$f(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}},{key:"showFullImageRange",get:function(){return this._canvas.showFullImageRange},set:function(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}},{key:"destroy",value:function(){Vl(wa(o.prototype),"destroy",this).call(this),this._eventListenersManager.reset()}},{key:"createRootElement",value:function(){var e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}},{key:"onContainerResize",value:function(){Vl(wa(o.prototype),"onContainerResize",this).call(this),this.updateTicksBar(),this._canvas.size=this.containerSize}},{key:"getVOIMultipliers",value:function(){return[vg.MULTIPLIER,vg.MULTIPLIER]}},{key:"onVoiChange",value:function(e){}},{key:"showTicks",value:function(){this.updateTicksBar(),this._ticksBar.visible=!0}},{key:"hideTicks",value:function(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}},{key:"_createCanvas",value:function(e){var t=e.imageRange,n=e.voiRange,r=e.showFullPixelValueRange,o=this._colormaps.get(this._activeColormapName);return new og({colormap:o,imageRange:t,voiRange:n,showFullPixelValueRange:r})}},{key:"_createTicksBar",value:function(e){var t=e.ticks;return new sg({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}},{key:"_getPointsFromMouseEvent",value:function(e){var t=this.rootElement,n=[e.clientX,e.clientY],r=[e.pageX,e.pageY],o=t.getBoundingClientRect();return{client:n,page:r,local:[r[0]-o.left-window.pageXOffset,r[1]-o.top-window.pageYOffset]}}},{key:"updateTicksBar",value:function(){var e=this.containerSize,t=e.width,n=e.height;if(0!==t||0!==n){var r,o,a=this._ticksBar,i=this._rangeTextPosition,l=t>=n,s=l?t:vg.TICKS_BAR_SIZE,c=l?vg.TICKS_BAR_SIZE:n;if(!function(e,t,n){return(e>=t?[Zf.Top,Zf.Bottom]:[Zf.Left,Zf.Right]).includes(n)}(t,n,i))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");a.size={width:s,height:c},l?(o=0,r=i===Zf.Top?-c:n):(r=0,o=i===Zf.Left?-s:t),a.top=r,a.left=o}}},{key:"_addRootElementEventListeners",value:function(){var e=this._eventListenersManager,t=this.rootElement;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}},{key:"_addVOIEventListeners",value:function(e){var t=this,n=this._eventListenersManager,r=this._getPointsFromMouseEvent(e),o=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ug(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ug(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},this._canvas.voiRange),a={points:r,voiRange:o};this._removeVOIEventListeners(),n.addEventListener(document,"voi.mouseup",this._mouseUpCallback),n.addEventListener(document,"voi.mousemove",(function(e){return t._mouseDragCallback(e,a)}))}},{key:"_removeVOIEventListeners",value:function(){var e=this._eventListenersManager;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}],[{key:"getColormapsMap",value:function(e){return e.colormaps.reduce((function(e,t){return e.set(t.Name,t)}),new Map)}},{key:"getInitialColormapName",value:function(e){var t=e.activeColormapName,n=e.colormaps;return t&&n.some((function(e){return e.Name===t}))?t:n[0].Name}}]),o}(dg);function gg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function hg(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gg(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gg(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var pg=J.Enums.Events,mg={lower:-1e3,upper:1e3},wg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(e){var t;oe(this,o);var n=e.element,a=e.volumeId,i=o._getImageRange(n,a),l=o._getVOIRange(n,a);return ae(ga(t=r.call(this,hg(hg({},e),{},{imageRange:i,voiRange:l}))),"_element",void 0),ae(ga(t),"_volumeId",void 0),ae(ga(t),"_hideTicksTime",void 0),ae(ga(t),"_hideTicksTimeoutId",void 0),ae(ga(t),"autoHideTicks",(function(){if(!t._hideTicksTimeoutId){var e=t._hideTicksTime-Date.now();e<=0?t.hideTicks():t._hideTicksTimeoutId=window.setTimeout((function(){t._hideTicksTimeoutId=0,t.autoHideTicks()}),e)}})),ae(ga(t),"_stackNewImageCallback",(function(){t.imageRange=o._getImageRange(t._element)})),ae(ga(t),"_imageVolumeModifiedCallback",(function(e){var n=e.detail.imageVolume.volumeId;if(n===t._volumeId){var r=ga(t)._element;t.imageRange=o._getImageRange(r,n)}})),ae(ga(t),"_viewportVOIModifiedCallback",(function(e){var n=e.detail,r=n.viewportId,o=n.volumeId,a=n.range;r===t.enabledElement.viewport.id&&o===t._volumeId&&(t.voiRange=a,t.showAndAutoHideTicks())})),t._element=n,t._volumeId=a,t._addCornerstoneEventListener(),t}return re(o,[{key:"element",get:function(){return this._element}},{key:"enabledElement",get:function(){return(0,J.getEnabledElement)(this._element)}},{key:"getVOIMultipliers",value:function(){return function(e,t,n){if("PT"===J.utilities.getViewportModality(e,t)){var r=e.element,o=r.clientWidth,a=r.clientHeight,i=5/Math.max(o,a),l=Sd(e,t),s={}.fixedPTWindowWidth,c=void 0===s||s?0:i;return l?[c,i]:[c,4]}return[4,4]}(this.enabledElement.viewport,this._volumeId)}},{key:"onVoiChange",value:function(e){Vl(wa(o.prototype),"onVoiChange",this).call(this,e);var t=this.enabledElement.viewport;if(t instanceof J.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof J.VolumeViewport){var n=this._volumeId,r=J.utilities.getViewportsWithVolumeId(n,t.renderingEngineId);t.setProperties({voiRange:e},n),r.forEach((function(e){return e.render()}))}}},{key:"showAndAutoHideTicks",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}},{key:"_addCornerstoneEventListener",value:function(){var e=this._element;J.eventTarget.addEventListener(pg.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(pg.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(pg.VOI_MODIFIED,this._viewportVOIModifiedCallback)}}],[{key:"_getImageRange",value:function(e,t){var n=(0,J.getEnabledElement)(e).viewport,r=t?n.getActor(t):n.getDefaultActor();if(!r)return mg;var o=r.actor.getMapper().getInputData().getPointData().getScalars().getRange();return 0===o[0]&&0===o[1]?mg:{lower:o[0],upper:o[1]}}},{key:"_getVOIRange",value:function(e,t){var n=(0,J.getEnabledElement)(e).viewport,r=t?n.getActor(t):n.getDefaultActor();if(!r||!J.utilities.isImageActor(r))return mg;var o=r.actor.getProperty().getRGBTransferFunction(0).getRange();return 0===o[0]&&0===o[1]?mg:{lower:o[0],upper:o[1]}}}]),o}(fg),Eg=function(e,t){var n=as.getDefinedCursor(t,!0);n||(n=Nl.getDefinedCursor(t)),n||(console.log("Cursor ".concat(t," is not defined either as SVG or as a standard cursor.")),n=Nl.getDefinedCursor(t)),vs(e,n)},yg=[].concat(Lr($l),Lr(Ul)),Ig=function(e,t,n){var r=ns("textBoxFontSize",e,t,n),o=ns("textBoxFontFamily",e,t,n);return"".concat(r,"px ").concat(o)},bg=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((function(e){if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===gt.Labelmap&&function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");var t=e.representation.data;if(!t.volumeId)throw new Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");if(!J.cache.getVolume(t.volumeId))throw new Error("volumeId of ".concat(t.volumeId," not found in cache, you should load and cache volume before adding segmentation"))}(e)}))},Cg=function(e){bg(e),e.map((function(e){Nt(le()(e))}))};function _g(){return(_g=Va(Ba().mark((function e(t,n,r){var o,a;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(fa(t)){e.next=3;break}throw new Error("No tool group found for toolGroupId: ".concat(t));case 3:return o=n.map((function(e){return Tg(t,e,r)})),e.next=6,Promise.all(o);case 6:return a=e.sent,e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Tg(e,t,n){return Og.apply(this,arguments)}function Og(){return(Og=Va(Ba().mark((function e(t,n,r){var o;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.type!==gt.Labelmap){e.next=6;break}return e.next=3,Ji.addSegmentationRepresentation(t,n,r);case 3:case 9:case 15:o=e.sent,e.next=19;break;case 6:if(n.type!==gt.Contour){e.next=12;break}return e.next=9,Mi.addSegmentationRepresentation(t,n,r);case 12:if(n.type!==gt.Surface){e.next=18;break}return e.next=15,si.addSegmentationRepresentation(t,n,r);case 18:throw new Error("The representation type ".concat(n.type," is not supported"));case 19:return e.abrupt("return",o);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Dg=function(e,t,n){return _g.apply(this,arguments)};var Sg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return oe(this,o),r.call(this,e,t)}return re(o,[{key:"touchDragCallback",value:function(e){this._dragCallback(e)}},{key:"mouseDragCallback",value:function(e){this._dragCallback(e)}},{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.deltaPoints,o=(0,J.getEnabledElement)(n),a=r.world,i=o.viewport.getCamera(),l=i.focalPoint,s=i.position,c=[s[0]-a[0],s[1]-a[1],s[2]-a[2]],d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]];o.viewport.setCamera({focalPoint:d,position:c}),o.viewport.render()}}]),o}(La);ae(Sg,"toolName",void 0),Sg.toolName="Pan";var kg=Sg;var Mg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"rotateCamera",(function(e,t,n,r){var o=e.getVtkActiveCamera(),a=o.getViewUp(),i=o.getFocalPoint(),l=o.getPosition(),s=[0,0,0],c=[0,0,0],d=[0,0,0],u=xs.mat4.identity(new Float32Array(16));xs.mat4.translate(u,u,t),xs.mat4.rotate(u,u,r,n),xs.mat4.translate(u,u,[-t[0],-t[1],-t[2]]),xs.vec3.transformMat4(s,l,u),xs.vec3.transformMat4(c,i,u),xs.mat4.identity(u),xs.mat4.rotate(u,u,r,n),xs.vec3.transformMat4(d,a,u),e.setCamera({position:s,viewUp:d,focalPoint:c})})),e.touchDragCallback=e._dragCallback.bind(ga(e)),e.mouseDragCallback=e._dragCallback.bind(ga(e)),e}return re(o,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=t.lastPoints,a=r.canvas,i=o.canvas,l=this.configuration.rotateIncrementDegrees,s=(0,J.getEnabledElement)(n).viewport,c=s.getCamera(),d=n.clientWidth,u=n.clientHeight,v=[a[0]/d,a[1]/u],f=[i[0]/d,i[1]/u],g=[.5*d,.5*u],h=s.canvasToWorld(g),p=Math.pow(1+Math.abs(.5),2),m=[f[0],0,0],w=[v[0],0,0],E=Math.pow(m[0],2),y=Math.pow(w[0],2),I=E>p?0:Math.sqrt(p-E),b=y>p?0:Math.sqrt(p-y),C=[m[0],0,I];Du().normalize(C);var _=[w[0],0,b];Du().normalize(_);var T=Du().dot(C,_);if(Math.abs(T)>1e-4){var O=-2*Math.acos(Du().clampValue(T,-1,1))*Math.sign(v[0]-f[0])*l,D=c.viewUp,S=c.viewPlaneNormal,k=[0,0,0],M=[0,0,0];Du().cross(D,S,k),Du().normalize(k),Du().cross(S,k,M),Du().normalize(M),Du().normalize(D),this.rotateCamera(s,h,M,O);var x=(f[1]-v[1])*l;this.rotateCamera(s,h,k,x),s.render()}}}]),o}(La);ae(Mg,"toolName",void 0),Mg.toolName="TrackballRotate";var xg=Mg;var Rg=J.utilities.transformWorldToIndex,Pg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ag}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"eventDispatchDetail",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{points:[Lr(a)]},cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:h},e._activateModify(o),gs(o),t.preventDefault(),ca(s,h),g})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=(0,J.getEnabledElement)(n),s=l.renderingEngine,c=l.viewportId;if(e.eventDispatchDetail={viewportId:c,renderingEngineId:s.id},e._deactivateModify(n),fs(n),e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(s,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=e.editData,l=i.annotation,s=i.viewportIdsToRender;l.data.handles.points[0]=Lr(a),l.invalidated=!0;var c=(0,J.getEnabledElement)(o).renderingEngine;ca(c,s)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=s[f],o=r.annotationUID,l=r.data,v=l.handles.points[0],g=i.worldToCanvas(v);u.annotationUID=o;var h=e.getStyle("color",u,r);if(l.cachedStats[c]&&null!=l.cachedStats[c].value){if(r.invalidated&&(e._calculateCachedStats(r,d,t),i instanceof J.VolumeViewport)){var p=r.metadata.referencedImageId;for(var m in l.cachedStats)m.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=J.utilities.imageIdToURI(p),n=e.hasImageURI(t),r=J.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[m]}}else l.cachedStats[c]={Modality:null,index:null,value:null},e._calculateCachedStats(r,d,t);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};Xs(n,o,"0",[g],{color:h}),a=!0;var w=e.getLinkedTextBoxStyle(u,r);if(!w.visibility)return"continue";var E=e.configuration.getTextLines(l,c);if(E){var y=[g[0]+6,g[1]-6];tc(n,o,"0",E,[y[0],y[1]],w)}},f=0;f<s.length;f++){var g=v();if("continue"!==g&&"object"===ee(g))return g.v}return a})),e}return re(o,[{key:"isPointNearTool",value:function(){return!1}},{key:"toolSelectedCallback",value:function(){}},{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=t.data.handles.points[0],i=o.worldToCanvas(a);if(!0==xs.vec2.distance(n,i)<r)return a}},{key:"handleSelectedCallback",value:function(e,t){var n=e.detail.element;t.highlighted=!0;var r=ad(n,this.getToolName());this.editData={annotation:t,viewportIdsToRender:r},this._activateModify(n),gs(n);var o=(0,J.getEnabledElement)(n).renderingEngine;ca(o,r),e.preventDefault()}},{key:"_calculateCachedStats",value:function(e,t,n){for(var r=e.data,o=n.viewportId,a=n.renderingEngineId,i=n.viewport,l=r.handles.points[0],s=r.cachedStats,c=Object.keys(s),d=0;d<c.length;d++){var u=c[d],v={isPreScaled:Sd(i,u),isSuvScaled:this.isSuvScaled(i,u,e.metadata.referencedImageId)},f=this.getTargetIdImage(u,t);if(f){var g=f.dimensions,h=f.imageData,p=f.metadata,m="getScalarData"in f?f.getScalarData():f.scalarData,w=p.Modality,E=Rg(h,l);if(E[0]=Math.round(E[0]),E[1]=Math.round(E[1]),E[2]=Math.round(E[2]),J.utilities.indexWithinDimensions(E,g)){this.isHandleOutsideImage=!1;var y=g[0],I=g[0]*g[1],b=m[E[2]*I+E[1]*y+E[0]];if(u.startsWith("imageId:")){var C=u.split("imageId:")[1],_=J.utilities.imageIdToURI(C),T=J.utilities.getViewportsWithImageURI(_,a)[0];E[2]=T.getCurrentImageIdIndex()}var O=Dd(w,e.metadata.referencedImageId,v);s[u]={index:E,value:b,Modality:w,modalityUnit:O}}else this.isHandleOutsideImage=!0,s[u]={index:E,Modality:w};e.invalidated=!1;var D=Q.ANNOTATION_MODIFIED,S={annotation:e,viewportId:o,renderingEngineId:a};(0,J.triggerEvent)(J.eventTarget,D,S)}}return s}}]),o}(hd);function Ag(e,t){var n=e.cachedStats[t],r=n.index,o=n.value,a=n.modalityUnit;if(void 0!==o){var i=[];return i.push("(".concat(r[0],", ").concat(r[1],", ").concat(r[2],")")),i.push("".concat(o.toFixed(2)," ").concat(a)),i}}ae(Pg,"toolName",void 0),Pg.toolName="Probe";var Ng=Pg;var Lg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Ug}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"eventDispatchDetail",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"postMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:v},data:{label:"",handles:{points:[Lr(a)]},cachedStats:{}}},g=ad(o,e.getToolName());return e.editData={annotation:f,newAnnotation:!0,viewportIdsToRender:g},e._activateModify(o),gs(o),t.preventDefault(),ca(s,g),f})),ae(ga(e),"postTouchStartCallback",(function(t){return e.postMouseDownCallback(t)})),ae(ga(e),"renderAnnotation",(function(t,n){var r=!1,o=t.viewport;if(!e.editData)return r;var a=e.filterInteractableAnnotationsForElement(o.element,[e.editData.annotation]);if(null==a||!a.length)return r;var i=e.getTargetId(o),l=o.getRenderingEngine(),s={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},c=e.editData.annotation,d=c.annotationUID,u=c.data,v=u.handles.points[0],f=o.worldToCanvas(v);s.annotationUID=d;var g=e.getStyle("color",s,c);if(Sd(o,i),e.isSuvScaled(o,i,c.metadata.referencedImageId),u.cachedStats[i]&&null!=u.cachedStats[i].value?c.invalidated&&e._calculateCachedStats(c,l,t):(u.cachedStats[i]={Modality:null,index:null,value:null},e._calculateCachedStats(c,l,t)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),r;Xs(n,d,"0",[f],{color:g}),r=!0;var h=e.configuration.getTextLines(u,i);if(h){var p=[f[0]+6,f[1]-6];tc(n,d,"0",h,[p[0],p[1]],e.getLinkedTextBoxStyle(s,c))}return r})),e}return re(o)}(Ng);function Ug(e,t){var n=e.cachedStats[t],r=n.index,o=n.value,a=n.modalityUnit;if(void 0!==o){var i=[];return i.push("(".concat(r[0],", ").concat(r[1],", ").concat(r[2],")")),i.push("".concat(o.toFixed(2)," ").concat(a)),i}}ae(Lg,"toolName",void 0),Lg.toolName="DragProbe";var Vg=Lg;var jg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_getImageDynamicRangeFromMiddleSlice",(function(t,n){var r,o,a=Math.floor(n[2]/2),i=n[0]*n[1];t instanceof Float32Array?(r=4,o=Float32Array):t instanceof Uint8Array?(r=1,o=Uint8Array):t instanceof Uint16Array?(r=2,o=Uint16Array):t instanceof Int16Array&&(r=2,o=Int16Array);var l=new o(t.buffer,a*i*r,i),s=e._getMinMax(l,i);return s.max-s.min})),e}return re(o,[{key:"touchDragCallback",value:function(e){this.mouseDragCallback(e)}},{key:"mouseDragCallback",value:function(e){var t,n,r,o,a,i,l=e.detail,s=l.element,c=l.deltaPoints,d=(0,J.getEnabledElement)(s),u=d.renderingEngine,v=d.viewport,f=!1;if(v instanceof J.VolumeViewport){t=this.getTargetId(v).split("volumeId:")[1],i=J.utilities.getViewportsWithVolumeId(t,u.id);var g=v.getProperties().voiRange;n=g.lower,r=g.upper;var h=J.cache.getVolume(t);o=h.metadata.Modality,f=h.scaling&&Object.keys(h.scaling).length>0}else{if(!(v instanceof J.StackViewport))throw new Error("Viewport is not a valid type");var p,m=v.getProperties();o=v.modality;var w=m.voiRange;n=w.lower,r=w.upper;var E=v.getImageData().preScale;f=E.scaled&&void 0!==(null===(p=E.scalingParameters)||void 0===p?void 0:p.suvbw)}return a="PT"===o?this.getPTScaledNewRange({deltaPointsCanvas:c.canvas,lower:n,upper:r,clientHeight:s.clientHeight,isPreScaled:f,viewport:v,volumeId:t}):this.getNewRange({viewport:v,deltaPointsCanvas:c.canvas,volumeId:t,lower:n,upper:r}),v instanceof J.StackViewport?(v.setProperties({voiRange:a}),void v.render()):v instanceof J.VolumeViewport?(v.setProperties({voiRange:a}),void i.forEach((function(e){e.render()}))):void 0}},{key:"getPTScaledNewRange",value:function(e){var t,n=e.deltaPointsCanvas,r=e.lower,o=e.upper,a=e.clientHeight,i=e.viewport,l=e.volumeId,s=e.isPreScaled;return t=s?5/a:this._getMultiplierFromDynamicRange(i,l)||4,o-=n[1]*t,{lower:r,upper:o=s?Math.max(o,.1):o}}},{key:"getNewRange",value:function(e){var t=e.viewport,n=e.deltaPointsCanvas,r=e.volumeId,o=e.lower,a=e.upper,i=this._getMultiplierFromDynamicRange(t,r)||4,l=n[0]*i,s=n[1]*i,c=J.utilities.windowLevel.toWindowLevel(o,a),d=c.windowWidth,u=c.windowCenter;return d+=l,u+=s,d=Math.max(d,1),J.utilities.windowLevel.toLowHighRange(d,u)}},{key:"_getMultiplierFromDynamicRange",value:function(e,t){var n;if(t){var r,o=J.cache.getVolume(t),a=o.dimensions,i=o.getScalarData(),l=this._getImageDynamicRangeFromMiddleSlice(i,a),s=null==o||null===(r=o.metadata)||void 0===r?void 0:r.BitsStored,c=s?Math.pow(2,s):1/0;n=Math.min(l,c)}else n=this._getImageDynamicRangeFromViewport(e);var d=n/1024,u=4;return d>1&&(u=Math.round(d)),u}},{key:"_getImageDynamicRangeFromViewport",value:function(e){var t,n,r=e.getImageData().imageData,o=r.getDimensions();if(t=r.getScalarData?r.getScalarData():r.getPointData().getScalars(),1!==o[2])return this._getImageDynamicRangeFromMiddleSlice(t,o);if(t.getRange)n=t.getRange();else{var a=this._getMinMax(t,t.length);n=[a.min,a.max]}return n[1]-n[0]}},{key:"_getMinMax",value:function(e,t){for(var n=1/0,r=-1/0,o=0;o<t;o++){var a=e[o];a<n&&(n=a),a>r&&(r=a)}return{max:r,min:n}}}]),o}(La);ae(jg,"toolName",void 0),jg.toolName="WindowLevel";var Bg=jg;var Wg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"initialMousePosWorld",void 0),ae(ga(e),"dirVec",void 0),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints.world,a=(0,J.getEnabledElement)(r).viewport.getCamera().focalPoint;e.initialMousePosWorld=o;var i=xs.vec3.fromValues(a[0]-o[0],a[1]-o[1],a[2]-o[2]);return i=xs.vec3.normalize(xs.vec3.create(),i),e.dirVec=i,!1})),ae(ga(e),"preTouchStartCallback",(function(t){if(!e.configuration.pinchToZoom)return e.preMouseDownCallback(t)})),ae(ga(e),"_dragParallelProjection",(function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=t.detail,i=a.element,l=a.deltaPoints,s=o?t.detail.deltaDistance.canvas:l.canvas[1],c=[i.clientWidth,i.clientHeight],d=r.parallelScale,u=r.focalPoint,v=r.position,f=s*(5/c[1])*(e.configuration.invert?-1:1),g=(1-f)*d,h=u,p=v;if(!e.configuration.zoomToCenter){var m=xs.vec3.distance(u,e.initialMousePosWorld);p=xs.vec3.scaleAndAdd(xs.vec3.create(),v,e.dirVec,-m*f),h=xs.vec3.scaleAndAdd(xs.vec3.create(),u,e.dirVec,-m*f)}var w=n.getImageData(),E=[1,1,1];w&&(E=w.spacing);var y=e.configuration,I=y.minZoomScale,b=y.maxZoomScale,C=i.clientHeight*E[1]*.5,_=C/g,T=g,O=!1;w&&(_<I?(T=C/I,O=!0):_>=b&&(T=C/b,O=!0)),n.setCamera({parallelScale:T,focalPoint:O?u:h,position:O?v:p})})),ae(ga(e),"_dragPerspectiveProjection",(function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=t.detail,i=a.element,l=a.deltaPoints,s=o?t.detail.deltaDistance.canvas:l.canvas[1],c=[i.clientWidth,i.clientHeight],d=r.position,u=r.focalPoint,v=r.viewPlaneNormal,f=Du().distance2BetweenPoints(d,u),g=Math.sqrt(f)/c[1],h=[-v[0],-v[1],-v[2]],p=e.configuration.invert?s/g:s*g,m=p*h[0];d[0]+=m,u[0]+=m,m=p*h[1],d[1]+=m,u[1]+=m,m=p*h[2],d[2]+=m,u[2]+=m,n.setCamera({position:d,focalPoint:u})})),e.initialMousePosWorld=[0,0,0],e.dirVec=[0,0,0],e.configuration.pinchToZoom?e.touchDragCallback=e._pinchCallback.bind(ga(e)):e.touchDragCallback=e._dragCallback.bind(ga(e)),e.mouseDragCallback=e._dragCallback.bind(ga(e)),e}return re(o,[{key:"_pinchCallback",value:function(e){if(e.detail.currentPointsList.length>1){var t=e.detail,n=t.element,r=t.currentPoints,o=(0,J.getEnabledElement)(n).viewport,a=o.getCamera(),i=r.world,l=a.focalPoint;this.initialMousePosWorld=i;var s=xs.vec3.fromValues(l[0]-i[0],l[1]-i[1],l[2]-i[2]);s=xs.vec3.normalize(xs.vec3.create(),s),this.dirVec=s,a.parallelProjection?this._dragParallelProjection(e,o,a,!0):this._dragPerspectiveProjection(e,o,a,!0),o.render()}this.configuration.pan&&this._panCallback(e)}},{key:"_dragCallback",value:function(e){var t=e.detail.element,n=(0,J.getEnabledElement)(t).viewport,r=n.getCamera();r.parallelProjection?this._dragParallelProjection(e,n,r):this._dragPerspectiveProjection(e,n,r),n.render()}},{key:"_panCallback",value:function(e){var t=e.detail,n=t.element,r=t.deltaPoints,o=(0,J.getEnabledElement)(n),a=r.world,i=o.viewport.getCamera(),l=i.focalPoint,s=i.position,c=[s[0]-a[0],s[1]-a[1],s[2]-a[2]],d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]];o.viewport.setCamera({focalPoint:d,position:c}),o.viewport.render()}}]),o}(La);ae(Wg,"toolName",void 0),Wg.toolName="Zoom";var Fg=Wg;var Hg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"deltaY",void 0),e.deltaY=1,e}return re(o,[{key:"mouseDragCallback",value:function(e){this._dragCallback(e)}},{key:"touchDragCallback",value:function(e){this._dragCallback(e)}},{key:"_dragCallback",value:function(e){var t,n=e.detail,r=n.deltaPoints,o=n.viewportId,a=n.renderingEngineId,i=(0,J.getEnabledElementByIds)(o,a).viewport,l=this.getTargetId(i),s=this.configuration,c=s.debounceIfNotLoaded,d=s.invert,u=s.loop,v=r.canvas[1];i instanceof J.VolumeViewport&&(t=l.split("volumeId:")[1]);var f=this._getPixelPerImage(i),g=v+this.deltaY;if(f)if(Math.abs(g)>=f){var h=Math.round(g/f);Ps(i,{delta:d?-h:h,volumeId:t,debounceLoading:c,loop:u}),this.deltaY=g%f}else this.deltaY=g}},{key:"_getPixelPerImage",value:function(e){var t=e.element,n=this._getNumberOfSlices(e);return Math.max(2,t.offsetHeight/Math.max(n,8))}},{key:"_getNumberOfSlices",value:function(e){return e instanceof J.VolumeViewport?J.utilities.getImageSliceDataForVolumeViewport(e).numberOfSlices:e instanceof J.StackViewport?e.getImageIds().length:void 0}}]),o}(La);ae(Hg,"toolName",void 0),Hg.toolName="StackScroll";var Gg=Hg;function qg(e,t){return 3===e[0].length?function(e,t){var n=dt(e,2),r=n[0],o=n[1],a=dt(t,2),i=a[0],l=a[1],s=xs.vec3.sub(xs.vec3.create(),o,r),c=xs.vec3.sub(xs.vec3.create(),i,l),d=xs.vec3.dot(s,c)/(xs.vec3.length(s)*xs.vec3.length(c));return 180*Math.acos(d)/Math.PI}(e,t):function(e,t){var n=dt(e,2),r=n[0],o=n[1],a=dt(t,2),i=a[0],l=a[1],s=xs.vec2.sub(xs.vec2.create(),o,r),c=xs.vec2.sub(xs.vec2.create(),i,l),d=xs.vec2.dot(s,c)/(xs.vec2.length(s)*xs.vec2.length(c));return Math.acos(d)*(180/Math.PI)}(e,t)}var zg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),e.touchDragCallback=e._dragCallback.bind(ga(e)),e.mouseDragCallback=e._dragCallback.bind(ga(e)),e}return re(o,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=t.startPoints,a=r.world,i=o.world,l=(0,J.getEnabledElement)(n).viewport,s=l.getCamera(),c=[.5*n.clientWidth,.5*n.clientHeight],d=l.canvasToWorld(c),u=qg([i,d],[d,a]),v=s.viewPlaneNormal,f=s.viewUp,g=xs.vec3.sub(xs.vec3.create(),d,i),h=xs.vec3.sub(xs.vec3.create(),d,a),p=xs.vec3.cross(xs.vec3.create(),g,h);if(xs.vec3.dot(v,p)>0&&(u=-u),!Number.isNaN(u)){if(l instanceof J.BaseVolumeViewport){var m=u*Math.PI/180,w=xs.mat4.identity(new Float32Array(16));xs.mat4.rotate(w,w,m,v);var E=xs.vec3.transformMat4(xs.vec3.create(),f,w);l.setCamera({viewUp:E})}else{var y=l.getProperties().rotation;l.setProperties({rotation:y+u})}l.render()}}}]),o}(La);ae(zg,"toolName",void 0),zg.toolName="PlanarRotate";var Kg=zg;var Yg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_configuration",void 0),e}return re(o,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.wheel,r=t.element,o=n.direction,a=this.configuration.invert,i=(0,J.getEnabledElement)(r).viewport,l=o*(a?-1:1),s=this.getTargetId(i).split("volumeId:")[1];Ps(i,{delta:l,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s})}}]),o}(La);ae(Yg,"toolName",void 0),Yg.toolName="StackScrollMouseWheel";var Xg=Yg;var Zg={X:[1,0,0],Y:[0,1,0],Z:[0,0,1],CUSTOM:[]},Jg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:Zg.Z,rotateIncrementDegrees:.5}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_configuration",void 0),e}return re(o,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.element,r=t.wheel,o=(0,J.getEnabledElement)(n).viewport,a=this.configuration,i=a.direction,l=a.rotateIncrementDegrees,s=o.getCamera(),c=s.viewUp,d=s.position,u=s.focalPoint,v=r.direction,f=dt(u,3),g=f[0],h=f[1],p=f[2],m=dt(i,3),w=m[0],E=m[1],y=m[2],I=v*l,b=[0,0,0],C=[0,0,0],_=[0,0,0],T=xs.mat4.identity(new Float32Array(16));xs.mat4.translate(T,T,[g,h,p]),xs.mat4.rotate(T,T,I,[w,E,y]),xs.mat4.translate(T,T,[-g,-h,-p]),xs.vec3.transformMat4(b,d,T),xs.vec3.transformMat4(C,u,T),xs.mat4.identity(T),xs.mat4.rotate(T,T,I,[w,E,y]),xs.vec3.transformMat4(_,c,T),o.setCamera({position:b,viewUp:_,focalPoint:C}),o.render()}}]),o}(La);ae(Jg,"toolName",void 0),Jg.toolName="VolumeRotateMouseWheel";var $g=Jg;var Qg=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_bounds",void 0),e}return re(o,[{key:"mouseClickCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=(0,J.getEnabledElement)(n),a=o.viewport,i=o.renderingEngine,l=this.getTargetId(a);if(!l.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");var s=l.split("volumeId:")[1],c=-1/0,d=Su(a,r.world,s,(function(e,t){if(e>c)return c=e,t}));if(d&&d.length){var u=this.configuration,v=u.targetViewportIds,f=u.toolGroupId;i.getViewports().filter((function(e){if((null==v?void 0:v.indexOf(e.id))>=0)return!0;var t=Fr(e.id,i.id);return!(!f||f!==(null==t?void 0:t.id))})).forEach((function(e){e instanceof J.VolumeViewport?Hf(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}}]),o}(La);ae(Qg,"toolName",void 0),Qg.toolName="MIPJumpToClickTool";var eh=Qg;var th=J.utilities.transformWorldToIndex,nh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:rh}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;gs(o),e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[Lr(a),Lr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),ca(s,h),g})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=dt(t.data.handles.points,2),i=a[0],l=a[1],s=o.worldToCanvas(i),c=o.worldToCanvas(l),d={start:{x:s[0],y:s[1]},end:{x:c[0],y:c[1]}};return Cd([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]])<=r})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),gs(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;c.handles.points[l]=Lr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,J.getEnabledElement)(r).renderingEngine;ca(h,i)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<s.length;v++){var f=s[v],g=f.annotationUID,h=f.data,p=h.handles,m=p.points,w=p.activeHandleIndex;u.annotationUID=g;var E=e.getStyle("lineWidth",u,f),y=e.getStyle("lineDash",u,f),I=e.getStyle("color",u,f),b=e.getStyle("shadow",u,f),C=m.map((function(e){return i.worldToCanvas(e)})),_=void 0;if(h.cachedStats[c]&&null!=h.cachedStats[c].unit?f.invalidated&&e._throttledCalculateCachedStats(f,d,t):(h.cachedStats[c]={length:null,unit:null},e._calculateCachedStats(f,d,t)),Pe(g)){ve(f)||e.editData||null===w||(_=[C[w]]),_&&Xs(n,g,"0",C,{color:I,lineDash:y,lineWidth:E});var T="".concat(g,"-line");if(Zs(n,g,"1",C[0],C[1],{color:I,width:E,lineDash:y,shadow:b},T),a=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var O=e.getLinkedTextBoxStyle(u,f);if(O.visibility){var D=e.configuration.getTextLines(h,c);if(!h.handles.textBox.hasMoved){var S=Td(C);h.handles.textBox.worldPosition=i.canvasToWorld(S)}var k=i.worldToCanvas(h.handles.textBox.worldPosition),M=rc(n,g,"1",D,k,C,{},O),x=M.x,R=M.y,P=M.width,A=M.height;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([x,R]),topRight:i.canvasToWorld([x+P,R]),bottomLeft:i.canvasToWorld([x,R+A]),bottomRight:i.canvasToWorld([x+P,R+A])}}else h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}return a})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=ad(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),gs(r);var s=(0,J.getEnabledElement)(r).renderingEngine;ca(s,l),e.preventDefault()}},{key:"_calculateLength",value:function(e,t){var n=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+r*r+o*o)}},{key:"_calculateCachedStats",value:function(e,t,n){for(var r=e.data,o=n.viewportId,a=n.renderingEngineId,i=r.handles.points[0],l=r.handles.points[1],s=r.cachedStats,c=Object.keys(s),d=0;d<c.length;d++){var u=c[d],v=this.getTargetIdImage(u,t);if(v){var f=v.imageData,g=v.dimensions,h=yd(v),p=this._calculateLength(i,l)/h,m=th(f,i),w=th(f,l);this._isInsideVolume(m,w,g)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,s[u]={length:p,unit:wd(0,v)}}}e.invalidated=!1;var E=Q.ANNOTATION_MODIFIED,y={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,E,y),s}},{key:"_isInsideVolume",value:function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}]),o}(hd);function rh(e,t){var n=e.cachedStats[t],r=n.length,o=n.unit;if(null!=r&&!isNaN(r))return["".concat(yc(r)," ").concat(o)]}ae(nh,"toolName",void 0),nh.toolName="Length";var oh=nh,ah=y(847),ih=y.n(ah);var lh=J.CONSTANTS.RENDERING_DEFAULTS;function sh(){return"rgb(0, 200, 0)"}function ch(){return!0}function dh(){return!0}function uh(){return!0}var vh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t,n,a,i,l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:J.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}};return oe(this,o),ae(ga(i=r.call(this,l,s)),"toolCenter",[0,0,0]),ae(ga(i),"_getReferenceLineColor",void 0),ae(ga(i),"_getReferenceLineControllable",void 0),ae(ga(i),"_getReferenceLineDraggableRotatable",void 0),ae(ga(i),"_getReferenceLineSlabThicknessControlsOn",void 0),ae(ga(i),"editData",void 0),ae(ga(i),"initializeViewport",(function(e){var t=e.renderingEngineId,n=e.viewportId,r=(0,J.getEnabledElementByIds)(n,t),o=r.FrameOfReferenceUID,a=r.viewport,l=a.element,s=a.getCamera(),c=s.position,d=s.focalPoint,u=s.viewPlaneNormal,v=i._getAnnotations(r);return(v=i.filterInteractableAnnotationsForElement(l,v)).length&&at(v[0].annotationUID),rt({highlighted:!1,metadata:{cameraPosition:Lr(c),cameraFocalPoint:Lr(d),FrameOfReferenceUID:o,toolName:i.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:i.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:n}},l),{normal:u,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}})),ae(ga(i),"_getViewportsInfo",(function(){return fa(i.toolGroupId).viewportsInfo})),ae(ga(i),"computeToolCenter",(function(e){if(!e.length||1===e.length)throw new Error("For crosshairs to operate, at least two viewports must be given.");var t=dt(e,3),n=t[0],r=t[1],o=t[2],a=i.initializeViewport(n),l=a.normal,s=a.point,c=i.initializeViewport(r),d=c.normal,u=c.point,v=[0,0,0],f=xs.vec3.create();if(o){var g=i.initializeViewport(o);v=g.normal,f=g.point}else xs.vec3.add(f,s,u),xs.vec3.scale(f,f,.5),xs.vec3.cross(v,l,d);var h=J.utilities.planar.planeEquation(l,s),p=J.utilities.planar.planeEquation(d,u),m=J.utilities.planar.planeEquation(v,f);i.toolCenter=J.utilities.planar.threePlaneIntersection(h,p,m);var w=(0,J.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId).renderingEngine;ca(w,e.map((function(e){return e.viewportId})))})),ae(ga(i),"addNewAnnotation",(function(e){var t=e.detail,n=t.element,r=t.currentPoints.world,o=(0,J.getEnabledElement)(n),a=o.viewport;i._jump(o,r);for(var l=i._getAnnotations(o),s=i.filterInteractableAnnotationsForElement(a.element,l),c=s[0].data,d=c.handles.rotationPoints,u=[],v=0;v<d.length-1;++v){var f=d[v][1],g=i._getReferenceLineControllable(f.id),h=i._getReferenceLineDraggableRotatable(f.id);g&&h&&(u.push(f.id),v++)}return c.activeViewportIds=[].concat(u),c.handles.activeOperation=1,e.preventDefault(),gs(n),i._activateModify(n),s[0]})),ae(ga(i),"cancel",(function(){console.log("Not implemented yet")})),ae(ga(i),"handleSelectedCallback",(function(e,t){var n=e.detail.element;t.highlighted=!0,i._activateModify(n),gs(n),e.preventDefault()})),ae(ga(i),"isPointNearTool",(function(e,t,n,r){return!!i._pointNearTool(e,t,n,6)})),ae(ga(i),"toolSelectedCallback",(function(e,t,n){var r=e.detail.element;t.highlighted=!0,i._activateModify(r),gs(r),e.preventDefault()})),ae(ga(i),"onCameraModified",(function(e){var t,n=e.detail.element,r=(0,J.getEnabledElement)(n),o=r.renderingEngine,a=r.viewport,l=i._getAnnotations(r),s=i.filterInteractableAnnotationsForElement(n,l)[0];if(s){var c=a.getCamera(),d=s.metadata.cameraPosition,u=[0,0,0];Du().subtract(c.position,d,u);var v=s.metadata.cameraFocalPoint,f=[0,0,0];Du().subtract(c.focalPoint,v,f),s.metadata.cameraPosition=Lr(c.position),s.metadata.cameraFocalPoint=Lr(c.focalPoint);var g=i._getReferenceLineControllable(a.id),h=i._getReferenceLineDraggableRotatable(a.id);if(!J.utilities.isEqual(c.position,d,.001)&&g&&h){var p=!1;J.utilities.isEqual(u,f,.001)||(p=!0);var m=Math.abs(Du().dot(u,c.viewPlaneNormal))<.01;p||m||(i.toolCenter[0]+=u[0],i.toolCenter[1]+=u[1],i.toolCenter[2]+=u[2])}null!==(t=i.configuration.autoPan)&&void 0!==t&&t.enabled&&Fr(a.id,o.id).getViewportIds().filter((function(e){return e!==a.id})).forEach((function(e){i._autoPanViewportIfNecessary(e,o)}));var w=ad(n,i.getToolName(),!1);ca(o,w)}})),ae(ga(i),"mouseMoveCallback",(function(e,t){for(var n=e.detail,r=n.element,o=n.currentPoints.canvas,a=!1,l=0;l<t.length;l++){var s=t[l];if(!ve(s)){var c=s.data,d=s.highlighted;if(c.handles){var u=c.handles.activeOperation,v=c.activeViewportIds&&c.activeViewportIds.length>0?Lr(c.activeViewportIds):[];c.activeViewportIds=[],c.handles.activeOperation=null;var f;(f=!!i.getHandleNearImagePoint(r,s,o,6)||i._pointNearTool(r,s,o,6))&&!d||!f&&d?(s.highlighted=!d,a=!0):c.handles.activeOperation===u&&i._areViewportIdArraysEqual(c.activeViewportIds,v)||(a=!0)}}}return a})),ae(ga(i),"filterInteractableAnnotationsForElement",(function(e,t){if(!t||!t.length)return[];var n=(0,J.getEnabledElement)(e).viewportId;return t.filter((function(e){return e.data.viewportId===n}))})),ae(ga(i),"renderAnnotation",(function(e,t){var n=!1,r=e.viewport,o=e.renderingEngine,a=r.element,l=i._getAnnotations(e),s=r.getCamera(),c=i.filterInteractableAnnotationsForElement(a,l)[0];if(null==l||!l.length||null==c||!c.data)return n;var d=c.annotationUID,u=r.canvas,v=u.clientWidth,f=u.clientHeight,g=Math.sqrt(v*v+f*f),h=Math.min(v,f),p=c.data,m=r.worldToCanvas(i.toolCenter),w=i._filterAnnotationsByUniqueViewportOrientations(e,l),E=[],y=[0,0,v,f];w.forEach((function(e){var t=e.data;t.handles.toolCenter=i.toolCenter;var n=o.getViewport(t.viewportId),a=n.getCamera(),l=i._getReferenceLineControllable(n.id),c=i._getReferenceLineDraggableRotatable(n.id),d=i._getReferenceLineSlabThicknessControlsOn(n.id),u=n.canvas,v=u.clientWidth,f=u.clientHeight,p=Math.sqrt(v*v+f*f),I=[.5*v,.5*f],b=n.canvasToWorld(I),C=[0,0,0];Du().cross(s.viewPlaneNormal,a.viewPlaneNormal,C),Du().normalize(C),Du().multiplyScalar(C,p);var _=[0,0,0];Du().add(b,C,_);var T=[0,0,0];Du().subtract(b,C,T);var O=r.worldToCanvas(_),D=r.worldToCanvas(b),S=xs.vec2.create();xs.vec2.subtract(S,O,D),xs.vec2.normalize(S,S);var k=xs.vec2.create();xs.vec2.scale(k,S,100*g);var M=xs.vec2.create();xs.vec2.scale(M,S,.4*h);var x=xs.vec2.create();xs.vec2.scale(x,S,.2*h);var R=xs.vec2.create(),P=i.configuration.referenceLinesCenterGapRadius;xs.vec2.scale(R,S,2===w.length?P:0);var A=xs.vec2.create(),N=xs.vec2.create(),L=xs.vec2.create(),U=xs.vec2.create(),V=xs.vec2.clone(m);c&&l||(V=xs.vec2.clone(D)),xs.vec2.add(A,V,R),xs.vec2.add(N,V,k),xs.vec2.subtract(L,V,R),xs.vec2.subtract(U,V,k),du(A,N,y),du(L,U,y);var j=xs.vec2.create();xs.vec2.subtract(j,m,M);var B=xs.vec2.create();xs.vec2.add(B,m,M);var W=xs.vec2.clone(m);!c&&d&&(W=xs.vec2.clone(D));var F=Lr(i.toolCenter);!c&&d&&(F=Lr(b));var H=[0,0,0];Du().subtract(_,T,H),Du().normalize(H);var G=s.viewPlaneNormal,q=ih().buildFromDegree().rotate(90,G).matrix,z=[0,0,0];xs.vec3.transformMat4(z,H,q);var K=n.getSlabThickness(),Y=[].concat(z);Du().multiplyScalar(Y,K);var X=[0,0,0];Du().add(F,Y,X);var Z=r.worldToCanvas(X),J=xs.vec2.create();xs.vec2.subtract(J,W,Z);var $=xs.vec2.create();xs.vec2.subtract($,W,k),xs.vec2.add($,$,J);var Q=xs.vec2.create();xs.vec2.add(Q,W,k),xs.vec2.add(Q,Q,J),du($,Q,y);var ee=xs.vec2.create();xs.vec2.add(ee,W,k),xs.vec2.subtract(ee,ee,J);var te=xs.vec2.create();xs.vec2.subtract(te,W,k),xs.vec2.subtract(te,te,J),du(ee,te,y);var ne=xs.vec2.create(),re=xs.vec2.create(),oe=xs.vec2.create(),ae=xs.vec2.create();xs.vec2.subtract(ne,W,x),xs.vec2.add(ne,ne,J),xs.vec2.add(re,W,x),xs.vec2.add(re,re,J),xs.vec2.subtract(oe,W,x),xs.vec2.subtract(oe,oe,J),xs.vec2.add(ae,W,x),xs.vec2.subtract(ae,ae,J),E.push([n,A,N,L,U,$,Q,ee,te,j,B,ne,re,oe,ae])}));var I=[],b=[],C=i._getReferenceLineColor(r.id),_=void 0!==C?C:"rgb(200, 200, 200)";return E.forEach((function(e,n){var o,a,l=e[0],s=i._getReferenceLineColor(l.id),c=i._getReferenceLineControllable(l.id),u=i._getReferenceLineDraggableRotatable(l.id)||(null===(o=i.configuration.mobile)||void 0===o?void 0:o.enabled),v=i._getReferenceLineSlabThicknessControlsOn(l.id)||(null===(a=i.configuration.mobile)||void 0===a?void 0:a.enabled),f=p.activeViewportIds.find((function(e){return e===l.id})),g=void 0!==s?s:"rgb(200, 200, 200)",h=1,m=null!==p.handles.activeOperation&&1===p.handles.activeOperation&&f;m&&(h=2.5);var w="".concat(n);if(c&&u?(w="".concat(n,"One"),Zs(t,d,w,e[1],e[2],{color:g,lineWidth:h}),w="".concat(n,"Two"),Zs(t,d,w,e[3],e[4],{color:g,lineWidth:h})):Zs(t,d,w,e[2],e[4],{color:g,lineWidth:h}),c){var E;g=void 0!==s?s:"rgb(200, 200, 200)";var y=2===p.handles.activeOperation,C=[e[9],e[10]],_=[r.canvasToWorld(e[9]),l,e[1],e[2]],T=[r.canvasToWorld(e[10]),l,e[3],e[4]];I.push(_,T);var O=3===p.handles.activeOperation,D=[e[11],e[12],e[13],e[14]],S=[r.canvasToWorld(e[11]),l,e[5],e[6]],k=[r.canvasToWorld(e[12]),l,e[5],e[6]],M=[r.canvasToWorld(e[13]),l,e[7],e[8]],x=[r.canvasToWorld(e[14]),l,e[7],e[8]];if(b.push(S,k,M,x),(m||null!==(E=i.configuration.mobile)&&void 0!==E&&E.enabled)&&!y&&!O&&u&&v){var R,P,A,N,L,U,V,j,B="".concat(n,"One");Xs(t,d,B,C,{color:g,handleRadius:null!==(R=i.configuration.mobile)&&void 0!==R&&R.enabled?null===(P=i.configuration.mobile)||void 0===P?void 0:P.handleRadius:3,opacity:null!==(A=i.configuration.mobile)&&void 0!==A&&A.enabled?null===(N=i.configuration.mobile)||void 0===N?void 0:N.opacity:1,type:"circle"}),B="".concat(n,"Two"),Xs(t,d,B,D,{color:g,handleRadius:null!==(L=i.configuration.mobile)&&void 0!==L&&L.enabled?null===(U=i.configuration.mobile)||void 0===U?void 0:U.handleRadius:3,opacity:null!==(V=i.configuration.mobile)&&void 0!==V&&V.enabled?null===(j=i.configuration.mobile)||void 0===j?void 0:j.opacity:1,type:"rect"})}else if(m&&!y&&!O&&u){var W,F,H,G,q="".concat(n);Xs(t,d,q,C,{color:g,handleRadius:null!==(W=i.configuration.mobile)&&void 0!==W&&W.enabled?null===(F=i.configuration.mobile)||void 0===F?void 0:F.handleRadius:3,opacity:null!==(H=i.configuration.mobile)&&void 0!==H&&H.enabled?null===(G=i.configuration.mobile)||void 0===G?void 0:G.opacity:1,type:"circle"})}else if(f&&!y&&!O&&v){var z,K,Y,X,Z="".concat(n);Xs(t,d,Z,D,{color:g,handleRadius:null!==(z=i.configuration.mobile)&&void 0!==z&&z.enabled?null===(K=i.configuration.mobile)||void 0===K?void 0:K.handleRadius:3,opacity:null!==(Y=i.configuration.mobile)&&void 0!==Y&&Y.enabled?null===(X=i.configuration.mobile)||void 0===X?void 0:X.opacity:1,type:"rect"})}else if(y&&u){var J="".concat(n);Xs(t,d,J,C,{color:g,handleRadius:2,fill:g,type:"circle"})}else O&&f&&v&&Xs(t,d,w,D,{color:g,handleRadius:2,fill:g,type:"rect"});l.getSlabThickness()>.5&&v&&(w="".concat(n,"STOne"),Zs(t,d,w,e[5],e[6],{color:g,width:1,lineDash:[2,3]}),w="".concat(n,"STTwo"),Zs(t,d,w,e[7],e[8],{color:g,width:e,lineDash:[2,3]}))}})),n=!0,p.handles.rotationPoints=I,p.handles.slabThicknessPoints=b,i.configuration.viewportIndicators&&Ks(t,d,"0",[.95*v,.05*f],.01*g,{color:_,fill:_}),n})),ae(ga(i),"_getAnnotations",(function(e){var t=e.viewport;return nt(i.getToolName(),t.element)})),ae(ga(i),"_onNewVolume",(function(e){var t=i._getViewportsInfo();i.computeToolCenter(t)})),ae(ga(i),"_areViewportIdArraysEqual",(function(e,t){return e.length===t.length&&(e.forEach((function(e){for(var n=!1,r=0;r<t.length;++r)if(e===t[r]){n=!0;break}if(!1===n)return!1})),!0)})),ae(ga(i),"_getAnnotationsForViewportsWithDifferentCameras",(function(e,t){var n=e.viewportId,r=e.renderingEngine,o=e.viewport,a=t.filter((function(e){return e.data.viewportId!==n}));if(!a||!a.length)return[];var i=o.getCamera(),l=i.viewPlaneNormal,s=i.position,c=a.filter((function(e){var t=e.data.viewportId,n=r.getViewport(t).getCamera();return!(J.utilities.isEqual(n.viewPlaneNormal,l,.01)&&J.utilities.isEqual(n.position,s,1))}));return c})),ae(ga(i),"_filterViewportWithSameOrientation",(function(e,t,n){var r=e.renderingEngine,o=t.data,a=r.getViewport(o.viewportId),l=n.filter((function(e){var t=e.data,n=r.getViewport(t.viewportId);return!0===i._getReferenceLineControllable(n.id)}));if(!l||!l.length)return[];var s=a.getCamera(),c=s.viewPlaneNormal;return Du().normalize(c),l.filter((function(e){var t=e.data.viewportId,n=r.getViewport(t).getCamera(),o=n.viewPlaneNormal;return Du().normalize(o),J.utilities.isEqual(c,o,.01)&&J.utilities.isEqual(s.viewUp,n.viewUp,.01)}))})),ae(ga(i),"_filterAnnotationsByUniqueViewportOrientations",(function(e,t){var n=e.renderingEngine,r=e.viewport,o=r.getCamera().viewPlaneNormal;Du().normalize(o);for(var a=t.filter((function(e){var t=e.data,o=n.getViewport(t.viewportId),a=i._getReferenceLineControllable(o.id);return r!==o&&!0===a})),l=[],s=0;s<a.length;++s){var c=a[s],d=c.data.viewportId,u=n.getViewport(d).getCamera(),v=u.viewPlaneNormal;if(Du().normalize(v),!J.utilities.isEqual(o,v,.01)&&!J.utilities.isOpposite(o,v,.01)){for(var f=!1,g=0;g<l.length;++g){var h=l[g].data.viewportId,p=n.getViewport(h).getCamera();J.utilities.isEqual(p.viewPlaneNormal,u.viewPlaneNormal,.01)&&J.utilities.isEqual(p.position,u.position,1)&&(f=!0)}f||l.push(c)}}for(var m=t.filter((function(e){var t=e.data,o=n.getViewport(t.viewportId),a=i._getReferenceLineControllable(o.id);return r!==o&&!0!==a})),w=0;w<m.length;++w){var E=m[w],y=E.data.viewportId,I=n.getViewport(y).getCamera(),b=I.viewPlaneNormal;if(Du().normalize(b),!J.utilities.isEqual(o,b,.01)&&!J.utilities.isOpposite(o,b,.01)){for(var C=!1,_=0;_<l.length;++_){var T=l[_].data.viewportId,O=n.getViewport(T).getCamera();J.utilities.isEqual(O.viewPlaneNormal,I.viewPlaneNormal,.01)&&J.utilities.isEqual(O.position,I.position,1)&&(C=!0)}C||l.push(E)}}for(var D=i._getAnnotationsForViewportsWithDifferentCameras(e,t),S=function(){var e=D[k];if(l.some((function(t){return t===e})))return"continue";var t=e.data.viewportId,r=n.getViewport(t).getCamera(),a=r.viewPlaneNormal;if(Du().normalize(a),J.utilities.isEqual(o,a,.01)||J.utilities.isOpposite(o,a,.01))return"continue";for(var i=!1,s=0;s<l.length;++s){var c=l[s].data.viewportId,d=n.getViewport(c).getCamera();J.utilities.isEqual(d.viewPlaneNormal,r.viewPlaneNormal,.01)&&J.utilities.isEqual(d.position,r.position,1)&&(i=!0)}i||l.push(e)},k=0;k<D.length;++k)S();return l})),ae(ga(i),"_checkIfViewportsRenderingSameScene",(function(e,t){var n=e.getActors(),r=t.getActors(),o=!0;return n.forEach((function(e){n.length===r.length&&void 0!==r.find((function(t){return t.uid===e.uid}))||(o=!1)})),o})),ae(ga(i),"_jump",(function(e,t){Ke.isInteractingWithTool=!0;var n=e.viewport,r=e.renderingEngine,o=i._getAnnotations(e),a=[0,0,0];Du().subtract(t,i.toolCenter,a);var l=i._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((function(e){var t=e.data,o=r.getViewport(t.viewportId),a=i._checkIfViewportsRenderingSameScene(n,o);return i._getReferenceLineControllable(o.id)&&i._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===l.length?(Ke.isInteractingWithTool=!1,!1):(i._applyDeltaShiftToSelectedViewportCameras(r,l,a),Ke.isInteractingWithTool=!1,!0)})),ae(ga(i),"_activateModify",(function(e){var t;Ke.isInteractingWithTool=!(null!==(t=i.configuration.mobile)&&void 0!==t&&t.enabled),e.addEventListener(Q.MOUSE_UP,i._endCallback),e.addEventListener(Q.MOUSE_DRAG,i._dragCallback),e.addEventListener(Q.MOUSE_CLICK,i._endCallback),e.addEventListener(Q.TOUCH_END,i._endCallback),e.addEventListener(Q.TOUCH_DRAG,i._dragCallback),e.addEventListener(Q.TOUCH_TAP,i._endCallback)})),ae(ga(i),"_deactivateModify",(function(e){Ke.isInteractingWithTool=!1,e.removeEventListener(Q.MOUSE_UP,i._endCallback),e.removeEventListener(Q.MOUSE_DRAG,i._dragCallback),e.removeEventListener(Q.MOUSE_CLICK,i._endCallback),e.removeEventListener(Q.TOUCH_END,i._endCallback),e.removeEventListener(Q.TOUCH_DRAG,i._dragCallback),e.removeEventListener(Q.TOUCH_TAP,i._endCallback)})),ae(ga(i),"_endCallback",(function(e){var t=e.detail.element;i.editData.annotation.data.handles.activeOperation=null,i.editData.annotation.data.activeViewportIds=[],i._deactivateModify(t),fs(t),i.editData=null;var n=(0,J.getEnabledElement)(t).renderingEngine,r=ad(t,i.getToolName(),!1);ca(n,r)})),ae(ga(i),"_dragCallback",(function(e){var t=e.detail,n=t.deltaPoints.world;if(!(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)){var r=t.element,o=(0,J.getEnabledElement)(r),a=o.renderingEngine,l=o.viewport,s=i._getAnnotations(o),c=i.filterInteractableAnnotationsForElement(r,s)[0];if(c){var d=c.data.handles,u=e.detail.currentPoints.canvas;if(1===d.activeOperation){var v=i._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineDraggableRotatable(n.id);return!0===r&&!0===o&&c.data.activeViewportIds.find((function(e){return e===n.id}))}));i._applyDeltaShiftToSelectedViewportCameras(a,v,n)}else if(2===d.activeOperation){var f=i._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineDraggableRotatable(n.id);return!0===r&&!0===o})),g=xs.vec2.create(),h=xs.vec2.create(),p=[i.toolCenter[0],i.toolCenter[1],i.toolCenter[2]],m=l.worldToCanvas(p),w=t.currentPoints.canvas,E=xs.vec2.create();xs.vec2.sub(E,w,t.deltaPoints.canvas),xs.vec2.sub(g,E,m),xs.vec2.sub(h,w,m);var y=xs.vec2.angle(g,h);i._isClockWise(m,E,w)&&(y*=-1),y=Math.round(100*y)/100;var I=l.getCamera().viewPlaneNormal,b=ih().buildFromRadian().translate(p[0],p[1],p[2]).rotate(y,I).translate(-p[0],-p[1],-p[2]).matrix,C=[];f.forEach((function(e){var t=e.data;t.handles.toolCenter=p;var n=a.getViewport(t.viewportId),r=n.getCamera(),o=r.viewUp,i=r.position,l=r.focalPoint;o[0]+=i[0],o[1]+=i[1],o[2]+=i[2],xs.vec3.transformMat4(l,l,b),xs.vec3.transformMat4(i,i,b),xs.vec3.transformMat4(o,o,b),o[0]-=i[0],o[1]-=i[1],o[2]-=i[2],n.setCamera({position:i,viewUp:o,focalPoint:l}),C.push(n.id)})),a.renderViewports(C)}else if(3===d.activeOperation){var _=i._getAnnotationsForViewportsWithDifferentCameras(o,s).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineSlabThicknessControlsOn(n.id);return!0===r&&!0===o&&c.data.activeViewportIds.find((function(e){return e===n.id}))}));if(0===_.length)return;var T=i._filterViewportWithSameOrientation(o,_[0],s),O=[];O.push(l.id),T.forEach((function(e){var r=e.data,o=a.getViewport(r.viewportId),s=o.getCamera().viewPlaneNormal,d=Du().dot(n,s),v=Lr(s);if(Du().multiplyScalar(v,d),Math.abs(v[0])>.001||Math.abs(v[1])>.001||Math.abs(v[2])>.001){var f=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),g=t.lastPoints.world,h=[0,0,0],p=[i.toolCenter[0],i.toolCenter[1],i.toolCenter[2]];if(!i._getReferenceLineDraggableRotatable(o.id)){var m=i.editData.annotation.data.handles.rotationPoints.filter((function(e){return e[1].uid===o.id}));if(2===m.length){var w=l.canvasToWorld(m[0][3]),E=l.canvasToWorld(m[1][3]);Du().add(w,E,p),Du().multiplyScalar(p,.5)}}Du().subtract(g,p,h);var y=Du().dot(h,s),I=Lr(s);Du().multiplyScalar(I,y);var b=[I[0],I[1],I[2]];xs.vec3.normalize(b,b);var C=[v[0],v[1],v[2]];xs.vec3.normalize(C,C);var _=o.getSlabThickness();J.utilities.isOpposite(b,C,.001)?_-=f:_+=f,_=Math.abs(_),_=Math.max(lh.MINIMUM_SLAB_THICKNESS,_),i._pointNearReferenceLine(c,u,6,o)&&(_=lh.MINIMUM_SLAB_THICKNESS),Fr(o.id,a.id).getToolInstance(i.getToolName()).setSlabThickness(o,_),O.push(o.id)}})),a.renderViewports(O)}}}})),ae(ga(i),"_pointNearReferenceLine",(function(e,t,n,r){for(var o=e.data.handles.rotationPoints,a=0;a<o.length-1;++a){var l=o[a][1];if(l.id===r.id&&i._getReferenceLineControllable(l.id)){var s={start:{x:o[a][2][0],y:o[a][2][1]},end:{x:o[a][3][0],y:o[a][3][1]}},c=Cd([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),d={start:{x:o[a+1][2][0],y:o[a+1][2][1]},end:{x:o[a+1][3][0],y:o[a+1][3][1]}},u=Cd([d.start.x,d.start.y],[d.end.x,d.end.y],[t[0],t[1]]);if(c<=n||u<=n)return!0;a++}}return!1})),i._getReferenceLineColor=(null===(e=l.configuration)||void 0===e?void 0:e.getReferenceLineColor)||sh,i._getReferenceLineControllable=(null===(t=l.configuration)||void 0===t?void 0:t.getReferenceLineControllable)||ch,i._getReferenceLineDraggableRotatable=(null===(n=l.configuration)||void 0===n?void 0:n.getReferenceLineDraggableRotatable)||dh,i._getReferenceLineSlabThicknessControlsOn=(null===(a=l.configuration)||void 0===a?void 0:a.getReferenceLineSlabThicknessControlsOn)||uh,i}return re(o,[{key:"onSetToolActive",value:function(){var e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}},{key:"onSetToolPassive",value:function(){var e=this._getViewportsInfo();this.computeToolCenter(e)}},{key:"onSetToolEnabled",value:function(){var e=this._getViewportsInfo();this.computeToolCenter(e)}},{key:"onSetToolDisabled",value:function(){var e=this,t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t),t.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,o=(0,J.getEnabledElementByIds)(r,n);if(o){var a=e._getAnnotations(o);null!=a&&a.length&&a.forEach((function(e){at(e.annotationUID)}))}}))}},{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=this._getRotationHandleNearImagePoint(o,t,n,r);return null!==a||null!==(a=this._getSlabThicknessHandleNearImagePoint(o,t,n,r))?a:void 0}},{key:"_unsubscribeToViewportNewVolumeSet",value:function(e){var t=this;e.forEach((function(e){var n=e.viewportId,r=e.renderingEngineId;(0,J.getEnabledElementByIds)(n,r).viewport.element.removeEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,t._onNewVolume)}))}},{key:"_subscribeToViewportNewVolumeSet",value:function(e){var t=this;e.forEach((function(e){var n=e.viewportId,r=e.renderingEngineId;(0,J.getEnabledElementByIds)(n,r).viewport.element.addEventListener(J.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,t._onNewVolume)}))}},{key:"_autoPanViewportIfNecessary",value:function(e,t){var n=t.getViewport(e),r=n.canvas,o=r.clientWidth,a=r.clientHeight,i=n.worldToCanvas(this.toolCenter),l=this.configuration.autoPan.panSize,s=[i[0],i[1]];if(i[0]<0?s[0]=l:i[0]>o&&(s[0]=o-l),i[1]<0?s[1]=l:i[1]>a&&(s[1]=a-l),s[0]!==i[0]||s[1]!==i[1]){var c=n.canvasToWorld(s),d=[c[0]-this.toolCenter[0],c[1]-this.toolCenter[1],c[2]-this.toolCenter[2]],u=n.getCamera(),v=u.focalPoint,f=u.position,g=[f[0]-d[0],f[1]-d[1],f[2]-d[2]],h=[v[0]-d[0],v[1]-d[1],v[2]-d[2]];n.setCamera({focalPoint:h,position:g}),n.render()}}},{key:"setSlabThickness",value:function(e,t){var n,r=this.configuration.filterActorUIDsToSetSlabThickness;r&&r.length>0&&(n=r);var o=this.configuration.slabThicknessBlendMode;t===lh.MINIMUM_SLAB_THICKNESS&&(o=J.Enums.BlendModes.COMPOSITE),e.setBlendMode(o,n,!1),e.setSlabThickness(t,n)}},{key:"_isClockWise",value:function(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}},{key:"_applyDeltaShiftToSelectedViewportCameras",value:function(e,t,n){var r=this;t.forEach((function(t){r._applyDeltaShiftToViewportCamera(e,t,n)}))}},{key:"_applyDeltaShiftToViewportCamera",value:function(e,t,n){var r=t.data,o=e.getViewport(r.viewportId),a=o.getCamera(),i=a.viewPlaneNormal,l=Du().dot(n,i),s=Lr(i);if(Du().multiplyScalar(s,l),Math.abs(s[0])>.001||Math.abs(s[1])>.001||Math.abs(s[2])>.001){var c=[0,0,0],d=[0,0,0];Du().add(a.focalPoint,s,c),Du().add(a.position,s,d),o.setCamera({focalPoint:c,position:d}),o.render()}}},{key:"_getRotationHandleNearImagePoint",value:function(e,t,n,r){for(var o=t.data,a=o.handles.rotationPoints,i=0;i<a.length;i++){var l=a[i][0],s=a[i][1];if(this._getReferenceLineControllable(s.id)&&this._getReferenceLineDraggableRotatable(s.id)){var c=e.worldToCanvas(l);if(xs.vec2.distance(n,c)<r)return o.handles.activeOperation=2,this.editData={annotation:t},l}}return null}},{key:"_getSlabThicknessHandleNearImagePoint",value:function(e,t,n,r){for(var o=t.data,a=o.handles.slabThicknessPoints,i=0;i<a.length;i++){var l=a[i][0],s=a[i][1];if(this._getReferenceLineControllable(s.id)&&this._getReferenceLineSlabThicknessControlsOn(s.id)){var c=e.worldToCanvas(l);if(xs.vec2.distance(n,c)<r)return o.handles.activeOperation=3,o.activeViewportIds=[s.id],this.editData={annotation:t},l}}return null}},{key:"_pointNearTool",value:function(e,t,n,r){for(var o=this,a=(0,J.getEnabledElement)(e).viewport.canvas,i=a.clientWidth,l=a.clientHeight,s=Math.sqrt(i*i+l*l),c=t.data,d=c.handles.rotationPoints,u=c.handles.slabThicknessPoints,v=[],f=0;f<d.length-1;++f){var g=d[f][1],h=this._getReferenceLineControllable(g.id),p=this._getReferenceLineDraggableRotatable(g.id);if(h&&p){var m={start:{x:d[f][2][0],y:d[f][2][1]},end:{x:d[f][3][0],y:d[f][3][1]}},w=Cd([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]),E={start:{x:d[f+1][2][0],y:d[f+1][2][1]},end:{x:d[f+1][3][0],y:d[f+1][3][1]}},y=Cd([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=r||y<=r)&&(v.push(g.id),c.handles.activeOperation=1),f++}}for(var I=function(e){var t=u[e][1];if(v.find((function(e){return e===t.id})))return b=e,"continue";var a=o._getReferenceLineControllable(t.id),i=o._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!i)return b=e,"continue";var l=u[e][2],d=u[e][3],f=xs.vec2.create();xs.vec2.add(f,l,d),xs.vec2.scale(f,f,.5);var g=xs.vec2.create();xs.vec2.subtract(g,l,f),xs.vec2.normalize(g,g);var h=xs.vec2.create();xs.vec2.scale(h,g,.05*s);var p=xs.vec2.create(),m=xs.vec2.create();xs.vec2.add(p,f,h),xs.vec2.subtract(m,f,h);var w={start:{x:p[0],y:p[1]},end:{x:l[0],y:l[1]}},E=Cd([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]),y={start:{x:m[0],y:m[1]},end:{x:d[0],y:d[1]}},I=Cd([y.start.x,y.start.y],[y.end.x,y.end.y],[n[0],n[1]]);(E<=r||I<=r)&&(v.push(t.id),c.handles.activeOperation=null),e++,b=e},b=0;b<u.length-1;++b)I(b);return c.activeViewportIds=[].concat(v),this.editData={annotation:t},1===c.handles.activeOperation}}]),o}(hd);ae(vh,"toolName",void 0),vh.toolName="Crosshairs";var fh=vh;var gh=J.CONSTANTS.EPSILON,hh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",{}),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"_init",(function(){var t=(0,J.getRenderingEngines)()[0];if(t){var n=t.getViewports();n=nd(n,e.getToolName());var r=t.getViewport(e.configuration.sourceViewportId);if(r&&r.getImageData()){var o=r.element,a=r.getCamera(),i=a.viewUp,l=a.viewPlaneNormal,s=J.utilities.getViewportImageCornersInWorld(r),c=e.editData.annotation,d=r.getFrameOfReferenceUID();if(c)e.editData.annotation.data.handles.points=s;else{var u={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(l),viewUp:Lr(i),FrameOfReferenceUID:d,referencedImageId:null},data:{handles:{points:s}}};rt(u,o),c=u}e.editData={sourceViewport:r,renderingEngine:t,annotation:c},ca(t,n.filter((function(e){return e.id!==r.id})).map((function(e){return e.id})))}}})),ae(ga(e),"onSetToolEnabled",(function(){e._init()})),ae(ga(e),"onCameraModified",(function(t){e._init()})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=t.viewport,i=e.editData,l=i.annotation,s=i.sourceViewport,c=!1;if(!s)return c;if(s.id===a.id)return c;if(!l||null==l||null===(r=l.data)||void 0===r||null===(o=r.handles)||void 0===o||!o.points)return c;var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=l.data.handles.points[0],v=l.data.handles.points[1],f=l.data.handles.points[2],g=l.data.handles.points[3],h=a.getCamera(),p=h.focalPoint,m=h.viewPlaneNormal,w=h.viewUp,E=s.getCamera().viewPlaneNormal;if(e.isParallel(m,E))return c;var y=J.utilities.planar.planeEquation(m,p),I=[u,f,v,g],b=[u,v,f,g],C=I,_=xs.vec3.subtract(xs.vec3.create(),I[0],I[1]);_=xs.vec3.normalize(xs.vec3.create(),_);var T=xs.vec3.subtract(xs.vec3.create(),I[2],I[0]);T=xs.vec3.normalize(xs.vec3.create(),T);var O=xs.vec3.cross(xs.vec3.create(),_,T);if(e.isParallel(O,m))return c;e.isPerpendicular(_,m)&&(C=b);var D=J.utilities.planar.linePlaneIntersection(C[0],C[1],y),S=J.utilities.planar.linePlaneIntersection(C[2],C[3],y),k=l.annotationUID;d.annotationUID=k;var M=e.getStyle("lineWidth",d,l),x=e.getStyle("lineDash",d,l),R=e.getStyle("color",d,l),P=e.getStyle("shadow",d,l),A=[D,S].map((function(e){return a.worldToCanvas(e)}));e.configuration.showFullDimension&&(A=e.handleFullDimension(a,D,m,w,S,A));var N="".concat(k,"-line");return Zs(n,k,"1",A[0],A[1],{color:R,width:M,lineDash:x,shadow:P},N),!0})),ae(ga(e),"isPerpendicular",(function(e,t){var n=xs.vec3.dot(e,t);return Math.abs(n)<gh})),e}return re(o,[{key:"handleFullDimension",value:function(e,t,n,r,o,a){var i=this,l=e.getRenderingEngine(),s=this.getTargetId(e),c=this.getTargetIdImage(s,l),d=this.getReferencedImageId(e,t,n,r);if(d&&c)try{var u=c.imageData,v=c.dimensions,f=dt([u.indexToWorld([0,0,0]),u.indexToWorld([v[0]-1,0,0]),u.indexToWorld([v[0]-1,v[1]-1,0]),u.indexToWorld([0,v[1]-1,0])].map((function(e){return J.utilities.worldToImageCoords(d,e)})),4),g=f[0],h=f[1],p=f[2],m=f[3],w=dt([t,o].map((function(e){return J.utilities.worldToImageCoords(d,e)})),2),E=w[0],y=w[1];a=[[g,h],[h,p],[m,p],[g,m]].map((function(e){var t=dt(e,2),n=t[0],r=t[1];return i.intersectInfiniteLines(n,r,E,y)})).filter((function(e){return e&&i.isInBound(e,v)})).map((function(t){var n=J.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return a}},{key:"intersectInfiniteLines",value:function(e,t,n,r){var o=dt(e,2),a=o[0],i=o[1],l=dt(t,2),s=l[0],c=l[1],d=dt(n,2),u=d[0],v=d[1],f=dt(r,2),g=f[0],h=f[1],p=c-i,m=a-s,w=s*i-a*c,E=h-v,y=u-g,I=g*v-u*h;if(!(Math.abs(p*y-E*m)<gh))return[(m*I-y*w)/(p*y-E*m),(E*w-p*I)/(p*y-E*m)]}},{key:"isParallel",value:function(e,t){return Math.abs(xs.vec3.dot(e,t))>1-gh}},{key:"isInBound",value:function(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}]),o}(vd);ae(hh,"toolName",void 0),hh.toolName="ReferenceLines";var ph=hh;var mh=J.CONSTANTS.EPSILON,wh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"onSetToolEnabled",(function(){e._init()})),ae(ga(e),"onSetToolActive",(function(){e._init()})),ae(ga(e),"_init",(function(){var t=e.configuration.sourceImageIds;if(null!=t&&t.length){var n=J.metaData.get("imagePlaneModule",t[0]);if(n){var r=n.frameOfReferenceUID,o=fa(e.toolGroupId).viewportsInfo;if(null!=o&&o.length){var a=nt(e.getToolName(),r);if(null==a||!a.length){var i=t.map((function(t){return e.calculateImageIdPointSets(t)}));rt({highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),FrameOfReferenceUID:r,referencedImageId:null},data:{viewportData:new Map,pointSets:i}},r)}ca((0,J.getRenderingEngine)(o[0].renderingEngineId),o.map((function(e){return e.viewportId})))}else console.warn("OverlayGridTool: No viewports found")}else console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds")}else console.warn("OverlayGridTool: No sourceImageIds provided in configuration")})),ae(ga(e),"calculateImageIdPointSets",(function(e){var t=J.metaData.get("imagePlaneModule",e),n=t.imagePositionPatient,r=t.rows,o=t.columns,a=t.rowCosines,i=t.columnCosines,l=t.rowPixelSpacing,s=t.columnPixelSpacing,c=Lr(n),d=Lr(n),u=Lr(n),v=Lr(n);return xs.vec3.scaleAndAdd(d,n,i,o*s),xs.vec3.scaleAndAdd(u,n,a,r*l),xs.vec3.scaleAndAdd(v,u,i,o*s),{pointSet1:[c,u,d,v],pointSet2:[c,d,u,v]}})),ae(ga(e),"renderAnnotation",(function(t,n){var r=e.configuration.sourceImageIds,o=!1;if(null==r||!r.length)return o;var a=t.viewport,i=t.FrameOfReferenceUID;if(a.getImageIds().length<2)return o;var l=nt(e.getToolName(),i);if(null==l||!l.length)return o;var s=l[0],c=s.annotationUID,d=a.getCamera(),u=d.focalPoint,v=d.viewPlaneNormal,f={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},g=e.getImageIdNormal(r[0]);if(e.isParallel(v,g))return o;for(var h=J.utilities.planar.planeEquation(v,u),p=s.data.pointSets,m=s.data.viewportData,w=0;w<r.length;w++){var E=p[w],y=E.pointSet1,I=E.pointSet2,b=m.get(a.id)||e.initializeViewportData(m,a.id);if(!b.pointSetsToUse[w]){var C=y,_=xs.vec3.subtract(xs.vec3.create(),y[0],y[1]);_=xs.vec3.normalize(xs.vec3.create(),_),e.isPerpendicular(_,v)&&(C=I),b.pointSetsToUse[w]=C,b.lineStartsWorld[w]=J.utilities.planar.linePlaneIntersection(C[0],C[1],h),b.lineEndsWorld[w]=J.utilities.planar.linePlaneIntersection(C[2],C[3],h)}var T=b.lineStartsWorld[w],O=b.lineEndsWorld[w];f.annotationUID=c;var D=e.getStyle("lineWidth",f,s),S=e.getStyle("lineDash",f,s),k=e.getStyle("color",f,s),M=e.getStyle("shadow",f,s),x=[T,O].map((function(e){return a.worldToCanvas(e)})),R="".concat(c,"-line");Zs(n,c,"".concat(w),x[0],x[1],{color:k,width:D,lineDash:S,shadow:M},R)}return!0})),ae(ga(e),"initializeViewportData",(function(e,t){return e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)})),ae(ga(e),"isPerpendicular",(function(e,t){var n=xs.vec3.dot(e,t);return Math.abs(n)<mh})),e}return re(o,[{key:"isParallel",value:function(e,t){return Math.abs(xs.vec3.dot(e,t))>1-mh}},{key:"getImageIdNormal",value:function(e){var t=J.metaData.get("imagePlaneModule",e).imageOrientationPatient,n=xs.vec3.fromValues(t[0],t[1],t[2]),r=xs.vec3.fromValues(t[3],t[4],t[5]);return xs.vec3.cross(xs.vec3.create(),n,r)}}]),o}(vd);ae(wh,"toolName",void 0),wh.toolName="OverlayGrid";var Eh=wh;var yh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{opacity:.5}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_init",(function(){var t,n=fa(e.toolGroupId).viewportsInfo;if(null!=n&&n.length){var r=null===(t=(0,J.getRenderingEngine)(n[0].renderingEngineId))||void 0===t?void 0:t.getViewport(n[0].viewportId);if(r){var o=r.getFrameOfReferenceUID(),a=nt(e.getToolName(),o);if(null==a||!a.length){var i=new Map;!function(e,t){t.forEach((function(t){var n,r=t.viewportId,o=t.renderingEngineId,a=null===(n=(0,J.getRenderingEngine)(o))||void 0===n?void 0:n.getViewport(r);Ih(e,a)}))}(i,n),rt({highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),FrameOfReferenceUID:o,referencedImageId:null},data:{actorsWorldPointsMap:i}},o)}ca((0,J.getRenderingEngine)(n[0].renderingEngineId),n.map((function(e){return e.viewportId})))}}else console.warn(e.getToolName()+"Tool: No viewports found")})),ae(ga(e),"onSetToolEnabled",(function(){e._init()})),ae(ga(e),"onCameraModified",(function(t){e._init()})),ae(ga(e),"renderAnnotation",(function(t,n){var r=t.viewport,o=t.FrameOfReferenceUID,a=!1,i=nt(e.getToolName(),o);if(null==i||!i.length)return a;var l=i[0],s=l.annotationUID,c=l.data.actorsWorldPointsMap;Ih(c,r);var d=r.getActors(),u=bh(r);return d.forEach((function(t){if(null!=t&&t.clippingFilter){var o=c.get(t.uid);if(o&&o.get(u))for(var a=1,i=o.get(u),l=i.worldPointsSet,d=i.color,v=0;v<l.length;v++){var f=l[v].map((function(e){return r.worldToCanvas(e)})),g={color:d,fillColor:d,fillOpacity:e.configuration.opacity,connectLastToFirst:!0},h=t.uid+"#"+a;$s(n,s,h,f,g),a++}}})),!0})),e}return re(o)}(vd);function Ih(e,t){var n=t.getActors(),r=bh(t);n.forEach((function(t){if(null!=t&&t.clippingFilter){var n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(r)){var o=Xf(t.clippingFilter.getOutputData());if(!o)return;var a=function(e){function t(e){var t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(r,{worldPointsSet:o,color:a})}}}))}function bh(e){var t=e.getCamera().viewPlaneNormal,n=e.getCurrentImageIdIndex();return"".concat(e.id,"-").concat($a(t),"-").concat(n)}ae(yh,"toolName",void 0),yh.toolName="SegmentationIntersection";var Ch=yh;function _h(e,t,n,r){var o=xs.vec3.create();xs.vec3.cross(o,t,e);var a=xs.vec3.fromValues.apply(xs.vec3,Lr(n)),i=xs.vec3.fromValues.apply(xs.vec3,Lr(r)),l=xs.vec3.create();xs.vec3.subtract(l,a,i);var s=xs.vec3.length(l);if(s<1e-4)return{worldWidth:0,worldHeight:0};var c=xs.vec3.dot(l,o)/(s*xs.vec3.length(o));return{worldWidth:Math.sqrt(1-c*c)*s,worldHeight:c*s}}var Th=J.utilities.transformWorldToIndex,Oh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:Dh,statsCalculator:xd}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",!1),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(r.canvas,(0,J.getEnabledElement)(o)),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},cachedStats:{},initialRotation:l.getRotation()}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,centerWorld:a,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,h),g})),ae(ga(e),"isPointNearTool",(function(t,n,r,o){var a=(0,J.getEnabledElement)(t).viewport,i=dt(Oc(n.data.handles.points.map((function(e){return a.worldToCanvas(e)}))),2),l=i[0],s=i[1],c={left:Math.min(l[0],s[0])+o/2,top:Math.min(l[1],s[1])+o/2,width:Math.abs(l[0]-s[0])-o,height:Math.abs(l[1]-s[1])-o},d={left:Math.min(l[0],s[0])-o/2,top:Math.min(l[1],s[1])-o/2,width:Math.abs(l[0]-s[0])+o,height:Math.abs(l[1]-s[1])+o},u=e._pointInEllipseCanvas(c,r);return!(!e._pointInEllipseCanvas(d,r)||u)})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},gs(r),e._activateModify(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l,s,c,d,u=!1;if(r.worldPosition)u=!0;else{var v=a.handles.points,f=(0,J.getEnabledElement)(o).viewport,g=f.worldToCanvas,h=f.canvasToWorld;i=v.findIndex((function(e){return e===r}));var p=v.map(g);d=p[i],s=Math.abs(p[2][0]-p[3][0]),c=Math.abs(p[0][1]-p[1][1]),l=h([(p[2][0]+p[3][0])/2,(p[0][1]+p[1][1])/2])}var m=ad(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:m,handleIndex:i,canvasWidth:s,canvasHeight:c,centerWorld:l,originalHandleCanvas:d,movingTextBox:u},e._activateModify(o),gs(o);var w=(0,J.getEnabledElement)(o).renderingEngine;ca(w,m),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){o.highlighted=!1,s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}}})),ae(ga(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,J.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport,s=l.canvasToWorld,c=e.editData,d=c.annotation,u=c.viewportIdsToRender,v=c.centerWorld,f=l.worldToCanvas(v),g=d.data,h=Math.abs(o[0]-f[0]),p=Math.abs(o[1]-f[1]),m=[f[0],f[1]-p],w=[f[0],f[1]+p],E=[f[0]-h,f[1]],y=[f[0]+h,f[1]];g.handles.points=[s(m),s(w),s(E),s(y)],d.invalidated=!0,e.editData.hasMoved=!0,ca(i,u)})),ae(ga(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else e._dragHandle(t),a.invalidated=!0;var g=(0,J.getEnabledElement)(r).renderingEngine;ca(g,i)})),ae(ga(e),"_dragHandle",(function(t){var n=t.detail,r=n.element,o=(0,J.getEnabledElement)(r).viewport,a=o.canvasToWorld,i=(o.worldToCanvas,e.editData),l=i.annotation,s=i.canvasWidth,c=i.canvasHeight,d=i.handleIndex,u=i.centerWorld,v=i.originalHandleCanvas,f=o.worldToCanvas(u),g=l.data.handles.points,h=n.currentPoints.canvas;if(0===d||1===d){var p=Math.abs(h[1]-f[1]),m=[f[0],f[1]-p],w=[f[0],f[1]+p];g[0]=a(m),g[1]=a(w);var E=s/2+(h[0]-v[0]),y=[f[0]-E,f[1]],I=[f[0]+E,f[1]];g[2]=a(y),g[3]=a(I)}else{var b=Math.abs(h[0]-f[0]),C=[f[0]-b,f[1]],_=[f[0]+b,f[1]];g[2]=a(C),g[3]=a(_);var T=c/2+(h[1]-v[1]),O=[f[0],f[1]-T],D=[f[0],f[1]+T];g[0]=a(O),g[1]=a(D)}})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragDrawCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragDrawCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=s[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex;u.annotationUID=o;var p,m=e.getStyle("lineWidth",u,r),w=e.getStyle("lineDash",u,r),E=e.getStyle("color",u,r),y=g.map((function(e){return i.worldToCanvas(e)})),I=Math.abs(i.getRotation()-(l.initialRotation||0));p=Oc(90==I||270==I?[y[2],y[3],y[0],y[1]]:y);var b,C=e.configuration.centerPointRadius;if(l.cachedStats[c]&&null!=l.cachedStats[c].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,i,d,t),i instanceof J.VolumeViewport)){var _=r.metadata.referencedImageId;for(var T in l.cachedStats)T.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=J.utilities.imageIdToURI(_),n=e.hasImageURI(t),r=J.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[T]}}else l.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,i,d,t);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!Pe(o))return"continue";ve(r)||e.editData||null===h||(b=[y[h]]),b&&Xs(n,o,"0",b,{color:E});var O="".concat(o,"-ellipse");if(Ys(n,o,"0",p[0],p[1],{color:E,lineDash:w,lineWidth:m},O),C>0&&Math.min(Math.abs(p[0][0]-p[1][0])/2,Math.abs(p[0][1]-p[1][1])/2)>3*C){var D=e._getCanvasEllipseCenter(y);Ks(n,o,"".concat("0","-center"),D,C,{color:E,lineDash:w,lineWidth:m})}a=!0;var S=e.getLinkedTextBoxStyle(u,r);if(!S.visibility)return l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},"continue";var k,M=e.configuration.getTextLines(l,c);if(!M||0===M.length)return"continue";l.handles.textBox.hasMoved||(k=Td(p),l.handles.textBox.worldPosition=i.canvasToWorld(k));var x=i.worldToCanvas(l.handles.textBox.worldPosition),R=rc(n,o,"1",M,x,y,{},S),P=R.x,A=R.y,N=R.width,L=R.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,A]),topRight:i.canvasToWorld([P+N,A]),bottomLeft:i.canvasToWorld([P,A+L]),bottomRight:i.canvasToWorld([P+N,A+L])}},f=0;f<s.length;f++){var g=v();if("continue"!==g&&"object"===ee(g))return g.v}return a})),ae(ga(e),"_calculateCachedStats",(function(t,n,r,o){for(var a=t.data,i=o.viewportId,l=o.renderingEngineId,s=a.handles.points.map((function(e){return n.worldToCanvas(e)})),c=n.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=dt(Oc(s),2),f=v[0],g=v[1],h=n.canvasToWorld(f),p=n.canvasToWorld(g),m=a.cachedStats,w=Object.keys(m),E=h,y=p,I=function(){var o=w[b],a=e.getTargetIdImage(o,r);if(!a)return"continue";var i=a.dimensions,l=a.imageData,s=a.metadata,c=(a.hasPixelSpacing,Th(l,E));c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]);var v=Th(l,y);if(v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),e._isInsideVolume(c,v,i)){var f,g,I,C=[[Math.min(c[0],v[0]),Math.max(c[0],v[0])],[Math.min(c[1],v[1]),Math.max(c[1],v[1])],[Math.min(c[2],v[2]),Math.max(c[2],v[2])]],_={center:[(h[0]+p[0])/2,(h[1]+p[1])/2,(h[2]+p[2])/2],xRadius:Math.abs(h[0]-p[0])/2,yRadius:Math.abs(h[1]-p[1])/2,zRadius:Math.abs(h[2]-p[2])/2},T=_h(d,u,E,y),O=T.worldWidth,D=T.worldHeight,S=0===O&&0===D,k=yd(a),M=Math.abs(Math.PI*(O/2)*(D/2))/k/k,x={isPreScaled:Sd(n,o),isSuvScaled:e.isSuvScaled(n,o,t.metadata.referencedImageId)},R=Dd(s.Modality,t.metadata.referencedImageId,x),P=pc(l,(function(e,t){return Dc(_,e)}),e.configuration.statsCalculator.statsCallback,C),A=e.configuration.statsCalculator.getStatistics();m[o]={Modality:s.Modality,area:M,mean:null===(f=A[1])||void 0===f?void 0:f.value,max:null===(g=A[0])||void 0===g?void 0:g.value,stdDev:null===(I=A[2])||void 0===I?void 0:I.value,statsArray:A,pointsInShape:P,isEmptyArea:S,areaUnit:Ed(0,a),modalityUnit:R}}else e.isHandleOutsideImage=!0,m[o]={Modality:s.Modality}},b=0;b<w.length;b++)I();t.invalidated=!1;var C=Q.ANNOTATION_MODIFIED,_={annotation:t,viewportId:i,renderingEngineId:l};return(0,J.triggerEvent)(J.eventTarget,C,_),m})),ae(ga(e),"_isInsideVolume",(function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"_pointInEllipseCanvas",value:function(e,t){var n=e.width/2,r=e.height/2;if(n<=0||r<=0)return!1;var o=[e.left+n,e.top+r],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(r*r)<=1}},{key:"_getCanvasEllipseCenter",value:function(e){var t=dt(e,4),n=t[0],r=t[1],o=t[2],a=t[3],i=[o[0],r[1]],l=[a[0],n[1]];return[(i[0]+l[0])/2,(i[1]+l[1])/2]}}]),o}(hd);function Dh(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.stdDev,i=n.max,l=n.isEmptyArea,s=n.areaUnit,c=n.modalityUnit,d=[];if(r){var u=l?"Area: Oblique not supported":"Area: ".concat(yc(r)," ").concat(s);d.push(u)}return o&&d.push("Mean: ".concat(yc(o)," ").concat(c)),i&&d.push("Max: ".concat(yc(i)," ").concat(c)),a&&d.push("Std Dev: ".concat(yc(a)," ").concat(c)),d}ae(Oh,"toolName",void 0),Oh.toolName="EllipticalROI";var Sh=Oh;function kh(e){var t=dt(e,2);return Tu(t[0],t[1])}function Mh(e){var t=dt(e,2),n=t[0],r=Tu(n,t[1]);return[[n[0]-r,n[1]-r],[n[0]+r,n[1]+r]]}var xh=J.utilities.transformWorldToIndex,Rh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:Ph,statsCalculator:xd}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",!1),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(r.canvas,(0,J.getEnabledElement)(o)),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[Lr(a),Lr(a)],activeHandleIndex:null},cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,h),g})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=t.data.handles.points.map((function(e){return o.worldToCanvas(e)})),i=kh(a),l=kh([a[0],n]);return Math.abs(l-i)<r/2})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},gs(r),e._activateModify(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var s=ad(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},e._activateModify(o),gs(o);var c=(0,J.getEnabledElement)(o).renderingEngine;ca(c,s),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){o.highlighted=!1,s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}}})),ae(ga(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,J.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,s=e.editData,c=s.annotation,d=s.viewportIdsToRender,u=c.data;u.handles.points=[u.handles.points[0],l(o)],c.invalidated=!0,e.editData.hasMoved=!0,ca(i,d)})),ae(ga(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else e._dragHandle(t),a.invalidated=!0;var g=(0,J.getEnabledElement)(r).renderingEngine;ca(g,i)})),ae(ga(e),"_dragHandle",(function(t){var n=t.detail,r=n.element,o=(0,J.getEnabledElement)(r).viewport,a=o.canvasToWorld,i=o.worldToCanvas,l=e.editData,s=l.annotation,c=l.handleIndex,d=s.data.handles.points,u=d.map((function(e){return i(e)})),v=n.currentPoints.canvas;if(0===c){var f=v[0]-u[0][0],g=v[1]-u[0][1],h=v,p=[u[1][0]+f,u[1][1]+g];d[0]=a(h),d[1]=a(p)}else d[1]=a(v)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragDrawCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragDrawCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=s[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex;u.annotationUID=o;var p,m=e.getStyle("lineWidth",u,r),w=e.getStyle("lineDash",u,r),E=e.getStyle("color",u,r),y=g.map((function(e){return i.worldToCanvas(e)})),I=y[0],b=kh(y),C=Mh(y),_=e.configuration.centerPointRadius;if(l.cachedStats[c]&&null!=l.cachedStats[c].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,i,d,t),i instanceof J.VolumeViewport)){var T=r.metadata.referencedImageId;for(var O in l.cachedStats)O.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=J.utilities.imageIdToURI(T),n=e.hasImageURI(t),r=J.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[O]}}else l.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},e._calculateCachedStats(r,i,d,t);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!Pe(o))return"continue";ve(r)||e.editData||null===h||(p=[y[h]]),p&&Xs(n,o,"0",p,{color:E});var D="".concat(o,"-circle");Ks(n,o,"0",I,b,{color:E,lineDash:w,lineWidth:m},D),_>0&&b>3*_&&Ks(n,o,"".concat("0","-center"),I,_,{color:E,lineDash:w,lineWidth:m}),a=!0;var S=e.getLinkedTextBoxStyle(u,r);if(!S.visibility)return l.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},"continue";var k,M=e.configuration.getTextLines(l,c);if(!M||0===M.length)return"continue";l.handles.textBox.hasMoved||(k=Td(C),l.handles.textBox.worldPosition=i.canvasToWorld(k));var x=i.worldToCanvas(l.handles.textBox.worldPosition),R=rc(n,o,"1",M,x,y,{},S),P=R.x,A=R.y,N=R.width,L=R.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,A]),topRight:i.canvasToWorld([P+N,A]),bottomLeft:i.canvasToWorld([P,A+L]),bottomRight:i.canvasToWorld([P+N,A+L])}},f=0;f<s.length;f++){var g=v();if("continue"!==g&&"object"===ee(g))return g.v}return a})),ae(ga(e),"_calculateCachedStats",(function(t,n,r,o){for(var a=t.data,i=o.viewportId,l=o.renderingEngineId,s=a.handles.points.map((function(e){return n.worldToCanvas(e)})),c=n.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=dt(Mh(s),2),f=v[0],g=v[1],h=n.canvasToWorld(f),p=n.canvasToWorld(g),m=a.cachedStats,w=Object.keys(m),E=h,y=p,I=function(){var o=w[b],a=e.getTargetIdImage(o,r);if(!a)return"continue";var i=a.dimensions,l=a.imageData,s=a.metadata,c=(a.hasPixelSpacing,xh(l,E));c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(c[2]);var v=xh(l,y);if(v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),e._isInsideVolume(c,v,i)){var f,g,I,C=[[Math.min(c[0],v[0]),Math.max(c[0],v[0])],[Math.min(c[1],v[1]),Math.max(c[1],v[1])],[Math.min(c[2],v[2]),Math.max(c[2],v[2])]],_={center:[(h[0]+p[0])/2,(h[1]+p[1])/2,(h[2]+p[2])/2],xRadius:Math.abs(h[0]-p[0])/2,yRadius:Math.abs(h[1]-p[1])/2,zRadius:Math.abs(h[2]-p[2])/2},T=_h(d,u,E,y),O=T.worldWidth,D=T.worldHeight,S=0===O&&0===D,k=yd(a),M=function(e){var t;return(null===(t=e.calibration)||void 0===t?void 0:t.aspect)||1}(a),x=Math.abs(Math.PI*(O/k/2)*(D/M/k/2)),R={isPreScaled:Sd(n,o),isSuvScaled:e.isSuvScaled(n,o,t.metadata.referencedImageId)},P=Dd(s.Modality,t.metadata.referencedImageId,R),A=pc(l,(function(e,t){return Dc(_,e)}),e.configuration.statsCalculator.statsCallback,C),N=e.configuration.statsCalculator.getStatistics();m[o]={Modality:s.Modality,area:x,mean:null===(f=N[1])||void 0===f?void 0:f.value,max:null===(g=N[0])||void 0===g?void 0:g.value,stdDev:null===(I=N[2])||void 0===I?void 0:I.value,statsArray:N,pointsInShape:A,isEmptyArea:S,areaUnit:Ed(0,a),radius:O/2/k,radiusUnit:wd(0,a),perimeter:2*Math.PI*(O/2)/k,modalityUnit:P}}else e.isHandleOutsideImage=!0,m[o]={Modality:s.Modality}},b=0;b<w.length;b++)I();t.invalidated=!1;var C=Q.ANNOTATION_MODIFIED,_={annotation:t,viewportId:i,renderingEngineId:l};return(0,J.triggerEvent)(J.eventTarget,C,_),m})),ae(ga(e),"_isInsideVolume",(function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o)}(hd);function Ph(e,t){var n=e.cachedStats[t],r=n.radius,o=n.radiusUnit,a=n.area,i=n.mean,l=n.stdDev,s=n.max,c=n.isEmptyArea,d=(n.Modality,n.areaUnit),u=n.modalityUnit,v=[];if(r){var f=c?"Radius: Oblique not supported":"Radius: ".concat(yc(r)," ").concat(o);v.push(f)}if(a){var g=c?"Area: Oblique not supported":"Area: ".concat(yc(a)," ").concat(d);v.push(g)}return i&&v.push("Mean: ".concat(yc(i)," ").concat(u)),s&&v.push("Max: ".concat(yc(s)," ").concat(u)),l&&v.push("Std Dev: ".concat(yc(l)," ").concat(u)),v}ae(Rh,"toolName",void 0),Rh.toolName="CircleROI";var Ah=Rh;var Nh=J.utilities.transformWorldToIndex,Lh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:Uh}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"preventHandleOutsideImage",void 0),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=t.data.handles.points,i=o.worldToCanvas(a[0]),l=o.worldToCanvas(a[1]),s={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}},c=Cd([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]);return c<=r||(i=o.worldToCanvas(a[2]),l=o.worldToCanvas(a[3]),(c=Cd([(s={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}}).start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]))<=r)})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),gs(r),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var s=ad(o,e.getToolName());gs(o),e.editData={annotation:n,viewportIdsToRender:s,handleIndex:i,movingTextBox:l},e._activateModify(o);var c=(0,J.getEnabledElement)(o).renderingEngine;ca(c,s),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(void 0!==e.editData.handleIndex){var d=s.handles.points,u=xs.vec3.distance(d[0],d[1]);if(xs.vec3.distance(d[2],d[3])>u){var v=[Lr(d[2]),Lr(d[3])],f=Lr(d[0]),g=Lr(d[1]),h=xs.vec2.create();xs.vec2.set(h,v[1][0]-v[0][0],v[1][1]-v[1][0]);var p=xs.vec2.create();xs.vec2.set(p,-h[1],h[0]);var m,w=xs.vec2.create();xs.vec2.set(w,g[0]-f[0],g[1]-f[0]),m=xs.vec2.dot(w,p)>0?[f,g]:[g,f],s.handles.points=[v[0],v[1],m[0],m[1]]}}if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var E=Q.ANNOTATION_COMPLETED,y={annotation:o};(0,J.triggerEvent)(J.eventTarget,E,y)}e.editData=null,e.isDrawing=!1}})),ae(ga(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=(0,J.getEnabledElement)(o),i=a.renderingEngine,l=a.viewport,s=l.worldToCanvas,c=e.editData,d=c.annotation,u=c.viewportIdsToRender,v=c.handleIndex,f=d.data,g=r.world;f.handles.points[v]=Lr(g);var h=f.handles.points.map(s),p={x:h[0][0],y:h[0][1]},m={x:h[1][0],y:h[1][1]},w=(h[2][0],h[2][1],h[3][0],h[3][1],xs.vec2.distance(h[0],h[1])/3),E=p.x-m.x,y=p.y-m.y,I=Math.sqrt(E*E+y*y),b=E/I,C=y/I,_=(p.x+m.x)/2,T=(p.y+m.y)/2,O=_+w*C,D=T-w*b,S=_-w*C,k=T+w*b;f.handles.points[2]=l.canvasToWorld([O,D]),f.handles.points[3]=l.canvasToWorld([S,k]),d.invalidated=!0,ca(i,u),e.editData.hasMoved=!0})),ae(ga(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=(0,J.getEnabledElement)(r).renderingEngine,a=e.editData,i=a.annotation,l=a.viewportIdsToRender,s=a.handleIndex,c=a.movingTextBox,d=i.data;if(c){var u=n.deltaPoints.world,v=d.handles.textBox,f=v.worldPosition;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],v.hasMoved=!0}else if(void 0===s){var g=n.deltaPoints.world;d.handles.points.forEach((function(e){e[0]+=g[0],e[1]+=g[1],e[2]+=g[2]})),i.invalidated=!0}else e._dragModifyHandle(t),i.invalidated=!0;ca(o,l)})),ae(ga(e),"_dragModifyHandle",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=(0,J.getEnabledElement)(o).viewport,i=e.editData,l=i.annotation,s=i.handleIndex,c=l.data,d=r.world,u=[a.worldToCanvas(c.handles.points[0]),a.worldToCanvas(c.handles.points[1]),a.worldToCanvas(c.handles.points[2]),a.worldToCanvas(c.handles.points[3])],v={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},f={start:{x:u[2][0],y:u[2][1]},end:{x:u[3][0],y:u[3][1]}},g=Lr(d),h=a.worldToCanvas(g);if(0===s||1===s){var p=u[0===s?1:0],m=xs.vec2.set(xs.vec2.create(),h[0]-p[0],h[1]-p[1]),w=xs.vec2.set(xs.vec2.create(),u[s][0]-p[0],u[s][1]-p[1]);xs.vec2.normalize(m,m),xs.vec2.normalize(w,w);var E={start:{x:p[0],y:p[1]},end:{x:h[0],y:h[1]}};if(e._movingLongAxisWouldPutItThroughShortAxis(E,f))return;var y=p,I=e._getSignedAngle(w,m),b=u[2][0],C=u[2][1],_=u[3][0],T=u[3][1];b-=y[0],C-=y[1],_-=y[0],T-=y[1];var O=b*Math.cos(I)-C*Math.sin(I),D=b*Math.sin(I)+C*Math.cos(I),S=_*Math.cos(I)-T*Math.sin(I),k=_*Math.sin(I)+T*Math.cos(I);b=O+y[0],C=D+y[1],_=S+y[0],T=k+y[1];var M=a.canvasToWorld([b,C]),x=a.canvasToWorld([_,T]);c.handles.points[s]=g,c.handles.points[2]=M,c.handles.points[3]=x}else{var R=2===s?3:2,P={longLineSegment:{start:v.start,end:v.end},shortLineSegment:{start:f.start,end:f.end}},A=xs.vec2.subtract(xs.vec2.create(),[P.longLineSegment.end.x,P.longLineSegment.end.y],[P.longLineSegment.start.x,P.longLineSegment.start.y]),N=xs.vec2.normalize(xs.vec2.create(),A),L=xs.vec2.subtract(xs.vec2.create(),[h[0],h[1]],[u[s][0],u[s][1]]),U=xs.vec2.length(L),V=e._getSignedAngle(N,L),j=Math.cos(V)*U,B=xs.vec2.scaleAndAdd(xs.vec2.create(),[u[R][0],u[R][1]],N,j);if(e._movingLongAxisWouldPutItThroughShortAxis({start:{x:h[0],y:h[1]},end:{x:B[0],y:B[1]}},{start:{x:P.longLineSegment.start.x,y:P.longLineSegment.start.y},end:{x:P.longLineSegment.end.x,y:P.longLineSegment.end.y}}))return;if(!vu([h[0],h[1]],[B[0],B[1]],[v.start.x,v.start.y],[v.end.x,v.end.y]))return;c.handles.points[R]=a.canvasToWorld(B),c.handles.points[s]=g}})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragDrawCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragDrawCallback)})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!0,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<s.length;v++){var f=s[v],g=f.annotationUID,h=f.data,p=h.handles,m=p.points,w=p.activeHandleIndex,E=m.map((function(e){return i.worldToCanvas(e)}));u.annotationUID=g;var y=e.getStyle("lineWidth",u,f),I=e.getStyle("lineDash",u,f),b=e.getStyle("color",u,f),C=e.getStyle("shadow",u,f);if(h.cachedStats[c]&&null!=h.cachedStats[c].unit?f.invalidated&&e._throttledCalculateCachedStats(f,d,t):(h.cachedStats[c]={length:null,width:null,unit:null},e._calculateCachedStats(f,d,t)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var _=void 0;if(Pe(g)){ve(f)||e.editData||null===w||(_=[E[w]]),_&&Xs(n,g,"0",_,{color:b});var T="".concat(g,"-line-1"),O="".concat(g,"-line-2");Zs(n,g,"0",E[0],E[1],{color:b,lineDash:I,lineWidth:y,shadow:C},T),Zs(n,g,"1",E[2],E[3],{color:b,lineDash:I,lineWidth:y,shadow:C},O),a=!0;var D=e.getLinkedTextBoxStyle(u,f);if(D.visibility){var S=e.configuration.getTextLines(h,c);if(S&&0!==S.length){var k=void 0;h.handles.textBox.hasMoved||(k=Td(E),h.handles.textBox.worldPosition=i.canvasToWorld(k));var M=i.worldToCanvas(h.handles.textBox.worldPosition),x=rc(n,g,"1",S,M,E,{},D),R=x.x,P=x.y,A=x.width,N=x.height;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([R,P]),topRight:i.canvasToWorld([R+A,P]),bottomLeft:i.canvasToWorld([R,P+N]),bottomRight:i.canvasToWorld([R+A,P+N])}}}else h.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}return a})),ae(ga(e),"_movingLongAxisWouldPutItThroughShortAxis",(function(e,t){var n=xs.vec2.create();xs.vec2.set(n,t.end.x-t.start.x,t.end.y-t.start.y),xs.vec2.normalize(n,n);var r={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!vu([r.start.x,r.start.y],[r.end.x,r.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])})),ae(ga(e),"_calculateCachedStats",(function(t,n,r){for(var o=t.data,a=r.viewportId,i=r.renderingEngineId,l=o.handles.points[0],s=o.handles.points[1],c=o.handles.points[2],d=o.handles.points[3],u=o.cachedStats,v=Object.keys(u),f=0;f<v.length;f++){var g=v[f],h=e.getTargetIdImage(g,n);if(h){var p=h.imageData,m=h.dimensions,w=yd(h),E=e._calculateLength(l,s)/w,y=e._calculateLength(c,d)/w,I=E>y?E:y,b=E>y?y:E,C=Nh(p,l),_=Nh(p,s),T=Nh(p,c),O=Nh(p,d);e._isInsideVolume(C,_,T,O,m)?e.isHandleOutsideImage=!1:e.isHandleOutsideImage=!0,u[g]={length:I,width:b,unit:wd(0,h)}}}t.invalidated=!1;var D=Q.ANNOTATION_MODIFIED,S={annotation:t,viewportId:a,renderingEngineId:i};return(0,J.triggerEvent)(J.eventTarget,D,S),u})),ae(ga(e),"_isInsideVolume",(function(e,t,n,r,o){return J.utilities.indexWithinDimensions(e,o)&&J.utilities.indexWithinDimensions(t,o)&&J.utilities.indexWithinDimensions(n,o)&&J.utilities.indexWithinDimensions(r,o)})),ae(ga(e),"_getSignedAngle",(function(e,t){return Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1])})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"addNewAnnotation",value:function(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=(0,J.getEnabledElement)(r),i=a.viewport,l=a.renderingEngine;this.isDrawing=!0;var s=i.getCamera(),c=s.viewPlaneNormal,d=s.viewUp,u=this.getReferencedImageId(i,o,c,d),v=i.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:Lr(c),viewUp:Lr(d),FrameOfReferenceUID:v,referencedImageId:u},data:{handles:{points:[Lr(o),Lr(o),Lr(o),Lr(o)],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};rt(f,r);var g=ad(r,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(r),gs(r),e.preventDefault(),ca(l,g),f}},{key:"_calculateLength",value:function(e,t){var n=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+r*r+o*o)}}]),o}(hd);function Uh(e,t){var n=e.cachedStats[t],r=n.length,o=n.width,a=n.unit;if(void 0!==r)return["L: ".concat(yc(r)," ").concat(a),"W: ".concat(yc(o)," ").concat(a)]}ae(Lh,"toolName",void 0),Lh.toolName="Bidirectional";var Vh=Lh;var jh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:Bh,changeTextCallback:Wh,preventHandleOutsideImage:!1,arrowFirst:!0}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;gs(o),e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=e.configuration.arrowFirst,g=l.getFrameOfReferenceUID(),h={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:g,referencedImageId:v},data:{text:"",handles:{points:[Lr(a),Lr(a)],activeHandleIndex:null,arrowFirst:f,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};rt(h,o);var p=ad(o,e.getToolName());return e.editData={annotation:h,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),ca(s,p),h})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=dt(t.data.handles.points,2),i=a[0],l=a[1],s=o.worldToCanvas(i),c=o.worldToCanvas(l),d={start:{x:s[0],y:s[1]},end:{x:c[0],y:c[1]}};return Cd([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]])<=r})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),gs(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n),d=c.viewportId,u=c.renderingEngineId,v=c.renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),i)e.configuration.getTextCallback((function(t){if(!t)return at(o.annotationUID),ca(v,a),e.editData=null,void(e.isDrawing=!1);o.data.text=t;var n=Q.ANNOTATION_COMPLETED,r={annotation:o};(0,J.triggerEvent)(J.eventTarget,n,r),ca(v,a)}));else{var f=Q.ANNOTATION_MODIFIED,g={annotation:o,viewportId:d,renderingEngineId:u};(0,J.triggerEvent)(J.eventTarget,f,g)}e.editData=null,e.isDrawing=!1}})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;c.handles.points[l]=Lr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,J.getEnabledElement)(r).renderingEngine;ca(h,i)})),ae(ga(e),"touchTapCallback",(function(t){2==t.detail.taps&&e.doubleClickCallback(t)})),ae(ga(e),"doubleClickCallback",(function(t){var n,r=t.detail,o=r.element,a=nt(e.getToolName(),o);if(null!==(n=a=e.filterInteractableAnnotationsForElement(o,a))&&void 0!==n&&n.length){var i=a.find((function(t){return e.isPointNearTool(o,t,r.currentPoints.canvas,6)}));if(i){var l=i;e.configuration.changeTextCallback(i,t.detail,e._doneChangingTextCallback.bind(ga(e),o,l)),e.editData=null,e.isDrawing=!1,t.stopImmediatePropagation(),t.preventDefault()}}})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},d=0;d<s.length;d++){var u=s[d],v=u.annotationUID,f=u.data,g=f.handles,h=f.text,p=g.points,m=g.activeHandleIndex;c.annotationUID=v;var w=e.getStyle("lineWidth",c,u),E=e.getStyle("lineDash",c,u),y=e.getStyle("color",c,u),I=p.map((function(e){return i.worldToCanvas(e)})),b=void 0;if(ve(u)||e.editData||null===m||(b=[I[m]]),b&&Xs(n,v,"0",I,{color:y,lineWidth:w}),e.configuration.arrowFirst?ac(n,v,"1",I[1],I[0],{color:y,width:w,lineDash:E}):ac(n,v,"1",I[0],I[1],{color:y,width:w,lineDash:E}),a=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(h){var C=e.getLinkedTextBoxStyle(c,u);if(C.visibility){if(!f.handles.textBox.hasMoved){var _=I[1];f.handles.textBox.worldPosition=i.canvasToWorld(_)}var T=i.worldToCanvas(f.handles.textBox.worldPosition),O=rc(n,v,"1",[h],T,I,{},C),D=O.x,S=O.y,k=O.width,M=O.height;f.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,S]),topRight:i.canvasToWorld([D+k,S]),bottomLeft:i.canvasToWorld([D,S+M]),bottomRight:i.canvasToWorld([D+k,S+M])}}else f.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}return a})),e}return re(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=ad(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),gs(r);var s=(0,J.getEnabledElement)(r).renderingEngine;ca(s,l),e.preventDefault()}},{key:"_doneChangingTextCallback",value:function(e,t,n){t.data.text=n;var r=(0,J.getEnabledElement)(e),o=r.renderingEngine,a=r.viewportId,i=r.renderingEngineId,l=ad(e,this.getToolName());ca(o,l);var s=Q.ANNOTATION_MODIFIED;(0,J.triggerEvent)(J.eventTarget,s,{annotation:t,viewportId:a,renderingEngineId:i})}},{key:"_isInsideVolume",value:function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)}}]),o}(hd);function Bh(e){return e(prompt("Enter your annotation:"))}function Wh(e,t,n){return n(prompt("Enter your annotation:"))}ae(jh,"toolName",void 0),jh.toolName="ArrowAnnotate";var Fh=jh;var Hh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Gh}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"angleStartedNotYetCompleted",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){if(!e.angleStartedNotYetCompleted){e.angleStartedNotYetCompleted=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;gs(o),e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[Lr(a),Lr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),ca(s,h),g}})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=dt(t.data.handles.points,3),i=a[0],l=a[1],s=a[2],c=o.worldToCanvas(i),d=o.worldToCanvas(l),u={start:{x:c[0],y:c[1]},end:{x:d[0],y:d[1]}};if(Cd([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=r)return!0;if(!s)return!1;var v=o.worldToCanvas(s),f={start:{x:d[0],y:d[1]},end:{x:v[0],y:v[1]}};return Cd([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]])<=r})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),gs(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l)if(e.angleStartedNotYetCompleted&&2===s.handles.points.length)e.editData.handleIndex=2;else{e.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=a.data;if(s){var d=n.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;c.handles.points[l]=Lr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,J.getEnabledElement)(r).renderingEngine;ca(h,i)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,e.angleStartedNotYetCompleted=!1,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_MOVE,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<s.length;v++){var f,g=s[v],h=g.annotationUID,p=g.data,m=p.handles,w=m.points,E=m.activeHandleIndex;u.annotationUID=h;var y=e.getStyle("lineWidth",u,g),I=e.getStyle("lineDash",u,g),b=e.getStyle("color",u,g),C=w.map((function(e){return i.worldToCanvas(e)}));p.cachedStats[c]&&null!=p.cachedStats[c].angle?g.invalidated&&e._throttledCalculateCachedStats(g,d,t):(p.cachedStats[c]={angle:null},e._calculateCachedStats(g,d,t));var _=void 0;if(ve(g)||e.editData||null===E||(_=[C[E]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;_&&Xs(n,h,"0",C,{color:b,lineDash:I,lineWidth:y});var T="1";if(Zs(n,h,T,C[0],C[1],{color:b,width:y,lineDash:I}),a=!0,3!==C.length)return a;if(Zs(n,h,T="2",C[1],C[2],{color:b,width:y,lineDash:I}),null!==(f=p.cachedStats[c])&&void 0!==f&&f.angle){var O=e.getLinkedTextBoxStyle(u,g);if(O.visibility){var D=e.configuration.getTextLines(p,c);if(!p.handles.textBox.hasMoved){var S=C[1];p.handles.textBox.worldPosition=i.canvasToWorld(S)}var k=i.worldToCanvas(p.handles.textBox.worldPosition),M=rc(n,h,"1",D,k,C,{},O),x=M.x,R=M.y,P=M.width,A=M.height;p.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([x,R]),topRight:i.canvasToWorld([x+P,R]),bottomLeft:i.canvasToWorld([x,R+A]),bottomRight:i.canvasToWorld([x+P,R+A])}}else p.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}return a})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=ad(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),gs(r);var s=(0,J.getEnabledElement)(r).renderingEngine;ca(s,l),e.preventDefault()}},{key:"_calculateCachedStats",value:function(e,t,n){var r=e.data,o=n.viewportId,a=n.renderingEngineId;if(3===r.handles.points.length){for(var i=r.handles.points[0],l=r.handles.points[1],s=r.handles.points[2],c=r.cachedStats,d=Object.keys(c),u=0;u<d.length;u++){var v=d[u],f=qg([i,l],[l,s]);c[v]={angle:isNaN(f)?"Incomplete Angle":f}}e.invalidated=!1;var g=Q.ANNOTATION_MODIFIED,h={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,g,h),c}}}]),o}(hd);function Gh(e,t){var n=e.cachedStats[t].angle;if(void 0!==n)return["".concat(yc(n)," ").concat(String.fromCharCode(176))]}ae(Hh,"toolName",void 0),Hh.toolName="Angle";var qh=Hh,zh=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=2===t[0].length?[0,0]:[0,0,0],o=t.length,a=0,i=t;a<i.length;a++){var l=i[a];r[0]+=l[0]/o,r[1]+=l[1]/o,3===r.length&&(r[2]+=l[2]/o)}return r};function Kh(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yh(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Kh(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Kh(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Xh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:Zh}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"angleStartedNotYetCompleted",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){if(!e.angleStartedNotYetCompleted){e.angleStartedNotYetCompleted=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;gs(o),e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[Lr(a),Lr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};rt(g,o);var h=ad(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),ca(s,h),g}})),ae(ga(e),"isPointNearTool",(function(t,n,r,o){var a=(0,J.getEnabledElement)(t).viewport,i=n.data,l=e.distanceToLines({viewport:a,points:i.handles.points,canvasCoords:r,proximity:o}),s=l.distanceToPoint,c=l.distanceToPoint2;return s<=o||c<=o})),ae(ga(e),"toolSelectedCallback",(function(t,n,r,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6,i=t.detail.element;n.highlighted=!0;var l=ad(i,e.getToolName()),s=(0,J.getEnabledElement)(i),c=s.renderingEngine,d=s.viewport,u=e.distanceToLines({viewport:d,points:n.data.handles.points,canvasCoords:o,proximity:a}),v=u.isNearFirstLine,f=u.isNearSecondLine;e.editData={annotation:n,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:v,isNearSecondLine:f},e._activateModify(i),gs(i),ca(c,l),t.preventDefault()})),ae(ga(e),"_mouseUpCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){if(e.angleStartedNotYetCompleted&&s.handles.points.length<4)return fs(n),void(e.editData.handleIndex=s.handles.points.length);e.angleStartedNotYetCompleted=!1,s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a),i){var d=Q.ANNOTATION_COMPLETED,u={annotation:o};(0,J.triggerEvent)(J.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),ae(ga(e),"_mouseDownCallback",(function(t){var n=e.editData,r=n.annotation,o=n.handleIndex,a=t.detail,i=a.element,l=a.currentPoints.world,s=r.data;return 1===o?(s.handles.points[1]=l,void(e.editData.hasMoved=s.handles.points[1][0]!==s.handles.points[0][0]||s.handles.points[1][1]!==s.handles.points[0][0])):3===o?(s.handles.points[3]=l,e.editData.hasMoved=s.handles.points[3][0]!==s.handles.points[2][0]||s.handles.points[3][1]!==s.handles.points[2][0],void(e.angleStartedNotYetCompleted=!1)):(e.editData.hasMoved=!1,gs(i),s.handles.points[2]=s.handles.points[3]=l,void(e.editData.handleIndex=s.handles.points.length-1))})),ae(ga(e),"_mouseDragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=o.movingTextBox,c=o.isNearFirstLine,d=o.isNearSecondLine,u=a.data;if(s){var v=n.deltaPoints.world,f=u.handles.textBox,g=f.worldPosition;g[0]+=v[0],g[1]+=v[1],g[2]+=v[2],f.hasMoved=!0}else if(void 0===l&&(c||d)){var h=n.deltaPoints.world,p=u.handles.points;c?[p[0],p[1]].forEach((function(e){e[0]+=h[0],e[1]+=h[1],e[2]+=h[2]})):d&&[p[2],p[3]].forEach((function(e){e[0]+=h[0],e[1]+=h[1],e[2]+=h[2]})),a.invalidated=!0}else{var m=n.currentPoints.world;u.handles.points[l]=Lr(m),a.invalidated=!0}e.editData.hasMoved=!0;var w=(0,J.getEnabledElement)(r).renderingEngine;ca(w,i)})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;i.handles.points.length<4&&at(r.annotationUID),r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,e.angleStartedNotYetCompleted=!1,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.addEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(Q.MOUSE_CLICK,e._mouseUpCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._mouseUpCallback)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.addEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(Q.MOUSE_MOVE,e._mouseDragCallback),t.addEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.addEventListener(Q.MOUSE_DOWN,e._mouseDownCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.removeEventListener(Q.MOUSE_DOWN,e._mouseDownCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,s=nt(e.getToolName(),l);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(l,s))||void 0===o||!o.length)return a;for(var c=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<s.length;v++){var f,g=s[v],h=g.annotationUID,p=g.data,m=p.handles,w=m.points,E=m.activeHandleIndex;u.annotationUID=h;var y=e.getStyle("lineWidth",u,g),I=e.getStyle("lineDash",u,g),b=e.getStyle("color",u,g),C=w.map((function(e){return i.worldToCanvas(e)}));p.cachedStats[c]&&null!=p.cachedStats[c].angle?g.invalidated&&e._throttledCalculateCachedStats(g,d,t):(p.cachedStats[c]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},e._calculateCachedStats(g,d,t));var _=void 0;if(ve(g)||e.editData||null===E||(_=[C[E]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;_&&Xs(n,h,"0",C,{color:b,lineDash:I,lineWidth:y});var T=[C[0],C[1]],O=[C[2],C[3]],D="line1";if(Zs(n,h,D,T[0],T[1],{color:b,width:y,lineDash:I}),a=!0,C.length<4)return a;Zs(n,h,D="line2",O[0],O[1],{color:b,width:y,lineDash:I}),Zs(n,h,D="linkLine",zh(T[0],T[1]),zh(O[0],O[1]),{color:b,lineWidth:"1",lineDash:"1,4"});var S=p.cachedStats[c].points.canvas,k=S.arc1Start,M=S.arc1End,x=S.arc2End,R=S.arc2Start,P=p.cachedStats[c],A=P.arc1Angle,N=P.arc2Angle;if(Zs(n,h,D="arc1",k,M,{color:b,lineWidth:"1"}),Zs(n,h,D="arc2",R,x,{color:b,lineWidth:"1"}),null!==(f=p.cachedStats[c])&&void 0!==f&&f.angle){var L=e.getLinkedTextBoxStyle(u,g);if(L.visibility){var U=e.configuration.getTextLines(p,c);if(!p.handles.textBox.hasMoved){var V=Td(C);p.handles.textBox.worldPosition=i.canvasToWorld(V)}var j=i.worldToCanvas(p.handles.textBox.worldPosition),B=rc(n,h,"cobbAngleText",U,j,C,{},L),W=B.x,F=B.y,H=B.width,G=B.height;p.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([W,F]),topRight:i.canvasToWorld([W+H,F]),bottomLeft:i.canvasToWorld([W,F+G]),bottomRight:i.canvasToWorld([W+H,F+G])};var q=["".concat(A.toFixed(2)," ").concat(String.fromCharCode(176))],z=zh(k,M);tc(n,h,"arcAngle1",q,z,Yh(Yh({},L),{},{padding:3}));var K=["".concat(N.toFixed(2)," ").concat(String.fromCharCode(176))],Y=zh(R,x);tc(n,h,"arcAngle2",K,Y,Yh(Yh({},L),{},{padding:3}))}else p.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}return a})),ae(ga(e),"distanceToLines",(function(e){var t=e.viewport,n=e.points,r=e.canvasCoords,o=e.proximity,a=dt(n,4),i=a[0],l=a[1],s=a[2],c=a[3],d=t.worldToCanvas(i),u=t.worldToCanvas(l),v=t.worldToCanvas(s),f=t.worldToCanvas(c),g={start:{x:d[0],y:d[1]},end:{x:u[0],y:u[1]}},h={start:{x:v[0],y:v[1]},end:{x:f[0],y:f[1]}},p=Cd([g.start.x,g.start.y],[g.end.x,g.end.y],[r[0],r[1]]),m=Cd([h.start.x,h.start.y],[h.end.x,h.end.y],[r[0],r[1]]),w=!1,E=!1;return p<=o?w=!0:m<=o&&(E=!0),{distanceToPoint:p,distanceToPoint2:m,isNearFirstLine:w,isNearSecondLine:E}})),ae(ga(e),"getArcsStartEndPoints",(function(e){var t=e.firstLine,n=e.secondLine,r=e.mid1,o=e.mid2,a=[r,o],i=qg(t,a),l=qg(n,a),s=i>90?1:0,c=l>90?0:1,d=zh(a[0],a[1]),u=Math.sqrt(Math.pow(a[1][0]-a[0][0],2)+Math.pow(a[1][1]-a[0][1],2)),v=.1,f=zh(t[0],t[1]),g=zh(n[0],n[1]),h=[t[s][0]-f[0],t[s][1]-f[1]],p=Math.sqrt(Math.pow(h[0],2)+Math.pow(h[1],2)),m=[h[0]/p,h[1]/p],w=[f[0]+m[0]*u*v,f[1]+m[1]*u*v],E=[d[0]-r[0],d[1]-r[1]],y=Math.sqrt(Math.pow(E[0],2)+Math.pow(E[1],2)),I=[E[0]/y,E[1]/y],b=[r[0]+I[0]*u*v,r[1]+I[1]*u*v],C=[n[c][0]-g[0],n[c][1]-g[1]],_=Math.sqrt(Math.pow(C[0],2)+Math.pow(C[1],2)),T=[C[0]/_,C[1]/_],O=[g[0]+T[0]*u*v,g[1]+T[1]*u*v],D=[d[0]-o[0],d[1]-o[1]],S=Math.sqrt(Math.pow(D[0],2)+Math.pow(D[1],2)),k=[D[0]/S,D[1]/S];return{arc1Start:w,arc1End:b,arc2Start:O,arc2End:[o[0]+k[0]*u*v,o[1]+k[1]*u*v],arc1Angle:i>90?180-i:i,arc2Angle:l>90?180-l:l}})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,25,{trailing:!0}),e}return re(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=ad(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),gs(r);var s=(0,J.getEnabledElement)(r).renderingEngine;ca(s,l),e.preventDefault()}},{key:"_calculateCachedStats",value:function(e,t,n){var r=e.data,o=n.viewportId,a=n.renderingEngineId;if(4===r.handles.points.length){for(var i=[null,null],l=[null,null],s=Number.MAX_VALUE,c=0;c<2;c+=1)for(var d=2;d<4;d+=1){var u=xs.vec3.distance(r.handles.points[c],r.handles.points[d]);u<s&&(s=u,i[1]=r.handles.points[c],i[0]=r.handles.points[(c+1)%2],l[0]=r.handles.points[d],l[1]=r.handles.points[2+(d-1)%2])}for(var v=n.viewport,f=r.handles.points.map((function(e){return v.worldToCanvas(e)})),g=[f[0],f[1]],h=[f[2],f[3]],p=zh(g[0],g[1]),m=zh(h[0],h[1]),w=this.getArcsStartEndPoints({firstLine:g,secondLine:h,mid1:p,mid2:m}),E=w.arc1Start,y=w.arc1End,I=w.arc2End,b=w.arc2Start,C=w.arc1Angle,_=w.arc2Angle,T=r.cachedStats,O=Object.keys(T),D=0;D<O.length;D++)T[O[D]]={angle:qg(i,l),arc1Angle:C,arc2Angle:_,points:{canvas:{arc1Start:E,arc1End:y,arc2End:I,arc2Start:b},world:{arc1Start:v.canvasToWorld(E),arc1End:v.canvasToWorld(y),arc2End:v.canvasToWorld(I),arc2Start:v.canvasToWorld(b)}}};e.invalidated=!1;var S=Q.ANNOTATION_MODIFIED,k={annotation:e,viewportId:o,renderingEngineId:a};return(0,J.triggerEvent)(J.eventTarget,S,k),T}}}]),o}(hd);function Zh(e,t){var n=e.cachedStats[t].angle;if(void 0!==n)return["".concat(n.toFixed(2)," ").concat(String.fromCharCode(176))]}ae(Xh,"toolName",void 0),Xh.toolName="CobbAngle";var Jh=Xh;var $h="magnify-viewport",Qh=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_bounds",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints,a=(0,J.getEnabledElement)(r),i=a.viewport,l=a.renderingEngine;if(!(i instanceof J.StackViewport))throw new Error("MagnifyTool only works on StackViewports");var s=e._getReferencedImageId(i);if(!s)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");var c=ad(r,e.getToolName());return e.editData={referencedImageId:s,viewportIdsToRender:c,enabledElement:a,renderingEngine:l,currentPoints:o},e._createMagnificationViewport(),e._activateDraw(r),gs(r),t.preventDefault(),ca(l,c),!0})),ae(ga(e),"preTouchStartCallback",(function(t){e.preMouseDownCallback(t)})),ae(ga(e),"_createMagnificationViewport",(function(){var t,n=e.editData,r=n.enabledElement,o=n.referencedImageId,a=n.viewportIdsToRender,i=n.renderingEngine,l=n.currentPoints,s=r.viewport,c=s.element,d=s.getProperties(),u=l.canvas,v=l.world;if(null===(t=c.querySelector(".magnifyTool"))){var f=document.createElement("div");f.classList.add("magnifyTool"),f.style.display="block",f.style.width="".concat(e.configuration.magnifyWidth,"px"),f.style.height="".concat(e.configuration.magnifyHeight,"px"),f.style.position="absolute",t=f,c.querySelector(".viewport-element").appendChild(f);var g={viewportId:$h,type:J.Enums.ViewportType.STACK,element:t};i.enableElement(g)}t.style.top="".concat(u[1]-e.configuration.magnifyHeight/2,"px"),t.style.left="".concat(u[0]-e.configuration.magnifyWidth/2,"px");var h=i.getViewport($h);h.setStack([o]).then((function(){h.setProperties(d);var t=s.getCamera().parallelScale,n=h.getCamera(),r=n.focalPoint,o=n.position,a=n.viewPlaneNormal,i=Math.sqrt(Math.pow(r[0]-o[0],2)+Math.pow(r[1]-o[1],2)+Math.pow(r[2]-o[2],2)),l=[v[0],v[1],v[2]],c=[l[0]+i*a[0],l[1]+i*a[1],l[2]+i*a[2]];h.setCamera({parallelScale:t*(1/e.configuration.magnifySize),focalPoint:l,position:c}),h.render()})),t.style.display="block",ca(i,a)})),ae(ga(e),"_dragCallback",(function(t){var n=t.detail,r=n.deltaPoints,o=n.element,a=n.currentPoints,i=r.world,l=a.canvas,s=(0,J.getEnabledElement)(o).renderingEngine.getViewport($h),c=o.querySelector(".magnifyTool");if(c){c.style.top="".concat(l[1]-e.configuration.magnifyHeight/2,"px"),c.style.left="".concat(l[0]-e.configuration.magnifyWidth/2,"px");var d=s.getCamera(),u=d.focalPoint,v=d.position,f=[v[0]+i[0],v[1]+i[1],v[2]+i[2]],g=[u[0]+i[0],u[1]+i[1],u[2]+i[2]];s.setCamera({focalPoint:g,position:f}),s.render()}})),ae(ga(e),"_dragEndCallback",(function(t){var n=t.detail.element;(0,J.getEnabledElement)(n).renderingEngine.disableElement($h);var r=n.querySelector(".viewport-element"),o=r.querySelector(".magnifyTool");r.removeChild(o),e._deactivateDraw(n),fs(n)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._dragEndCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._dragEndCallback),t.addEventListener(Q.TOUCH_END,e._dragEndCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._dragEndCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._dragEndCallback),t.removeEventListener(Q.TOUCH_END,e._dragEndCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback)})),e}return re(o,[{key:"_getReferencedImageId",value:function(e){var t,n=this.getTargetId(e);return e instanceof J.StackViewport&&(t=n.split("imageId:")[1]),t}}]),o}(La);ae(Qh,"toolName",void 0),Qh.toolName="Magnify";var ep=Qh;function tp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function np(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tp(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tp(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var rp=function(e){return e.uid!==e.referenceId},op=function(){function e(t){var n=t.magnifyViewportId,r=t.sourceEnabledElement,o=t.radius,a=void 0===o?125:o,i=t.position,l=void 0===i?[0,0]:i,s=t.zoomFactor,c=t.autoPan;oe(this,e),ae(this,"_viewportId",void 0),ae(this,"_sourceEnabledElement",void 0),ae(this,"_enabledElement",null),ae(this,"_sourceToolGroup",null),ae(this,"_magnifyToolGroup",null),ae(this,"_isViewportReady",!1),ae(this,"_radius",0),ae(this,"_resized",!1),ae(this,"_resizeViewportAsync",void 0),ae(this,"_canAutoPan",!1),ae(this,"_autoPan",void 0),ae(this,"position",void 0),ae(this,"zoomFactor",void 0),ae(this,"visible",void 0),this._viewportId=null!=n?n:J.utilities.uuidv4(),this._sourceEnabledElement=r,this._autoPan=c,this.radius=a,this.position=l,this.zoomFactor=s,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=vc(this._resizeViewport.bind(this),1),this._initialize()}return re(e,[{key:"sourceEnabledElement",get:function(){return this._sourceEnabledElement}},{key:"viewportId",get:function(){return this._viewportId}},{key:"radius",get:function(){return this._radius},set:function(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}},{key:"update",value:function(){var e=this.radius,t=this.position,n=this.visible,r=this._enabledElement.viewport,o=r.element,a=2*e,i=dt(t,2),l=i[0],s=i[1];this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(o.style,{display:n?"block":"hidden",width:"".concat(a,"px"),height:"".concat(a,"px"),left:"".concat(-e,"px"),top:"".concat(-e,"px"),transform:"translate(".concat(l,"px, ").concat(s,"px)")}),this._isViewportReady&&(this._syncViewports(),r.render())}},{key:"dispose",value:function(){var e=this._enabledElement.viewport,t=e.element,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}},{key:"_handleToolModeChanged",value:function(e){var t,n=this._magnifyToolGroup,r=e.detail,o=r.toolGroupId,a=r.toolName,i=r.mode,l=r.toolBindingsOptions;if((null===(t=this._sourceToolGroup)||void 0===t?void 0:t.id)===o)switch(i){case Xe.Active:n.setToolActive(a,l);break;case Xe.Passive:n.setToolPassive(a);break;case Xe.Enabled:n.setToolEnabled(a);break;case Xe.Disabled:n.setToolDisabled(a);break;default:throw new Error("Unknow tool mode (".concat(i,")"))}}},{key:"_inheritBorderRadius",value:function(e){var t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}},{key:"_createViewportNode",value:function(){var e=document.createElement("div"),t=this.radius,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:"".concat(n,"px"),height:"".concat(n,"px"),position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:"".concat(-t,"px"),top:"".concat(-t,"px"),transform:"translate(-1000px, -1000px)"}),e}},{key:"_convertZoomFactorToParalellScale",value:function(e,t,n){return e.getCamera().parallelScale*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}},{key:"_isStackViewport",value:function(e){return"setStack"in e}},{key:"_isVolumeViewport",value:function(e){return"addVolumes"in e}},{key:"_cloneToolGroups",value:function(e,t){var n=e.getActors(),r="".concat(t.id,"-toolGroup"),o=Fr(e.id,e.renderingEngineId),a=o.clone(r,(function(e){var t=o.getToolInstance(e);return t instanceof hd&&!(t instanceof sp)||e===el.toolName}));return a.addViewport(t.id,t.renderingEngineId),n.filter(rp).forEach((function(e){Dg(r,[{segmentationId:e.referenceId,type:gt.Labelmap}])})),{sourceToolGroup:o,magnifyToolGroup:a}}},{key:"_cloneStack",value:function(e,t){var n=this,r=e.getImageIds();t.setStack(r).then((function(){n._isViewportReady=!0,n.update()}))}},{key:"_cloneVolumes",value:function(e,t){var n=this,r=e.getActors().filter((function(e){return!rp(e)})).map((function(e){return{volumeId:e.uid}}));return t.setVolumes(r).then((function(){n._isViewportReady=!0,n.update()})),t}},{key:"_cloneViewport",value:function(e,t){var n=this.viewportId,r=e.getRenderingEngine(),o=e.options,a={element:t,viewportId:n,type:e.type,defaultOptions:np({},o)};r.enableElement(a);var i=r.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,i):this._isVolumeViewport(e)&&this._cloneVolumes(e,i),this._inheritBorderRadius(t);var l=this._cloneToolGroups(e,i);this._sourceToolGroup=l.sourceToolGroup,this._magnifyToolGroup=l.magnifyToolGroup}},{key:"_cancelMouseEventCallback",value:function(e){e.stopPropagation(),e.preventDefault()}},{key:"_browserMouseUpCallback",value:function(e){var t=this._enabledElement.viewport.element;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}},{key:"_browserMouseDownCallback",value:function(e){var t,n=this._enabledElement.viewport.element;this._canAutoPan=!(null===(t=e.target)||void 0===t||!t.closest(".advancedMagnifyTool")),document.addEventListener("mouseup",this._browserMouseUpCallback),n.removeEventListener("mouseup",this._cancelMouseEventCallback),n.removeEventListener("mousemove",this._cancelMouseEventCallback)}},{key:"_mouseDragCallback",value:function(e){if(Ke.isInteractingWithTool){var t=this._autoPan;if(t.enabled&&this._canAutoPan){var n=e.detail.currentPoints,r=this._enabledElement.viewport.canvasToWorld,o=n.canvas,a=this.radius,i=[a,a],l=Tu(i,o),s=a-t.padding;if(!(l<=s)){var c=l-s,d=xs.vec2.sub(xs.vec2.create(),o,i);xs.vec2.normalize(d,d),xs.vec2.scale(d,d,c);var u=xs.vec2.add(xs.vec2.create(),this.position,d),v=r(this.position),f=r(u),g=xs.vec3.sub(xs.vec3.create(),f,v),h={points:{currentPosition:{canvas:this.position,world:v},newPosition:{canvas:u,world:f}},delta:{canvas:d,world:g}};t.callback(h)}}}}},{key:"_addBrowserEventListeners",value:function(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}},{key:"_removeBrowserEventListeners",value:function(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}},{key:"_addEventListeners",value:function(e){J.eventTarget.addEventListener(Q.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}},{key:"_removeEventListeners",value:function(e){J.eventTarget.removeEventListener(Q.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(Q.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(Q.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}},{key:"_initialize",value:function(){var e=this._sourceEnabledElement.viewport,t=e.canvas,n=this._createViewportNode();t.parentNode.appendChild(n),this._addEventListeners(n),this._cloneViewport(e,n),this._enabledElement=(0,J.getEnabledElement)(n)}},{key:"_syncViewportsCameras",value:function(e,t){var n=e.canvasToWorld(this.position),r=this._convertZoomFactorToParalellScale(e,t,this.zoomFactor),o=t.getCamera(),a=o.focalPoint,i=o.position,l=o.viewPlaneNormal,s=Math.sqrt(Math.pow(a[0]-i[0],2)+Math.pow(a[1]-i[1],2)+Math.pow(a[2]-i[2],2)),c=[n[0],n[1],n[2]],d=[c[0]+s*l[0],c[1]+s*l[1],c[2]+s*l[2]];t.setCamera({parallelScale:r,focalPoint:c,position:d})}},{key:"_syncStackViewports",value:function(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}},{key:"_syncViewports",value:function(){var e=this._sourceEnabledElement.viewport,t=this._enabledElement.viewport,n=e.getProperties();t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t)}},{key:"_resizeViewport",value:function(){this._enabledElement.viewport.getRenderingEngine().resize()}}]),e}(),ap=1-J.CONSTANTS.EPSILON,ip=J.Enums.Events,lp=function(){function e(){var t=this;oe(this,e),ae(this,"_magnifyViewportsMap",void 0),ae(this,"createViewport",(function(e,n){var r=n.magnifyViewportId,o=n.sourceEnabledElement,a=n.position,i=n.radius,l=n.zoomFactor,s=n.autoPan,c=o.viewport.element,d=new op({magnifyViewportId:r,sourceEnabledElement:o,radius:i,position:a,zoomFactor:l,autoPan:s});return t._addSourceElementEventListener(c),t._magnifyViewportsMap.set(d.viewportId,{annotation:e,magnifyViewport:d}),d})),ae(this,"_annotationRemovedCallback",(function(e){var n=e.detail.annotation;"AdvancedMagnify"===n.metadata.toolName&&t._destroyViewport(n.data.magnifyViewportId)})),ae(this,"_newStackImageCallback",(function(e){var n=e.detail,r=n.viewportId,o=n.imageId;t._getMagnifyViewportsMapEntriesBySourceViewportId(r).forEach((function(e){var t=e.annotation;t.metadata.referencedImageId=o,t.invalidated=!0}))})),ae(this,"_newVolumeImageCallback",(function(e){var n=e.detail,r=n.renderingEngineId,o=n.viewportId,a=(0,J.getRenderingEngine)(r).getViewport(o),i=a.getCamera().viewPlaneNormal;t._getMagnifyViewportsMapEntriesBySourceViewportId(o).forEach((function(e){var t=e.annotation,n=t.metadata.viewPlaneNormal;if(Math.abs(xs.vec3.dot(n,i))>ap){for(var r=t.data.handles,o=a.canvasToWorld([0,0]),l=xs.vec3.sub(xs.vec3.create(),o,r.points[0]),s=xs.vec3.dot(l,i),c=xs.vec3.scale(xs.vec3.create(),i,s),d=0,u=r.points.length;d<u;d++){var v=r.points[d];v[0]+=c[0],v[1]+=c[1],v[2]+=c[2]}t.invalidated=!0}}))})),this._magnifyViewportsMap=new Map,this._initialize()}return re(e,[{key:"getViewport",value:function(e){var t;return null===(t=this._magnifyViewportsMap.get(e))||void 0===t?void 0:t.magnifyViewport}},{key:"dispose",value:function(){this._removeEventListeners(),this._destroyViewports()}},{key:"_destroyViewport",value:function(e){var t=this._magnifyViewportsMap.get(e);if(t){var n=t.magnifyViewport,r=n.sourceEnabledElement.viewport.element;this._removeSourceElementEventListener(r),n.dispose(),this._magnifyViewportsMap.delete(e)}}},{key:"_destroyViewports",value:function(){var e=this;Array.from(this._magnifyViewportsMap.keys()).forEach((function(t){return e._destroyViewport(t)}))}},{key:"_getMagnifyViewportsMapEntriesBySourceViewportId",value:function(e){return Array.from(this._magnifyViewportsMap.values()).filter((function(t){return t.magnifyViewport.sourceEnabledElement.viewport.id===e}))}},{key:"_addEventListeners",value:function(){J.eventTarget.addEventListener(Q.ANNOTATION_REMOVED,this._annotationRemovedCallback)}},{key:"_removeEventListeners",value:function(){J.eventTarget.removeEventListener(Q.ANNOTATION_REMOVED,this._annotationRemovedCallback)}},{key:"_addSourceElementEventListener",value:function(e){e.addEventListener(ip.STACK_NEW_IMAGE,this._newStackImageCallback),e.addEventListener(ip.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}},{key:"_removeSourceElementEventListener",value:function(e){e.removeEventListener(ip.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(ip.VOLUME_NEW_IMAGE,this._newVolumeImageCallback)}},{key:"_initialize",value:function(){this._addEventListeners()}}],[{key:"getInstance",value:function(){var t;return e._singleton=null!==(t=e._singleton)&&void 0!==t?t:new e,e._singleton}}]),e}();ae(lp,"_singleton",void 0);var sp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:2.5,zoomFactorList:[2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:[{method:"showZoomFactorsList",bindings:[{mouseButton:Eo.Secondary,modifierKey:yo.Shift}]}]}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"magnifyViewportManager",void 0),ae(ga(e),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=(0,J.getEnabledElement)(o),i=a.viewport,l=a.renderingEngine,s=r.world,c=r.canvas,d=e.configuration.magnifyingGlass,u=d.radius,v=d.zoomFactor,f=d.autoPan,g=e._getWorldHandlesPoints(i,c,u),h=i.getCamera(),p=h.viewPlaneNormal,m=h.viewUp,w=e.getReferencedImageId(i,s,p,m),E=J.utilities.uuidv4(),y=J.utilities.uuidv4(),I=i.getFrameOfReferenceUID(),b={annotationUID:E,highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(p),viewUp:Lr(m),FrameOfReferenceUID:I,referencedImageId:w},data:{sourceViewportId:i.id,magnifyViewportId:y,zoomFactor:v,handles:{points:g,activeHandleIndex:null}}};e.magnifyViewportManager.createViewport(b,{magnifyViewportId:y,sourceEnabledElement:a,position:c,radius:u,zoomFactor:v,autoPan:{enabled:f.enabled,padding:f.padding,callback:function(e){for(var t=b.data.handles.points,n=e.delta.world,r=0,o=t.length;r<o;r++)t[r][0]+=n[0],t[r][1]+=n[1],t[r][2]+=n[2]}}}),rt(b,o);var C=ad(o,e.getToolName());return t.preventDefault(),ca(l,C),b})),ae(ga(e),"isPointNearTool",(function(e,t,n,r){var o=(0,J.getEnabledElement)(e).viewport,a=t.data.handles.points.map((function(e){return o.worldToCanvas(e)})),i=a[0],l=a[2],s=a[3],c=.5*Math.abs(l[1]-i[1]),d=kh([[s[0]+c,i[1]+c],n]);return Math.abs(d-c)<1.5*r})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=ad(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o},gs(r),e._activateModify(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i=a.handles.points.findIndex((function(e){return e===r})),l=ad(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:l,handleIndex:i},e._activateModify(o),gs(o);var s=(0,J.getEnabledElement)(o).renderingEngine;ca(s,l),t.preventDefault()})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation;o.data.handles.activeHandleIndex=null,e._deactivateModify(n),fs(n);var l=(0,J.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,ca(l,a),i){var s=Q.ANNOTATION_COMPLETED,c={annotation:o};(0,J.triggerEvent)(J.eventTarget,s,c)}})),ae(ga(e),"_dragDrawCallback",(function(t){var n;e.isDrawing=!0;var r=t.detail,o=r.element,a=r.deltaPoints,i=null!==(n=null==a?void 0:a.world)&&void 0!==n?n:[0,0,0],l=(0,J.getEnabledElement)(o).renderingEngine,s=e.editData,c=s.annotation,d=s.viewportIdsToRender;c.data.handles.points.forEach((function(e){e[0]+=i[0],e[1]+=i[1],e[2]+=i[2]})),c.invalidated=!0,e.editData.hasMoved=!0,ca(l,d)})),ae(ga(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,s=a.data;if(void 0===l){var c=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=c[0],e[1]+=c[1],e[2]+=c[2]})),a.invalidated=!0}else e._dragHandle(t),a.invalidated=!0;var d=(0,J.getEnabledElement)(r).renderingEngine;ca(d,i)})),ae(ga(e),"_dragHandle",(function(t){var n=t.detail,r=n.element,o=(0,J.getEnabledElement)(r).viewport,a=o.worldToCanvas,i=e.editData.annotation.data.handles.points,l=i.map((function(e){return a(e)})),s=l[0],c=l[2],d=l[3],u=.5*Math.abs(c[1]-s[1]),v=[d[0]+u,s[1]+u],f=kh([v,n.currentPoints.canvas]),g=e._getWorldHandlesPoints(o,v,f);i[0]=g[0],i[1]=g[1],i[2]=g[2],i[3]=g[3]})),ae(ga(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateModify(t),fs(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,J.getEnabledElement)(t).renderingEngine;if(ca(l,o),a){var s=Q.ANNOTATION_COMPLETED,c={annotation:r};(0,J.triggerEvent)(J.eventTarget,s,c)}return e.editData=null,r.annotationUID}})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a,i=!1,l=t.viewport,s=l.element,c=nt(e.getToolName(),s);if(null===(r=c)||void 0===r||!r.length)return i;if(c=null===(o=c=e.filterInteractableAnnotationsForElement(s,c))||void 0===o?void 0:o.filter((function(e){return e.data.sourceViewportId===l.id})),null===(a=c)||void 0===a||!a.length)return i;for(var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=0;u<c.length;u++){var v=c[u],f=v.annotationUID,g=v.data,h=g.magnifyViewportId,p=g.zoomFactor,m=g.handles,w=m.points,E=m.activeHandleIndex;d.annotationUID=f;var y=e.getStyle("lineWidth",d,v),I=e.getStyle("lineDash",d,v),b=e.getStyle("color",d,v),C=w.map((function(e){return l.worldToCanvas(e)})),_=C[0],T=C[2],O=C[3],D=.5*Math.abs(T[1]-_[1]),S=[O[0]+D,_[1]+D];if(!l.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),i;var k=void 0;if(Pe(f)){ve(v)||e.editData||null===E||(k=[C[E]]),k&&Xs(n,f,"0",k,{color:b});var M="".concat(f,"-advancedMagnify");Ks(n,f,"0",S,D,{color:b,lineDash:I,lineWidth:y},M);var x=e.magnifyViewportManager.getViewport(h);x.position=S,x.radius=D,x.zoomFactor=p,x.update(),i=!0}}return i})),ae(ga(e),"_getWorldHandlesPoints",(function(e,t,n){return[[t[0],t[1]-n],[t[0]+n,t[1]],[t[0],t[1]+n],[t[0]-n,t[1]]].map((function(t){return e.canvasToWorld(t)}))})),e.magnifyViewportManager=lp.getInstance(),e}return re(o,[{key:"showZoomFactorsList",value:function(e,t){var n=e.detail,r=n.element,o=n.currentPoints,a=(0,J.getEnabledElement)(r).viewport,i=o.canvas,l=r.querySelector(":scope .viewport-element"),s=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(s,(function(e){void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),a.render()}));Object.assign(c.style,{left:"".concat(i[0],"px"),top:"".concat(i[1],"px")}),l.appendChild(c),c.focus()}},{key:"_getZoomFactorsListDropdown",value:function(e,t){var n=this.configuration.magnifyingGlass.zoomFactorList,r=document.createElement("select");return r.size=5,Object.assign(r.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((function(e){r.addEventListener(e,(function(e){return e.stopPropagation()}))})),r.addEventListener("change",(function(e){e.stopPropagation(),t(r.value)})),r.addEventListener("keydown",(function(e){var n,r;((null!==(n=e.keyCode)&&void 0!==n?n:27===e.which)||"escape"===(null===(r=e.key)||void 0===r?void 0:r.toLowerCase()))&&(e.stopPropagation(),t())})),n.forEach((function(t){var n=document.createElement("option");n.label=t,n.title="Zoom factor ".concat(t.toFixed(1)),n.value=t,n.defaultSelected=t===e,r.add(n)})),r}}]),o}(hd);ae(sp,"toolName",void 0),sp.toolName="AdvancedMagnify";var cp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"isDrawing",!1),ae(ga(e),"isHandleOutsideImage",!1),ae(ga(e),"_elementWithCursor",null),ae(ga(e),"_currentCursorWorldPosition",null),ae(ga(e),"_currentCanvasPosition",null),ae(ga(e),"_disableCursorEnabled",!1),ae(ga(e),"mouseMoveCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints;e._currentCursorWorldPosition=o.world,e._currentCanvasPosition=o.canvas,e._elementWithCursor=r;var a=e.getActiveAnnotation(r);return null===a?(e.createInitialAnnotation(o.world,r),!1):(e.updateAnnotationPosition(r,a),!1)})),ae(ga(e),"createInitialAnnotation",(function(t,n){var r=(0,J.getEnabledElement)(n);if(!r)throw new Error("No enabled element found");var o=r.viewport,a=r.renderingEngine;e.isDrawing=!0;var i=o.getCamera(),l=i.viewPlaneNormal,s=i.viewUp;if(!l||!s)throw new Error("Camera not found");var c=e.getReferencedImageId(o,t,l,s),d=o.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(l),viewUp:Lr(s),FrameOfReferenceUID:d,referencedImageId:c},data:{label:"",handles:{points:[Lr(t)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(nt(e.getToolName(),n).length>0)return null;if(null!==rt(u,n)){var v=ad(n,e.getToolName(),!1);ca(a,v)}})),ae(ga(e),"onCameraModified",(function(t){var n=t.detail,r=n.element,o=n.previousCamera,a=n.camera,i=(0,J.getEnabledElement)(r).viewport;if(r===e._elementWithCursor){var l=o.focalPoint,s=a.viewPlaneNormal,c=a.focalPoint,d=[0,0,0];if(Du().subtract(c,l,d),0!==d.reduce((function(e,t){return e+t}),0)){var u=Du().dot(d,s);if(!(Math.abs(u)<.01)&&e._currentCanvasPosition){var v=i.canvasToWorld(e._currentCanvasPosition);e._currentCursorWorldPosition=v,e.updateAnnotationPosition(r,e.getActiveAnnotation(r))}}}})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=(t.FrameOfReferenceUID,e._elementWithCursor===i.element);e.configuration.positionSync&&!l&&e.updateViewportImage(i);var s=i.element,c=nt(e.getToolName(),s);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(s,c))||void 0===o||!o.length)return a;for(var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=0;u<c.length;u++){var v=c[u],f=v.annotationUID,g=v.data.handles.points;if(!f)return a;d.annotationUID=f;var h=parseFloat(e.getStyle("lineWidth",d,v)),p=e.getStyle("lineDash",d,v),m=e.getStyle("color",d,v);if(g[0].some((function(e){return isNaN(e)})))return a;var w=g.map((function(e){return i.worldToCanvas(e)}));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(Pe(f)){var E={upper:"upper",right:"right",lower:"lower",left:"left"},y=dt(w[0],2),I=y[0],b=y[1],C=l?20:7,_=l?5:7;Zs(n,f,E.upper,[I,b-(C/2+_)],[I,b-C/2],{color:m,lineDash:p,lineWidth:h}),Zs(n,f,E.lower,[I,b+(C/2+_)],[I,b+C/2],{color:m,lineDash:p,lineWidth:h}),Zs(n,f,E.right,[I+(C/2+_),b],[I+C/2,b],{color:m,lineDash:p,lineWidth:h}),Zs(n,f,E.left,[I-(C/2+_),b],[I-C/2,b],{color:m,lineDash:p,lineWidth:h}),a=!0}}return a})),e._disableCursorEnabled=e.configuration.disableCursor,e}return re(o,[{key:"onSetToolActive",value:function(){if(this._disableCursorEnabled=this.configuration.disableCursor,this._disableCursorEnabled){var e=fa(this.toolGroupId).viewportsInfo;e&&e.map((function(e){return(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})).forEach((function(e){e&&gs(e.viewport.element)}))}}},{key:"onSetToolDisabled",value:function(){if(this._disableCursorEnabled){var e=fa(this.toolGroupId).viewportsInfo;e&&e.map((function(e){return(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})).forEach((function(e){e&&fs(e.viewport.element)}))}}},{key:"getActiveAnnotation",value:function(e){var t=nt(this.getToolName(),e);return t.length?t[0]:null}},{key:"updateAnnotationPosition",value:function(e,t){var n,r,o=this._currentCursorWorldPosition;if(o&&null!==(n=t.data)&&void 0!==n&&null!==(r=n.handles)&&void 0!==r&&r.points){t.data.handles.points=[Lr(o)],t.invalidated=!0;var a=ad(e,this.getToolName(),!1),i=(0,J.getEnabledElement)(e);if(i){var l=i.renderingEngine;ca(l,a)}}}},{key:"filterInteractableAnnotationsForElement",value:function(e,t){var n,r,o;if(!(t instanceof Array)||0===t.length)return[];var a=t[0],i=null===(n=(0,J.getEnabledElement)(e))||void 0===n?void 0:n.viewport;if(!i)return[];var l=i.getCamera(),s=l.viewPlaneNormal,c=l.focalPoint;if(!s||!c)return[];var d=null===(r=a.data)||void 0===r||null===(o=r.handles)||void 0===o?void 0:o.points;if(!(d instanceof Array)||1!==d.length)return[];var u=d[0],v=J.utilities.planar.planeEquation(s,c);return J.utilities.planar.planeDistanceToPoint(v,u)<this.configuration.displayThreshold?[a]:[]}},{key:"updateViewportImage",value:function(e){var t=this._currentCursorWorldPosition;if(t&&!t.some((function(e){return isNaN(e)})))if(e instanceof J.StackViewport){var n=J.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof J.VolumeViewport){var r=e.getCamera(),o=r.focalPoint,a=r.viewPlaneNormal;if(!o||!a)return;var i=J.utilities.planar.planeEquation(a,o),l=J.utilities.planar.planeDistanceToPoint(i,t,!0);if(Math.abs(l)<.5)return;var s=xs.vec3.normalize(xs.vec3.create(),xs.vec3.fromValues.apply(xs.vec3,Lr(a))),c=xs.vec3.scale(xs.vec3.create(),s,l),d=xs.vec3.add(xs.vec3.create(),xs.vec3.fromValues.apply(xs.vec3,Lr(o)),c);e.setCamera({focalPoint:d});var u=e.getRenderingEngine();u&&u.renderViewport(e.id)}}}]),o}(vd);ae(cp,"toolName",void 0),cp.toolName="ReferenceCursors";var dp=cp;var up=[],vp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{viewportId:"",scaleLocation:"bottom"}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"touchDragCallback",void 0),ae(ga(e),"mouseDragCallback",void 0),ae(ga(e),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",{}),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"_init",(function(){var t=(0,J.getRenderingEngines)()[0];if(t){var n=fa(e.toolGroupId).viewportsInfo;if(n){var r=n.map((function(e){return(0,J.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})),o=r[0].viewport,a=r[0].FrameOfReferenceUID;if(e.configuration.viewportId&&r.forEach((function(t){t.viewport.id==e.configuration.viewportId&&(o=t.viewport)})),o){var i=o.getCamera(),l=i.viewUp,s=i.viewPlaneNormal,c=J.utilities.getViewportImageCornersInWorld(o),d=e.editData.annotation,u=nt(e.getToolName(),o.element);if(u.length&&(d=u.filter((function(e){return e.data.viewportId==o.id}))[0]),up.includes(o.id))e.editData.annotation.data.viewportId==o.id&&(e.editData.annotation.data.handles.points=c,e.editData.annotation.data.viewportId=o.id);else{var v={metadata:{toolName:e.getToolName(),viewPlaneNormal:Lr(s),viewUp:Lr(l),FrameOfReferenceUID:a,referencedImageId:null},data:{handles:{points:c},viewportId:o.id}};up.push(o.id),rt(v,o.element),d=v}e.editData={viewport:o,renderingEngine:t,annotation:d}}}}})),ae(ga(e),"onSetToolEnabled",(function(){e._init()})),ae(ga(e),"onCameraModified",(function(t){e.configuration.viewportId=t.detail.viewportId,e._init()})),ae(ga(e),"computeScaleSize",(function(e,t,n){var r=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];return("top"==n||"bottom"==n?r.filter((function(t){return t<.6*e&&t>.2*e})):r.filter((function(e){return e<.6*t&&e>.2*t})))[0]})),ae(ga(e),"computeEndScaleTicks",(function(e,t){var n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}})),ae(ga(e),"computeInnerScaleTicks",(function(e,t,n,r,o){var a;"bottom"==t||"top"==t?a=o[0][0]-r[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-r[0][1]);var i=[],l=[],s=[],c=e;e>=50&&(c=e/10);for(var d=a/c,u=0;u<c-1;u++){var v={bottom:[[d*(u+1),0],[d*(u+1),5]],top:[[d*(u+1),0],[d*(u+1),-5]],left:[[0,d*(u+1)],[-5,d*(u+1)]],right:[[0,d*(u+1)],[5,d*(u+1)]]};i.push("".concat(n,"-tick").concat(u)),l.push("tick".concat(u)),(u+1)%5==0?s.push([[r[0][0]+v[t][0][0],r[0][1]+v[t][0][1]],[r[1][0]+v[t][0][0],r[1][1]+v[t][0][1]]]):s.push([[r[0][0]+v[t][0][0],r[0][1]+v[t][0][1]],[r[1][0]+v[t][1][0],r[1][1]+v[t][1][1]]])}return{tickIds:i,tickUIDs:l,tickCoordinates:s}})),ae(ga(e),"computeWorldScaleCoordinates",(function(e,t,n){var r,o=xs.vec3.subtract(xs.vec3.create(),n[0],n[1]);o=xs.vec3.normalize(xs.vec3.create(),o);var a=xs.vec3.subtract(xs.vec3.create(),n[2],n[0]);a=xs.vec3.normalize(xs.vec3.create(),a);var i={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},l=xs.vec3.add(xs.vec3.create(),i[t][0],i[t][0]).map((function(e){return e/2})),s=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?r=[xs.vec3.subtract(xs.vec3.create(),l,a.map((function(e){return e*s}))),xs.vec3.add(xs.vec3.create(),l,a.map((function(e){return e*s})))]:"left"!=t&&"right"!=t||(r=[xs.vec3.add(xs.vec3.create(),l,o.map((function(e){return e*s}))),xs.vec3.subtract(xs.vec3.create(),l,o.map((function(e){return e*s})))]),r})),ae(ga(e),"computeCanvasScaleCoordinates",(function(e,t,n,r,o){var a;if("top"==o||"bottom"==o){var i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){var l=t[0][1]-t[1][1];a=[[r.width,e.height/2-l/2],[r.width,e.height/2+l/2]]}return a})),ae(ga(e),"computeScaleBounds",(function(e,t,n,r){var o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),i={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},l={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:l[r][0]+i[r][0],width:l[r][1]+i[r][1]}})),e}return re(o,[{key:"renderAnnotation",value:function(e,t){if(this.editData.viewport){var n=this.configuration.scaleLocation,r=e.viewport,o=nt(this.getToolName(),r.element).filter((function(e){return e.data.viewportId==r.id}))[0],a=e.viewport.canvas;if(!r)return!1;var i={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l={width:a.width,height:a.height},s=o.data.handles.points[0],c=o.data.handles.points[1],d=o.data.handles.points[2],u=o.data.handles.points[3],v=[s,d,c,u],f=xs.vec3.distance(d,u),g=xs.vec3.distance(s,d),h=this.computeScaleBounds(l,.05,.05,n),p=this.computeScaleBounds(l,.05,.05,n),m=this.computeScaleSize(f,g,n),w=this.computeWorldScaleCoordinates(m,n,v).map((function(e){return r.worldToCanvas(e)})),E=this.computeCanvasScaleCoordinates(l,w,p,h,n),y=this.computeEndScaleTicks(E,n),I=o.annotationUID;i.annotationUID=I;var b=this.getStyle("lineWidth",i,o),C=this.getStyle("lineDash",i,o),_=this.getStyle("color",i,o),T=this.getStyle("shadow",i,o),O="".concat(I,"-scaleline");Zs(t,I,"1",E[0],E[1],{color:_,width:b,lineDash:C,shadow:T},O);var D="".concat(I,"-left");Zs(t,I,"2",y.endTick1[0],y.endTick1[1],{color:_,width:b,lineDash:C,shadow:T},D);var S="".concat(I,"-right");Zs(t,I,"3",y.endTick2[0],y.endTick2[1],{color:_,width:b,lineDash:C,shadow:T},S);for(var k={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},M=[E[0][0]+k[n][0],E[0][1]+k[n][1]],x=this._getTextLines(m),R=this.computeInnerScaleTicks(m,n,I,y.endTick1,y.endTick2),P=R.tickIds,A=R.tickUIDs,N=R.tickCoordinates,L=0;L<A.length;L++)Zs(t,I,A[L],N[L][0],N[L][1],{color:_,width:b,lineDash:C,shadow:T},P[L]);return tc(t,I,"text0",x,[M[0],M[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:_}),!1}}},{key:"_getTextLines",value:function(e){var t,n;return e>=50?(t=e/10,n=" cm"):(t=e,n=" mm"),[t.toString().concat(n)]}}]),o}(vd);ae(vp,"toolName",void 0),vp.toolName="ScaleOverlay";var fp=vp,gp=J.utilities.transformWorldToIndex;function hp(e,t){!function(e,t){var n=t.volume,r=t.points,o=t.segmentsLocked,a=t.segmentIndex,i=t.segmentationId,l=t.constraintFn,s=n.imageData,c=n.dimensions,d=n.getScalarData(),u=r.map((function(e){return gp(s,e)}));u=u.map((function(e){return e.map((function(e){return Math.round(e)}))}));var v=mc(u,c);pc(s,(function(){return!0}),(function(e){var t=e.value,n=e.index,r=e.pointIJK;o.includes(t)||(l?l(r)&&(d[n]=a):d[n]=a)}),v),St(i)}(0,t)}var pp=J.utilities.transformWorldToIndex;function mp(e,t){!function(e,t){var n=t.volume,r=t.points,o=t.segmentsLocked,a=t.segmentationId,i=n.imageData,l=n.dimensions,s=n.getScalarData(),c=r.map((function(e){return pp(i,e)})),d=mc(c,l);pc(i,(function(){return!0}),(function(e){var t=e.value,n=e.index;o.includes(t)||(s[n]=0)}),d),St(a)}(0,t)}var wp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:hp,ERASE_INSIDE:mp},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c=l.getCamera(),d=c.viewPlaneNormal,u=c.viewUp,v=e.toolGroupId,f=Nc(v);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");var g=f.segmentationRepresentationUID,h=f.segmentationId,p=f.type,m=Wc(h),w=jc(h),E=Gc(v,g,m),y=Pt(h).representationData[p].volumeId,I=J.cache.getVolume(y),b={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:Lr(d),viewUp:Lr(u),FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:E},data:{handles:{points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null}}},C=ad(o,e.getToolName());return e.editData={annotation:b,segmentation:I,segmentIndex:m,segmentsLocked:w,segmentColor:E,segmentationId:h,viewportIdsToRender:C,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,C),!0})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n,r,o,a,i,l,s,c,d=t.detail,u=d.element,v=e.editData,f=v.annotation,g=v.viewportIdsToRender,h=v.handleIndex,p=f.data,m=d.currentPoints,w=(0,J.getEnabledElement)(u),E=w.viewport,y=E.worldToCanvas,I=E.canvasToWorld,b=m.world,C=p.handles.points;switch(C[h]=Lr(b),h){case 0:case 3:n=y(C[0]),r=[(a=y(C[3]))[0],n[1]],o=[n[0],a[1]],l=I(r),s=I(o),C[1]=l,C[2]=s;break;case 1:case 2:r=y(C[1]),n=[(o=y(C[2]))[0],r[1]],a=[r[0],o[1]],i=I(n),c=I(a),C[0]=i,C[3]=c}f.invalidated=!0,e.editData.hasMoved=!0;var _=w.renderingEngine;ca(_,g)})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,s=r.segmentationId,c=r.segmentIndex,d=r.segmentsLocked,u=o.data;if(!a||i){u.handles.activeHandleIndex=null,e._deactivateDraw(n),fs(n);var v=(0,J.getEnabledElement)(n),f=v.viewport;if(e.editData=null,e.isDrawing=!1,f instanceof J.StackViewport)throw new Error("Not implemented yet");var g={points:u.handles.points,volume:l,segmentationId:s,segmentIndex:c,segmentsLocked:d};e.applyActiveStrategy(v,g)}})),ae(ga(e),"_activateDraw",(function(t){t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport,a=e.editData.annotation,i=a.metadata,l=a.annotationUID,s=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),c="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(oc(n,l,"0",s[0],s[3],{color:c}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return re(o)}(La);ae(wp,"toolName",void 0),wp.toolName="RectangleScissor";var Ep=wp;var yp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Mc},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=r.canvas,l=(0,J.getEnabledElement)(o),s=l.viewport,c=l.renderingEngine;e.isDrawing=!0;var d=s.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.toolGroupId,g=Nc(f);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");var h=g.segmentationRepresentationUID,p=g.segmentationId,m=g.type,w=Wc(p),E=jc(p),y=Gc(f,h,w),I=Pt(p).representationData[m].volumeId,b=J.cache.getVolume(I),C={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:Lr(u),viewUp:Lr(v),FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:y},data:{handles:{points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},_=[s.id];return e.editData={annotation:C,segmentation:b,centerCanvas:i,segmentIndex:w,segmentationId:p,segmentsLocked:E,segmentColor:y,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(c,_),!0})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,J.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,s=e.editData,c=s.annotation,d=s.viewportIdsToRender,u=s.centerCanvas,v=c.data,f=Math.abs(o[0]-u[0]),g=Math.abs(o[1]-u[1]),h=Math.sqrt(f*f+g*g),p=[u[0],u[1]+h],m=[u[0],u[1]-h],w=[u[0]-h,u[1]],E=[u[0]+h,u[1]];v.handles.points=[l(p),l(m),l(w),l(E)],c.invalidated=!0,e.editData.hasMoved=!0,ca(i,d)})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,s=r.segmentIndex,c=r.segmentsLocked,d=r.segmentationId,u=o.data,v=o.metadata,f=v.viewPlaneNormal,g=v.viewUp;if(!a||i){u.handles.activeHandleIndex=null,e._deactivateDraw(n),fs(n);var h=(0,J.getEnabledElement)(n),p=h.viewport;if(e.editData=null,e.isDrawing=!1,p instanceof J.StackViewport)throw new Error("Not implemented yet");var m={points:u.handles.points,volume:l,segmentIndex:s,segmentsLocked:c,viewPlaneNormal:f,segmentationId:d,viewUp:g};e.applyActiveStrategy(h,m)}})),ae(ga(e),"_activateDraw",(function(t){t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback),t.addEventListener(Q.TOUCH_END,e._endCallback)})),ae(ga(e),"_deactivateDraw",(function(t){t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport;if(!e.editData.viewportIdsToRender.includes(o.id))return r;var a=e.editData.annotation,i=a.metadata,l=a.annotationUID,s=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),c=s[0],d=s[1],u=[Math.floor((c[0]+d[0])/2),Math.floor((c[1]+d[1])/2)],v=Math.abs(c[1]-Math.floor((c[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(Ks(n,l,"0",u,v,{color:f}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return re(o)}(La);ae(yp,"toolName",void 0),yp.toolName="CircleScissor";var Ip=yp;var bp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Cc},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return oe(this,o),ae(ga(e=r.call(this,t,n)),"editData",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=r.canvas,l=(0,J.getEnabledElement)(o),s=l.viewport,c=l.renderingEngine;e.isDrawing=!0;var d=s.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.toolGroupId,g=Nc(f);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");var h=g.segmentationRepresentationUID,p=g.segmentationId,m=g.type,w=Wc(p),E=jc(p),y=Gc(f,h,w),I=Pt(p).representationData[m].volumeId,b=J.cache.getVolume(I);e.isDrawing=!0;var C={metadata:{viewPlaneNormal:Lr(u),viewUp:Lr(v),FrameOfReferenceUID:s.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:y},data:{invalidated:!0,handles:{points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},cachedStats:{},highlighted:!0}},_=[s.id];return e.editData={annotation:C,segmentation:b,centerCanvas:i,segmentIndex:w,segmentsLocked:E,segmentColor:y,segmentationId:p,toolGroupId:f,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(c,_),!0})),ae(ga(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,J.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,s=e.editData,c=s.annotation,d=s.viewportIdsToRender,u=s.centerCanvas,v=c.data,f=Math.abs(o[0]-u[0]),g=Math.abs(o[1]-u[1]),h=Math.sqrt(f*f+g*g),p=[u[0],u[1]+h],m=[u[0],u[1]-h],w=[u[0]-h,u[1]],E=[u[0]+h,u[1]];v.handles.points=[l(p),l(m),l(w),l(E)],c.invalidated=!0,e.editData.hasMoved=!0,ca(i,d)})),ae(ga(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,s=r.segmentIndex,c=r.segmentsLocked,d=r.segmentationId,u=o.data,v=o.metadata,f=v.viewPlaneNormal,g=v.viewUp;if(!a||i){o.highlighted=!1,u.handles.activeHandleIndex=null,e._deactivateDraw(n),fs(n);var h=(0,J.getEnabledElement)(n),p=h.viewport;if(e.editData=null,e.isDrawing=!1,p instanceof J.StackViewport)throw new Error("Not implemented yet");var m={points:u.handles.points,volume:l,segmentIndex:s,segmentsLocked:c,segmentationId:d,viewPlaneNormal:f,viewUp:g};e.applyActiveStrategy(h,m)}})),ae(ga(e),"_activateDraw",(function(t){t.addEventListener(Q.MOUSE_UP,e._endCallback),t.addEventListener(Q.MOUSE_DRAG,e._dragCallback),t.addEventListener(Q.MOUSE_CLICK,e._endCallback),t.addEventListener(Q.TOUCH_END,e._endCallback),t.addEventListener(Q.TOUCH_TAP,e._endCallback),t.addEventListener(Q.TOUCH_DRAG,e._dragCallback)})),ae(ga(e),"_deactivateDraw",(function(t){t.removeEventListener(Q.MOUSE_UP,e._endCallback),t.removeEventListener(Q.MOUSE_DRAG,e._dragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._endCallback),t.removeEventListener(Q.TOUCH_END,e._endCallback),t.removeEventListener(Q.TOUCH_DRAG,e._dragCallback),t.removeEventListener(Q.TOUCH_TAP,e._endCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport;if(!e.editData.viewportIdsToRender.includes(o.id))return r;var a=e.editData.annotation,i=a.metadata,l=a.annotationUID,s=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),c=s[0],d=s[1],u=[Math.floor((c[0]+d[0])/2),Math.floor((c[1]+d[1])/2)],v=Math.abs(c[1]-Math.floor((c[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(Ks(n,l,"0",u,v,{color:f}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return re(o)}(La);ae(bp,"toolName",void 0),bp.toolName="SphereScissor";var Cp=bp,_p=y(518),Tp=y.n(_p),Op=y(744),Dp=y.n(Op),Sp=y(424),kp=y.n(Sp),Mp=y(614),xp=y.n(Mp);function Rp(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pp(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Rp(Object(n),!0).forEach((function(t){ae(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Rp(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ap={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3},Np=function(e){pa(l,e);var t,n,r,o,a,i=(o=l,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=wa(o);if(a){var n=wa(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return ma(this,e)});function l(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{orientationWidget:{enabled:!0,viewportCorner:Tp().Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:l.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:(e={},ae(e,l.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,{faceProperties:{xPlus:{text:"R",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"L",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:function(e){return e/2},faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}}),ae(e,l.OVERLAY_MARKER_TYPES.AXES,{}),ae(e,l.OVERLAY_MARKER_TYPES.CUSTOM,{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}),e)}};return oe(this,l),ae(ga(t=i.call(this,n,r)),"orientationMarkers",void 0),ae(ga(t),"polyDataURL",void 0),ae(ga(t),"configuration_invalidated",!0),ae(ga(t),"onSetToolEnabled",(function(){t.initViewports(),t.configuration_invalidated=!0})),ae(ga(t),"onSetToolActive",(function(){t.initViewports()})),ae(ga(t),"onSetToolDisabled",(function(){t.cleanUpData()})),t.orientationMarkers={},t.configuration_invalidated=!0,t}return re(l,[{key:"cleanUpData",value:function(){var e=this;(0,J.getRenderingEngines)()[0].getViewports().forEach((function(t){var n=e.orientationMarkers[t.id];if(n){var r=n.actor,o=n.orientationWidget;null==o||o.setEnabled(!1),null==o||o.delete(),null==r||r.delete(),t.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),t.getRenderingEngine().render(),delete e.orientationMarkers[t.id]}}))}},{key:"initViewports",value:function(){var e=this,t=(0,J.getRenderingEngines)()[0];if(t){var n=t.getViewports();(n=nd(n,this.getToolName())).forEach((function(t){return e.addAxisActorInViewport(t)}))}}},{key:"addAxisActorInViewport",value:(r=Va(Ba().mark((function e(t){var n,r,o,a,i,l,s,c,d,u,v,f,g,h,p,m;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.id,r=this.configuration.overlayMarkerType,o=this.configuration.overlayConfiguration[r],this.orientationMarkers[n]&&(a=this.orientationMarkers[n],i=a.actor,l=a.orientationWidget,t.getRenderer().removeActor(i),l.setEnabled(!1)),1!==r){e.next=8;break}s=this.createAnnotationCube(o),e.next=16;break;case 8:if(2!==r){e.next=12;break}s=kp().newInstance(),e.next=16;break;case 12:if(3!==r){e.next=16;break}return e.next=15,this.createCustomActor();case 15:s=e.sent;case 16:c=t.getRenderer(),d=t.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),u=this.configuration.orientationWidget,v=u.enabled,f=u.viewportCorner,g=u.viewportSize,h=u.minPixelSize,p=u.maxPixelSize,(m=Tp().newInstance({actor:s,interactor:d.getInteractor(),parentRenderer:c})).setEnabled(v),m.setViewportCorner(f),m.setViewportSize(g),m.setMinPixelSize(h),m.setMaxPixelSize(p),m.updateMarkerOrientation(),this.orientationMarkers[n]={orientationWidget:m,actor:s},d.render(),t.getRenderingEngine().render(),this.configuration_invalidated=!1;case 30:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"createCustomActor",value:(n=Va(Ba().mark((function e(){var t,n,r,o,a,i,l;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.configuration.overlayConfiguration[Ap.CUSTOM].polyDataURL,e.next=3,fetch(t);case 3:return n=e.sent,e.next=6,n.arrayBuffer();case 6:return r=e.sent,(o=xp().newInstance()).parseAsArrayBuffer(r),o.update(),(a=Xa().newInstance()).shallowCopy(o.getOutputData()),a.getPointData().setActiveScalars("Color"),(i=Ha().newInstance()).setInputData(a),i.setColorModeToDirectScalars(),(l=qa().newInstance()).setMapper(i),l.rotateZ(180),e.abrupt("return",l);case 20:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"createAnnotationCube",value:function(e){var t=Dp().newInstance();return t.setDefaultStyle(Pp({},e.defaultStyle)),t.setXPlusFaceProperty(Pp({},e.faceProperties.xPlus)),t.setXMinusFaceProperty(Pp({},e.faceProperties.xMinus)),t.setYPlusFaceProperty(Pp({},e.faceProperties.yPlus)),t.setYMinusFaceProperty(Pp({},e.faceProperties.yMinus)),t.setZPlusFaceProperty(Pp({},e.faceProperties.zPlus)),t.setZMinusFaceProperty(Pp({},e.faceProperties.zMinus)),t}},{key:"createAnnotatedCubeActor",value:(t=Va(Ba().mark((function e(){var t,n,r,o;return Ba().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Dp().newInstance(),n=this.configuration.annotatedCube,r=n.faceProperties,o=n.defaultStyle,t.setDefaultStyle(o),Object.keys(r).forEach((function(e){var n="set".concat(e.charAt(0).toUpperCase()+e.slice(1),"FaceProperty");t[n](r[e])})),e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),l}(La);ae(Np,"toolName",void 0),ae(Np,"CUBE",1),ae(Np,"AXIS",2),ae(Np,"VTPFILE",3),ae(Np,"OVERLAY_MARKER_TYPES",Ap),Np.toolName="OrientationMarker";var Lp=Np;var Up=J.utilities.transformWorldToIndex,Vp=J.utilities.isEqual,jp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return oe(this,o),ae(ga(e=r.call(this,t,n)),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o).viewport.getCamera().viewPlaneNormal,l=Nc(e.toolGroupId);if(!l)throw new Error("No active segmentation detected, create one before using scissors tool");var s=l.segmentationId,c=l.type,d=Wc(s),u=jc(s),v=Pt(s).representationData[c].volumeId,f=J.cache.getVolume(v),g=f.dimensions,h=f.direction,p=f.getScalarData(),m=Up(f.imageData,a),w=e.getFixedDimension(i,h);if(void 0!==w){var E=e.generateHelpers(p,g,m,w),y=E.floodFillGetter,I=E.getLabelValue,b=E.getScalarDataPositionFromPlane,C=E.inPlaneSeedPoint,_=E.fixedDimensionValue;if(!(m[0]<0||m[0]>=g[0]||m[1]<0||m[1]>=g[1]||m[2]<0||m[2]>=g[2])){var T=I(m[0],m[1],m[2]);if(!u.includes(T)){var O=eu(y,C);return O.flooded.forEach((function(e){var t=b(e[0],e[1]);p[t]=d})),St(s,e.getFramesModified(w,_,O)),!0}}}else console.warn("Oblique paint fill not yet supported")})),ae(ga(e),"getFramesModified",(function(e,t,n){var r=n.boundaries;if(2===e)return[t];for(var o=1/0,a=-1/0,i=0;i<r.length;i++){var l=r[i][1];l<o&&(o=l),l>a&&(a=l)}for(var s=[],c=o;c<=a;c++)s.push(c);return s})),ae(ga(e),"generateHelpers",(function(t,n,r){var o,a,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;switch(i){case 0:o=r[0],a=[r[1],r[2]];break;case 1:o=r[1],a=[r[0],r[2]];break;case 2:o=r[2],a=[r[0],r[1]];break;default:throw new Error("Invalid fixedDimension: ".concat(i))}var l=function(e,t,r){return r*n[1]*n[0]+t*n[0]+e},s=function(e,n,r){return t[l(e,n,r)]},c=e.generateFloodFillGetter(n,i,o,s);return{getScalarDataPositionFromPlane:e.generateGetScalarDataPositionFromPlane(l,i,o),getLabelValue:s,floodFillGetter:c,inPlaneSeedPoint:a,fixedDimensionValue:o}})),ae(ga(e),"generateFloodFillGetter",(function(e,t,n,r){var o;switch(t){case 0:o=function(t,o){if(!(t>=e[1]||t<0||o>=e[2]||o<0))return r(n,t,o)};break;case 1:o=function(t,o){if(!(t>=e[0]||t<0||o>=e[2]||o<0))return r(t,n,o)};break;case 2:o=function(t,o){if(!(t>=e[0]||t<0||o>=e[1]||o<0))return r(t,o,n)};break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return o})),ae(ga(e),"generateGetScalarDataPositionFromPlane",(function(e,t,n){var r;switch(t){case 0:r=function(t,r){return e(n,t,r)};break;case 1:r=function(t,r){return e(t,n,r)};break;case 2:r=function(t,r){return e(t,r,n)};break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return r})),e}return re(o,[{key:"getFixedDimension",value:function(e,t){var n=t.slice(0,3),r=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],i=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(Vp(a,i))return 0;var l=[Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2])];if(Vp(a,l))return 1;var s=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return Vp(a,s)?2:void 0}}]),o}(La);ae(jp,"toolName",void 0),jp.toolName="PaintFill";var Bp=jp;var Wp=function(e){pa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=wa(t);if(n){var o=wa(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return ma(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return oe(this,o),ae(ga(e=r.call(this,t,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}})),"_throttledCalculateCachedStats",void 0),ae(ga(e),"editData",void 0),ae(ga(e),"_configuration",void 0),ae(ga(e),"isDrawing",void 0),ae(ga(e),"isHandleOutsideImage",void 0),ae(ga(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,J.getEnabledElement)(o),l=i.viewport,s=i.renderingEngine;e.isDrawing=!0;var c={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:l.getFrameOfReferenceUID(),toolName:e.getToolName()},data:{invalidated:!0,handles:{points:[Lr(a),Lr(a),Lr(a),Lr(a)],activeHandleIndex:null},cachedStats:{},active:!0}};rt(c,o);var d=ad(o,e.getToolName(),!1);return e.editData={annotation:c,viewportUIDsToRender:d,handleIndex:3,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),gs(o),t.preventDefault(),ca(s,d),c})),ae(ga(e),"getHandleNearImagePoint",(function(e,t,n,r){for(var o=(0,J.getEnabledElement)(e).viewport,a=t.data,i=a.handles.points,l=0;l<i.length;l++){var s=i[l],c=o.worldToCanvas(s);if(!0==xs.vec2.distance(n,c)<r)return a.handles.activeHandleIndex=l,s}a.handles.activeHandleIndex=null})),ae(ga(e),"isPointNearTool",(function(t,n,r,o){var a=(0,J.getEnabledElement)(t).viewport,i=n.data.handles.points,l=a.worldToCanvas(i[0]),s=a.worldToCanvas(i[3]),c=e._getRectangleImageCoordinates([l,s]),d=[r[0],r[1]];if(_d([c.left,c.top,c.width,c.height],d)<=o)return!0})),ae(ga(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.data.active=!0;var o=ad(r,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:o},e._activateModify(r),gs(r);var a=(0,J.getEnabledElement)(r).renderingEngine;ca(a,o),t.preventDefault()})),ae(ga(e),"handleSelectedCallback",(function(t,n,r){var o,a=t.detail.element,i=n.data;i.active=!0,r.worldPosition||(o=i.handles.points.findIndex((function(e){return e===r})));var l=ad(a,e.getToolName(),!1);e.editData={annotation:n,viewportUIDsToRender:l,handleIndex:o},e._activateModify(a),gs(a);var s=(0,J.getEnabledElement)(a).renderingEngine;ca(s,l),t.preventDefault()})),ae(ga(e),"_mouseUpCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportUIDsToRender,i=r.newAnnotation,l=r.hasMoved,s=o.data;if(!i||l){s.active=!1,s.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),fs(n);var c=(0,J.getEnabledElement)(n).renderingEngine;e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&at(o.annotationUID),ca(c,a)}})),ae(ga(e),"_mouseDragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportUIDsToRender,l=o.handleIndex,s=a.data;if(void 0===l){var c=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=c[0],e[1]+=c[1],e[2]+=c[2]})),s.invalidated=!0}else{var d,u,v,f,g,h,p,m,w=n.currentPoints,E=(0,J.getEnabledElement)(r).viewport,y=E.worldToCanvas,I=E.canvasToWorld,b=w.world,C=s.handles.points;switch(C[l]=Lr(b),l){case 0:case 3:d=y(C[0]),u=[(f=y(C[3]))[0],d[1]],v=[d[0],f[1]],h=I(u),p=I(v),C[1]=h,C[2]=p;break;case 1:case 2:u=y(C[1]),d=[(v=y(C[2]))[0],u[1]],f=[u[0],v[1]],g=I(d),m=I(f),C[0]=g,C[3]=m}s.invalidated=!0}e.editData.hasMoved=!0;var _=(0,J.getEnabledElement)(r).renderingEngine;ca(_,i)})),ae(ga(e),"_activateDraw",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.addEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(Q.MOUSE_MOVE,e._mouseDragCallback),t.addEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.addEventListener(Q.TOUCH_END,e._mouseUpCallback),t.addEventListener(Q.TOUCH_DRAG,e._mouseDragCallback)})),ae(ga(e),"_deactivateDraw",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_MOVE,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.removeEventListener(Q.TOUCH_END,e._mouseUpCallback),t.removeEventListener(Q.TOUCH_DRAG,e._mouseDragCallback)})),ae(ga(e),"_activateModify",(function(t){Ke.isInteractingWithTool=!0,t.addEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.addEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.addEventListener(Q.TOUCH_END,e._mouseUpCallback),t.addEventListener(Q.TOUCH_DRAG,e._mouseDragCallback)})),ae(ga(e),"_deactivateModify",(function(t){Ke.isInteractingWithTool=!1,t.removeEventListener(Q.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(Q.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(Q.MOUSE_CLICK,e._mouseUpCallback),t.removeEventListener(Q.TOUCH_END,e._mouseUpCallback),t.removeEventListener(Q.TOUCH_DRAG,e._mouseDragCallback)})),ae(ga(e),"renderAnnotation",(function(t,n){var r,o,a=t.viewport,i=a.element,l=nt(e.getToolName(),i);if(null===(r=l)||void 0===r||!r.length)return!1;if(null===(o=l=e.filterInteractableAnnotationsForElement(i,l))||void 0===o||!o.length)return!1;e.getTargetId(a),a.getRenderingEngine();for(var s={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},c=0;c<l.length;c++){var d=l[c],u=d.annotationUID,v=(d.metadata,d.data.handles),f=v.points,g=v.activeHandleIndex,h=f.map((function(e){return a.worldToCanvas(e)})),p=e.getStyle("lineWidth",s,d),m=e.getStyle("lineDash",s,d),w=e.getStyle("color",s,d);if(!a.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");var E=void 0;e.editData||null===g||(E=[h[g]]),E&&Xs(n,u,"0",E,{color:w}),ic(n,u,"0",h[0],h[3],{color:"black",lineDash:m,lineWidth:p})}})),ae(ga(e),"_getRectangleImageCoordinates",(function(e){var t=dt(e,2),n=t[0],r=t[1];return{left:Math.min(n[0],r[0]),top:Math.min(n[1],r[1]),width:Math.abs(n[0]-r[0]),height:Math.abs(n[1]-r[1])}})),ae(ga(e),"_calculateCachedStats",(function(t,n,r,o,a){for(var i=t.data,l=a.viewportUID,s=a.renderingEngineUID,c=a.sceneUID,d=i.handles.points[0],u=i.handles.points[3],v=i.cachedStats,f=Object.keys(v),g=0;g<f.length;g++){var h=f[g],p=e._getImageVolumeFromTargetUID(h,o).imageVolume,m=p.dimensions,w=p.scalarData,E=p.vtkImageData,y=p.metadata,I=xs.vec3.fromValues(0,0,0),b=xs.vec3.fromValues(0,0,0);if(E.worldToIndexVec3(d,I),I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]),E.worldToIndexVec3(u,b),b[0]=Math.floor(b[0]),b[1]=Math.floor(b[1]),b[2]=Math.floor(b[2]),e._isInsideVolume(I,b,m)){e.isHandleOutsideImage=!1;for(var C=Math.min(I[0],b[0]),_=Math.max(I[0],b[0]),T=Math.min(I[1],b[1]),O=Math.max(I[1],b[1]),D=Math.min(I[2],b[2]),S=Math.max(I[2],b[2]),k=_h(n,r,d,u),M=k.worldWidth*k.worldHeight,x=0,R=0,P=0,A=m[0],N=m[0]*m[1],L=D;L<=S;L++)for(var U=T;U<=O;U++)for(var V=C;V<=_;V++)x++,R+=w[L*N+U*A+V];R/=x;for(var j=D;j<=S;j++)for(var B=T;B<=O;B++)for(var W=C;W<=_;W++){var F=w[j*N+B*A+W]-R;P+=F*F}P/=x,P=Math.sqrt(P),v[h]={Modality:y.Modality,area:M,mean:R,stdDev:P}}else e.isHandleOutsideImage=!0,v[h]={Modality:y.Modality}}i.invalidated=!1;var H=Q.ANNOTATION_MODIFIED,G={annotation:t,viewportUID:l,renderingEngineUID:s,sceneUID:c};return(0,J.triggerEvent)(J.eventTarget,H,G),v})),ae(ga(e),"_isInsideVolume",(function(e,t,n){return J.utilities.indexWithinDimensions(e,n)&&J.utilities.indexWithinDimensions(t,n)})),ae(ga(e),"_getTargetVolumeUID",(function(t){if(e.configuration.volumeUID)return e.configuration.volumeUID;var n=t.getVolumeActors();return n||n.length?n[0].uid:void 0})),e._throttledCalculateCachedStats=fc(e._calculateCachedStats,100,{trailing:!0}),e}return re(o,[{key:"cancel",value:function(e){if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),fs(e);var t=this.editData,n=t.annotation,r=t.viewportUIDsToRender,o=n.data;o.active=!1,o.handles.activeHandleIndex=null;var a=(0,J.getEnabledElement)(e).renderingEngine;return ca(a,r),this.editData=null,n.metadata.annotationUID}}},{key:"_getImageVolumeFromTargetUID",value:function(e,t){var n;if(e.startsWith("stackTarget")){var r=e.indexOf(":"),o=e.substring(r+1);n=t.getViewport(o).getImageData()}else n=J.cache.getVolume(e);return{imageVolume:n,viewport:void 0}}},{key:"_getTargetStackUID",value:function(e){return"stackTarget:".concat(e.uid)}}]),o}(hd);Wp.toolName="VideoRedaction";var Fp=Wp}(),I}()}));
//# sourceMappingURL=index.js.map